<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת מעקב הוצאות בניה</title>
    
    <!-- AWS Cognito SDK -->
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1498.0.min.js"></script>
    <script src="https://unpkg.com/amazon-cognito-identity-js@6.3.12/dist/amazon-cognito-identity.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #ffffff;
            min-height: 100vh;
            color: #000000;
            direction: rtl;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: #ffffff;
            position: relative;
            padding: 30px 140px 20px 140px;
            background: #000000;
            border-bottom: 2px solid #000000;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .company-logo {
            position: absolute;
            top: 0;
            right: 0;
            width: 120px;
            height: auto;
            border-radius: 0;
            border: 2px solid #000000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            background: white;
            padding: 8px;
            transition: transform 0.3s ease;
        }

        .company-logo:hover {
            transform: scale(1.05);
        }

        @media (max-width: 768px) {
            .company-logo {
                width: 80px;
                top: 10px;
                right: 10px;
            }
        }

        .status-panel {
            background: #ffffff;
            border: 2px solid #000000;
            border-radius: 0;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 0 0 rgba(0,0,0,0);
            color: #000000;
        }

        .status-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #000000;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: bold;
        }

        .demo-section {
            background: #ffffff;
            border: 2px solid #000000;
            border-radius: 0;
            padding: 20px;
            margin-bottom: 20px;
        }

        .demo-title {
            font-weight: bold;
            color: #000000;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }


        .results-area {
            background: #000000;
            color: #ffffff;
            border: 2px solid #ffffff;
            border-radius: 0;
            padding: 20px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }

        .expense-card {
            background: #ffffff;
            border: 2px solid #000000;
            border-radius: 0;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: none;
            color: #000000;
        }

        .expense-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            position: relative;
        }
        
        .expense-actions {
            position: absolute;
            top: 0;
            left: 0;
            display: flex;
            gap: 5px;
        }
        
        .delete-button {
            background: #000000;
            color: #ffffff;
            border: 2px solid #ffffff;
            border-radius: 0;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .delete-button:hover {
            background: #ffffff;
            color: #000000;
        }
        
        .edit-button {
            background: #ffffff;
            color: #000000;
            border: 2px solid #000000;
            border-radius: 0;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .edit-button:hover {
            background: #000000;
            color: #ffffff;
        }

        .project-name {
            font-size: 1.3rem;
            font-weight: bold;
            color: #000000;
        }

        .amount {
            font-size: 1.4rem;
            font-weight: bold;
            color: #000000;
        }

        .expense-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 10px;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .detail-label {
            font-weight: 600;
            color: #4a5568;
        }

        .detail-value {
            color: #2d3748;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .status-pending {
            background: #fed7d7;
            color: #c53030;
        }

        .status-paid {
            background: #c6f6d5;
            color: #2f855a;
        }

        .loading {
            text-align: center;
            color: #666;
            font-style: italic;
        }

        .error {
            color: #e53e3e;
            background: #fed7d7;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .success {
            color: #2f855a;
            background: #c6f6d5;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .feature-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }

        .feature-card:hover {
            transform: translateY(-5px);
        }

        .feature-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .api-endpoint {
            background: #2d3748;
            color: #e2e8f0;
            padding: 8px 12px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            margin: 5px 0;
        }

        .project-summary {
            background: #e6fffa;
            border: 2px solid #38b2ac;
            border-radius: 0;
            padding: 20px;
            margin-bottom: 20px;
        }

        .project-summary-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #2c5282;
            margin-bottom: 15px;
            text-align: center;
        }

        .project-item {
            background: white;
            border-radius: 0;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #38b2ac;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .project-name-summary {
            font-weight: bold;
            color: #2d3748;
        }

        .project-stats {
            text-align: left;
            color: #4a5568;
        }

        .project-amount {
            font-size: 1.2rem;
            font-weight: bold;
            color: #38a169;
        }

        .filter-controls {
            background: #f7fafc;
            border-radius: 0;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #e2e8f0;
        }

        .filter-active {
            background: #bee3f8;
            border-color: #3182ce;
        }

        .tab-navigation {
            display: flex;
            background: #ffffff;
            border: 2px solid #000000;
            border-radius: 0;
            margin-bottom: 20px;
            overflow: hidden;
            box-shadow: none;
        }

        .tab-button {
            flex: 1;
            padding: 15px 20px;
            border: none;
            background: #ffffff;
            color: #000000;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .tab-button:hover {
            background: #000000;
            color: #ffffff;
        }

        .tab-button.active {
            background: #000000;
            color: #ffffff;
            font-weight: bold;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .projects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .project-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 5px solid #3182ce;
            position: relative;
        }

        .project-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .project-card.selected {
            border-left-color: #e53e3e;
            background: #fef5e7;
        }

        .project-title {
            font-size: 1.4rem;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 10px;
        }

        .project-amount-large {
            font-size: 2rem;
            font-weight: bold;
            color: #38a169;
            margin-bottom: 15px;
        }

        .project-stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 10px;
            background: #f7fafc;
            border-radius: 0;
        }

        .stat-number {
            font-size: 1.3rem;
            font-weight: bold;
            color: #3182ce;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #718096;
            margin-top: 5px;
        }

        .project-details-view {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .back-button {
            background: #ffffff;
            color: #000000;
            border: 2px solid #000000;
            padding: 10px 20px;
            border-radius: 0;
            cursor: pointer;
            font-size: 1rem;
            margin-bottom: 20px;
            transition: all 0.2s ease;
            font-weight: bold;
        }

        .back-button:hover {
            background: #000000;
            color: #ffffff;
        }

        .project-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }

        .expense-list-detailed {
            margin-top: 20px;
        }

        .add-expense-button {
            background: #000000;
            color: #ffffff;
            border: 2px solid #ffffff;
            padding: 12px 24px;
            border-radius: 0;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            margin-bottom: 20px;
            transition: all 0.2s ease;
            box-shadow: none;
        }

        .add-expense-button:hover {
            background: #ffffff;
            color: #000000;
            transform: none;
            box-shadow: none;
        }


        .form-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }

        .form-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2d3748;
        }

        .close-form {
            background: #e53e3e;
            color: white;
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
            width: 100%;
            box-sizing: border-box;
            overflow: hidden;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            width: 100%;
            box-sizing: border-box;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-label {
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .form-input, .form-select, .form-textarea {
            padding: 12px;
            border: 2px solid #000000;
            border-radius: 0;
            font-size: 1rem;
            transition: border-color 0.3s ease;
            direction: rtl;
            width: 100%;
            box-sizing: border-box;
            max-width: 100%;
            overflow: hidden;
            background: #ffffff;
            color: #000000;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #3182ce;
            box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-start;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #e2e8f0;
        }

        .form-submit {
            background: #000000;
            color: #ffffff;
            border: 2px solid #ffffff;
            padding: 12px 30px;
            border-radius: 0;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .form-submit:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(49, 130, 206, 0.4);
        }

        .form-cancel {
            background: #718096;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 0;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.3s ease;
        }

        .form-cancel:hover {
            background: #4a5568;
        }

        .success-message {
            background: #c6f6d5;
            color: #2f855a;
            padding: 15px;
            border-radius: 0;
            margin-bottom: 20px;
            border-left: 4px solid #38a169;
        }

        .error-message {
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 0;
            margin-bottom: 20px;
            border-left: 4px solid #e53e3e;
        }

        .add-project-button {
            background: #000000;
            color: #ffffff;
            border: 2px solid #ffffff;
            padding: 12px 24px;
            border-radius: 0;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(128, 90, 213, 0.3);
        }

        .add-project-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(128, 90, 213, 0.4);
        }

        .project-form-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .project-form-container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .dropdown-with-add {
            position: relative;
        }

        .project-selector {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .project-dropdown-container {
            flex: 1;
        }

        .add-project-inline {
            background: #805ad5;
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 0;
            cursor: pointer;
            font-size: 0.9rem;
            white-space: nowrap;
            transition: background 0.3s ease;
        }

        .add-project-inline:hover {
            background: #6b46c1;
        }

        .add-contractor-button {
            background: #000000;
            color: #ffffff;
            border: 2px solid #ffffff;
            padding: 12px 24px;
            border-radius: 0;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(128, 90, 213, 0.3);
        }

        .add-contractor-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(128, 90, 213, 0.4);
        }

        .contractor-selector {
            width: 100%;
        }

        .contractor-dropdown-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .contractor-dropdown-container select {
            flex: 1;
        }

        .new-project-button,
        .new-contractor-button {
            background: #000000;
            color: #ffffff;
            border: 2px solid #ffffff;
            padding: 8px 16px;
            border-radius: 0;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(128, 90, 213, 0.3);
            white-space: nowrap;
        }

        .new-project-button:hover,
        .new-contractor-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(128, 90, 213, 0.4);
        }

        .contractors-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .contractor-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 5px solid #ed8936;
            position: relative;
        }

        .contractor-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .contractor-name {
            font-size: 1.3rem;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 8px;
        }

        .contractor-phone {
            color: #718096;
            font-size: 0.95rem;
            margin-bottom: 15px;
        }

        .contractor-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .contractor-stat {
            text-align: center;
            padding: 8px;
            background: #faf5f0;
            border-radius: 0;
        }

        .contractor-stat-number {
            font-size: 1.1rem;
            font-weight: bold;
            color: #dd6b20;
        }

        .contractor-stat-label {
            font-size: 0.85rem;
            color: #9c4221;
            margin-top: 2px;
        }

        .contractor-details-view {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .contractor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }

        .contractor-form-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .contractor-form-container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .contractor-details-view {
            max-width: 800px;
            margin: 0 auto;
        }

        .contractor-details-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
        }

        .contractor-info h2 {
            margin: 0;
            color: #2d3748;
            font-size: 1.5rem;
        }

        .contractor-specialty-detail {
            color: #ed8936;
            font-weight: 600;
            margin-top: 5px;
        }

        .contractor-contact-info {
            background: #f7fafc;
            padding: 20px;
            border-radius: 0;
            margin-bottom: 30px;
        }

        .contact-item {
            margin-bottom: 10px;
            color: #4a5568;
        }

        .contact-item strong {
            color: #2d3748;
            margin-left: 10px;
        }

        .payments-summary {
            background: #edf2f7;
            padding: 20px;
            border-radius: 0;
            margin-bottom: 30px;
        }

        .payments-summary h3 {
            margin: 0 0 15px 0;
            color: #2d3748;
            font-size: 1.2rem;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 0;
            border-right: 4px solid #ed8936;
        }

        .summary-label {
            font-weight: 600;
            color: #4a5568;
        }

        .summary-value {
            font-weight: bold;
            color: #2d3748;
            font-size: 1.1rem;
        }

        .payments-list h3 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 1.2rem;
        }

        .payment-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 0;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .payment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e2e8f0;
        }

        .payment-project {
            font-weight: 600;
            color: #2d3748;
            font-size: 1.1rem;
        }

        .payment-amount {
            font-weight: bold;
            color: #38a169;
            font-size: 1.2rem;
        }

        .payment-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .payment-detail {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
        }

        .payment-detail .detail-label {
            font-weight: 600;
            color: #4a5568;
        }

        .payment-detail .detail-value {
            color: #2d3748;
        }

        .status-paid {
            color: #38a169 !important;
            font-weight: bold;
        }

        .status-pending {
            color: #ed8936 !important;
            font-weight: bold;
        }

        .no-payments {
            text-align: center;
            color: #a0aec0;
            font-style: italic;
            padding: 40px;
            background: #f7fafc;
            border-radius: 0;
        }

        .no-data {
            text-align: center;
            color: #a0aec0;
            font-style: italic;
            padding: 40px;
            background: #f7fafc;
            border-radius: 0;
        }

        /* File Upload Styles */
        .file-upload-container {
            margin-top: 8px;
        }

        .file-input {
            display: none;
        }

        .file-upload-button {
            display: inline-block;
            background: #000000;
            color: #ffffff;
            padding: 12px 20px;
            border-radius: 0;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            text-align: center;
            min-width: 180px;
            box-shadow: 0 2px 10px rgba(66, 153, 225, 0.3);
        }

        .file-upload-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(66, 153, 225, 0.4);
            background: linear-gradient(135deg, #3182ce 0%, #2c5282 100%);
        }

        .file-upload-button.has-file {
            background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);
            box-shadow: 0 2px 10px rgba(56, 161, 105, 0.3);
        }

        .file-upload-button.has-file:hover {
            box-shadow: 0 4px 15px rgba(56, 161, 105, 0.4);
        }

        .upload-text {
            display: block;
        }

        .image-preview {
            margin-top: 15px;
            text-align: center;
        }

        .image-preview img {
            max-width: 200px;
            max-height: 150px;
            border-radius: 0;
            border: 2px solid #e2e8f0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            object-fit: cover;
        }

        .image-preview .remove-image {
            display: block;
            margin-top: 10px;
            background: #e53e3e;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .image-preview .remove-image:hover {
            background: #c53030;
            transform: translateY(-1px);
        }

        .file-name {
            color: #4a5568;
            font-size: 0.9rem;
            margin-top: 8px;
            padding: 8px 12px;
            background: #f7fafc;
            border-radius: 4px;
            border: 1px solid #e2e8f0;
        }

        /* Image Modal Styles */
        .image-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .image-modal-content {
            position: relative;
            max-width: 90%;
            max-height: 90%;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
        }

        .close-modal {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            font-size: 2rem;
            color: #666;
            cursor: pointer;
            z-index: 2001;
        }

        .close-modal:hover {
            color: #333;
        }

        .image-modal img {
            max-width: 100%;
            max-height: 70vh;
            border-radius: 0;
            object-fit: contain;
        }

        .modal-image-name {
            text-align: center;
            margin-top: 15px;
            font-weight: 600;
            color: #4a5568;
        }

        /* Contractor Expenses Modal */
        .contractor-expenses-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .contractor-expenses-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            position: relative;
        }

        .contractor-modal-header {
            background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
            color: white;
            padding: 20px;
            border-radius: 15px 15px 0 0;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .contractor-modal-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .contractor-modal-subtitle {
            font-size: 1rem;
            opacity: 0.9;
        }

        .modal-close-btn {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 1.5rem;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }

        .modal-close-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .contractor-modal-body {
            padding: 25px;
        }

        .contractor-summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 0;
        }

        .stat-card {
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 0;
            border: 2px solid #ed8936;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #ed8936;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
        }

        .expenses-section-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 20px;
            border-bottom: 2px solid #ed8936;
            padding-bottom: 10px;
        }

        .expense-item {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 0;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .expense-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .expense-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .expense-project {
            font-size: 1.1rem;
            font-weight: bold;
            color: #2d3748;
        }

        .expense-amount {
            font-size: 1.2rem;
            font-weight: bold;
            color: #ed8936;
        }

        .expense-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .expense-detail {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
        }

        .detail-label {
            font-weight: 600;
            color: #4a5568;
        }

        .detail-value {
            color: #2d3748;
        }

        .status-paid {
            color: #38a169;
            font-weight: bold;
        }

        .status-pending {
            color: #ed8936;
            font-weight: bold;
        }

        .no-expenses-message {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 1.1rem;
        }

        /* Add Expense Tab Styles */
        .expense-form-tab {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .form-grid-tab {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .form-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 0;
            border: 1px solid #e2e8f0;
        }

        .section-title {
            color: #2d3748;
            font-size: 1.2rem;
            font-weight: 600;
            margin: 0 0 10px 0;
            border-bottom: 2px solid #4299e1;
            padding-bottom: 8px;
        }

        .section-description {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 20px;
        }

        .form-message {
            margin-bottom: 20px;
            padding: 12px;
            border-radius: 0;
            text-align: center;
            font-weight: 600;
        }

        .form-message.success {
            background: #c6f6d5;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }

        .form-message.error {
            background: #fed7d7;
            color: #c53030;
            border: 1px solid #feb2b2;
        }

        .form-actions-tab {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #e2e8f0;
        }

        .form-submit-tab {
            background: #000000;
            color: #ffffff;
            border: 2px solid #ffffff;
            padding: 15px 30px;
            border-radius: 0;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(56, 161, 105, 0.3);
        }

        .form-submit-tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(56, 161, 105, 0.4);
        }

        .form-reset-tab {
            background: linear-gradient(135deg, #a0aec0 0%, #718096 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 0;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(160, 174, 192, 0.3);
        }

        .form-reset-tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(160, 174, 192, 0.4);
        }

        /* Signature Canvas Styles */
        .signature-container {
            text-align: center;
        }

        #signatureCanvas {
            border: 2px solid #e2e8f0;
            border-radius: 0;
            cursor: crosshair;
            background: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            max-width: 100%;
            height: auto;
        }

        .signature-controls {
            margin-top: 15px;
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .signature-button {
            padding: 10px 20px;
            border: none;
            border-radius: 0;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .clear-signature {
            background: #fed7d7;
            color: #c53030;
        }

        .clear-signature:hover {
            background: #feb2b2;
            transform: translateY(-1px);
        }

        .save-signature {
            background: #c6f6d5;
            color: #22543d;
        }

        .save-signature:hover {
            background: #9ae6b4;
            transform: translateY(-1px);
        }

        .signature-preview-container {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 0;
            border: 1px solid #e2e8f0;
        }

        .signature-label {
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 10px;
        }

        .signature-preview-image {
            max-width: 300px;
            max-height: 100px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header {
                padding: 10px 100px 10px 10px;
            }
            
            .header h1 {
                font-size: 1.6rem;
                margin-top: 10px;
                line-height: 1.2;
            }
            
            .header p {
                font-size: 0.9rem;
                line-height: 1.3;
            }
            
            .form-input, .form-select, .form-textarea {
                font-size: 0.9rem;
                padding: 8px;
                width: 100% !important;
                max-width: calc(100vw - 60px) !important;
                min-width: 0;
                box-sizing: border-box;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
                gap: 10px;
                width: 100%;
                max-width: calc(100vw - 40px);
                box-sizing: border-box;
                padding: 0;
            }
            
            .form-group {
                width: 100%;
                max-width: 100%;
                min-width: 0;
                margin-bottom: 15px;
                box-sizing: border-box;
            }
            
            .expense-form-container, .project-form-container, .contractor-form-container {
                width: 95vw;
                max-width: 95vw;
                margin: 0 auto;
                box-sizing: border-box;
            }
            
            .modal-content {
                width: 95% !important;
                max-width: 95% !important;
                padding: 15px;
                box-sizing: border-box;
            }
            
            .tab-navigation {
                flex-wrap: wrap;
            }
            
            .tab-button {
                flex: 1;
                min-width: 50%;
                font-size: 0.9rem;
                padding: 12px 10px;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .project-selector {
                flex-direction: column;
                align-items: stretch;
            }
            
            .expense-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .project-name {
                font-size: 1.1rem;
            }
            
            .amount {
                font-size: 1.2rem;
            }
            
            .expense-details {
                grid-template-columns: 1fr;
            }
            
            .projects-grid {
                grid-template-columns: 1fr;
            }
            
            .project-stats-grid {
                grid-template-columns: 1fr;
            }
            
            .project-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .form-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .contractor-grid {
                grid-template-columns: 1fr;
            }
            
            .contractor-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .status-panel {
                padding: 15px;
            }
            
            .signature-canvas {
                width: 100%;
                max-width: 300px;
            }
            
            .file-upload-area {
                padding: 20px;
            }
            
            .project-amount-large {
                font-size: 1.5rem;
            }
            
            .project-form-container, 
            .contractor-form-container {
                width: 95vw !important;
                max-width: 95vw !important;
                margin: 5px auto;
                padding: 15px;
                box-sizing: border-box;
            }
            
            .project-form-modal,
            .contractor-form-modal {
                padding: 10px;
                box-sizing: border-box;
            }
            
            body {
                overflow-x: hidden;
            }
            
            .container {
                max-width: 100vw;
                overflow-x: hidden;
            }
            
            .expense-form-tab {
                max-width: 100% !important;
                width: 100% !important;
                padding: 15px;
                box-sizing: border-box;
            }
            
            .form-grid-tab {
                grid-template-columns: 1fr !important;
                gap: 10px;
                width: 100%;
                box-sizing: border-box;
            }
            
            .demo-section {
                padding: 15px;
                margin: 10px 0;
            }
        }

        /* Works Styles */
        .add-work-button {
            background: #000000;
            color: #ffffff;
            border: 2px solid #ffffff;
            padding: 12px 24px;
            border-radius: 0;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(72, 187, 120, 0.3);
        }
        .add-work-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(72, 187, 120, 0.4);
        }
        .works-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .work-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 5px solid #667eea;
            position: relative;
        }
        .work-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }
        .work-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        .work-name {
            font-size: 1.3rem;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 5px;
        }
        .work-project {
            color: #667eea;
            font-size: 0.9rem;
            font-weight: 600;
        }
        .work-contractor {
            color: #718096;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }
        .work-cost {
            font-size: 1.2rem;
            font-weight: bold;
            color: #38a169;
        }
        .work-progress {
            margin-top: 15px;
        }
        .work-progress-bar {
            background: #e2e8f0;
            border-radius: 0;
            height: 8px;
            overflow: hidden;
        }
        .work-progress-fill {
            background: linear-gradient(90deg, #48bb78, #38a169);
            height: 100%;
            border-radius: 0;
            transition: width 0.3s ease;
        }
        .work-progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: #718096;
            margin-top: 5px;
        }
        .work-description {
            color: #4a5568;
            font-size: 0.9rem;
            margin-top: 10px;
            line-height: 1.4;
        }

        /* Works Form Modal */
        .works-form-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .works-form-container {
            background: #ffffff;
            border: 2px solid #000000;
            border-radius: 0;
            box-shadow: none;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        /* Work Details Modal */
        .work-details-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .work-details-content {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 800px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        .work-modal-header {
            background: #000000;
            color: #ffffff;
            padding: 25px 30px;
            border-radius: 0;
            position: relative;
            border: 2px solid #ffffff;
            border-bottom: none;
        }
        .work-modal-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .work-modal-subtitle {
            font-size: 1rem;
            opacity: 0.9;
        }
        .work-modal-body {
            padding: 30px;
            background: #ffffff;
            color: #000000;
            border: 2px solid #ffffff;
            border-top: none;
        }
        .work-summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .work-stat-card {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .work-stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 5px;
        }
        .work-stat-label {
            font-size: 0.9rem;
            color: #718096;
        }
        .work-progress-section {
            background: #f7fafc;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
        }
        .work-progress-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 15px;
        }
        .work-progress-bar-large {
            background: #e2e8f0;
            border-radius: 15px;
            height: 20px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        .work-progress-fill-large {
            background: linear-gradient(90deg, #48bb78, #38a169);
            height: 100%;
            border-radius: 15px;
            transition: width 0.5s ease;
            position: relative;
        }
        .work-progress-text-large {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: #4a5568;
            font-weight: 500;
        }
        .work-expenses-section {
            margin-top: 25px;
        }
        .work-expenses-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
        }
        
        /* Authentication Styles */
        #authContainer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        
        .auth-modal {
            background: white;
            padding: 40px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .auth-modal h2 {
            margin-bottom: 30px;
            color: #2d3748;
        }
        
        .auth-button {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .auth-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(66, 153, 225, 0.4);
        }
        
        .user-bar {
            background: #f7fafc;
            padding: 10px 20px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logout-btn {
            background: #e53e3e;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .logout-btn:hover {
            background: #c53030;
        }
    </style>
</head>
<body>
    <!-- Authentication Container -->
    <div id="authContainer" style="display: flex;">
        <div class="auth-modal">
            <h2>מערכת מעקב הוצאות בניה</h2>
            
            <!-- Auth Tabs -->
            <div class="auth-tabs" style="display: flex; margin-bottom: 20px; border-bottom: 2px solid #e2e8f0;">
                <button onclick="showLoginTab()" class="auth-tab-button active" id="loginTab" style="flex: 1; padding: 12px; background: #000; color: #fff; border: none; cursor: pointer; font-size: 16px; font-weight: bold;">התחברות</button>
                <button onclick="showRegisterCompanyTab()" class="auth-tab-button" id="registerCompanyTab" style="flex: 1; padding: 12px; background: #f7fafc; color: #4a5568; border: none; cursor: pointer; font-size: 16px; font-weight: bold;">הרשמת חברה</button>
                <button onclick="showInvitationTab()" class="auth-tab-button" id="invitationTab" style="flex: 1; padding: 12px; background: #f7fafc; color: #4a5568; border: none; cursor: pointer; font-size: 16px; font-weight: bold;">הרשמה בהזמנה</button>
            </div>
            
            <!-- Login Form -->
            <div id="loginForm">
                <div style="margin-bottom: 15px;">
                    <input type="email" id="loginEmail" placeholder="כתובת אימייל" style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 16px; direction: ltr;" required>
                </div>
                <div style="margin-bottom: 15px;">
                    <input type="password" id="loginPassword" placeholder="סיסמה" style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 16px; direction: ltr;" required>
                </div>
                <button onclick="signIn()" class="auth-button" id="loginButton">התחבר</button>
                <div id="authMessage" style="margin-top: 15px; color: #e53e3e; font-size: 14px;"></div>
            </div>
            
            <!-- Registration Form -->
            <div id="registerForm" style="display: none;">
                <div style="margin-bottom: 15px;">
                    <input type="text" id="registerName" placeholder="שם מלא" style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 16px;" required>
                </div>
                <div style="margin-bottom: 15px;">
                    <input type="email" id="registerEmail" placeholder="כתובת אימייל" style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 16px; direction: ltr;" required>
                </div>
                <div style="margin-bottom: 15px;">
                    <input type="password" id="registerPassword" placeholder="סיסמה (לפחות 8 תווים)" style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 16px; direction: ltr;" required>
                </div>
                <div style="margin-bottom: 15px;">
                    <input type="password" id="registerConfirmPassword" placeholder="אישור סיסמה" style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 16px; direction: ltr;" required>
                </div>
                <div style="margin-bottom: 15px;">
                    <input type="tel" id="registerPhone" placeholder="מספר טלפון (אופציונלי)" style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 16px; direction: ltr;">
                </div>
                <button onclick="signUp()" class="auth-button" id="registerButton">הירשם</button>
                <div id="registerMessage" style="margin-top: 15px; color: #e53e3e; font-size: 14px;"></div>
            </div>
            
            <!-- Email Verification Form -->
            <div id="verificationForm" style="display: none;">
                <p style="margin-bottom: 15px; color: #718096; text-align: center;">נשלח קוד אימות לאימייל שלך</p>
                <div style="margin-bottom: 15px;">
                    <input type="text" id="verificationCode" placeholder="קוד אימות" style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 16px; direction: ltr; text-align: center;" required>
                </div>
                <button onclick="confirmSignUp()" class="auth-button" id="verifyButton">אמת קוד</button>
                <button onclick="resendConfirmationCode()" style="background: #f7fafc; color: #4a5568; border: 1px solid #e2e8f0; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px; margin-top: 10px; width: 100%;">שלח קוד מחדש</button>
                <div id="verificationMessage" style="margin-top: 15px; color: #e53e3e; font-size: 14px;"></div>
            </div>
            
            <!-- Company Registration Form -->
            <div id="registerCompanyForm" style="display: none;">
                <h3 style="margin-bottom: 20px; text-align: center; color: #2d3748;">הרשמת חברה חדשה</h3>
                
                <!-- Company Details -->
                <div style="background: #f7fafc; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px; color: #4a5568;">פרטי החברה</h4>
                    <div style="margin-bottom: 15px;">
                        <input type="text" id="companyName" placeholder="שם החברה" style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 16px;" required>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <input type="text" id="companyIndustry" placeholder="תחום עסקים (אופציונלי)" style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 16px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <textarea id="companyDescription" placeholder="תיאור החברה (אופציונלי)" style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 16px; min-height: 80px; resize: vertical;"></textarea>
                    </div>
                </div>
                
                <!-- Admin User Details -->
                <div style="background: #e6fffa; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px; color: #4a5568;">פרטי המנהל הראשי</h4>
                    <div style="margin-bottom: 15px;">
                        <input type="text" id="adminName" placeholder="שם מלא של המנהל" style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 16px;" required>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <input type="email" id="adminEmail" placeholder="כתובת אימייל של המנהל" style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 16px; direction: ltr;" required>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <input type="password" id="adminPassword" placeholder="סיסמה (לפחות 8 תווים)" style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 16px; direction: ltr;" required>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <input type="password" id="adminConfirmPassword" placeholder="אישור סיסמה" style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 16px; direction: ltr;" required>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <input type="tel" id="adminPhone" placeholder="מספר טלפון (אופציונלי)" style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 16px; direction: ltr;">
                    </div>
                </div>
                
                <button onclick="registerCompany()" class="auth-button" id="registerCompanyButton">צור חברה</button>
                <div id="companyRegisterMessage" style="margin-top: 15px; color: #e53e3e; font-size: 14px;"></div>
            </div>
            
            <!-- Invitation Registration Form -->
            <div id="invitationForm" style="display: none;">
                <h3 style="margin-bottom: 20px; text-align: center; color: #2d3748;">הרשמה בהזמנה</h3>
                
                <div style="background: #fef5e7; padding: 15px; border-radius: 6px; margin-bottom: 20px; border: 1px solid #f6ad55;">
                    <p style="margin-bottom: 10px; color: #7b341e;">📧 יש לך הזמנה להצטרף לחברה?</p>
                    <p style="font-size: 14px; color: #744210;">הכנס את קוד ההזמנה שקיבלת באימייל כדי להירשם</p>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <input type="text" id="invitationToken" placeholder="קוד הזמנה" style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 16px; direction: ltr; text-align: center;" required>
                </div>
                
                <div id="invitationDetails" style="display: none; background: #f0fff4; padding: 15px; border-radius: 6px; margin-bottom: 20px; border: 1px solid #68d391;">
                    <h4 style="margin-bottom: 10px; color: #2f855a;">פרטי ההזמנה</h4>
                    <p id="invitationCompany" style="margin-bottom: 5px;"></p>
                    <p id="invitationRole" style="margin-bottom: 15px; font-size: 14px; color: #38a169;"></p>
                </div>
                
                <div id="invitationUserForm" style="display: none;">
                    <div style="margin-bottom: 15px;">
                        <input type="text" id="invitationName" placeholder="שם מלא" style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 16px;" required>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <input type="password" id="invitationPassword" placeholder="צור סיסמה (לפחות 8 תווים)" style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 16px; direction: ltr;" required>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <input type="password" id="invitationConfirmPassword" placeholder="אישור סיסמה" style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 16px; direction: ltr;" required>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <input type="tel" id="invitationPhone" placeholder="מספר טלפון (אופציונלי)" style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 16px; direction: ltr;">
                    </div>
                    
                    <button onclick="acceptInvitation()" class="auth-button" id="acceptInvitationButton">השלם הרשמה</button>
                </div>
                
                <button onclick="validateInvitation()" class="auth-button" id="validateInvitationButton">בדוק הזמנה</button>
                
                <div id="invitationMessage" style="margin-top: 15px; color: #e53e3e; font-size: 14px;"></div>
            </div>
            
            <!-- New Password Form (for temporary passwords) -->
            <div id="newPasswordForm" style="display: none;">
                <p style="margin-bottom: 15px; color: #718096;">נדרש לעדכן סיסמה</p>
                <div style="margin-bottom: 15px;">
                    <input type="password" id="newPassword" placeholder="סיסמה חדשה" style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 16px; direction: ltr;" required>
                </div>
                <div style="margin-bottom: 15px;">
                    <input type="password" id="confirmPassword" placeholder="אישור סיסמה" style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 16px; direction: ltr;" required>
                </div>
                <button onclick="setNewPassword()" class="auth-button" id="newPasswordButton">עדכן סיסמה</button>
            </div>
        </div>
    </div>

    <!-- User Info Bar -->
    <div id="userInfo" style="display: none;">
        <div class="user-bar">
            <span id="userName">שלום, משתמש</span>
            <button onclick="signOut()" class="logout-btn">התנתק</button>
        </div>
    </div>

    <div class="container" id="mainContent">
        <div class="header">
            <img src="Yankale_logo.jpg" alt="Yankale Logo" class="company-logo">
            <h1>מערכת מעקב הוצאות בניה</h1>
            <p>ינקלה יזמות ובניה, פותח על ידי מאור דניאל</p>
        </div>

        <div class="status-panel">
            <div class="tab-navigation">
                <button class="tab-button active" data-tab="expenses">רשימת הוצאות</button>
                <button class="tab-button" data-tab="addExpense">הוספת הוצאה</button>
                <button class="tab-button" data-tab="projects">פרויקטים</button>
                <button class="tab-button" data-tab="contractors">קבלנים/ספקים</button>
                <button class="tab-button" data-tab="works">עבודות</button>
            </div>

            <!-- Expenses Tab -->
            <div id="expensesTab" class="tab-content active">
                <div class="demo-section">
                    <div class="demo-title">רשימת הוצאות</div>
                    <p>המערכת מכילה 3 הוצאות בנייה לדוגמה:</p>
                    
                    <button class="add-expense-button" data-tab="addExpense">הוספת הוצאה חדשה</button>
                    
                    <div class="filter-controls" id="filterControls">
                        <label for="projectFilter" style="font-weight: bold; margin-left: 10px;">סינון לפי פרויקט:</label>
                        <select id="projectFilter" onchange="filterByProject()" style="padding: 8px 12px; border-radius: 5px; border: 1px solid #ccc; margin-right: 10px;">
                            <option value="">כל הפרויקטים</option>
                        </select>
                        
                        <button onclick="resetFilter()" style="background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                            איפוס סינון
                        </button>
                    </div>
                    
                    <div id="expensesList" class="loading">טוען הוצאות...</div>
                </div>
            </div>

            <!-- Add Expense Tab -->
            <div id="addExpenseTab" class="tab-content">
                <div class="demo-section">
                    <div class="demo-title">הוספת הוצאה חדשה</div>
                    <p>מלא את כל הפרטים הנדרשים להוספת הוצאה חדשה:</p>
                    
                    <div id="addExpenseMessage" class="form-message"></div>
                    
                    <form id="newExpenseForm" class="expense-form-tab" onsubmit="submitNewExpense(event)">
                        <div class="form-grid-tab">
                            <div class="form-group">
                                <label class="form-label" for="newProjectName">שם הפרויקט *</label>
                                <div class="project-selector">
                                    <div class="project-dropdown-container">
                                        <select id="newProjectName" class="form-select" required>
                                            <option value="">בחר פרויקט</option>
                                        </select>
                                        <button type="button" class="new-project-button" onclick="openProjectForm(); isExpenseFormWaitingForProject = true;">פרויקט חדש</button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="newContractorName">שם הקבלן/ספק *</label>
                                <div class="contractor-selector">
                                    <div class="contractor-dropdown-container">
                                        <select id="newContractorName" class="form-select" required>
                                            <option value="">בחר קבלן/ספק</option>
                                        </select>
                                        <button type="button" class="new-contractor-button" onclick="switchTab('contractors'); setTimeout(() => { openContractorForm(); }, 100);">קבלן/ספק חדש</button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="newWorkName">עבודה קשורה (אופציונלי)</label>
                                <div class="work-selector">
                                    <select id="newWorkName" class="form-select">
                                        <option value="">בחר עבודה (אופציונלי)</option>
                                    </select>
                                </div>
                                <small class="form-help-text">בחר עבודה אם ההוצאה קשורה לעבודה ספציפית</small>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="newInvoiceNumber">מספר חשבונית *</label>
                                <input type="text" id="newInvoiceNumber" class="form-input" required 
                                       placeholder="לדוגמה: INV-001">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="newExpenseAmount">סכום *</label>
                                <input type="number" id="newExpenseAmount" class="form-input" required min="0" step="0.01"
                                       placeholder="לדוגמה: 25000">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="newPaymentTerms">תנאי תשלום *</label>
                                <input type="text" id="newPaymentTerms" class="form-input" required 
                                       placeholder="לדוגמה: 30 ימים">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="newPaymentMethod">אמצעי תשלום *</label>
                                <select id="newPaymentMethod" class="form-select" required>
                                    <option value="">בחר אמצעי תשלום</option>
                                    <option value="העברה בנקאית">העברה בנקאית</option>
                                    <option value="המחאה">המחאה</option>
                                    <option value="מזומן">מזומן</option>
                                    <option value="אשראי">כרטיס אשראי</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="newExpenseDate">תאריך *</label>
                                <input type="date" id="newExpenseDate" class="form-input" required>
                            </div>
                            
                        </div>
                        
                        <!-- File Upload Section -->
                        <div class="form-section">
                            <h3 class="section-title">קבצים מצורפים</h3>
                            
                            <div class="form-group full-width">
                                <label class="form-label" for="newReceiptImage">תמונת קבלה</label>
                                <div class="file-upload-container">
                                    <input type="file" id="newReceiptImage" class="file-input" accept="image/*" onchange="previewImage('newReceiptImage', 'newReceiptPreview')">
                                    <label for="newReceiptImage" class="file-upload-button">
                                        <span class="upload-text">העלה תמונת קבלה</span>
                                    </label>
                                    <div id="newReceiptPreview" class="image-preview"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Signature Section -->
                        <div class="form-section">
                            <h3 class="section-title">חתימת הקבלן/ספק</h3>
                            <p class="section-description">הקבלן/ספק יכול לחתום כאן לאישור קבלת התשלום</p>
                            
                            <div class="signature-container">
                                <canvas id="signatureCanvas" width="600" height="200"></canvas>
                                <div class="signature-controls">
                                    <button type="button" class="signature-button clear-signature" onclick="clearSignature()">נקה חתימה</button>
                                    <button type="button" class="signature-button save-signature" onclick="saveSignature()">שמור חתימה</button>
                                </div>
                                <div id="signaturePreviewContainer" class="signature-preview-container" style="display: none;">
                                    <div class="signature-label">חתימה שמורה:</div>
                                    <img id="signaturePreview" class="signature-preview-image" alt="חתימת קבלן/ספק">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Description Section -->
                        <div class="form-section">
                            <div class="form-group full-width">
                                <label class="form-label" for="newExpenseDescription">תיאור נוסף</label>
                                <textarea id="newExpenseDescription" class="form-textarea" 
                                          placeholder="תיאור מפורט של ההוצאה (אופציונלי)"></textarea>
                            </div>
                        </div>
                        
                        <div class="form-actions-tab">
                            <button type="submit" class="form-submit-tab">שמירת הוצאה</button>
                            <button type="button" class="form-reset-tab" onclick="resetExpenseForm()">איפוס טופס</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Projects Tab -->
            <div id="projectsTab" class="tab-content">
                <div class="demo-section">
                    <div class="demo-title">פרויקטים</div>
                    <p>לחץ על פרויקט לצפייה בפרטים מלאים:</p>
                    
                    <button class="add-project-button" onclick="openProjectForm()">יצירת פרויקט חדש</button>
                    
                    <div id="projectsGrid" class="projects-grid">
                        <!-- Projects will be populated here -->
                    </div>
                    
                    <div id="projectDetails" class="project-details-view" style="display: none;">
                        <!-- Project details will be shown here -->
                    </div>
                </div>
            </div>

            <!-- Contractors Tab -->
            <div id="contractorsTab" class="tab-content">
                <div class="demo-section">
                    <div class="demo-title">קבלנים/ספקים</div>
                    <p>לחץ על קבלן/ספק לצפייה בפרטים ותשלומים:</p>
                    
                    <button class="add-contractor-button" onclick="openContractorForm()">הוספת קבלן/ספק חדש</button>
                    
                    <div id="contractorsGrid" class="contractors-grid">
                        <!-- Contractors will be populated here -->
                    </div>
                    
                    <div id="contractorDetails" class="contractor-details-view" style="display: none;">
                        <!-- Contractor details will be shown here -->
                    </div>
                </div>
            </div>

            <!-- Works Tab -->
            <div id="worksTab" class="tab-content">
                <div class="demo-section">
                    <div class="demo-title">עבודות</div>
                    <p>לחץ על עבודה לצפייה בפרטים ותקציב:</p>
                    
                    <button class="add-work-button" onclick="openWorkForm()">הוספת עבודה חדשה</button>
                    
                    <div id="worksGrid" class="works-grid">
                        <!-- Works will be populated here -->
                    </div>
                    
                    <div id="workDetails" class="work-details-view" style="display: none;">
                        <!-- Work details will be shown here -->
                    </div>
                </div>
            </div>

        </div>

    </div>


    <!-- Project Form Modal -->
    <div id="projectFormModal" class="project-form-modal">
        <div class="project-form-container">
            <div class="form-header">
                <div class="form-title">יצירת פרויקט חדש</div>
                <button class="close-form" onclick="closeProjectForm()">×</button>
            </div>
            
            <div id="projectFormMessage"></div>
            
            <form id="projectForm" onsubmit="submitProject(event)">
                <div class="form-group">
                    <label class="form-label" for="projectNameInput">שם הפרויקט *</label>
                    <input type="text" id="projectNameInput" class="form-input" required 
                           placeholder="לדוגמה: בניין מגורים תל אביב">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="projectLocation">מיקום הפרויקט</label>
                    <input type="text" id="projectLocation" class="form-input" 
                           placeholder="לדוגמה: תל אביב, רחוב הרצל 10">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="projectBudget">תקציב משוער</label>
                    <input type="number" id="projectBudget" class="form-input" min="0" step="1000"
                           placeholder="לדוגמה: 1000000">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="projectStartDate">תאריך התחלה</label>
                    <input type="date" id="projectStartDate" class="form-input">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="projectStatus">סטטוס הפרויקט</label>
                    <select id="projectStatus" class="form-select">
                        <option value="planning">תכנון</option>
                        <option value="active" selected>פעיל</option>
                        <option value="on-hold">מושהה</option>
                        <option value="completed">הושלם</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="projectDescription">תיאור הפרויקט</label>
                    <textarea id="projectDescription" class="form-textarea" 
                              placeholder="תיאור מפורט של הפרויקט (אופציונלי)"></textarea>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="form-submit">יצירת פרויקט</button>
                    <button type="button" class="form-cancel" onclick="closeProjectForm()">ביטול</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Contractor Form Modal -->
    <div id="contractorFormModal" class="contractor-form-modal">
        <div class="contractor-form-container">
            <div class="form-header">
                <div class="form-title">הוספת קבלן/ספק חדש</div>
                <button class="close-form" onclick="closeContractorForm()">×</button>
            </div>
            
            <div id="contractorFormMessage"></div>
            
            <form id="contractorForm" onsubmit="submitContractor(event)">
                <div class="form-group">
                    <label class="form-label" for="contractorNameInput">שם הקבלן/ספק *</label>
                    <input type="text" id="contractorNameInput" class="form-input" required 
                           placeholder="לדוגמה: חברת בניה בע״מ">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="contractorPhone">מספר טלפון</label>
                    <input type="tel" id="contractorPhone" class="form-input" 
                           placeholder="לדוגמה: 050-1234567">
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="form-submit">שמירת קבלן/ספק</button>
                    <button type="button" class="form-cancel" onclick="closeContractorForm()">ביטול</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Image Modal -->
    <div id="imageModal" class="image-modal" onclick="closeImageModal()">
        <div class="image-modal-content" onclick="event.stopPropagation()">
            <button class="close-modal" onclick="closeImageModal()">×</button>
            <img id="modalImage" src="" alt="תצוגה מלאה">
            <div id="modalImageName" class="modal-image-name"></div>
        </div>
    </div>

    <!-- Works Form Modal -->
    <div id="worksFormModal" class="works-form-modal">
        <div class="works-form-container">
            <div class="form-header">
                <div class="form-title">הוספת עבודה חדשה</div>
                <button class="close-form" onclick="closeWorksForm()">×</button>
            </div>
            
            <div id="worksFormMessage"></div>
            
            <form id="worksForm" onsubmit="submitWork(event)">
                <div class="form-group">
                    <label class="form-label" for="workNameInput">שם העבודה *</label>
                    <input type="text" id="workNameInput" class="form-input" required 
                           placeholder="לדוגמה: עבודות חשמל קומה ראשונה">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="workProject">פרויקט *</label>
                    <select id="workProject" class="form-select" required>
                        <option value="">בחר פרויקט</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="workContractor">קבלן/ספק *</label>
                    <select id="workContractor" class="form-select" required>
                        <option value="">בחר קבלן/ספק</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="workCost">עלות מוסכמת *</label>
                    <input type="number" id="workCost" class="form-input" required 
                           placeholder="0.00" step="0.01" min="0">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="workPhone">מספר טלפון</label>
                    <input type="tel" id="workPhone" class="form-input" 
                           placeholder="לדוגמה: 050-1234567">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="workDescription">תיאור העבודה</label>
                    <textarea id="workDescription" class="form-textarea" rows="3"
                             placeholder="תיאור מפורט של העבודה הנדרשת..."></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="workContract">חוזה/מסמך (אופציונלי)</label>
                    <div class="file-upload-area">
                        <input type="file" id="workContract" accept="image/*,.pdf" onchange="previewWorkContract()">
                        <label for="workContract" class="upload-button">
                            <span class="upload-icon">📎</span>
                            <span class="upload-text">העלה חוזה או מסמך</span>
                        </label>
                        <div id="workContractPreview" class="file-preview"></div>
                    </div>
                </div>
                
                <div class="form-buttons">
                    <button type="submit" class="submit-button">הוסף עבודה</button>
                    <button type="button" class="cancel-button" onclick="closeWorksForm()">ביטול</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Work Details Modal -->
    <div id="workDetailsModal" class="work-details-modal" onclick="closeWorkDetailsModal()">
        <div class="work-details-content" onclick="event.stopPropagation()">
            <div class="work-modal-header">
                <button class="modal-close-btn" onclick="closeWorkDetailsModal()">×</button>
                <div class="work-modal-title" id="workModalTitle">פרטי עבודה</div>
                <div class="work-modal-subtitle" id="workModalSubtitle">מעקב תשלומים והתקדמות</div>
            </div>
            <div class="work-modal-body" id="workModalBody">
                <!-- Content will be dynamically generated -->
            </div>
        </div>
    </div>

    <!-- Contractor Expenses Modal -->
    <div id="contractorExpensesModal" class="contractor-expenses-modal" onclick="closeContractorExpensesModal()">
        <div class="contractor-expenses-content" onclick="event.stopPropagation()">
            <div class="contractor-modal-header">
                <button class="modal-close-btn" onclick="closeContractorExpensesModal()">×</button>
                <div class="contractor-modal-title" id="contractorModalTitle">פרטי קבלן/ספק</div>
                <div class="contractor-modal-subtitle" id="contractorModalSubtitle">רשימת הוצאות ותשלומים</div>
            </div>
            <div class="contractor-modal-body" id="contractorModalBody">
                <!-- Content will be dynamically generated -->
            </div>
        </div>
    </div>

    <script>
        // AWS Config for production - Multi-Table Architecture with New Authentication
        const AWS_CONFIG = {
            region: 'us-east-1',
            userPoolId: 'us-east-1_GvpeCqtAc',
            userPoolClientId: '1konm59fgcjf1tf4rhk16bobi1',
            apiEndpoint: 'https://2woj5i92td.execute-api.us-east-1.amazonaws.com/prod',
            cognitoDomain: 'construction-expenses-auth.auth.us-east-1.amazoncognito.com'
        };

        // Cognito Configuration
        const poolData = {
            UserPoolId: AWS_CONFIG.userPoolId,
            ClientId: AWS_CONFIG.userPoolClientId
        };
        const userPool = new AmazonCognitoIdentity.CognitoUserPool(poolData);
        
        // Authentication state
        let currentAuthToken = null;
        
        // Authentication Functions
        function checkAuthState() {
            console.log('Checking authentication state...');
            try {
                const currentUser = userPool.getCurrentUser();
                console.log('Current user:', currentUser);
                if (currentUser != null) {
                    currentUser.getSession((err, session) => {
                        console.log('Session error:', err);
                        console.log('Session:', session);
                        if (err || !session.isValid()) {
                            console.log('Session invalid, showing auth modal');
                            showAuthModal();
                            return;
                        }
                        // User is authenticated
                        console.log('User authenticated, showing main app');
                        currentAuthToken = session.getIdToken().getJwtToken();
                        showMainApp();
                        updateUserInfo(currentUser);
                    });
                } else {
                    console.log('No current user, showing auth modal');
                    showAuthModal();
                }
            } catch (error) {
                console.error('Error in checkAuthState:', error);
                showAuthModal();
            }
        }
        
        function signIn() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const loginButton = document.getElementById('loginButton');
            const authMessage = document.getElementById('authMessage');
            
            if (!email || !password) {
                authMessage.textContent = 'נא להזין אימייל וסיסמה';
                return;
            }
            
            // Disable button and show loading
            loginButton.textContent = 'מתחבר...';
            loginButton.disabled = true;
            authMessage.textContent = '';
            
            const authenticationDetails = new AmazonCognitoIdentity.AuthenticationDetails({
                Username: email,
                Password: password,
            });
            
            const userData = {
                Username: email,
                Pool: userPool,
            };
            
            const cognitoUser = new AmazonCognitoIdentity.CognitoUser(userData);
            
            cognitoUser.authenticateUser(authenticationDetails, {
                onSuccess: function (result) {
                    currentAuthToken = result.getIdToken().getJwtToken();
                    showMainApp();
                    updateUserInfo(cognitoUser);
                },
                onFailure: function (err) {
                    console.error('Authentication failed:', err);
                    authMessage.textContent = 'שגיאה בהתחברות: ' + (err.message || 'שם משתמש או סיסמה שגויים');
                    loginButton.textContent = 'התחבר';
                    loginButton.disabled = false;
                },
                newPasswordRequired: function (userAttributes, requiredAttributes) {
                    // User needs to set new password
                    document.getElementById('loginForm').style.display = 'none';
                    document.getElementById('newPasswordForm').style.display = 'block';
                    window.currentCognitoUser = cognitoUser;
                }
            });
        }
        
        function setNewPassword() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const newPasswordButton = document.getElementById('newPasswordButton');
            const authMessage = document.getElementById('authMessage');
            
            if (!newPassword || !confirmPassword) {
                authMessage.textContent = 'נא להזין סיסמה חדשה ואישורה';
                return;
            }
            
            if (newPassword !== confirmPassword) {
                authMessage.textContent = 'הסיסמאות אינן זהות';
                return;
            }
            
            if (newPassword.length < 8) {
                authMessage.textContent = 'הסיסמה חייבת להכיל לפחות 8 תווים';
                return;
            }
            
            newPasswordButton.textContent = 'מעדכן...';
            newPasswordButton.disabled = true;
            
            window.currentCognitoUser.completeNewPasswordChallenge(newPassword, {}, {
                onSuccess: function (result) {
                    currentAuthToken = result.getIdToken().getJwtToken();
                    showMainApp();
                    updateUserInfo(window.currentCognitoUser);
                },
                onFailure: function (err) {
                    console.error('Password update failed:', err);
                    authMessage.textContent = 'שגיאה בעדכון סיסמה: ' + err.message;
                    newPasswordButton.textContent = 'עדכן סיסמה';
                    newPasswordButton.disabled = false;
                }
            });
        }
        
        function signOut() {
            const currentUser = userPool.getCurrentUser();
            if (currentUser) {
                currentUser.signOut();
            }
            currentAuthToken = null;
            
            // Reset all forms
            resetAuthForms();
            showAuthModal();
        }
        
        // Tab switching functions
        function showLoginTab() {
            hideAllForms();
            document.getElementById('loginForm').style.display = 'block';
            
            setActiveTab('loginTab');
            clearMessages();
        }
        
        function showRegisterCompanyTab() {
            hideAllForms();
            document.getElementById('registerCompanyForm').style.display = 'block';
            
            setActiveTab('registerCompanyTab');
            clearMessages();
        }
        
        function showInvitationTab() {
            hideAllForms();
            document.getElementById('invitationForm').style.display = 'block';
            
            setActiveTab('invitationTab');
            clearMessages();
            
            // Check for invitation token in URL
            const urlParams = new URLSearchParams(window.location.search);
            const invitationToken = urlParams.get('invitation');
            if (invitationToken) {
                document.getElementById('invitationToken').value = invitationToken;
                validateInvitation();
            }
        }
        
        function hideAllForms() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('verificationForm').style.display = 'none';
            document.getElementById('newPasswordForm').style.display = 'none';
            document.getElementById('registerCompanyForm').style.display = 'none';
            document.getElementById('invitationForm').style.display = 'none';
        }
        
        function setActiveTab(activeTabId) {
            const tabs = ['loginTab', 'registerCompanyTab', 'invitationTab'];
            
            tabs.forEach(tabId => {
                const tab = document.getElementById(tabId);
                if (tab) {
                    if (tabId === activeTabId) {
                        tab.classList.add('active');
                        tab.style.background = '#000';
                        tab.style.color = '#fff';
                    } else {
                        tab.classList.remove('active');
                        tab.style.background = '#f7fafc';
                        tab.style.color = '#4a5568';
                    }
                }
            });
        }
        
        // Registration functions
        let pendingUser = null;
        
        function signUp() {
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('registerConfirmPassword').value;
            const phone = document.getElementById('registerPhone').value;
            const registerButton = document.getElementById('registerButton');
            const registerMessage = document.getElementById('registerMessage');
            
            // Validation
            if (!name || !email || !password || !confirmPassword) {
                registerMessage.textContent = 'נא למלא את כל השדות הנדרשים';
                registerMessage.style.color = '#e53e3e';
                return;
            }
            
            if (password !== confirmPassword) {
                registerMessage.textContent = 'הסיסמאות אינן תואמות';
                registerMessage.style.color = '#e53e3e';
                return;
            }
            
            if (password.length < 8) {
                registerMessage.textContent = 'הסיסמה חייבת להכיל לפחות 8 תווים';
                registerMessage.style.color = '#e53e3e';
                return;
            }
            
            registerButton.textContent = 'נרשם...';
            registerButton.disabled = true;
            registerMessage.textContent = '';
            
            const attributeList = [
                new AmazonCognitoIdentity.CognitoUserAttribute({
                    Name: 'email',
                    Value: email
                }),
                new AmazonCognitoIdentity.CognitoUserAttribute({
                    Name: 'name',
                    Value: name
                })
            ];
            
            if (phone) {
                attributeList.push(new AmazonCognitoIdentity.CognitoUserAttribute({
                    Name: 'phone_number',
                    Value: phone
                }));
            }
            
            userPool.signUp(email, password, attributeList, null, function(err, result) {
                registerButton.textContent = 'הירשם';
                registerButton.disabled = false;
                
                if (err) {
                    console.error('Registration error:', err);
                    let errorMessage = 'שגיאה בהרשמה';
                    
                    if (err.code === 'UsernameExistsException') {
                        errorMessage = 'משתמש עם אימייל זה כבר קיים';
                    } else if (err.code === 'InvalidPasswordException') {
                        errorMessage = 'הסיסמה חייבת להכיל לפחות 8 תווים, אות גדולה, מספר וסימן מיוחד';
                    } else if (err.code === 'InvalidParameterException') {
                        errorMessage = 'פרטים לא תקינים - בדוק את הפורמט של האימייל';
                    } else if (err.message) {
                        errorMessage = err.message;
                    }
                    
                    registerMessage.textContent = errorMessage;
                    registerMessage.style.color = '#e53e3e';
                    return;
                }
                
                pendingUser = result.user;
                console.log('User registered successfully:', result.user.getUsername());
                
                // Show verification form
                document.getElementById('registerForm').style.display = 'none';
                document.getElementById('verificationForm').style.display = 'block';
                
                registerMessage.textContent = 'ההרשמה הושלמה! נשלח קוד אימות לאימייל שלך';
                registerMessage.style.color = '#38a169';
            });
        }
        
        function confirmSignUp() {
            const verificationCode = document.getElementById('verificationCode').value;
            const verifyButton = document.getElementById('verifyButton');
            const verificationMessage = document.getElementById('verificationMessage');
            
            if (!verificationCode) {
                verificationMessage.textContent = 'נא להזין קוד אימות';
                verificationMessage.style.color = '#e53e3e';
                return;
            }
            
            if (!pendingUser) {
                verificationMessage.textContent = 'שגיאה: לא נמצא משתמש להרשמה';
                verificationMessage.style.color = '#e53e3e';
                return;
            }
            
            verifyButton.textContent = 'מאמת...';
            verifyButton.disabled = true;
            
            pendingUser.confirmRegistration(verificationCode, true, function(err, result) {
                verifyButton.textContent = 'אמת קוד';
                verifyButton.disabled = false;
                
                if (err) {
                    console.error('Verification error:', err);
                    let errorMessage = 'קוד אימות שגוי';
                    
                    if (err.code === 'CodeMismatchException') {
                        errorMessage = 'קוד אימות שגוי';
                    } else if (err.code === 'ExpiredCodeException') {
                        errorMessage = 'קוד האימות פג תוקף - בקש קוד חדש';
                    } else if (err.message) {
                        errorMessage = err.message;
                    }
                    
                    verificationMessage.textContent = errorMessage;
                    verificationMessage.style.color = '#e53e3e';
                    return;
                }
                
                console.log('Email confirmed successfully');
                verificationMessage.textContent = 'האימייל אומת בהצלחה! כעת תוכל להתחבר';
                verificationMessage.style.color = '#38a169';
                
                // Auto-switch to login tab after successful verification
                setTimeout(() => {
                    showLoginTab();
                    document.getElementById('loginEmail').value = pendingUser.getUsername();
                    pendingUser = null;
                }, 2000);
            });
        }
        
        function resendConfirmationCode() {
            if (!pendingUser) {
                document.getElementById('verificationMessage').textContent = 'שגיאה: לא נמצא משתמש להרשמה';
                return;
            }
            
            pendingUser.resendConfirmationCode(function(err, result) {
                const verificationMessage = document.getElementById('verificationMessage');
                
                if (err) {
                    console.error('Resend error:', err);
                    verificationMessage.textContent = 'שגיאה בשליחת קוד מחדש';
                    verificationMessage.style.color = '#e53e3e';
                    return;
                }
                
                verificationMessage.textContent = 'קוד אימות חדש נשלח לאימייל שלך';
                verificationMessage.style.color = '#38a169';
            });
        }
        
        // Helper functions
        function resetAuthForms() {
            // Reset login form
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
            document.getElementById('loginButton').textContent = 'התחבר';
            document.getElementById('loginButton').disabled = false;
            
            // Reset registration form
            document.getElementById('registerName').value = '';
            document.getElementById('registerEmail').value = '';
            document.getElementById('registerPassword').value = '';
            document.getElementById('registerConfirmPassword').value = '';
            document.getElementById('registerPhone').value = '';
            document.getElementById('registerButton').textContent = 'הירשם';
            document.getElementById('registerButton').disabled = false;
            
            // Reset verification form
            document.getElementById('verificationCode').value = '';
            document.getElementById('verifyButton').textContent = 'אמת קוד';
            document.getElementById('verifyButton').disabled = false;
            
            // Reset new password form
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            document.getElementById('newPasswordButton').textContent = 'עדכן סיסמה';
            document.getElementById('newPasswordButton').disabled = false;
            
            // Clear messages
            clearMessages();
            
            // Show login tab by default
            showLoginTab();
        }
        
        function clearMessages() {
            document.getElementById('authMessage').textContent = '';
            document.getElementById('registerMessage').textContent = '';
            document.getElementById('verificationMessage').textContent = '';
        }
        
        function showAuthModal() {
            console.log('Showing auth modal');
            document.getElementById('authContainer').style.display = 'flex';
            document.getElementById('mainContent').style.display = 'none';
            const userInfo = document.getElementById('userInfo');
            if (userInfo) userInfo.style.display = 'none';
        }
        
        async function showMainApp() {
            console.log('Showing main app');
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            const userInfo = document.getElementById('userInfo');
            if (userInfo) userInfo.style.display = 'block';
            
            try {
                // Show loading indicator
                const expensesList = document.getElementById('expensesList');
                if (expensesList) {
                    expensesList.innerHTML = '<div class="loading">טוען נתונים...</div>';
                }
                
                // Load data after authentication is complete
                console.log('Loading company data...');
                await loadFromStorage();
                
                // Render UI with loaded data
                populateProjectFilter();
                populateNewExpenseProjectFilter();
                populateNewExpenseContractorFilter();
                populateNewExpenseWorkFilter();
                renderExpenses();
                renderProjectsGrid();
                
                // Initialize contractors if we're on that tab
                if (contractors.length === 0) {
                    initializeContractors();
                }
                
                console.log('App initialized successfully with company data');
            } catch (error) {
                console.error('Failed to initialize app:', error);
                // Try to render with whatever data we have
                populateProjectFilter();
                populateNewExpenseProjectFilter();
                populateNewExpenseContractorFilter();
                populateNewExpenseWorkFilter();
                renderExpenses();
                renderProjectsGrid();
            }
        }
        
        function updateUserInfo(user) {
            user.getUserAttributes((err, attributes) => {
                if (!err && attributes) {
                    const nameAttr = attributes.find(attr => attr.Name === 'name');
                    const emailAttr = attributes.find(attr => attr.Name === 'email');
                    const displayName = nameAttr ? nameAttr.Value : (emailAttr ? emailAttr.Value : 'משתמש');
                    document.getElementById('userName').textContent = `שלום, ${displayName}`;
                }
            });
        }
        
        // Company Registration Functions
        async function registerCompany() {
            const companyName = document.getElementById('companyName').value;
            const companyIndustry = document.getElementById('companyIndustry').value;
            const companyDescription = document.getElementById('companyDescription').value;
            const adminName = document.getElementById('adminName').value;
            const adminEmail = document.getElementById('adminEmail').value;
            const adminPassword = document.getElementById('adminPassword').value;
            const adminConfirmPassword = document.getElementById('adminConfirmPassword').value;
            const adminPhone = document.getElementById('adminPhone').value;
            
            const registerButton = document.getElementById('registerCompanyButton');
            const messageElement = document.getElementById('companyRegisterMessage');
            
            // Validation
            if (!companyName || !adminName || !adminEmail || !adminPassword) {
                messageElement.textContent = 'נא למלא את כל השדות הנדרשים';
                messageElement.style.color = '#e53e3e';
                return;
            }
            
            if (adminPassword !== adminConfirmPassword) {
                messageElement.textContent = 'הסיסמאות אינן תואמות';
                messageElement.style.color = '#e53e3e';
                return;
            }
            
            if (adminPassword.length < 8) {
                messageElement.textContent = 'הסיסמה חייבת להכיל לפחות 8 תווים';
                messageElement.style.color = '#e53e3e';
                return;
            }
            
            // Email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(adminEmail)) {
                messageElement.textContent = 'כתובת האימייל אינה תקינה';
                messageElement.style.color = '#e53e3e';
                return;
            }
            
            registerButton.textContent = 'יוצר חברה...';
            registerButton.disabled = true;
            messageElement.textContent = '';
            
            try {
                const response = await apiCall('registerCompany', 'POST', {
                    company: {
                        name: companyName,
                        industry: companyIndustry,
                        description: companyDescription
                    },
                    admin: {
                        name: adminName,
                        email: adminEmail,
                        password: adminPassword,
                        confirmPassword: adminConfirmPassword,
                        phone: adminPhone
                    }
                });
                
                if (response.success) {
                    messageElement.textContent = 'החברה נוצרה בהצלחה! כעת ניתן להתחבר';
                    messageElement.style.color = '#38a169';
                    
                    // Clear form
                    document.getElementById('companyName').value = '';
                    document.getElementById('companyIndustry').value = '';
                    document.getElementById('companyDescription').value = '';
                    document.getElementById('adminName').value = '';
                    document.getElementById('adminEmail').value = '';
                    document.getElementById('adminPassword').value = '';
                    document.getElementById('adminConfirmPassword').value = '';
                    document.getElementById('adminPhone').value = '';
                    
                    // Switch to login tab after a delay
                    setTimeout(() => {
                        showLoginTab();
                    }, 2000);
                } else {
                    messageElement.textContent = response.message || 'שגיאה ביצירת החברה';
                    messageElement.style.color = '#e53e3e';
                }
            } catch (error) {
                console.error('Company registration error:', error);
                messageElement.textContent = 'שגיאת תקשורת - נסה שוב מאוחר יותר';
                messageElement.style.color = '#e53e3e';
            } finally {
                registerButton.textContent = 'צור חברה';
                registerButton.disabled = false;
            }
        }
        
        // Invitation Functions
        async function validateInvitation() {
            const token = document.getElementById('invitationToken').value;
            const validateButton = document.getElementById('validateInvitationButton');
            const messageElement = document.getElementById('invitationMessage');
            
            if (!token) {
                messageElement.textContent = 'נא להכניס קוד הזמנה';
                messageElement.style.color = '#e53e3e';
                return;
            }
            
            validateButton.textContent = 'בודק...';
            validateButton.disabled = true;
            messageElement.textContent = '';
            
            try {
                const response = await apiCall('validateInvitation', 'POST', { token });
                
                if (response.success) {
                    // Show invitation details
                    document.getElementById('invitationDetails').style.display = 'block';
                    document.getElementById('invitationCompany').textContent = `חברה: ${response.data.companyName}`;
                    document.getElementById('invitationRole').textContent = `תפקיד: ${response.data.role === 'admin' ? 'מנהל' : 'משתמש'}`;
                    
                    // Show user form
                    document.getElementById('invitationUserForm').style.display = 'block';
                    document.getElementById('validateInvitationButton').style.display = 'none';
                    
                    messageElement.textContent = 'ההזמנה תקינה! נא למלא את פרטיך להשלמת ההרשמה';
                    messageElement.style.color = '#38a169';
                } else {
                    messageElement.textContent = response.message || 'קוד הזמנה לא תקין';
                    messageElement.style.color = '#e53e3e';
                }
            } catch (error) {
                console.error('Invitation validation error:', error);
                messageElement.textContent = 'שגיאה בבדיקת ההזמנה';
                messageElement.style.color = '#e53e3e';
            } finally {
                validateButton.textContent = 'בדוק הזמנה';
                validateButton.disabled = false;
            }
        }
        
        async function acceptInvitation() {
            const token = document.getElementById('invitationToken').value;
            const name = document.getElementById('invitationName').value;
            const password = document.getElementById('invitationPassword').value;
            const confirmPassword = document.getElementById('invitationConfirmPassword').value;
            const phone = document.getElementById('invitationPhone').value;
            
            const acceptButton = document.getElementById('acceptInvitationButton');
            const messageElement = document.getElementById('invitationMessage');
            
            // Validation
            if (!name || !password) {
                messageElement.textContent = 'נא למלא שם וסיסמה';
                messageElement.style.color = '#e53e3e';
                return;
            }
            
            if (password !== confirmPassword) {
                messageElement.textContent = 'הסיסמאות אינן תואמות';
                messageElement.style.color = '#e53e3e';
                return;
            }
            
            if (password.length < 8) {
                messageElement.textContent = 'הסיסמה חייבת להכיל לפחות 8 תווים';
                messageElement.style.color = '#e53e3e';
                return;
            }
            
            acceptButton.textContent = 'משלים הרשמה...';
            acceptButton.disabled = true;
            messageElement.textContent = '';
            
            try {
                const response = await apiCall('acceptInvitation', 'POST', {
                    token,
                    name,
                    password,
                    confirmPassword,
                    phone
                });
                
                if (response.success) {
                    messageElement.textContent = 'ההרשמה הושלמה בהצלחה! כעת ניתן להתחבר';
                    messageElement.style.color = '#38a169';
                    
                    // Clear form
                    document.getElementById('invitationName').value = '';
                    document.getElementById('invitationPassword').value = '';
                    document.getElementById('invitationConfirmPassword').value = '';
                    document.getElementById('invitationPhone').value = '';
                    
                    // Switch to login tab after a delay
                    setTimeout(() => {
                        showLoginTab();
                    }, 2000);
                } else {
                    messageElement.textContent = response.message || 'שגיאה בהשלמת ההרשמה';
                    messageElement.style.color = '#e53e3e';
                }
            } catch (error) {
                console.error('Accept invitation error:', error);
                messageElement.textContent = 'שגיאת תקשורת - נסה שוב מאוחר יותר';
                messageElement.style.color = '#e53e3e';
            } finally {
                acceptButton.textContent = 'השלם הרשמה';
                acceptButton.disabled = false;
            }
        }

        // Initialize authentication on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthState();
        });
        
        // API Helper Functions
        async function apiCall(endpoint, method = 'GET', data = null) {
            const url = `${AWS_CONFIG.apiEndpoint}${endpoint}`;
            const headers = {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            };
            
            // Add authentication header if available
            if (currentAuthToken) {
                headers['Authorization'] = `Bearer ${currentAuthToken}`;
                console.log('Adding auth token to request:', currentAuthToken.substring(0, 20) + '...');
            } else {
                console.log('WARNING: No currentAuthToken available!');
            }
            
            const options = {
                method,
                headers,
                mode: 'cors'
            };
            
            if (data && (method === 'POST' || method === 'PUT')) {
                options.body = JSON.stringify(data);
            }
            
            try {
                console.log(`API Call: ${method} ${url}`);
                console.log('Request data:', data);
                console.log('Request options:', options);
                const response = await fetch(url, options);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`HTTP error! status: ${response.status}, response:`, errorText);
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                console.log(`API Response:`, result);
                return result;
            } catch (error) {
                console.error('API call failed:', error);
                throw error;
            }
        }

        // API Data Functions
        async function loadExpenses() {
            try {
                console.log('Loading expenses from API...');
                const result = await apiCall('/expenses');
                console.log('Expenses API result:', result);
                originalMockData = result.data?.expenses || result.items || [];
                console.log('Expenses after assignment:', originalMockData, 'isArray:', Array.isArray(originalMockData));
                mockData = [...originalMockData];
                
                // Refresh works display when expenses are loaded
                if (document.getElementById('worksTab').classList.contains('active')) {
                    renderWorksGrid();
                }
                
                return originalMockData;
            } catch (error) {
                console.warn('Failed to load expenses from API:', error);
                // Fallback to localStorage
                const saved = localStorage.getItem('construction_expenses');
                if (saved) {
                    originalMockData = JSON.parse(saved);
                    mockData = [...originalMockData];
                }
                return originalMockData;
            }
        }
        
        async function loadProjects() {
            try {
                console.log('Loading projects from API...');
                const result = await apiCall('/projects');
                console.log('Projects API result:', result);
                console.log('result.data?.projects type:', typeof result.data?.projects, 'isArray:', Array.isArray(result.data?.projects));
                projects = result.data?.projects || result.data || result.items || [];
                console.log('Projects after assignment:', projects, 'type:', typeof projects, 'isArray:', Array.isArray(projects));
                return projects;
            } catch (error) {
                console.warn('Failed to load projects from API:', error);
                // Fallback to localStorage
                const saved = localStorage.getItem('construction_projects');
                if (saved) {
                    projects = JSON.parse(saved);
                    console.log('Projects loaded from localStorage:', projects);
                } else {
                    console.log('No projects in localStorage either');
                }
                return projects;
            }
        }
        
        async function loadContractors() {
            try {
                console.log('Loading contractors from API...');
                const result = await apiCall('/contractors');
                console.log('Contractors API result:', result);
                contractors = result.data?.contractors || result.data || result.items || [];
                console.log('Contractors after assignment:', contractors, 'isArray:', Array.isArray(contractors));
                return contractors;
            } catch (error) {
                console.warn('Failed to load contractors from API:', error);
                // Fallback to localStorage
                const saved = localStorage.getItem('construction_contractors');
                if (saved) {
                    contractors = JSON.parse(saved);
                }
                return contractors;
            }
        }
        
        async function saveExpense(expense) {
            try {
                await apiCall('/expenses', 'POST', expense);
                // Also save to localStorage as backup
                localStorage.setItem('construction_expenses', JSON.stringify(originalMockData));
            } catch (error) {
                console.warn('Failed to save expense to API:', error);
                // Save to localStorage as fallback
                localStorage.setItem('construction_expenses', JSON.stringify(originalMockData));
                throw error;
            }
        }
        
        async function saveProject(project) {
            try {
                await apiCall('/projects', 'POST', project);
                // Also save to localStorage as backup
                localStorage.setItem('construction_projects', JSON.stringify(projects));
            } catch (error) {
                console.warn('Failed to save project to API:', error);
                // Save to localStorage as fallback
                localStorage.setItem('construction_projects', JSON.stringify(projects));
                throw error;
            }
        }
        
        async function saveContractor(contractor) {
            try {
                await apiCall('/contractors', 'POST', contractor);
                // Also save to localStorage as backup
                localStorage.setItem('construction_contractors', JSON.stringify(contractors));
            } catch (error) {
                console.warn('Failed to save contractor to API:', error);
                // Save to localStorage as fallback
                localStorage.setItem('construction_contractors', JSON.stringify(contractors));
                throw error;
            }
        }
        
        async function deleteExpenseAPI(expenseId) {
            try {
                await apiCall(`/expenses/${expenseId}`, 'DELETE');
                localStorage.setItem('construction_expenses', JSON.stringify(originalMockData));
            } catch (error) {
                console.warn('Failed to delete expense from API:', error);
                localStorage.setItem('construction_expenses', JSON.stringify(originalMockData));
                throw error;
            }
        }

        async function deleteProjectAPI(projectId) {
            try {
                await apiCall(`/projects/${projectId}?cascade=true`, 'DELETE');
            } catch (error) {
                console.warn('Failed to delete project from API:', error);
                throw error;
            }
        }

        async function deleteContractorAPI(contractorId) {
            try {
                await apiCall(`/contractors/${contractorId}`, 'DELETE');
            } catch (error) {
                console.warn('Failed to delete contractor from API:', error);
                throw error;
            }
        }
        
        // Legacy localStorage functions for fallback
        function saveToStorage() {
            try {
                localStorage.setItem('construction_expenses', JSON.stringify(originalMockData));
                localStorage.setItem('construction_projects', JSON.stringify(projects));
                localStorage.setItem('construction_contractors', JSON.stringify(contractors));
                localStorage.setItem('construction_works', JSON.stringify(works));
            } catch (error) {
                console.warn('Failed to save to localStorage:', error);
            }
        }
        
        function exportData() {
            const dataToExport = {
                expenses: originalMockData,
                projects: projects,
                contractors: contractors,
                works: works,
                exportDate: new Date().toISOString(),
                version: '1.0'
            };
            
            const dataStr = JSON.stringify(dataToExport, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `construction-expenses-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
            showMessage('גיבוי נתונים הורד בהצלחה!', 'success');
        }
        
        // Clear old localStorage data for company users
        function clearOldData() {
            if (currentAuthToken) {
                console.log('Company authentication detected - clearing old localStorage data');
                localStorage.removeItem('construction_expenses');
                localStorage.removeItem('construction_projects');
                localStorage.removeItem('construction_contractors');
                localStorage.removeItem('construction_works');
            }
        }
        
        async function loadFromStorage() {
            // Clear old single-user data when using company authentication
            clearOldData();
            
            try {
                // Load all data from API
                await Promise.all([
                    loadExpenses(),
                    loadProjects(),
                    loadContractors(),
                    loadWorks()
                ]);
                
                console.log('Data loaded from API successfully');
                console.log('Expenses:', originalMockData.length);
                console.log('Projects:', projects.length);
                console.log('Contractors:', contractors.length);
                console.log('Works:', works.length);
                
            } catch (error) {
                console.warn('Failed to load from API:', error);
                
                // For company users, don't fall back to localStorage (data isolation)
                if (currentAuthToken) {
                    console.log('Company user detected - initializing with empty data instead of localStorage fallback');
                    originalMockData = [];
                    mockData = [];
                    projects = [];
                    contractors = [];
                    works = [];
                    return;
                }
                
                console.log('Using localStorage fallback for non-company user:');
                
                // Fallback to localStorage
                try {
                    const savedExpenses = localStorage.getItem('construction_expenses');
                    const savedProjects = localStorage.getItem('construction_projects');
                    const savedContractors = localStorage.getItem('construction_contractors');
                    const savedWorks = localStorage.getItem('construction_works');
                    
                    if (savedExpenses) {
                        originalMockData = JSON.parse(savedExpenses);
                        mockData = [...originalMockData];
                    }
                    
                    if (savedProjects) {
                        projects = JSON.parse(savedProjects);
                    }
                    
                    if (savedContractors) {
                        contractors = JSON.parse(savedContractors);
                    }
                    
                    if (savedWorks) {
                        works = JSON.parse(savedWorks);
                    }
                } catch (localError) {
                    console.warn('Failed to load from localStorage:', localError);
                    // Initialize with empty arrays if everything fails
                    originalMockData = [];
                    mockData = [];
                    projects = [];
                    contractors = [];
                    works = [];
                }
            }
        }
        
        // Initialize data arrays
        let originalMockData = [];
        let mockData = []; // Working copy for filtering
        let currentFilter = '';
        let selectedProject = null;
        let isFormForProject = false;
        let projects = []; // Store project data separately
        let isExpenseFormWaitingForProject = false;

        function formatCurrency(amount) {
            return new Intl.NumberFormat('he-IL', {
                style: 'currency',
                currency: 'ILS'
            }).format(amount);
        }

        function switchTab(tabName, event = null) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Add active class to selected tab button
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // Find and activate the corresponding tab button when called programmatically
                const tabBtn = document.querySelector(`[onclick*="switchTab('${tabName}')"]`);
                if (tabBtn) {
                    tabBtn.classList.add('active');
                }
            }
            
            // Load content based on tab
            if (tabName === 'projects') {
                renderProjectsGrid();
            } else if (tabName === 'contractors') {
                if (contractors.length === 0) {
                    initializeContractors();
                }
                renderContractorsGrid();
            } else if (tabName === 'works') {
                renderWorksGrid();
            } else if (tabName === 'addExpense') {
                // Initialize signature canvas when switching to add expense tab
                setTimeout(() => {
                    initializeSignatureCanvas();
                    populateNewExpenseProjectFilter();
                    populateNewExpenseContractorFilter();
                    populateNewExpenseWorkFilter();
                    // Set default date to today
                    document.getElementById('newExpenseDate').value = new Date().toISOString().split('T')[0];
                }, 100);
            }
        }

        function renderProjectsGrid() {
            const grid = document.getElementById('projectsGrid');
            
            // DEBUG: Log what projects contains
            console.log('🔍 renderProjectsGrid: projects variable:', projects, 'type:', typeof projects, 'isArray:', Array.isArray(projects));
            
            // Comprehensive safety check for all arrays
        function ensureArraysInitialized() {
            if (!Array.isArray(projects)) {
                console.warn('🚨 projects is not an array, resetting to empty array');
                projects = [];
            }
            if (!Array.isArray(contractors)) {
                console.warn('🚨 contractors is not an array, resetting to empty array');
                contractors = [];
            }
            if (!Array.isArray(originalMockData)) {
                console.warn('🚨 originalMockData is not an array, resetting to empty array');
                originalMockData = [];
            }
            if (!Array.isArray(mockData)) {
                console.warn('🚨 mockData is not an array, resetting to empty array');
                mockData = [];
            }
            if (!Array.isArray(works)) {
                console.warn('🚨 works is not an array, resetting to empty array');
                works = [];
            }
        }

        // Safety check: ensure projects is an array
            ensureArraysInitialized();
            if (!Array.isArray(projects)) {
                console.warn('🚨 projects is not an array, resetting to empty array');
                projects = [];
            }
            
            if (!projects || projects.length === 0) {
                grid.innerHTML = '<p class="no-data">אין פרויקטים במערכת. לחץ על "יצירת פרויקט חדש" כדי להוסיף פרויקט.</p>';
                return;
            }
            
            const projectsWithExpenses = {};
            
            // Group expenses by project (if any expenses exist)
            originalMockData.forEach(expense => {
                // Resolve project and contractor names from IDs
                const projectName = expense.project || (expense.projectId ? 
                    (projects.find(p => p.projectId === expense.projectId)?.name || `Project ${expense.projectId}`) : 
                    'Unknown Project');
                const contractorName = expense.contractor || (expense.contractorId ? 
                    (contractors.find(c => c.contractorId === expense.contractorId)?.name || `Contractor ${expense.contractorId}`) : 
                    'Unknown Contractor');
                
                if (!projectsWithExpenses[projectName]) {
                    projectsWithExpenses[projectName] = {
                        name: projectName,
                        totalAmount: 0,
                        expenseCount: 0,
                        expenses: [],
                        contractors: new Set(),
                        statuses: new Set(),
                        dateRange: { earliest: expense.date, latest: expense.date }
                    };
                }
                
                const project = projectsWithExpenses[projectName];
                project.totalAmount += parseFloat(expense.amount) || 0;
                project.expenseCount++;
                project.expenses.push(expense);
                project.contractors.add(contractorName);
                project.statuses.add(expense.status);
                
                // Update date range
                if (expense.date < project.dateRange.earliest) {
                    project.dateRange.earliest = expense.date;
                }
                if (expense.date > project.dateRange.latest) {
                    project.dateRange.latest = expense.date;
                }
            });
            
            let gridHtml = '';
            
            // First, show projects that have expenses
            Object.values(projectsWithExpenses).forEach(project => {
                const waitingAmount = calculateWaitingAmount(project.name);
                const paidAmount = calculatePaidAmount(project.name);
                
                gridHtml += `
                    <div class="project-card">
                        <div style="position: relative;">
                            <button class="delete-button" style="position: absolute; top: -5px; left: -5px; z-index: 10;" onclick="event.stopPropagation(); deleteProject('${project.name}')" title="מחק פרויקט">🗑</button>
                            <div class="project-title" onclick="showProjectDetails('${project.name}')" style="cursor: pointer;">${project.name}</div>
                        </div>
                        <div class="project-amount-large" onclick="showProjectDetails('${project.name}')" style="cursor: pointer;">
                            <div>${formatCurrency(project.totalAmount)}</div>
                            <div style="font-size: 0.7rem; color: #718096; margin-top: 2px;">סך הוצאות</div>
                        </div>
                        
                        <div class="project-stats-grid" onclick="showProjectDetails('${project.name}')" style="cursor: pointer;">
                            <div class="stat-item">
                                <div class="stat-number">${project.expenseCount}</div>
                                <div class="stat-label">הוצאות</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number">${project.contractors.size}</div>
                                <div class="stat-label">קבלנים</div>
                            </div>
                        </div>
                        
                        <div class="project-stats-grid" onclick="showProjectDetails('${project.name}')" style="cursor: pointer;">
                            <div class="stat-item">
                                <div class="stat-number" style="color: #e53e3e;">${formatCurrency(waitingAmount)}</div>
                                <div class="stat-label">ממתין</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number" style="color: #38a169;">${formatCurrency(paidAmount)}</div>
                                <div class="stat-label">שולם</div>
                            </div>
                        </div>
                        
                        <div onclick="showProjectDetails('${project.name}')" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e2e8f0; font-size: 0.9rem; color: #718096; cursor: pointer;">
                            <div>תקופה: ${project.dateRange.earliest} - ${project.dateRange.latest}</div>
                        </div>
                    </div>
                `;
            });
            
            // Then, show projects without expenses
            projects.forEach(project => {
                // Skip if this project already has expenses (was shown above)
                if (projectsWithExpenses[project.name]) return;
                
                gridHtml += `
                    <div class="project-card">
                        <div style="position: relative;">
                            <button class="delete-button" style="position: absolute; top: -5px; left: -5px; z-index: 10;" onclick="event.stopPropagation(); deleteProject('${project.name}')" title="מחק פרויקט">🗑</button>
                            <div class="project-title" onclick="showProjectDetails('${project.name}')" style="cursor: pointer;">${project.name}</div>
                        </div>
                        <div class="project-amount-large" onclick="showProjectDetails('${project.name}')" style="cursor: pointer;">${formatCurrency(0)}</div>
                        
                        <div class="project-stats-grid" onclick="showProjectDetails('${project.name}')" style="cursor: pointer;">
                            <div class="stat-item">
                                <div class="stat-number">0</div>
                                <div class="stat-label">הוצאות</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number">0</div>
                                <div class="stat-label">קבלנים</div>
                            </div>
                        </div>
                        
                        <div class="project-stats-grid" onclick="showProjectDetails('${project.name}')" style="cursor: pointer;">
                            <div class="stat-item">
                                <div class="stat-number" style="color: #e53e3e;">0</div>
                                <div class="stat-label">ממתין</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number" style="color: #38a169;">0</div>
                                <div class="stat-label">שולם</div>
                            </div>
                        </div>
                        
                        <div onclick="showProjectDetails('${project.name}')" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e2e8f0; font-size: 0.9rem; color: #718096; cursor: pointer;">
                            <div>סטאטוס: ${project.status || 'פעיל'}</div>
                        </div>
                    </div>
                `;
            });
            
            grid.innerHTML = gridHtml;
        }

        function showProjectDetails(projectName) {
            selectedProject = projectName;
            const grid = document.getElementById('projectsGrid');
            const detailsView = document.getElementById('projectDetails');
            
            // Hide grid and show details
            grid.style.display = 'none';
            detailsView.style.display = 'block';
            
            // Safety check: ensure originalMockData is an array
            if (!Array.isArray(originalMockData)) {
                console.warn('🚨 originalMockData is not an array in showProjectDetails, resetting');
                originalMockData = [];
            }
            
            // Get project data - need to resolve project and contractor IDs to names
            const projectExpenses = originalMockData.filter(expense => {
                // Support both old format (expense.project) and new format (expense.projectId)
                const expenseProjectName = expense.project || (expense.projectId ? 
                    (projects.find(p => p.projectId === expense.projectId)?.name || expense.projectId) : 
                    'Unknown Project');
                return expenseProjectName === projectName;
            });
            const totalAmount = projectExpenses.reduce((sum, expense) => sum + (parseFloat(expense.amount) || 0), 0);
            const projectContractors = [...new Set(projectExpenses.map(e => {
                // Support both old format (expense.contractor) and new format (expense.contractorId)
                return e.contractor || (e.contractorId ? 
                    (contractors.find(c => c.contractorId === e.contractorId)?.name || e.contractorId) : 
                    'Unknown Contractor');
            }))];
            
            let detailsHtml = `
                <button class="back-button" onclick="backToProjectsGrid()">חזרה לרשימת פרויקטים</button>
                
                <div class="project-header">
                    <div>
                        <h2 style="color: #2d3748; margin-bottom: 5px;">${projectName}</h2>
                        <p style="color: #718096;">${projectExpenses.length} הוצאות • ${projectContractors.length} קבלנים</p>
                    </div>
                    <div class="project-amount-large" style="margin: 0;">${formatCurrency(totalAmount)}</div>
                </div>
                
                <button class="add-expense-button" onclick="switchTab('addExpense'); populateProjectInNewExpenseForm('${projectName}')">הוספת הוצאה לפרויקט זה</button>
                
                <div class="project-stats-grid" style="margin-bottom: 25px;">
                    <div class="stat-item">
                        <div class="stat-number">${formatCurrency(calculateWaitingAmount(projectName))}</div>
                        <div class="stat-label">ממתין תשלום</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">${formatCurrency(calculatePaidAmount(projectName))}</div>
                        <div class="stat-label">שולם</div>
                    </div>
                </div>
                
                <h3 style="margin-bottom: 15px; color: #2d3748;">קבלנים בפרויקט:</h3>
                <div style="margin-bottom: 25px;">
            `;
            
            // Safety check: ensure projectContractors array is valid
            if (!Array.isArray(projectContractors)) {
                console.warn('🚨 projectContractors is not an array in showProjectDetails, resetting');
                projectContractors = [];
            }
            
            projectContractors.forEach(contractor => {
                const contractorExpenses = projectExpenses.filter(e => {
                    // Support both old format (e.contractor) and new format (e.contractorId)
                    const expenseContractorName = e.contractor || (e.contractorId ? 
                        (contractors.find(c => c.contractorId === e.contractorId)?.name || e.contractorId) : 
                        'Unknown Contractor');
                    return expenseContractorName === contractor;
                });
                const contractorTotal = contractorExpenses.reduce((sum, e) => sum + e.amount, 0);
                
                detailsHtml += `
                    <div style="background: #f7fafc; padding: 12px; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: bold; color: #2d3748;">${contractor}</div>
                            <div style="color: #718096; font-size: 0.9rem;">${contractorExpenses.length} הוצאות</div>
                        </div>
                        <div style="font-weight: bold; color: #38a169;">${formatCurrency(contractorTotal)}</div>
                    </div>
                `;
            });
            
            detailsHtml += `
                </div>
                
                <h3 style="margin-bottom: 15px; color: #2d3748;">רשימת הוצאות מפורטת:</h3>
                <div class="expense-list-detailed">
            `;
            
            // Sort expenses by date (newest first)
            projectExpenses.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(expense => {
                detailsHtml += `
                    <div class="expense-card">
                        <div class="expense-header">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <div class="project-name" style="font-size: 1.1rem;">${expense.contractor || (expense.contractorId ? (contractors.find(c => c.contractorId === expense.contractorId)?.name || expense.contractorId) : 'Unknown Contractor')}</div>
                                <span class="status-badge status-${expense.status}">${getStatusText(expense.status)}</span>
                            </div>
                            <div class="amount">${formatCurrency(expense.amount)}</div>
                        </div>
                        <div class="expense-details">
                            <div class="detail-item">
                                <span class="detail-label">מספר חשבונית:</span>
                                <span class="detail-value">${expense.invoiceNum}</span>
                            </div>
                            <div class="detail-item">
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">אמצעי תשלום:</span>
                                <span class="detail-value">${expense.paymentMethod}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">תאריך:</span>
                                <span class="detail-value">${expense.date}</span>
                            </div>
                        </div>
                        ${expense.description ? `<p style="margin-top: 10px; color: #666;"><strong>תיאור:</strong> ${expense.description}</p>` : ''}
                    </div>
                `;
            });
            
            detailsHtml += `</div>`;
            
            detailsView.innerHTML = detailsHtml;
        }

        function backToProjectsGrid() {
            const grid = document.getElementById('projectsGrid');
            const detailsView = document.getElementById('projectDetails');
            
            // Show grid and hide details
            grid.style.display = 'grid';
            detailsView.style.display = 'none';
            
            selectedProject = null;
        }


        function populateProjectDropdown() {
            const select = document.getElementById('projectName');
            const existingProjects = [...new Set(originalMockData.map(expense => expense.project))];
            
            // Clear existing options
            select.innerHTML = '<option value="">בחר פרויקט</option>';
            
            // Add existing projects from expenses
            existingProjects.forEach(project => {
                const option = document.createElement('option');
                option.value = project;
                option.textContent = project;
                select.appendChild(option);
            });
            
            // Add standalone projects (if any)
            if (projects && projects.length > 0) {
                projects.forEach(project => {
                    if (!existingProjects.includes(project.name)) {
                        const option = document.createElement('option');
                        option.value = project.name;
                        option.textContent = project.name;
                        select.appendChild(option);
                    }
                });
            }
        }

        function openProjectForm(fromExpenseForm = false) {
            const modal = document.getElementById('projectFormModal');
            const form = document.getElementById('projectForm');
            
            // Reset form
            form.reset();
            document.getElementById('projectFormMessage').innerHTML = '';
            
            // Set default start date to today
            document.getElementById('projectStartDate').value = new Date().toISOString().split('T')[0];
            
            isExpenseFormWaitingForProject = fromExpenseForm;
            
            modal.style.display = 'flex';
        }

        function closeProjectForm() {
            const modal = document.getElementById('projectFormModal');
            modal.style.display = 'none';
            isExpenseFormWaitingForProject = false;
        }

        
        async function submitProject(event) {
            event.preventDefault();
            
            // Prevent double submission
            
            const submitButton = document.querySelector('#projectForm button[type="submit"]');
            if (submitButton) {
            }
            
            try {
                // Updated project data structure for multi-table architecture
                const projectData = {
                name: document.getElementById('projectNameInput').value.trim(),
                startDate: document.getElementById('projectStartDate').value || '',
                status: document.getElementById('projectStatus').value || 'active',
                description: document.getElementById('projectDescription').value.trim() || '',
                SpentAmount: 0 // Initialize SpentAmount to 0 for new projects
            };
            
            // Validate required fields
            const missingFields = [];
            if (!projectData.name) missingFields.push('שם הפרויקט');
            if (!projectData.startDate) missingFields.push('תאריך התחלה');
            
            if (missingFields.length > 0) {
                document.getElementById('projectFormMessage').innerHTML = 
                    `<div class="error-message">חסרים שדות חובה: ${missingFields.join(', ')}</div>`;
                return;
            }

            // Generate unique ID
            const projectId = `proj_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            const timestamp = new Date().toISOString();

            const newProject = {
                projectId,
                ...projectData,
                createdAt: timestamp,
                updatedAt: timestamp
            };

            // Save to API first
            try {
                await saveProject(newProject);
                // Reload projects from API to get consistent data structure
                await loadProjects();
            } catch (error) {
                console.error('Failed to save project:', error);
                // Add to local projects array as fallback
                projects.push(newProject);
                showMessage('projectFormMessage', 'שגיאה בשמירת הפרויקט. נשמר מקומית.', 'warning');
            }

            // Show success message
            const messageDiv = document.getElementById('projectFormMessage');
            messageDiv.innerHTML = `
                <div class="success-message">
                    פרויקט נוצר בהצלחה!<br>
                    שם הפרויקט: ${projectData.name}<br>
                    מספר פרויקט: ${projectId}
                </div>
            `;

            // Update all dropdowns with fresh data
            populateProjectFilter();
            populateNewExpenseProjectFilter();

            // If called from expense form, select the new project and return to expense form
            if (isExpenseFormWaitingForProject) {
                setTimeout(() => {
                    closeProjectForm();
                    // Set the dropdown to the created project name
                    document.getElementById('newProjectName').value = projectData.name;
                    isExpenseFormWaitingForProject = false;
                }, 1500);
            } else {
                // Update projects grid if we're in projects tab
                if (document.getElementById('projectsTab').classList.contains('active')) {
                    setTimeout(() => {
                        renderProjectsGrid();
                    }, 1000);
                }
                
                // Close form after showing success message
                setTimeout(() => {
                    closeProjectForm();
                }, 2000);
            }
            
        } catch (error) {
            console.error('Error in submitProject:', error);
            showMessage('projectFormMessage', 'שגיאה ביצירת פרויקט', 'error');
        } finally {
                // Re-enable submission
                const submitButton = document.querySelector('#projectForm button[type="submit"]');
                if (submitButton) {
                }
            }
        }

        function closeExpenseForm() {
            const modal = document.getElementById('expenseFormModal');
            modal.style.display = 'none';
            isFormForProject = false;
            
            // Reset file uploads
            document.getElementById('expenseForm').reset();
            removeImage('receiptImage', 'receiptPreview');
            removeImage('contractorSignature', 'signaturePreview');
        }

        // Double submission prevention
        let expenseSubmitting = false;
        
        async function submitExpense(event) {
            event.preventDefault();
            
            // Prevent double submission
            if (expenseSubmitting) {
                console.log('Expense submission already in progress');
                return;
            }
            
            expenseSubmitting = true;
            const submitButton = event.target.querySelector('button[type="submit"]');
            if (submitButton) {
                submitButton.disabled = true;
                submitButton.textContent = 'שומר...';
            }
            
            try {
                // Handle file uploads
            const receiptImageFile = document.getElementById('receiptImage').files[0];
            const signatureFile = document.getElementById('contractorSignature').files[0];
            
            let receiptImage = null;
            let contractorSignature = null;
            
            // Convert files to base64 for storage
            if (receiptImageFile) {
                try {
                    receiptImage = await readFileAsDataURL(receiptImageFile);
                } catch (error) {
                    console.error('Error reading receipt image:', error);
                    showMessage('formMessage', 'שגיאה בקריאת תמונת הקבלה', 'error');
                    return;
                }
            }
            
            if (signatureFile) {
                try {
                    contractorSignature = await readFileAsDataURL(signatureFile);
                } catch (error) {
                    console.error('Error reading signature file:', error);
                    showMessage('formMessage', 'שגיאה בקריאת קובץ החתימה', 'error');
                    return;
                }
            }

            // Updated form data structure for multi-table architecture
            const formData = {
                projectId: document.getElementById('projectName').value,     // Updated field
                contractorId: document.getElementById('contractorName').value, // Updated field
                invoiceNum: document.getElementById('invoiceNumber').value,
                amount: parseFloat(document.getElementById('expenseAmount').value),
                paymentMethod: document.getElementById('paymentMethod').value,
                date: document.getElementById('expenseDate').value,
                description: document.getElementById('expenseDescription').value || '',
                receiptImage: receiptImage,
                contractorSignature: contractorSignature
            };
            
            // Validate required fields
            const missingFields = [];
            if (!formData.projectId) missingFields.push('פרויקט');
            if (!formData.contractorId) missingFields.push('קבלן');
            if (!formData.invoiceNum) missingFields.push('מספר חשבונית');
            if (!formData.amount || formData.amount <= 0) missingFields.push('סכום');
            if (!formData.paymentMethod) missingFields.push('אמצעי תשלום');
            if (!formData.date) missingFields.push('תאריך');
            
            if (missingFields.length > 0) {
                showMessage('formMessage', `חסרים שדות חובה: ${missingFields.join(', ')}`, 'error');
                return;
            }

            // Generate unique ID
            const expenseId = `exp_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            const timestamp = new Date().toISOString();

            const newExpense = {
                userId: 'test-user-123',
                expenseId,
                ...formData,
                createdAt: timestamp,
                updatedAt: timestamp
            };

            // Add to mock data
            originalMockData.push(newExpense);
            mockData = [...originalMockData];
            
            // Save to API with error handling
            try {
                await saveExpense(formData); // Send formData directly to API
            } catch (error) {
                console.error('Failed to save expense:', error);
                let errorMessage = 'שגיאה בשמירת ההוצאה';
                
                if (error.message?.includes('Foreign key validation')) {
                    errorMessage = 'שגיאה: הפרויקט או הקבלן שנבחרו לא קיימים במערכת';
                } else if (error.message?.includes('already exists')) {
                    errorMessage = 'מספר החשבונית כבר קיים במערכת';
                } else if (error.message?.includes('Amount exceeds')) {
                    errorMessage = 'הסכום חורג מהמגבלה המותרת';
                }
                
                showMessage('formMessage', errorMessage, 'error');
                return;
            }

            // Show success message
            const messageDiv = document.getElementById('formMessage');
            messageDiv.innerHTML = `
                <div class="success-message">
                    הוצאה נוספה בהצלחה!<br>
                    מספר הוצאה: ${expenseId}<br>
                    פרויקט: ${formData.project}<br>
                    סכום: ${formatCurrency(formData.amount)}
                </div>
            `;

            // Update project filter dropdown
            populateProjectFilter();

            // If we're in expenses tab, refresh the list
            if (document.getElementById('expensesTab').classList.contains('active')) {
                renderExpenses();
            }

            // If we're in project details, refresh that view
            if (selectedProject) {
                setTimeout(() => {
                    showProjectDetails(selectedProject);
                }, 1000);
            }

                // Reset form after showing success message
                setTimeout(() => {
                    closeExpenseForm();
                }, 2000);
                
            } catch (error) {
                console.error('Error in submitExpense:', error);
                showMessage('formMessage', 'שגיאה בשמירת ההוצאה', 'error');
            } finally {
                // Re-enable form submission
                expenseSubmitting = false;
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.textContent = 'הוסף הוצאה';
                }
            }
        }

        // Contractor management variables
        let contractors = [];
        let selectedContractor = null;
        
        // Works management variables
        let works = [];
        let selectedWork = null;
        
        // Data will be loaded after authentication via showMainApp()

        // Helper function to compress and read image file
        function compressImage(file, maxSizeKB = 300, quality = 0.8) {
            return new Promise((resolve, reject) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    // Calculate new dimensions to keep image under size limit
                    let { width, height } = img;
                    const maxDimension = 1200; // Max width or height
                    
                    if (width > height && width > maxDimension) {
                        height = (height * maxDimension) / width;
                        width = maxDimension;
                    } else if (height > maxDimension) {
                        width = (width * maxDimension) / height;
                        height = maxDimension;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    // Draw and compress
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Start with quality and reduce if needed
                    let currentQuality = quality;
                    let compressedData;
                    
                    do {
                        compressedData = canvas.toDataURL(file.type || 'image/jpeg', currentQuality);
                        currentQuality -= 0.1;
                    } while (compressedData.length > maxSizeKB * 1024 * 4/3 && currentQuality > 0.1); // 4/3 for base64 overhead
                    
                    resolve({
                        name: file.name,
                        data: compressedData,
                        type: file.type || 'image/jpeg',
                        size: Math.round(compressedData.length * 0.75) // Approximate compressed size
                    });
                };
                
                img.onerror = function() {
                    reject(new Error('Failed to load image: ' + file.name));
                };
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    img.src = e.target.result;
                };
                reader.onerror = function() {
                    reject(new Error('Failed to read file: ' + file.name));
                };
                reader.readAsDataURL(file);
            });
        }

        // Helper function to read file as data URL
        function readFileAsDataURL(file) {
            // For images, compress them first
            if (file.type && file.type.startsWith('image/')) {
                return compressImage(file);
            }
            
            // For non-images, read normally
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    resolve({
                        name: file.name,
                        data: e.target.result,
                        type: file.type,
                        size: file.size
                    });
                };
                reader.onerror = function(e) {
                    reject(new Error('Failed to read file: ' + file.name));
                };
                reader.readAsDataURL(file);
            });
        }

        // File upload and preview functionality
        function previewImage(inputId, previewId) {
            const input = document.getElementById(inputId);
            const preview = document.getElementById(previewId);
            const button = document.querySelector(`label[for="${inputId}"]`);
            
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    preview.innerHTML = `
                        <img src="${e.target.result}" alt="תצוגה מקדימה">
                        <div class="file-name">${file.name}</div>
                        <button type="button" class="remove-image" onclick="removeImage('${inputId}', '${previewId}')">
                            הסר תמונה
                        </button>
                    `;
                    
                    // Update button style to show file is selected
                    button.classList.add('has-file');
                    button.querySelector('.upload-text').textContent = `עודכן: ${file.name}`;
                };
                
                reader.readAsDataURL(file);
            }
        }

        function removeImage(inputId, previewId) {
            const input = document.getElementById(inputId);
            const preview = document.getElementById(previewId);
            const button = document.querySelector(`label[for="${inputId}"]`);
            
            input.value = '';
            preview.innerHTML = '';
            button.classList.remove('has-file');
            
            // Reset button text based on input type
            if (inputId === 'receiptImage') {
                button.querySelector('.upload-text').textContent = 'העלה תמונת קבלה';
            } else if (inputId === 'contractorSignature') {
                button.querySelector('.upload-text').textContent = 'העלה חתימת קבלן/ספק';
            }
        }

        // Image modal functions
        function showImageModal(imageSrc, imageName) {
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            const modalImageName = document.getElementById('modalImageName');
            
            modalImage.src = imageSrc;
            modalImageName.textContent = imageName || 'תמונה';
            modal.style.display = 'flex';
        }

        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            modal.style.display = 'none';
        }

        // Signature canvas functionality
        let isDrawing = false;
        let signatureCanvas = null;
        let signatureCtx = null;
        let savedSignature = null;

        function initializeSignatureCanvas() {
            signatureCanvas = document.getElementById('signatureCanvas');
            if (!signatureCanvas) return;
            
            signatureCtx = signatureCanvas.getContext('2d');
            
            // Set up canvas properties
            signatureCtx.lineWidth = 2;
            signatureCtx.lineCap = 'round';
            signatureCtx.strokeStyle = '#2d3748';
            
            // Mouse events
            signatureCanvas.addEventListener('mousedown', startDrawing);
            signatureCanvas.addEventListener('mousemove', draw);
            signatureCanvas.addEventListener('mouseup', stopDrawing);
            signatureCanvas.addEventListener('mouseout', stopDrawing);
            
            // Touch events for mobile
            signatureCanvas.addEventListener('touchstart', handleTouchStart, {passive: false});
            signatureCanvas.addEventListener('touchmove', handleTouchMove, {passive: false});
            signatureCanvas.addEventListener('touchend', stopDrawing);
        }

        function startDrawing(e) {
            isDrawing = true;
            const rect = signatureCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            signatureCtx.beginPath();
            signatureCtx.moveTo(x, y);
        }

        function draw(e) {
            if (!isDrawing) return;
            
            const rect = signatureCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            signatureCtx.lineTo(x, y);
            signatureCtx.stroke();
        }

        function stopDrawing() {
            isDrawing = false;
        }

        function handleTouchStart(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousedown', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            signatureCanvas.dispatchEvent(mouseEvent);
        }

        function handleTouchMove(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousemove', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            signatureCanvas.dispatchEvent(mouseEvent);
        }

        function clearSignature() {
            if (!signatureCtx) return;
            
            signatureCtx.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
            savedSignature = null;
            
            // Hide preview
            const previewContainer = document.getElementById('signaturePreviewContainer');
            previewContainer.style.display = 'none';
        }

        function saveSignature() {
            if (!signatureCanvas) return;
            
            // Check if canvas is blank
            const canvasData = signatureCtx.getImageData(0, 0, signatureCanvas.width, signatureCanvas.height);
            const isCanvasBlank = !canvasData.data.some(channel => channel !== 0);
            
            if (isCanvasBlank) {
                showMessage('addExpenseMessage', 'אנא הוסף חתימה לפני השמירה', 'error');
                return;
            }
            
            // Convert canvas to base64
            savedSignature = signatureCanvas.toDataURL('image/png');
            
            // Show preview
            const previewContainer = document.getElementById('signaturePreviewContainer');
            const previewImage = document.getElementById('signaturePreview');
            
            previewImage.src = savedSignature;
            previewContainer.style.display = 'block';
            
            showMessage('addExpenseMessage', 'חתימה נשמרה בהצלחה!', 'success');
        }

        function showMessage(containerId, message, type) {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="form-message ${type}">${message}</div>`;
            
            // Auto-hide after 3 seconds
            setTimeout(() => {
                container.innerHTML = '';
            }, 3000);
        }

        // New expense form functions
        
        async function submitNewExpense(event) {
            event.preventDefault();
            
            // Prevent double submission
            
            const submitButton = document.querySelector('#newExpenseForm button[type="submit"]');
            if (submitButton) {
            }
            
            try {
                // Get receipt image
            const receiptImageFile = document.getElementById('newReceiptImage').files[0];
            let receiptImage = null;
            
            if (receiptImageFile) {
                try {
                    receiptImage = await readFileAsDataURL(receiptImageFile);
                } catch (error) {
                    console.error('Error reading receipt image:', error);
                    showMessage('addExpenseMessage', 'שגיאה בקריאת תמונת הקבלה', 'error');
                    return;
                }
            }

            // DEBUG: Check dropdown values before creating formData
            const projectDropdown = document.getElementById('newProjectName');
            const contractorDropdown = document.getElementById('newContractorName');
            console.log('🔍 DEBUG: Project dropdown value:', projectDropdown.value);
            console.log('🔍 DEBUG: Contractor dropdown value:', contractorDropdown.value);
            console.log('🔍 DEBUG: Project dropdown options:', Array.from(projectDropdown.options).map(o => ({value: o.value, text: o.textContent})));
            console.log('🔍 DEBUG: Contractor dropdown options:', Array.from(contractorDropdown.options).map(o => ({value: o.value, text: o.textContent})));
            
            const formData = {
                projectId: projectDropdown.value,
                contractorId: contractorDropdown.value,
                invoiceNum: document.getElementById('newInvoiceNumber').value,
                amount: parseFloat(document.getElementById('newExpenseAmount').value),
                paymentTerms: document.getElementById('newPaymentTerms').value,
                paymentMethod: document.getElementById('newPaymentMethod').value,
                date: document.getElementById('newExpenseDate').value,
                status: 'paid', // All expenses are always paid
                description: document.getElementById('newExpenseDescription').value || '',
                receiptImage: receiptImage,
                contractorSignature: savedSignature ? {
                    name: 'contractor-signature.png',
                    data: savedSignature,
                    type: 'image/png'
                } : null
            };

            // DEBUG: Log the complete form data
            console.log('🔍 DEBUG: Complete formData being sent:', JSON.stringify(formData, null, 2));

            // Add work information if selected
            const selectedWorkId = document.getElementById('newWorkName').value;
            if (selectedWorkId) {
                const selectedWork = works.find(work => work.workId === selectedWorkId);
                if (selectedWork) {
                    formData.workId = selectedWorkId;
                    formData.workName = selectedWork.WorkName || selectedWork.name || 'ללא שם';
                }
            }

            // Validate required fields
            const requiredFields = ['projectId', 'contractorId', 'invoiceNum', 'amount', 'paymentTerms', 'paymentMethod', 'date'];
            const missingFields = requiredFields.filter(field => !formData[field]);
            
            if (missingFields.length > 0) {
                showMessage('addExpenseMessage', `חסרים שדות חובה: ${missingFields.join(', ')}`, 'error');
                return;
            }

            // Generate unique ID
            const expenseId = `exp_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            const timestamp = new Date().toISOString();

            const newExpense = {
                userId: 'test-user-123',
                expenseId,
                ...formData,
                createdAt: timestamp,
                updatedAt: timestamp
            };

            // Add to mock data
            originalMockData.push(newExpense);
            mockData = [...originalMockData];
            
            // Save to API
            try {
                await saveExpense(newExpense);
            } catch (apiError) {
                console.error('Failed to save expense:', apiError);
                showMessage('addExpenseMessage', 'שגיאה בשמירת ההוצאה. נשמרה מקומית.', 'warning');
            }

            // Show success message
            showMessage('addExpenseMessage', 'הוצאה נוספה בהצלחה! חוזר לרשימת הוצאות...', 'success');

            // Reset form after 2 seconds and switch to expenses tab
            setTimeout(async () => {
                resetExpenseForm();
                switchTab('expenses');
                
                // Update project filter dropdown in expenses tab
                populateProjectFilter();
                // Load fresh data from API
                await loadExpenses();
                renderExpenses();
            }, 2000);
            
        } catch (error) {
            console.error('Error in submitNewExpense:', error);
            showMessage('addExpenseMessage', 'שגיאה בהוספת הוצאה', 'error');
        } finally {
            // Re-enable submission
            const submitButton = document.querySelector('#newExpenseForm button[type="submit"]');
            if (submitButton) {
            }
        }
    }

        function resetExpenseForm() {
            document.getElementById('newExpenseForm').reset();
            
            // Clear signature
            clearSignature();
            
            // Clear receipt image
            removeImage('newReceiptImage', 'newReceiptPreview');
            
            // Clear messages
            document.getElementById('addExpenseMessage').innerHTML = '';
            
            // Repopulate dropdowns
            populateNewExpenseProjectFilter();
            populateNewExpenseContractorFilter();
            populateNewExpenseWorkFilter();
            
            // Set default date to today
            document.getElementById('newExpenseDate').value = new Date().toISOString().split('T')[0];
        }

        function populateNewExpenseProjectFilter() {
            const select = document.getElementById('newProjectName');
            
            // DEBUG: Log projects data when populating dropdown
            console.log('🔍 DEBUG: populateNewExpenseProjectFilter called with projects:', projects, 'length:', projects?.length);
            
            // Safety check: ensure projects is an array
            if (!Array.isArray(projects)) {
                console.warn('🚨 projects is not an array in populateNewExpenseProjectFilter, resetting');
                projects = [];
            }
            
            // Clear existing options except the first one
            select.innerHTML = '<option value="">בחר פרויקט</option>';
            
            // Add projects from projects array first
            if (projects && projects.length > 0) {
                projects.forEach(project => {
                    const option = document.createElement('option');
                    option.value = project.projectId;
                    option.textContent = project.name;
                    select.appendChild(option);
                });
            }
            
            // Add projects from existing expenses (if any and not already added)
            const expenseProjects = [...new Set(originalMockData.map(expense => expense.project))];
            expenseProjects.forEach(projectName => {
                // Check if already added from projects array
                if (!projects || !projects.find(p => p.name === projectName)) {
                    const option = document.createElement('option');
                    option.value = projectName;
                    option.textContent = projectName;
                    select.appendChild(option);
                }
            });
        }

        function populateNewExpenseContractorFilter() {
            const select = document.getElementById('newContractorName');
            
            // DEBUG: Log contractors data when populating dropdown
            console.log('🔍 DEBUG: populateNewExpenseContractorFilter called with contractors:', contractors, 'length:', contractors?.length);
            
            // Safety checks: ensure arrays exist
            if (!Array.isArray(originalMockData)) {
                console.warn('🚨 originalMockData is not an array, resetting');
                originalMockData = [];
            }
            if (!Array.isArray(contractors)) {
                console.warn('🚨 contractors is not an array, resetting');
                contractors = [];
            }
            
            // Clear existing options except the first one
            select.innerHTML = '<option value="">בחר קבלן/ספק</option>';
            
            // Add contractors from contractors array (use contractorId as value)
            if (contractors && contractors.length > 0) {
                contractors.forEach(contractor => {
                    const option = document.createElement('option');
                    option.value = contractor.contractorId;
                    option.textContent = contractor.name;
                    select.appendChild(option);
                });
            }
        }

        function populateNewExpenseWorkFilter() {
            const select = document.getElementById('newWorkName');
            
            // Safety check: ensure works is an array
            if (!Array.isArray(works)) {
                console.warn('🚨 works is not an array in populateNewExpenseWorkFilter, resetting');
                works = [];
            }
            
            // Clear existing options
            select.innerHTML = '<option value="">בחר עבודה (אופציונלי)</option>';
            
            if (works && works.length > 0) {
                works.forEach(work => {
                    const option = document.createElement('option');
                    option.value = work.workId;
                    
                    // Use the correct field names based on API response structure
                    const workName = work.WorkName || work.name || 'ללא שם';
                    
                    // Resolve project and contractor names from IDs if needed
                    let projectName = work.projectName || work.project;
                    let contractorName = work.contractorName || work.contractor;
                    
                    // If enhanced names are missing, resolve from IDs
                    if (!projectName && work.projectId) {
                        const project = projects.find(p => p.projectId === work.projectId);
                        projectName = project ? project.name : `Project ${work.projectId}`;
                    } else if (!projectName) {
                        projectName = 'לא זוהה';
                    }
                    
                    if (!contractorName && work.contractorId) {
                        const contractor = contractors.find(c => c.contractorId === work.contractorId);
                        contractorName = contractor ? contractor.name : `Contractor ${work.contractorId}`;
                    } else if (!contractorName) {
                        contractorName = 'לא זוהה';
                    }
                    
                    option.textContent = `${workName} - ${projectName}`;
                    option.setAttribute('data-contractor', contractorName);
                    select.appendChild(option);
                });
            }
        }

        function populateProjectInNewExpenseForm(projectName) {
            // Wait for the tab to be fully loaded
            setTimeout(() => {
                const select = document.getElementById('newProjectName');
                if (select && projectName) {
                    select.value = projectName;
                }
            }, 200);
        }

        // Initialize contractors with data from expenses
        function initializeContractors() {
            // Initialize with empty array since we removed mock data
            if (!contractors) {
                contractors = [];
            }
        }

        // Contractor form functions
        function openContractorForm() {
            document.getElementById('contractorFormModal').style.display = 'flex';
            document.getElementById('contractorForm').reset();
            document.getElementById('contractorFormMessage').innerHTML = '';
        }

        function closeContractorForm() {
            document.getElementById('contractorFormModal').style.display = 'none';
            document.getElementById('contractorForm').reset();
            document.getElementById('contractorFormMessage').innerHTML = '';
        }

        
        async function submitContractor(event) {
            event.preventDefault();
            
            // Prevent double submission
            
            const submitButton = document.querySelector('#contractorForm button[type="submit"]');
            if (submitButton) {
            }
            
            try {
                const formData = new FormData(event.target);
            const contractorData = {
                name: document.getElementById('contractorNameInput').value.trim(),
                phone: document.getElementById('contractorPhone').value.trim() || ''
            };

            // Validate required fields
            if (!contractorData.name) {
                document.getElementById('contractorFormMessage').innerHTML = 
                    '<div class="error-message">שם הקבלן/ספק הוא שדה חובה</div>';
                return;
            }

            // Check for duplicate names
            if (contractors.some(contractor => contractor.name === contractorData.name)) {
                document.getElementById('contractorFormMessage').innerHTML = 
                    '<div class="error-message">קבלן/ספק עם השם הזה כבר קיים במערכת</div>';
                return;
            }

            // Save to API first
            try {
                await saveContractor(contractorData);
                // Reload contractors from API to get consistent data structure
                await loadContractors();
            } catch (error) {
                console.error('Failed to save contractor:', error);
                // Add to local contractors array as fallback
                contractors.push(contractorData);
                showMessage('contractorFormMessage', 'שגיאה בשמירת הקבלן. נשמר מקומית.', 'warning');
            }
            
            // Show success message
            document.getElementById('contractorFormMessage').innerHTML = 
                '<div class="success-message">קבלן/ספק נוסף בהצלחה!</div>';

            // Update contractor dropdowns
            populateNewExpenseContractorFilter();
            
            // Refresh contractors grid
            renderContractorsGrid();

            // Close form after delay
            setTimeout(() => {
                closeContractorForm();
            }, 1500);
            
            } catch (error) {
                console.error('Error in submitContractor:', error);
                showMessage('contractorFormMessage', 'שגיאה בהוספת קבלן/ספק', 'error');
            } finally {
                // Re-enable submission
                const submitButton = document.querySelector('#contractorForm button[type="submit"]');
                if (submitButton) {
                }
            }
        }

        // Works form functions
        function openWorkForm() {
            document.getElementById('worksFormModal').style.display = 'flex';
            document.getElementById('worksForm').reset();
            document.getElementById('worksFormMessage').innerHTML = '';
            
            // Populate project and contractor dropdowns
            populateWorkProjectDropdown();
            populateWorkContractorDropdown();
        }

        function closeWorksForm() {
            document.getElementById('worksFormModal').style.display = 'none';
            document.getElementById('worksForm').reset();
            document.getElementById('worksFormMessage').innerHTML = '';
            document.getElementById('workContractPreview').innerHTML = '';
        }

        function populateWorkProjectDropdown() {
            const select = document.getElementById('workProject');
            select.innerHTML = '<option value="">בחר פרויקט</option>';
            
            // Safety check: ensure projects is an array
            if (!Array.isArray(projects)) {
                console.warn('🚨 projects is not an array in populateWorkProjectDropdown, resetting');
                projects = [];
            }
            
            if (projects && projects.length > 0) {
                projects.forEach(project => {
                    const option = document.createElement('option');
                    option.value = project.projectId;  // Use projectId for API call
                    option.textContent = project.name;
                    select.appendChild(option);
                });
            }
        }

        function populateWorkContractorDropdown() {
            const select = document.getElementById('workContractor');
            select.innerHTML = '<option value="">בחר קבלן/ספק</option>';
            
            // Safety check: ensure contractors is an array
            if (!Array.isArray(contractors)) {
                console.warn('🚨 contractors is not an array in populateWorkContractorDropdown, resetting');
                contractors = [];
            }
            
            if (contractors && contractors.length > 0) {
                contractors.forEach(contractor => {
                    const option = document.createElement('option');
                    option.value = contractor.contractorId;  // Use contractorId for API call
                    option.textContent = contractor.name;
                    select.appendChild(option);
                });
            }
        }

        function previewWorkContract() {
            const input = document.getElementById('workContract');
            const preview = document.getElementById('workContractPreview');
            
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    if (file.type.startsWith('image/')) {
                        preview.innerHTML = `
                            <img src="${e.target.result}" alt="תצוגה מקדימה" style="max-width: 200px; max-height: 150px; border-radius: 8px;">
                            <div class="file-name">${file.name}</div>
                        `;
                    } else {
                        preview.innerHTML = `
                            <div class="file-icon">📄</div>
                            <div class="file-name">${file.name}</div>
                        `;
                    }
                };
                reader.readAsDataURL(file);
            }
        }

        
        async function submitWork(event) {
            event.preventDefault();
            
            // Prevent double submission
            
            const submitButton = document.querySelector('#worksForm button[type="submit"]');
            if (submitButton) {
            }
            
            // Updated work data structure for multi-table architecture
            let workData;
            
            try {
                workData = {
                projectId: document.getElementById('workProject').value,      // Updated field
                contractorId: document.getElementById('workContractor').value, // Updated field
                WorkName: document.getElementById('workNameInput').value.trim(), // Updated field name
                TotalWorkCost: parseFloat(document.getElementById('workCost').value), // Updated field name
                description: document.getElementById('workDescription').value.trim(),
                status: 'planned' // Default status for new works
            };

            // DEBUG: Log the work data being sent
            console.log('🔍 DEBUG: Work data being sent:', JSON.stringify(workData, null, 2));
            console.log('🔍 DEBUG: projectId type:', typeof workData.projectId, 'value:', workData.projectId);
            console.log('🔍 DEBUG: contractorId type:', typeof workData.contractorId, 'value:', workData.contractorId);
            console.log('🔍 DEBUG: TotalWorkCost type:', typeof workData.TotalWorkCost, 'value:', workData.TotalWorkCost);

            // Validate required fields
            const missingFields = [];
            if (!workData.WorkName) missingFields.push('שם העבודה');
            if (!workData.projectId) missingFields.push('פרויקט');
            if (!workData.contractorId) missingFields.push('קבלן');
            if (!workData.TotalWorkCost || workData.TotalWorkCost <= 0) missingFields.push('עלות העבודה');
            
            if (missingFields.length > 0) {
                document.getElementById('worksFormMessage').innerHTML = 
                    `<div class="error-message">חסרים שדות חובה: ${missingFields.join(', ')}</div>`;
                return;
            }

            // Handle contract file upload
            const contractFile = document.getElementById('workContract').files[0];
            if (contractFile) {
                try {
                    const contractData = await readFileAsDataURL(contractFile);
                    workData.contract = contractData;
                } catch (error) {
                    console.error('Error reading contract file:', error);
                    document.getElementById('worksFormMessage').innerHTML = 
                        '<div class="error-message">שגיאה בהעלאת קובץ החוזה</div>';
                    return;
                }
            }

            // The backend will handle duplicate checking and foreign key validation
            // Remove client-side duplicate checking as the server has the authoritative data

        } catch (error) {
            console.error('Error in work data preparation:', error);
            document.getElementById('worksFormMessage').innerHTML = 
                '<div class="error-message">שגיאה בהכנת נתוני העבודה</div>';
            return;
        }

        try {
                await saveWork(workData);
                
                // Reload works from API to get consistent data structure
                await loadWorks();
                
                // Show success message
                document.getElementById('worksFormMessage').innerHTML = 
                    '<div class="success-message">העבודה נוספה בהצלחה!</div>';
                
                // Refresh works grid
                renderWorksGrid();
                
                // Update work dropdown in expense form
                populateNewExpenseWorkFilter();
                
                // Close form after delay
                setTimeout(() => {
                    closeWorksForm();
                }, 1500);
                
            } catch (error) {
                console.error('Error saving work:', error);
                document.getElementById('worksFormMessage').innerHTML = 
                    '<div class="error-message">שגיאה בשמירת העבודה</div>';
            } finally {
                // Re-enable submission
                const submitButton = document.querySelector('#worksForm button[type="submit"]');
                if (submitButton) {
                    submitButton.textContent = 'הוסף עבודה';
                }
            }
        }

        function renderContractorsGrid() {
            const grid = document.getElementById('contractorsGrid');
            
            // Safety check: ensure contractors is an array
            if (!Array.isArray(contractors)) {
                console.warn('🚨 contractors is not an array in renderContractorsGrid, resetting');
                contractors = [];
            }
            
            // Safety check: ensure originalMockData is an array
            if (!Array.isArray(originalMockData)) {
                console.warn('🚨 originalMockData is not an array in renderContractorsGrid, resetting');
                originalMockData = [];
            }
            
            if (contractors.length === 0) {
                grid.innerHTML = '<p class="no-data">אין קבלנים/ספקים במערכת. לחץ על "הוספת קבלן/ספק חדש" כדי להוסיף קבלן/ספק.</p>';
                return;
            }

            let html = '';
            
            contractors.forEach(contractor => {
                // Calculate payment statistics
                const contractorExpenses = originalMockData.filter(expense => {
                    // Support both old format (expense.contractor) and new format (expense.contractorId)
                    return expense.contractor === contractor.name || expense.contractorId === contractor.contractorId;
                });
                
                const totalPaid = contractorExpenses.reduce((sum, expense) => sum + (parseFloat(expense.amount) || 0), 0);
                const paymentCount = contractorExpenses.length;
                
                html += `
                    <div class="contractor-card">
                        <div class="contractor-header">
                            <button class="delete-button" style="position: absolute; top: 10px; left: 10px; z-index: 10;" onclick="event.stopPropagation(); deleteContractor('${contractor.name}')" title="מחק קבלן">🗑</button>
                            <div class="contractor-name" onclick="showContractorDetails('${contractor.contractorId}')" style="cursor: pointer;">${contractor.name}</div>
                        </div>
                        <div class="contractor-stats" onclick="showContractorDetails('${contractor.contractorId}')" style="cursor: pointer;">
                            <div class="stat-item">
                                <span class="stat-label">סך תשלומים:</span>
                                <span class="stat-value">${formatCurrency(totalPaid)}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">מספר תשלומים:</span>
                                <span class="stat-value">${paymentCount}</span>
                            </div>
                        </div>
                        ${contractor.phone ? `<div class="contractor-phone" onclick="showContractorDetails('${contractor.contractorId}')" style="cursor: pointer;">${contractor.phone}</div>` : ''}
                    </div>
                `;
            });
            
            grid.innerHTML = html;
        }

        function showContractorDetails(contractorId) {
            // Find contractor by contractorId
            let contractor = contractors.find(c => c.contractorId === contractorId);
            
            if (!contractor) {
                console.warn('Contractor not found:', contractorId);
                return;
            }

            // Get all expenses for this contractor
            const contractorExpenses = originalMockData.filter(expense => {
                // Support both old format (expense.contractor) and new format (expense.contractorId)
                return expense.contractor === contractor.name || expense.contractorId === contractorId;
            });
            
            const totalPaid = contractorExpenses.reduce((sum, expense) => sum + parseFloat(expense.amount || 0), 0);
            const paidExpenses = contractorExpenses; // All expenses are considered paid
            const pendingExpenses = []; // No pending expenses since all are paid

            // Update modal title
            document.getElementById('contractorModalTitle').textContent = contractor.name;
            document.getElementById('contractorModalSubtitle').textContent = 
                contractor.phone ? `טלפון: ${contractor.phone}` : 'רשימת הוצאות ותשלומים';

            // Generate modal body content
            let html = `
                <div class="contractor-summary-stats">
                    <div class="stat-card">
                        <div class="stat-number">${formatCurrency(totalPaid)}</div>
                        <div class="stat-label">סך הכל תשלומים</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${contractorExpenses.length}</div>
                        <div class="stat-label">מספר הוצאות</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${paidExpenses.length}</div>
                        <div class="stat-label">הוצאות ששולמו</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${pendingExpenses.length}</div>
                        <div class="stat-label">הוצאות ממתינות</div>
                    </div>
                </div>
            `;

            if (contractorExpenses.length === 0) {
                html += '<div class="no-expenses-message">אין הוצאות רשומות לקבלן/ספק זה</div>';
            } else {
                html += '<div class="expenses-section-title">רשימת הוצאות</div>';
                
                // Sort expenses by date (newest first)
                const sortedExpenses = contractorExpenses.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                sortedExpenses.forEach(expense => {
                    html += `
                        <div class="expense-item">
                            <div class="expense-header">
                                <div class="expense-project">${expense.project || (expense.projectId ? (projects.find(p => p.projectId === expense.projectId)?.name || `Project ${expense.projectId}`) : 'Unknown Project')}</div>
                                <div class="expense-amount">${formatCurrency(expense.amount)}</div>
                            </div>
                            <div class="expense-details">
                                <div class="expense-detail">
                                    <span class="detail-label">מספר חשבונית:</span>
                                    <span class="detail-value">${expense.invoiceNum}</span>
                                </div>
                                <div class="expense-detail">
                                    <span class="detail-label">תאריך:</span>
                                    <span class="detail-value">${formatDate(expense.date)}</span>
                                </div>
                                <div class="expense-detail">
                                    <span class="detail-label">סטטוס:</span>
                                    <span class="detail-value status-${expense.status}">${getStatusText(expense.status)}</span>
                                </div>
                                <div class="expense-detail">
                                    <span class="detail-label">אמצעי תשלום:</span>
                                    <span class="detail-value">${getPaymentMethodText(expense.paymentMethod)}</span>
                                </div>
                                <div class="expense-detail">
                                    <span class="detail-label">תנאי תשלום:</span>
                                    <span class="detail-value">${expense.paymentTerms}</span>
                                </div>
                                ${expense.description ? `
                                <div class="expense-detail" style="grid-column: 1 / -1;">
                                    <span class="detail-label">תיאור:</span>
                                    <span class="detail-value">${expense.description}</span>
                                </div>
                                ` : ''}
                            </div>
                            ${expense.receiptImage || expense.contractorSignature ? `
                                <div class="expense-attachments" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e2e8f0;">
                                    <div style="font-weight: bold; margin-bottom: 10px; color: #4a5568;">קבצים מצורפים:</div>
                                    <div class="attachments-grid" style="display: flex; gap: 15px; flex-wrap: wrap;">
                                        ${expense.receiptImage ? `
                                            <div class="attachment-item">
                                                <div class="attachment-label" style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">תמונת קבלה:</div>
                                                <img src="${expense.receiptImage.data}" alt="קבלה" style="max-width: 100px; max-height: 60px; border-radius: 6px; border: 1px solid #e2e8f0; cursor: pointer;" onclick="showImageModal('${expense.receiptImage.data}', '${expense.receiptImage.name}')">
                                                <div class="attachment-filename" style="font-size: 0.8rem; color: #666; margin-top: 3px;">${expense.receiptImage.name}</div>
                                            </div>
                                        ` : ''}
                                        ${expense.contractorSignature ? `
                                            <div class="attachment-item">
                                                <div class="attachment-label" style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">חתימת קבלן/ספק:</div>
                                                <img src="${expense.contractorSignature.data}" alt="חתימה" style="max-width: 100px; max-height: 60px; border-radius: 6px; border: 1px solid #e2e8f0; cursor: pointer;" onclick="showImageModal('${expense.contractorSignature.data}', '${expense.contractorSignature.name}')">
                                                <div class="attachment-filename" style="font-size: 0.8rem; color: #666; margin-top: 3px;">${expense.contractorSignature.name}</div>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
            }

            document.getElementById('contractorModalBody').innerHTML = html;
            document.getElementById('contractorExpensesModal').style.display = 'flex';
        }

        function closeContractorExpensesModal() {
            document.getElementById('contractorExpensesModal').style.display = 'none';
        }

        // Helper functions for contractor modal
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('he-IL');
        }

        function getStatusText(status) {
            // All expenses are always paid
            return 'שולם';
        }

        function getPaymentMethodText(method) {
            switch (method) {
                case 'cash': return 'מזומן';
                case 'check': return 'צ\'ק';
                case 'transfer': return 'העברה בנקאית';
                case 'credit': return 'כרטיס אשראי';
                default: return method || 'לא ידוע';
            }
        }

        function calculateWaitingAmount(projectName) {
            // Calculate waiting amount = (Total work amounts for project) - (Paid expenses associated with those works)
            
            // Get all works for this project
            const projectWorks = works.filter(work => {
                // Support both old format (work.project) and new format (work.projectId)
                const workProjectName = work.project || (work.projectId ? 
                    (projects.find(p => p.projectId === work.projectId)?.name || work.projectId) : 
                    'Unknown Project');
                return workProjectName === projectName;
            });
            
            // Calculate total work amounts
            const totalWorkAmount = projectWorks.reduce((sum, work) => {
                const workCost = parseFloat(work.TotalWorkCost || work.cost || 0);
                return sum + workCost;
            }, 0);
            
            // Get all expenses associated with these works (all expenses are considered paid)
            const paidExpensesAmount = originalMockData
                .filter(expense => {
                    // Check if this expense is associated with any work in this project
                    const expenseWorkId = expense.workId;
                    if (!expenseWorkId) return false;
                    
                    // Check if this work belongs to our project
                    const associatedWork = projectWorks.find(work => work.workId === expenseWorkId);
                    return associatedWork; // All expenses are paid, no need to check status
                })
                .reduce((sum, expense) => sum + parseFloat(expense.amount || 0), 0);
            
            // Return the waiting amount (unpaid work costs)
            return Math.max(0, totalWorkAmount - paidExpensesAmount);
        }

        function calculatePaidAmount(projectName) {
            // Calculate total amount of ALL expenses for this project (all expenses are considered paid)
            
            // Get all expenses for this project
            const projectExpenses = originalMockData.filter(expense => {
                // Support both old format (expense.project) and new format (expense.projectId)
                const expenseProjectName = expense.project || (expense.projectId ? 
                    (projects.find(p => p.projectId === expense.projectId)?.name || expense.projectId) : 
                    'Unknown Project');
                return expenseProjectName === projectName;
            });
            
            // Sum all expenses (all are considered paid)
            const totalAmount = projectExpenses.reduce((sum, expense) => sum + (parseFloat(expense.amount) || 0), 0);
            
            return totalAmount;
        }

        function hideContractorDetails() {
            document.getElementById('contractorDetails').style.display = 'none';
            document.getElementById('contractorsGrid').style.display = 'grid';
            selectedContractor = null;
        }

        function backToContractorsList() {
            hideContractorDetails();
        }

        // Works management functions
        function renderWorksGrid() {
            const grid = document.getElementById('worksGrid');
            
            // Safety check: ensure works is an array
            if (!Array.isArray(works)) {
                console.warn('🚨 works is not an array in renderWorksGrid, resetting');
                works = [];
            }
            
            if (works.length === 0) {
                grid.innerHTML = '<p class="no-data">אין עבודות במערכת. לחץ על "הוספת עבודה חדשה" כדי להוסיף עבודה.</p>';
                return;
            }
            
            let html = '';
            works.forEach(work => {
                // Calculate how much was paid from related expenses
                const workExpenses = originalMockData.filter(expense => expense.workId === work.workId);
                const totalPaid = workExpenses.reduce((sum, expense) => sum + (parseFloat(expense.amount) || 0), 0);
                const workCost = work.TotalWorkCost || work.cost || 0;
                const progressPercentage = workCost > 0 ? Math.min((totalPaid / workCost) * 100, 100) : 0;
                
                // Use enhanced names from API, or resolve from IDs as fallback
                let projectName = work.projectName;
                let contractorName = work.contractorName;
                
                // If enhanced names are missing, resolve from IDs
                if (!projectName && work.projectId) {
                    const project = projects.find(p => p.projectId === work.projectId);
                    projectName = project ? project.name : 'לא זוהה';
                } else if (!projectName) {
                    projectName = 'לא זוהה';
                }
                
                if (!contractorName && work.contractorId) {
                    const contractor = contractors.find(c => c.contractorId === work.contractorId);
                    contractorName = contractor ? contractor.name : 'לא זוהה';
                } else if (!contractorName) {
                    contractorName = 'לא זוהה';
                }
                
                html += `
                    <div class="work-card" onclick="showWorkDetails('${work.workId}')">
                        <div class="work-header">
                            <div>
                                <div class="work-name">${work.WorkName || work.name || 'ללא שם'}</div>
                                <div class="work-project">פרויקט: ${projectName}</div>
                                <div class="work-contractor">קבלן: ${contractorName}</div>
                            </div>
                            <div class="work-cost">${formatCurrency(workCost)}</div>
                            <button class="delete-button" style="position: absolute; top: 10px; left: 10px; z-index: 10;" onclick="event.stopPropagation(); deleteWork('${work.workId}')" title="מחק עבודה">🗑</button>
                        </div>
                        
                        <div class="work-progress">
                            <div class="work-progress-bar">
                                <div class="work-progress-fill" style="width: ${progressPercentage}%"></div>
                            </div>
                            <div class="work-progress-text">
                                <span>שולם: ${formatCurrency(totalPaid)}</span>
                                <span>${Math.round(progressPercentage)}%</span>
                            </div>
                        </div>
                        
                        ${work.description ? `<div class="work-description">${work.description}</div>` : ''}
                    </div>
                `;
            });
            
            grid.innerHTML = html;
        }

        async function saveWork(workData) {
            try {
                await apiCall('/works', 'POST', workData);
                // Also save to localStorage as backup
                works.push(workData);
                localStorage.setItem('construction_works', JSON.stringify(works));
            } catch (error) {
                console.warn('Failed to save work to API:', error);
                // Save to localStorage as fallback
                works.push(workData);
                localStorage.setItem('construction_works', JSON.stringify(works));
                throw error;
            }
        }

        async function loadWorks() {
            try {
                console.log('Loading works from API...');
                const result = await apiCall('/works');
                console.log('Works API result:', result);
                works = result.data?.works || result.items || [];
                console.log('Works after assignment:', works, 'isArray:', Array.isArray(works));
                return works;
            } catch (error) {
                console.warn('Failed to load works from API:', error);
                // Fallback to localStorage
                const saved = localStorage.getItem('construction_works');
                if (saved) {
                    works = JSON.parse(saved);
                }
                return works;
            }
        }

        async function deleteWork(workId) {
            if (!confirm('האם אתה בטוח שברצונך למחוק עבודה זו?')) {
                return;
            }

            try {
                // Check if work has associated expenses
                const workExpenses = originalMockData.filter(expense => expense.workId === workId);
                
                let cascadeParam = '';
                if (workExpenses.length > 0) {
                    const cascadeDelete = confirm(`לעבודה זו יש ${workExpenses.length} הוצאות קשורות. האם להמשיך ולמחוק את העבודה ולהסיר קישור העבודה מההוצאות?`);
                    if (!cascadeDelete) {
                        return;
                    }
                    cascadeParam = '?cascade=true';
                }

                // Delete from API
                await apiCall(`/works/${workId}${cascadeParam}`, 'DELETE');
                
                // Remove work from local array
                works = works.filter(work => work.workId !== workId);
                localStorage.setItem('construction_works', JSON.stringify(works));
                
                // Re-render grid
                renderWorksGrid();
                
                // Reload expenses to get updated data
                await loadExpenses();
                
                // Show success message
                console.log('Work deleted successfully');
                
            } catch (error) {
                console.error('Error deleting work:', error);
                alert('שגיאה במחיקת העבודה');
            }
        }

        function showWorkDetails(workId) {
            const work = works.find(w => w.workId === workId);
            if (!work) {
                console.warn('Work not found:', workId);
                return;
            }

            // Get all expenses for this work
            const workExpenses = originalMockData.filter(expense => expense.workId === workId);
            const totalPaid = workExpenses.reduce((sum, expense) => sum + (parseFloat(expense.amount) || 0), 0);
            const workCost = parseFloat(work.TotalWorkCost || work.cost || 0);
            const remainingBudget = workCost - totalPaid;
            const progressPercentage = workCost > 0 ? Math.min((totalPaid / workCost) * 100, 100) : 0;
            const paidExpenses = workExpenses; // All expenses are considered paid
            const pendingExpenses = []; // No pending expenses since all are paid

            // Resolve project and contractor names from IDs if needed
            const projectName = work.project || (work.projectId ? 
                (projects.find(p => p.projectId === work.projectId)?.name || `Project ${work.projectId}`) : 
                'Unknown Project');
            const contractorName = work.contractor || (work.contractorId ? 
                (contractors.find(c => c.contractorId === work.contractorId)?.name || `Contractor ${work.contractorId}`) : 
                'Unknown Contractor');

            // Update modal title
            document.getElementById('workModalTitle').textContent = work.WorkName || work.name || 'ללא שם';
            document.getElementById('workModalSubtitle').textContent = 
                `פרויקט: ${projectName} • קבלן: ${contractorName}`;

            // Generate modal body content
            let html = `
                <div class="work-summary-stats">
                    <div class="work-stat-card">
                        <div class="work-stat-number">${formatCurrency(workCost)}</div>
                        <div class="work-stat-label">תקציב מוסכם</div>
                    </div>
                    <div class="work-stat-card">
                        <div class="work-stat-number">${formatCurrency(totalPaid)}</div>
                        <div class="work-stat-label">סך ששולם</div>
                    </div>
                    <div class="work-stat-card">
                        <div class="work-stat-number">${formatCurrency(remainingBudget)}</div>
                        <div class="work-stat-label">יתרה</div>
                    </div>
                    <div class="work-stat-card">
                        <div class="work-stat-number">${workExpenses.length}</div>
                        <div class="work-stat-label">סך הוצאות</div>
                    </div>
                </div>

                <div class="work-progress-section">
                    <div class="work-progress-title">התקדמות תשלומים</div>
                    <div class="work-progress-bar-large">
                        <div class="work-progress-fill-large" style="width: ${progressPercentage}%"></div>
                    </div>
                    <div class="work-progress-text-large">
                        <span>${Math.round(progressPercentage)}% מהתקציב שולם</span>
                        <span>${formatCurrency(totalPaid)} מתוך ${formatCurrency(work.cost)}</span>
                    </div>
                </div>

                ${work.description ? `
                    <div style="background: #f0f4f8; border-radius: 10px; padding: 15px; margin-bottom: 25px;">
                        <h4 style="margin: 0 0 10px 0; color: #2d3748;">תיאור העבודה:</h4>
                        <p style="margin: 0; color: #4a5568; line-height: 1.6;">${work.description}</p>
                    </div>
                ` : ''}

                ${work.contract ? `
                    <div style="background: #e6fffa; border-radius: 10px; padding: 15px; margin-bottom: 25px; border-left: 4px solid #38b2ac;">
                        <h4 style="margin: 0 0 10px 0; color: #2d3748;">חוזה/מסמך:</h4>
                        ${work.contract.data.startsWith('data:image') ? 
                            `<img src="${work.contract.data}" alt="חוזה" style="max-width: 200px; max-height: 150px; border-radius: 8px; cursor: pointer;" onclick="showImageModal('${work.contract.data}', '${work.contract.name}')">` :
                            `<div style="display: flex; align-items: center; gap: 10px;">
                                <div style="font-size: 2rem;">📄</div>
                                <div>${work.contract.name}</div>
                            </div>`
                        }
                    </div>
                ` : ''}
            `;

            if (workExpenses.length === 0) {
                html += '<div class="work-expenses-section">';
                html += '<div class="work-expenses-title">הוצאות קשורות</div>';
                html += '<div style="text-align: center; color: #718096; padding: 40px;">עדיין לא הוגשו הוצאות לעבודה זו</div>';
                html += '</div>';
            } else {
                html += '<div class="work-expenses-section">';
                html += '<div class="work-expenses-title">הוצאות קשורות</div>';
                
                // Sort expenses by date (newest first)
                const sortedExpenses = workExpenses.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                sortedExpenses.forEach(expense => {
                    html += `
                        <div class="expense-item" style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <div class="expense-header" style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                                <div>
                                    <div style="font-weight: bold; font-size: 1.1rem; color: #2d3748; margin-bottom: 5px;">#${expense.invoiceNum}</div>
                                    <div style="color: #718096; font-size: 0.9rem;">${formatDate(expense.date)}</div>
                                </div>
                                <div style="font-size: 1.3rem; font-weight: bold; color: #38a169;">${formatCurrency(expense.amount)}</div>
                            </div>
                            <div class="expense-details" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                <div class="expense-detail">
                                    <span style="color: #718096; font-size: 0.9rem;">סטטוס:</span>
                                    <span style="color: #2d3748; font-weight: 500;" class="status-${expense.status}">${getStatusText(expense.status)}</span>
                                </div>
                                <div class="expense-detail">
                                    <span style="color: #718096; font-size: 0.9rem;">אמצעי תשלום:</span>
                                    <span style="color: #2d3748; font-weight: 500;">${getPaymentMethodText(expense.paymentMethod)}</span>
                                </div>
                                <div class="expense-detail">
                                    <span style="color: #718096; font-size: 0.9rem;">תנאי תשלום:</span>
                                    <span style="color: #2d3748; font-weight: 500;">${expense.paymentTerms}</span>
                                </div>
                                ${expense.description ? `
                                <div class="expense-detail" style="grid-column: 1 / -1;">
                                    <span style="color: #718096; font-size: 0.9rem;">תיאור:</span>
                                    <span style="color: #2d3748;">${expense.description}</span>
                                </div>
                                ` : ''}
                            </div>
                            ${expense.receiptImage || expense.contractorSignature ? `
                                <div class="expense-attachments" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e2e8f0;">
                                    <div style="font-weight: bold; margin-bottom: 10px; color: #4a5568;">קבצים מצורפים:</div>
                                    <div class="attachments-grid" style="display: flex; gap: 15px; flex-wrap: wrap;">
                                        ${expense.receiptImage ? `
                                            <div class="attachment-item">
                                                <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">תמונת קבלה:</div>
                                                <img src="${expense.receiptImage.data}" alt="קבלה" style="max-width: 80px; max-height: 50px; border-radius: 6px; border: 1px solid #e2e8f0; cursor: pointer;" onclick="showImageModal('${expense.receiptImage.data}', '${expense.receiptImage.name}')">
                                                <div style="font-size: 0.8rem; color: #666; margin-top: 3px;">${expense.receiptImage.name}</div>
                                            </div>
                                        ` : ''}
                                        ${expense.contractorSignature ? `
                                            <div class="attachment-item">
                                                <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">חתימת קבלן:</div>
                                                <img src="${expense.contractorSignature.data}" alt="חתימה" style="max-width: 80px; max-height: 50px; border-radius: 6px; border: 1px solid #e2e8f0; cursor: pointer;" onclick="showImageModal('${expense.contractorSignature.data}', '${expense.contractorSignature.name}')">
                                                <div style="font-size: 0.8rem; color: #666; margin-top: 3px;">${expense.contractorSignature.name}</div>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                
                html += '</div>';
            }

            document.getElementById('workModalBody').innerHTML = html;
            document.getElementById('workDetailsModal').style.display = 'flex';
        }

        function closeWorkDetailsModal() {
            document.getElementById('workDetailsModal').style.display = 'none';
        }

        // Close modals when clicking outside
        document.addEventListener('click', function(event) {
            const projectModal = document.getElementById('projectFormModal');
            const contractorModal = document.getElementById('contractorFormModal');
            const contractorExpensesModal = document.getElementById('contractorExpensesModal');
            const worksModal = document.getElementById('worksFormModal');
            const workDetailsModal = document.getElementById('workDetailsModal');
            
            if (event.target === projectModal) {
                closeProjectForm();
            }
            
            if (event.target === contractorModal) {
                closeContractorForm();
            }
            
            if (event.target === contractorExpensesModal) {
                closeContractorExpensesModal();
            }
            
            if (event.target === worksModal) {
                closeWorksForm();
            }
            
            if (event.target === workDetailsModal) {
                closeWorkDetailsModal();
            }
        });

        function populateProjectFilter() {
            const select = document.getElementById('projectFilter');
            
            // Safety check: ensure projects is an array
            if (!Array.isArray(projects)) {
                console.warn('🚨 projects is not an array in populateProjectFilter, resetting');
                projects = [];
            }
            
            // Clear existing options except the first one
            select.innerHTML = '<option value="">כל הפרויקטים</option>';
            
            // Add projects from projects array
            if (projects && projects.length > 0) {
                projects.forEach(project => {
                    const option = document.createElement('option');
                    option.value = project.name;
                    option.textContent = project.name;
                    select.appendChild(option);
                });
            }
            
            // Also add projects from expenses (if any)
            const expenseProjects = [...new Set(originalMockData.map(expense => expense.project))];
            expenseProjects.forEach(projectName => {
                // Check if already added from projects array
                if (!projects || !projects.find(p => p.name === projectName)) {
                    const option = document.createElement('option');
                    option.value = projectName;
                    option.textContent = projectName;
                    select.appendChild(option);
                }
            });
        }

        function filterByProject() {
            const selectedProject = document.getElementById('projectFilter').value;
            const filterControls = document.getElementById('filterControls');
            
            currentFilter = selectedProject;
            
            if (selectedProject) {
                mockData = originalMockData.filter(expense => expense.project === selectedProject);
                filterControls.classList.add('filter-active');
            } else {
                mockData = [...originalMockData];
                filterControls.classList.remove('filter-active');
            }
            
            renderExpenses();
        }

        function resetFilter() {
            document.getElementById('projectFilter').value = '';
            document.getElementById('filterControls').classList.remove('filter-active');
            document.getElementById('projectSummary').style.display = 'none';
            currentFilter = '';
            mockData = [...originalMockData];
            renderExpenses();
        }

        function showProjectSummary() {
            const summaryDiv = document.getElementById('projectSummary');
            const projects = {};
            
            // Group expenses by project
            originalMockData.forEach(expense => {
                if (!projects[expense.project]) {
                    projects[expense.project] = {
                        name: expense.project,
                        totalAmount: 0,
                        expenseCount: 0,
                        expenses: []
                    };
                }
                
                projects[expense.project].totalAmount += expense.amount;
                projects[expense.project].expenseCount++;
                projects[expense.project].expenses.push(expense);
            });
            
            let summaryHtml = `
                <div class="project-summary">
                    <div class="project-summary-title">סיכום הוצאות לפי פרויקט</div>
            `;
            
            Object.values(projects).forEach(project => {
                summaryHtml += `
                    <div class="project-item">
                        <div>
                            <div class="project-name-summary">${project.name}</div>
                            <div class="project-stats">
                                <small>${project.expenseCount} הוצאות</small>
                            </div>
                        </div>
                        <div class="project-amount">${formatCurrency(project.totalAmount)}</div>
                    </div>
                `;
            });
            
            const totalAll = Object.values(projects).reduce((sum, project) => sum + project.totalAmount, 0);
            const totalExpenses = Object.values(projects).reduce((sum, project) => sum + project.expenseCount, 0);
            
            summaryHtml += `
                    <div class="project-item" style="border-left-color: #e53e3e; background: #fed7d7;">
                        <div>
                            <div class="project-name-summary">סך הכל</div>
                            <div class="project-stats">
                                <small>${Object.keys(projects).length} פרויקטים, ${totalExpenses} הוצאות</small>
                            </div>
                        </div>
                        <div class="project-amount" style="color: #c53030;">${formatCurrency(totalAll)}</div>
                    </div>
                </div>
            `;
            
            summaryDiv.innerHTML = summaryHtml;
            summaryDiv.style.display = 'block';
        }

        function renderExpenses() {
            const container = document.getElementById('expensesList');
            
            if (!mockData || mockData.length === 0) {
                container.innerHTML = '<p class="error">לא נמצאו הוצאות</p>';
                return;
            }

            let html = '';
            let totalAmount = 0;

            mockData.forEach(expense => {
                totalAmount += expense.amount;
                html += `
                    <div class="expense-card">
                        <div class="expense-header">
                            <div class="expense-actions">
                                <button class="delete-button" onclick="deleteExpense('${expense.expenseId}')" title="מחק הוצאה">🗑</button>
                            </div>
                            <div class="project-name">${expense.projectName || expense.project || 'פרויקט לא ידוע'}</div>
                            <div class="amount">${formatCurrency(expense.amount)}</div>
                        </div>
                        <div class="expense-details">
                            <div class="detail-item">
                                <span class="detail-label">קבלן/ספק:</span>
                                <span class="detail-value">${expense.contractorName || expense.contractor || 'קבלן לא ידוע'}</span>
                                ${expense.contractorPhone ? `<span class="detail-extra"> (${expense.contractorPhone})</span>` : ''}
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">מספר חשבונית:</span>
                                <span class="detail-value">${expense.invoiceNum}</span>
                            </div>
                            <div class="detail-item">
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">אמצעי תשלום:</span>
                                <span class="detail-value">${expense.paymentMethod}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">תאריך:</span>
                                <span class="detail-value">${expense.date}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">סטטוס:</span>
                                <span class="status-badge status-${expense.status}">${getStatusText(expense.status)}</span>
                            </div>
                        </div>
                        ${expense.description ? `<p style="margin-top: 10px; color: #666;"><strong>תיאור:</strong> ${expense.description}</p>` : ''}
                        ${expense.receiptImage || expense.contractorSignature ? `
                            <div class="expense-attachments" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e2e8f0;">
                                <div style="font-weight: bold; margin-bottom: 10px; color: #4a5568;">קבצים מצורפים:</div>
                                <div class="attachments-grid" style="display: flex; gap: 15px; flex-wrap: wrap;">
                                    ${expense.receiptImage ? `
                                        <div class="attachment-item">
                                            <div class="attachment-label" style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">תמונת קבלה:</div>
                                            <img src="${expense.receiptImage.data}" alt="קבלה" style="max-width: 150px; max-height: 100px; border-radius: 6px; border: 1px solid #e2e8f0; cursor: pointer;" onclick="showImageModal('${expense.receiptImage.data}', '${expense.receiptImage.name}')">
                                            <div class="attachment-filename" style="font-size: 0.8rem; color: #666; margin-top: 3px;">${expense.receiptImage.name}</div>
                                        </div>
                                    ` : ''}
                                    ${expense.contractorSignature ? `
                                        <div class="attachment-item">
                                            <div class="attachment-label" style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">חתימת קבלן/ספק:</div>
                                            <img src="${expense.contractorSignature.data}" alt="חתימה" style="max-width: 150px; max-height: 100px; border-radius: 6px; border: 1px solid #e2e8f0; cursor: pointer;" onclick="showImageModal('${expense.contractorSignature.data}', '${expense.contractorSignature.name}')">
                                            <div class="attachment-filename" style="font-size: 0.8rem; color: #666; margin-top: 3px;">${expense.contractorSignature.name}</div>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            });

            const summaryTitle = currentFilter ? 
                `סיכום עבור פרויקט: ${currentFilter}` : 
                'סיכום כולל';
            
            const summaryText = currentFilter ? 
                `${mockData.length} הוצאות בפרויקט זה` : 
                `סך הכל ${mockData.length} הוצאות בסיסטם`;

            html += `
                <div class="expense-card" style="border-left-color: #38a169;">
                    <div class="expense-header">
                        <div class="project-name">${summaryTitle}</div>
                        <div class="amount">${formatCurrency(totalAmount)}</div>
                    </div>
                    <p>${summaryText}</p>
                </div>
            `;

            container.innerHTML = html;
        }
        
        // Delete Functions
        async function deleteExpense(expenseId) {
            if (confirm('האם אתה בטוח שברצונך למחוק הוצאה זו?')) {
                const index = originalMockData.findIndex(expense => expense.expenseId === expenseId);
                if (index > -1) {
                    originalMockData.splice(index, 1);
                    mockData = [...originalMockData];
                    
                    try {
                        await deleteExpenseAPI(expenseId);
                        showMessage('ההוצאה נמחקה בהצלחה!', 'success');
                    } catch (error) {
                        console.error('Failed to delete expense from API:', error);
                        showMessage('שגיאה במחיקת ההוצאה מהשרת. נמחקה מקומית.', 'warning');
                    }
                    
                    renderExpenses();
                }
            }
        }
        
        async function deleteProject(projectName) {
            if (confirm('האם אתה בטוח שברצונך למחוק פרויקט זה? זה ימחק גם את כל ההוצאות שלו.')) {
                // Safety check: ensure projects is an array
                if (!Array.isArray(projects)) {
                    console.warn('🚨 projects is not an array in deleteProject, resetting');
                    projects = [];
                }
                
                // Find project by name to get ID
                const project = projects.find(p => p.name === projectName);
                if (!project) {
                    showMessage('שגיאה: פרויקט לא נמצא', 'error');
                    return;
                }

                try {
                    // Delete from API
                    await deleteProjectAPI(project.projectId);
                    
                    // Remove from local data after successful API call
                    originalMockData = originalMockData.filter(expense => expense.project !== projectName);
                    mockData = [...originalMockData];
                    projects = projects.filter(p => p.name !== projectName);
                    
                    // Save to localStorage
                    saveToStorage();
                    
                    renderProjectsGrid();
                    showMessage('הפרויקט וכל ההוצאות שלו נמחקו בהצלחה!', 'success');
                    
                } catch (error) {
                    console.error('Failed to delete project:', error);
                    showMessage('שגיאה במחיקת הפרויקט מהשרת', 'error');
                }
            }
        }
        
        async function deleteContractor(contractorName) {
            if (confirm('האם אתה בטוח שברצונך למחוק קבלן זה?')) {
                // Safety check: ensure contractors is an array
                if (!Array.isArray(contractors)) {
                    console.warn('🚨 contractors is not an array in deleteContractor, resetting');
                    contractors = [];
                }
                
                // Find contractor by name to get ID
                const contractor = contractors.find(c => c.name === contractorName);
                if (!contractor) {
                    showMessage('שגיאה: קבלן לא נמצא', 'error');
                    return;
                }

                try {
                    // Delete from API
                    await deleteContractorAPI(contractor.contractorId);
                    
                    // Remove from local data after successful API call
                    contractors = contractors.filter(c => c.name !== contractorName);
                    
                    // Save to localStorage
                    saveToStorage();
                    
                    renderContractorsGrid();
                    showMessage('הקבלן נמחק בהצלחה!', 'success');
                    
                } catch (error) {
                    console.error('Failed to delete contractor:', error);
                    showMessage('שגיאה במחיקת הקבלן מהשרת', 'error');
                }
            }
        }
        
        function showMessage(message, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = type;
            messageDiv.textContent = message;
            messageDiv.style.position = 'fixed';
            messageDiv.style.top = '20px';
            messageDiv.style.right = '20px';
            messageDiv.style.zIndex = '10000';
            messageDiv.style.padding = '15px';
            messageDiv.style.borderRadius = '8px';
            messageDiv.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)';
            
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                document.body.removeChild(messageDiv);
            }, 3000);
        }


        // Setup UI event listeners on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Setup tab navigation event listeners
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabName = button.dataset.tab;
                    if (typeof switchTab === 'function') {
                        switchTab(tabName);
                    } else {
                        console.error('switchTab function not found');
                    }
                });
            });
            
            // Setup add-expense-button event listeners
            const addExpenseButtons = document.querySelectorAll('.add-expense-button');
            addExpenseButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabName = button.dataset.tab;
                    if (typeof switchTab === 'function') {
                        switchTab(tabName);
                    }
                });
            });
            
            console.log('UI event listeners initialized');
        });
    </script>
</body>
</html>