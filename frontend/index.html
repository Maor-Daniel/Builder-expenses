<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××¢×¨×›×ª ××¢×§×‘ ×”×•×¦××•×ª ×‘× ×™×”</title>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Rubik', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            color: #1a202c;
        }

        /* Clerk Auth Container */
        #clerkAuthContainer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #ffffff;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .clerk-loading {
            text-align: center;
            color: #4a5568;
        }

        .clerk-loading h2 {
            font-size: 1.5rem;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .spinner {
            border: 3px solid #e2e8f0;
            border-radius: 50%;
            border-top: 3px solid #3182ce;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Main App Container */
        #mainContent {
            display: none;
            width: 100%;
        }

        /* Header */
        .header {
            background: #ffffff;
            padding: 20px 40px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #1a202c;
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header h1 i {
            color: #3182ce;
            font-size: 1.3rem;
        }

        /* User Info */
        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-details {
            text-align: left;
        }

        .user-name {
            font-weight: 500;
            color: #2d3748;
            font-size: 1rem;
        }

        .company-name {
            font-size: 0.85rem;
            color: #718096;
        }

        .user-menu {
            display: flex;
            gap: 10px;
        }

        .btn-user {
            padding: 8px 16px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
            background: #ffffff;
        }

        .btn-profile {
            color: #3182ce;
            border-color: #3182ce;
        }

        .btn-profile:hover {
            background: #3182ce;
            color: white;
        }

        .btn-org {
            color: #38a169;
            border-color: #38a169;
        }

        .btn-org:hover {
            background: #38a169;
            color: white;
        }

        .btn-signout {
            color: #e53e3e;
            border-color: #e53e3e;
        }

        .btn-signout:hover {
            background: #e53e3e;
            color: white;
        }

        /* Main Container */
        .container {
            padding: 30px;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        /* Dashboard Cards */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
            transition: all 0.2s;
        }

        .card:hover {
            border-color: #cbd5e0;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        .card-icon {
            font-size: 1.25rem;
            margin-bottom: 12px;
            color: #718096;
        }

        .card-title {
            color: #718096;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .card-value {
            color: #1a202c;
            font-size: 2rem;
            font-weight: 700;
            line-height: 1;
        }

        /* Tabs */
        .tabs {
            background: white;
            border-radius: 12px;
            padding: 8px;
            margin-bottom: 24px;
            display: flex;
            gap: 4px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
        }

        .tab-button {
            padding: 10px 20px;
            border: none;
            background: transparent;
            color: #718096;
            cursor: pointer;
            border-radius: 8px;
            font-size: 0.9375rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .tab-button.active {
            background: #3182ce;
            color: white;
        }

        .tab-button:hover:not(.active) {
            background: #f7fafc;
            color: #4a5568;
        }

        /* Content Area */
        .content-area {
            background: white;
            border-radius: 12px;
            padding: 32px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
            min-height: 500px;
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #4a5568;
            font-weight: 500;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3182ce;
            box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.1);
        }

        .btn-primary {
            background: #3182ce;
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 8px;
            font-size: 0.9375rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .btn-primary:hover {
            background: #2c5282;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Message */
        .message {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .message.success {
            background: #c6f6d5;
            color: #22543d;
            border-left: 4px solid #48bb78;
        }

        .message.error {
            background: #fed7d7;
            color: #742a2a;
            border-left: 4px solid #f56565;
        }

        /* Table */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 24px;
        }

        th {
            background: #f7fafc;
            padding: 14px 16px;
            text-align: right;
            color: #4a5568;
            font-weight: 600;
            font-size: 0.875rem;
            border-bottom: 1px solid #e2e8f0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            padding: 16px;
            border-bottom: 1px solid #f0f0f0;
            color: #1a202c;
            font-size: 0.9375rem;
        }

        tr:hover {
            background: #fafafa;
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        /* Action Buttons */
        .btn-edit, .btn-delete {
            padding: 6px 16px;
            background: white;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            margin: 0 4px;
            font-family: 'Rubik', sans-serif;
        }

        .btn-edit {
            border: 1.5px solid #1a202c;
            color: #1a202c;
        }

        .btn-edit:hover {
            background: #1a202c;
            color: white;
        }

        .btn-delete {
            border: 1.5px solid #e53e3e;
            color: #e53e3e;
        }

        .btn-delete:hover {
            background: #c53030;
            border-color: #c53030;
            color: white;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: #718096;
        }

        .loading i {
            font-size: 3rem;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 32px;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            animation: slideDown 0.3s;
            border: 1px solid #e2e8f0;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-content h2 {
            color: #1a202c;
            margin-bottom: 28px;
            font-size: 1.5rem;
            font-weight: 700;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 16px;
        }

        .close {
            color: #718096;
            float: left;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close:hover,
        .close:focus {
            color: #2d3748;
        }

        .modal-content form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .modal-content .form-group {
            margin-bottom: 0;
        }

        .modal-content label {
            display: block;
            margin-bottom: 6px;
            color: #4a5568;
            font-weight: 500;
            font-size: 0.875rem;
        }

        .modal-content input,
        .modal-content select,
        .modal-content textarea {
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 1rem;
            font-family: 'Rubik', sans-serif;
            transition: border-color 0.3s;
        }

        .modal-content input[type="file"] {
            padding: 8px;
            cursor: pointer;
        }

        .modal-content input[type="file"]::file-selector-button {
            background: #3182ce;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
            font-family: 'Rubik', sans-serif;
        }

        .modal-content input[type="file"]::file-selector-button:hover {
            background: #2c5aa0;
        }

        .modal-content input:focus,
        .modal-content select:focus,
        .modal-content textarea:focus {
            outline: none;
            border-color: #3182ce;
            box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.1);
        }

        .modal-content textarea {
            min-height: 100px;
            resize: vertical;
        }

        .modal-content button[type="submit"] {
            background: #3182ce;
            color: white;
            padding: 11px 24px;
            border: none;
            border-radius: 8px;
            font-size: 0.9375rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .modal-content button[type="submit"]:hover {
            background: #2c5282;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .modal-content button[type="button"] {
            background: #ffffff;
            color: #4a5568;
            padding: 11px 24px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.9375rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-content button[type="button"]:hover {
            background: #f7fafc;
            border-color: #cbd5e0;
        }

        /* Charts and Reports */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.08);
        }

        .metric-icon {
            width: 48px;
            height: 48px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 12px;
        }

        .metric-icon.blue { background: #dbeafe; color: #3182ce; }
        .metric-icon.green { background: #d1fae5; color: #10b981; }
        .metric-icon.purple { background: #e9d5ff; color: #9333ea; }
        .metric-icon.orange { background: #fed7aa; color: #f97316; }

        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: #1a202c;
            margin: 8px 0;
        }

        .metric-label {
            color: #718096;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .metric-change {
            font-size: 0.875rem;
            margin-top: 8px;
            font-weight: 500;
        }

        .metric-change.positive { color: #10b981; }
        .metric-change.negative { color: #ef4444; }

        .chart-container {
            background: white;
            padding: 24px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
            margin-bottom: 24px;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1a202c;
        }

        .chart-canvas {
            position: relative;
            height: 300px;
        }

        .reports-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 24px;
        }

        .report-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.2s;
        }

        .report-card:hover {
            border-color: #3182ce;
            box-shadow: 0 4px 6px rgba(0,0,0,0.08);
        }

        .report-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin-bottom: 12px;
            background: #dbeafe;
            color: #3182ce;
        }

        .report-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1a202c;
            margin-bottom: 8px;
        }

        .report-description {
            font-size: 0.875rem;
            color: #718096;
        }

        .filter-bar {
            background: white;
            padding: 16px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            margin-bottom: 20px;
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-bar label {
            margin: 0;
            font-size: 0.875rem;
        }

        .filter-bar select, .filter-bar input {
            padding: 8px 12px;
            font-size: 0.875rem;
            min-width: 150px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            background: #3182ce;
            transition: width 0.3s;
        }

        .progress-fill.warning { background: #f97316; }
        .progress-fill.danger { background: #ef4444; }

        .budget-table {
            width: 100%;
            margin-top: 20px;
        }

        .budget-table td {
            padding: 12px;
        }

        .alert-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .alert-badge.success { background: #d1fae5; color: #065f46; }
        .alert-badge.warning { background: #fed7aa; color: #9a3412; }
        .alert-badge.danger { background: #fee2e2; color: #991b1b; }
    </style>
</head>
<body>
    <!-- Clerk Auth Container -->
    <div id="clerkAuthContainer">
        <div class="clerk-loading">
            <h2>××¢×¨×›×ª ××¢×§×‘ ×”×•×¦××•×ª ×‘× ×™×”</h2>
            <div class="spinner"></div>
            <p>×××ª×—×œ ××¢×¨×›×ª ××‘×˜×—×”...</p>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainContent">
        <div class="header">
            <h1>
                <i class="fas fa-hard-hat"></i>
                ××¢×¨×›×ª ××¢×§×‘ ×”×•×¦××•×ª ×‘× ×™×”
            </h1>
            <div class="user-info" id="userInfo">
                <div class="user-details">
                    <div class="user-name" id="userName">×˜×•×¢×Ÿ...</div>
                    <div class="company-name" id="companyName">×˜×•×¢×Ÿ...</div>
                </div>
                <div class="user-menu">
                    <button class="btn-user btn-profile" onclick="ClerkAuth.showUserProfile()">
                        <i class="fas fa-user"></i> ×¤×¨×•×¤×™×œ
                    </button>
                    <button class="btn-user btn-org" onclick="ClerkAuth.showOrganizationSwitcher()">
                        <i class="fas fa-building"></i> ×”×—×œ×£ ×—×‘×¨×”
                    </button>
                    <button class="btn-user btn-signout" onclick="signOut()">
                        <i class="fas fa-sign-out-alt"></i> ×™×¦×™××”
                    </button>
                </div>
            </div>
        </div>

        <div class="container">
            <!-- Dashboard Cards -->
            <div class="dashboard-cards">
                <div class="card">
                    <div class="card-icon">ğŸ’°</div>
                    <div class="card-title">×¡×”"×› ×”×•×¦××•×ª</div>
                    <div class="card-value" id="totalExpenses">â‚ª0</div>
                </div>
                <div class="card">
                    <div class="card-icon">ğŸ—ï¸</div>
                    <div class="card-title">×¤×¨×•×™×§×˜×™× ×¤×¢×™×œ×™×</div>
                    <div class="card-value" id="activeProjects">0</div>
                </div>
                <div class="card">
                    <div class="card-icon">ğŸ‘·</div>
                    <div class="card-title">×§×‘×œ× ×™×</div>
                    <div class="card-value" id="totalContractors">0</div>
                </div>
                <div class="card">
                    <div class="card-icon">ğŸ“Š</div>
                    <div class="card-title">×”×•×¦××•×ª ×”×—×•×“×©</div>
                    <div class="card-value" id="monthlyExpenses">â‚ª0</div>
                </div>
            </div>

            <!-- Main Tabs -->
            <div class="tabs">
                <button class="tab-button active" onclick="showTab('expenses')">
                    <i class="fas fa-receipt"></i> ×”×•×¦××•×ª
                </button>
                <button class="tab-button" onclick="showTab('projects')">
                    <i class="fas fa-project-diagram"></i> ×¤×¨×•×™×§×˜×™×
                </button>
                <button class="tab-button" onclick="showTab('contractors')">
                    <i class="fas fa-users"></i> ×§×‘×œ× ×™×
                </button>
                <button class="tab-button" onclick="showTab('works')">
                    <i class="fas fa-hammer"></i> ×¢×‘×•×“×•×ª
                </button>
                <button class="tab-button" onclick="showTab('reports')">
                    <i class="fas fa-chart-bar"></i> ×“×•×—×•×ª
                </button>
                <button class="tab-button" onclick="showTab('billing')">
                    <i class="fas fa-credit-card"></i> ×—×™×•×‘ ×•×× ×•×™
                </button>
            </div>

            <!-- Content Area -->
            <div class="content-area">
                <div id="messageArea" class="message"></div>
                <div id="tabContent">
                    <!-- Tab content will be loaded here -->
                    <div class="loading">
                        <i class="fas fa-spinner"></i>
                        <p>×˜×•×¢×Ÿ × ×ª×•× ×™×...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Forms -->
    <div id="projectModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('projectModal')">&times;</span>
            <h2>×”×•×¡×£ ×¤×¨×•×™×§×˜ ×—×“×©</h2>
            <form id="projectForm" onsubmit="submitProject(event)">
                <input type="text" id="projectName" placeholder="×©× ×¤×¨×•×™×§×˜ *" required>
                <textarea id="projectDescription" placeholder="×ª×™××•×¨" rows="3"></textarea>
                <div class="form-group">
                    <label for="projectStartDate">×ª××¨×™×š ×”×ª×—×œ×” *</label>
                    <input type="date" id="projectStartDate" required>
                </div>
                <div class="form-group">
                    <label for="projectEndDate">×ª××¨×™×š ×¡×™×•×</label>
                    <input type="date" id="projectEndDate">
                </div>
                <input type="number" id="projectBudget" placeholder="×ª×§×¦×™×‘" step="0.01">
                <input type="text" id="projectLocation" placeholder="××™×§×•×">
                <input type="text" id="projectClient" placeholder="×©× ×œ×§×•×—">
                <button type="submit" class="btn-primary">×©××•×¨</button>
                <button type="button" class="btn-secondary" onclick="closeModal('projectModal')">×‘×™×˜×•×œ</button>
            </form>
        </div>
    </div>

    <div id="contractorModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('contractorModal')">&times;</span>
            <h2>×”×•×¡×£ ×§×‘×œ×Ÿ ×—×“×©</h2>
            <form id="contractorForm" onsubmit="submitContractor(event)">
                <input type="text" id="contractorName" placeholder="×©× ×§×‘×œ×Ÿ *" required>
                <input type="tel" id="contractorPhone" placeholder="×˜×œ×¤×•×Ÿ">
                <input type="text" id="contractorSpecialty" placeholder="×”×ª××—×•×ª">
                <button type="submit" class="btn-primary">×©××•×¨</button>
                <button type="button" class="btn-secondary" onclick="closeModal('contractorModal')">×‘×™×˜×•×œ</button>
            </form>
        </div>
    </div>

    <div id="workModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('workModal')">&times;</span>
            <h2>×”×•×¡×£ ×¢×‘×•×“×” ×—×“×©×”</h2>
            <form id="workForm" onsubmit="submitWork(event)">
                <input type="text" id="workName" placeholder="×©× ×¢×‘×•×“×” *" required>
                <select id="workProjectId" required>
                    <option value="">×‘×—×¨ ×¤×¨×•×™×§×˜ *</option>
                </select>
                <select id="workContractorId" required>
                    <option value="">×‘×—×¨ ×§×‘×œ×Ÿ *</option>
                </select>
                <input type="number" id="workCost" placeholder="×¢×œ×•×ª ×›×•×œ×œ×ª *" step="0.01" required>
                <textarea id="workDescription" placeholder="×ª×™××•×¨" rows="3"></textarea>
                <button type="submit" class="btn-primary">×©××•×¨</button>
                <button type="button" class="btn-secondary" onclick="closeModal('workModal')">×‘×™×˜×•×œ</button>
            </form>
        </div>
    </div>

    <div id="expenseModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('expenseModal')">&times;</span>
            <h2>×”×•×¡×£ ×”×•×¦××” ×—×“×©×”</h2>
            <form id="expenseForm" onsubmit="submitExpense(event)">
                <input type="text" id="expenseDescription" placeholder="×ª×™××•×¨ *" required>
                <input type="number" id="expenseAmount" placeholder="×¡×›×•× *" step="0.01" required>
                <input type="date" id="expenseDate" placeholder="×ª××¨×™×š *" required>
                <input type="text" id="expenseInvoice" placeholder="××¡×¤×¨ ×—×©×‘×•× ×™×ª *" required>
                <div class="form-group">
                    <label for="expenseReceipt">×ª××•× ×ª ×—×©×‘×•× ×™×ª / ×§×‘×œ×”</label>
                    <input type="file" id="expenseReceipt" accept="image/*,application/pdf">
                    <small id="receiptPreview" style="display: none; color: #3182ce; margin-top: 5px;"></small>
                </div>
                <select id="expensePayment" required>
                    <option value="">×××¦×¢×™ ×ª×©×œ×•× *</option>
                    <option value="Cash">××–×•××Ÿ</option>
                    <option value="Credit Card">×›×¨×˜×™×¡ ××©×¨××™</option>
                    <option value="Bank Transfer">×”×¢×‘×¨×” ×‘× ×§××™×ª</option>
                    <option value="Check">×”××—××”</option>
                </select>
                <select id="expenseWorkId" onchange="onWorkSelected()">
                    <option value="">×‘×—×¨ ×¢×‘×•×“×” (×××œ× ××•×˜×•××˜×™×ª ×¤×¨×•×™×§×˜ ×•×§×‘×œ×Ÿ)</option>
                </select>
                <select id="expenseProjectId">
                    <option value="">×‘×—×¨ ×¤×¨×•×™×§×˜ (××•×¤×¦×™×•× ×œ×™)</option>
                </select>
                <select id="expenseContractorId">
                    <option value="">×‘×—×¨ ×§×‘×œ×Ÿ (××•×¤×¦×™×•× ×œ×™)</option>
                </select>
                <button type="submit" class="btn-primary">×©××•×¨</button>
                <button type="button" class="btn-secondary" onclick="closeModal('expenseModal')">×‘×™×˜×•×œ</button>
            </form>
        </div>
    </div>

    <!-- Clerk Configuration -->
    <script>
        // Clerk Configuration
        window.CLERK_PUBLISHABLE_KEY = 'pk_test_bW92ZWQtaHVza3ktOTguY2xlcmsuYWNjb3VudHMuZGV2JA';
        window.CLERK_FRONTEND_API = 'https://Builder-expenses.clerk.accounts.dev';

        // API Configuration
        const API_CONFIG = {
            endpoint: 'https://2woj5i92td.execute-api.us-east-1.amazonaws.com/prod'
        };

        // Application State
        let currentUser = null;
        let currentOrganization = null;
        let authToken = null;
        let currentTab = 'expenses'; // Track current active tab
        let appData = {
            expenses: [],
            projects: [],
            contractors: [],
            works: []
        };
    </script>

    <!-- Clerk Authentication Module -->
    <script src="clerk-auth.js"></script>

    <!-- Main Application Script -->
    <script>
        // Initialize Clerk when page loads
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Initialize Clerk
                await ClerkAuth.initialize();

                // Check authentication status
                if (ClerkAuth.isAuthenticated()) {
                    // User is authenticated
                    await initializeApp();
                } else {
                    // Show Clerk sign-in
                    showClerkAuth();
                }
            } catch (error) {
                console.error('Failed to initialize Clerk:', error);
                showError('Failed to initialize authentication system');
            }
        });

        // Set up authentication callback
        window.onUserAuthenticated = async (user) => {
            console.log('User authenticated:', user);
            currentUser = user;
            await initializeApp();
        };

        window.onUserSignedOut = () => {
            console.log('User signed out');
            currentUser = null;
            currentOrganization = null;
            authToken = null;
            showClerkAuth();
        };

        // Show Clerk Authentication
        async function showClerkAuth() {
            document.getElementById('clerkAuthContainer').style.display = 'flex';
            document.getElementById('mainContent').style.display = 'none';

            // Update loading message
            const loadingDiv = document.querySelector('.clerk-loading');
            loadingDiv.innerHTML = `
                <h2>××¢×¨×›×ª ××¢×§×‘ ×”×•×¦××•×ª ×‘× ×™×”</h2>
                <div style="margin: 30px 0;">
                    <button class="btn-primary" onclick="ClerkAuth.showSignIn()" style="margin: 10px;">
                        <i class="fas fa-sign-in-alt"></i> ×”×ª×—×‘×¨×•×ª
                    </button>
                    <button class="btn-primary" onclick="ClerkAuth.showSignUp()" style="margin: 10px;">
                        <i class="fas fa-user-plus"></i> ×”×¨×©××”
                    </button>
                </div>
                <p style="color: white; margin-top: 20px;">××¢×¨×›×ª ×××•×‘×˜×—×ª ×¢× Clerk Authentication</p>
            `;
        }

        // Initialize Application
        async function initializeApp() {
            try {
                // Hide auth container
                document.getElementById('clerkAuthContainer').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';

                // Get auth token
                authToken = await ClerkAuth.getAuthToken();

                // Get user info
                currentUser = window.currentUser;
                if (currentUser) {
                    document.getElementById('userName').textContent = currentUser.name || currentUser.email;

                    // Get organization info
                    const orgs = await ClerkAuth.getUserOrganizations();
                    if (orgs && orgs.length > 0) {
                        currentOrganization = orgs[0];
                        document.getElementById('companyName').textContent = currentOrganization.name;
                    } else {
                        document.getElementById('companyName').textContent = '×œ×œ× ×—×‘×¨×”';
                    }
                }

                // Load application data
                await loadAppData();

                // Show initial tab only if not already on a tab (initial load)
                if (!currentTab) {
                    console.log('[INIT] First load - showing expenses tab');
                    showTab('expenses');
                } else {
                    console.log('[INIT] Re-authentication - staying on current tab:', currentTab);
                    // Refresh the current tab to update data
                    refreshCurrentTab();
                }

            } catch (error) {
                console.error('Failed to initialize app:', error);
                showError('Failed to initialize application');
            }
        }

        // Load Application Data
        async function loadAppData() {
            try {
                // Load all data in parallel
                const [expensesResp, projectsResp, contractorsResp, worksResp] = await Promise.all([
                    apiCall('/expenses'),
                    apiCall('/projects'),
                    apiCall('/contractors'),
                    apiCall('/works')
                ]);

                appData.expenses = expensesResp.expenses || [];
                appData.projects = projectsResp.projects || [];
                appData.contractors = contractorsResp.contractors || [];
                appData.works = worksResp.works || [];

                updateDashboard();

            } catch (error) {
                console.error('Failed to load data:', error);
                showError('Failed to load application data');
            }
        }

        // API Call Helper with Clerk Authentication
        async function apiCall(endpoint, method = 'GET', data = null) {
            try {
                // Ensure we have a valid token
                const token = await ClerkAuth.ensureValidToken();

                const response = await fetch(`${API_CONFIG.endpoint}${endpoint}`, {
                    method,
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: data ? JSON.stringify(data) : null
                });

                if (!response.ok) {
                    throw new Error(`API call failed: ${response.statusText}`);
                }

                return await response.json();

            } catch (error) {
                console.error('API call error:', error);
                throw error;
            }
        }

        // Update Dashboard
        function updateDashboard() {
            // Calculate totals
            const totalExpenses = appData.expenses.reduce((sum, exp) => sum + (exp.amount || 0), 0);
            const activeProjects = appData.projects.length;
            const totalContractors = appData.contractors.length;

            // Calculate monthly expenses
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const monthlyExpenses = appData.expenses
                .filter(exp => {
                    const date = new Date(exp.date);
                    return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
                })
                .reduce((sum, exp) => sum + (exp.amount || 0), 0);

            // Update UI
            document.getElementById('totalExpenses').textContent = `â‚ª${totalExpenses.toLocaleString('he-IL')}`;
            document.getElementById('activeProjects').textContent = activeProjects;
            document.getElementById('totalContractors').textContent = totalContractors;
            document.getElementById('monthlyExpenses').textContent = `â‚ª${monthlyExpenses.toLocaleString('he-IL')}`;
        }

        // Show Tab
        function showTab(tabName) {
            console.log('[TAB DEBUG] showTab called with:', tabName);
            console.log('[TAB DEBUG] Current tab before change:', currentTab);

            // Store current tab
            currentTab = tabName;

            // Update active tab
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            // Find and activate the button for this tab
            const activeButton = Array.from(document.querySelectorAll('.tab-button')).find(btn =>
                btn.textContent.includes(tabName) || btn.onclick?.toString().includes(`'${tabName}'`)
            );
            if (activeButton) {
                activeButton.classList.add('active');
                console.log('[TAB DEBUG] Activated button:', activeButton.textContent.trim());
            } else {
                console.warn('[TAB DEBUG] No button found for tab:', tabName);
            }

            // Load tab content
            const tabContent = document.getElementById('tabContent');

            try {
                switch(tabName) {
                    case 'expenses':
                        showExpensesTab(tabContent);
                        break;
                    case 'projects':
                        showProjectsTab(tabContent);
                        break;
                    case 'contractors':
                        showContractorsTab(tabContent);
                        break;
                    case 'works':
                        showWorksTab(tabContent);
                        break;
                    case 'reports':
                        showReportsTab(tabContent);
                        break;
                    case 'billing':
                        showBillingTab(tabContent);
                        break;
                    default:
                        console.error('[TAB DEBUG] Unknown tab:', tabName);
                }
                console.log('[TAB DEBUG] Tab content loaded successfully for:', tabName);
            } catch (error) {
                console.error('[TAB DEBUG] Error loading tab content:', error);
            }
        }

        // Refresh current tab (used after data updates)
        function refreshCurrentTab() {
            showTab(currentTab);
        }

        // Show Expenses Tab
        function showExpensesTab(container) {
            container.innerHTML = `
                <h2>×”×•×¦××•×ª</h2>
                <button class="btn-primary" onclick="showAddExpenseForm()">
                    <i class="fas fa-plus"></i> ×”×•×¡×£ ×”×•×¦××”
                </button>
                <table>
                    <thead>
                        <tr>
                            <th>×ª××¨×™×š</th>
                            <th>×ª×™××•×¨</th>
                            <th>×¡×›×•×</th>
                            <th>×¢×‘×•×“×”</th>
                            <th>×¤×¨×•×™×§×˜</th>
                            <th>×§×‘×œ×Ÿ</th>
                            <th>×§×‘×œ×”</th>
                            <th>×¤×¢×•×œ×•×ª</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${appData.expenses.map(expense => `
                            <tr>
                                <td>${new Date(expense.date).toLocaleDateString('he-IL')}</td>
                                <td>${expense.description}</td>
                                <td>â‚ª${expense.amount.toLocaleString('he-IL')}</td>
                                <td>${expense.workName || '-'}</td>
                                <td>${expense.projectName || '-'}</td>
                                <td>${expense.contractorName || '-'}</td>
                                <td>
                                    ${expense.receiptUrl ? `<a href="${expense.receiptUrl}" target="_blank" class="btn-secondary" style="display: inline-block; padding: 6px 12px; text-decoration: none;"><i class="fas fa-file-image"></i> ×¦×¤×”</a>` : '-'}
                                </td>
                                <td>
                                    <button class="btn-edit" onclick="editExpense('${expense.expenseId}')">×¢×¨×•×š</button>
                                    <button class="btn-delete" onclick="deleteExpense('${expense.expenseId}')">××—×§</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Show Projects Tab
        function showProjectsTab(container) {
            container.innerHTML = `
                <h2>×¤×¨×•×™×§×˜×™×</h2>
                <button class="btn-primary" onclick="showAddProjectForm()">
                    <i class="fas fa-plus"></i> ×”×•×¡×£ ×¤×¨×•×™×§×˜
                </button>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-top: 20px;">
                    ${appData.projects.map(project => `
                        <div class="card">
                            <h3>${project.name}</h3>
                            <p>${project.description || '××™×Ÿ ×ª×™××•×¨'}</p>
                            <div style="margin-top: 10px;">
                                <strong>×ª×§×¦×™×‘:</strong> â‚ª${(project.budget || 0).toLocaleString('he-IL')}
                            </div>
                            <div style="margin-top: 10px;">
                                <button class="btn-edit" onclick="editProject('${project.projectId}')">×¢×¨×•×š</button>
                                <button class="btn-delete" onclick="deleteProject('${project.projectId}')">××—×§</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Delete Functions using Clerk Auth
        async function deleteProject(projectId) {
            if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ×¤×¨×•×™×§×˜ ×–×”?')) {
                return;
            }

            try {
                await apiCall(`/projects/${projectId}`, 'DELETE');
                showSuccess('×”×¤×¨×•×™×§×˜ × ××—×§ ×‘×”×¦×œ×—×”');
                await loadAppData();
                refreshCurrentTab();
            } catch (error) {
                showError('×©×’×™××” ×‘××—×™×§×ª ×”×¤×¨×•×™×§×˜');
            }
        }

        async function deleteExpense(expenseId) {
            if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ×”×•×¦××” ×–×•?')) {
                return;
            }

            try {
                await apiCall(`/expenses/${expenseId}`, 'DELETE');
                showSuccess('×”×”×•×¦××” × ××—×§×” ×‘×”×¦×œ×—×”');
                await loadAppData();
                refreshCurrentTab();
            } catch (error) {
                showError('×©×’×™××” ×‘××—×™×§×ª ×”×”×•×¦××”');
            }
        }

        // Show Contractors Tab
        function showContractorsTab(container) {
            container.innerHTML = `
                <h2>×§×‘×œ× ×™×</h2>
                <button class="btn-primary" onclick="showAddContractorForm()">
                    <i class="fas fa-plus"></i> ×”×•×¡×£ ×§×‘×œ×Ÿ
                </button>
                <table>
                    <thead>
                        <tr>
                            <th>×©×</th>
                            <th>×˜×œ×¤×•×Ÿ</th>
                            <th>×”×ª××—×•×ª</th>
                            <th>×¤×¢×•×œ×•×ª</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${appData.contractors.map(contractor => `
                            <tr>
                                <td>${contractor.name}</td>
                                <td>${contractor.phone || '-'}</td>
                                <td>${contractor.specialty || contractor.speciality || '-'}</td>
                                <td>
                                    <button class="btn-edit" onclick="editContractor('${contractor.contractorId}')">×¢×¨×•×š</button>
                                    <button class="btn-delete" onclick="deleteContractor('${contractor.contractorId}')">××—×§</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        async function deleteContractor(contractorId) {
            if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ×§×‘×œ×Ÿ ×–×”?')) {
                return;
            }

            try {
                await apiCall(`/contractors/${contractorId}`, 'DELETE');
                showSuccess('×”×§×‘×œ×Ÿ × ××—×§ ×‘×”×¦×œ×—×”');
                await loadAppData();
                refreshCurrentTab();
            } catch (error) {
                showError('×©×’×™××” ×‘××—×™×§×ª ×”×§×‘×œ×Ÿ');
            }
        }

        // Show Works Tab
        function showWorksTab(container) {
            container.innerHTML = `
                <h2>×¢×‘×•×“×•×ª</h2>
                <button class="btn-primary" onclick="showAddWorkForm()">
                    <i class="fas fa-plus"></i> ×”×•×¡×£ ×¢×‘×•×“×”
                </button>
                <table>
                    <thead>
                        <tr>
                            <th>×©× ×”×¢×‘×•×“×”</th>
                            <th>×¤×¨×•×™×§×˜</th>
                            <th>×§×‘×œ×Ÿ</th>
                            <th>×ª××¨×™×š ×”×ª×—×œ×”</th>
                            <th>×¡×˜×˜×•×¡</th>
                            <th>×¤×¢×•×œ×•×ª</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${appData.works.map(work => `
                            <tr>
                                <td>${work.workName || '-'}</td>
                                <td>${work.projectName || '-'}</td>
                                <td>${work.contractorName || '-'}</td>
                                <td>${work.startDate ? new Date(work.startDate).toLocaleDateString('he-IL') : '-'}</td>
                                <td>${work.status || 'planned'}</td>
                                <td>
                                    <button class="btn-edit" onclick="editWork('${work.workId}')">×¢×¨×•×š</button>
                                    <button class="btn-delete" onclick="deleteWork('${work.workId}')">××—×§</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        async function deleteWork(workId) {
            if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ×¢×‘×•×“×” ×–×•?')) {
                return;
            }

            try {
                await apiCall(`/works/${workId}`, 'DELETE');
                showSuccess('×”×¢×‘×•×“×” × ××—×§×” ×‘×”×¦×œ×—×”');
                await loadAppData();
                refreshCurrentTab();
            } catch (error) {
                showError('×©×’×™××” ×‘××—×™×§×ª ×”×¢×‘×•×“×”');
            }
        }

        // Show Reports Tab
        function showReportsTab(container) {
            container.innerHTML = `
                <h2>×“×•×—×•×ª ×•× ×™×ª×•×—×™×</h2>

                <!-- Key Metrics -->
                <div class="dashboard-grid">
                    <div class="metric-card">
                        <div class="metric-icon blue">
                            <i class="fas fa-coins"></i>
                        </div>
                        <div class="metric-value" id="report-total-expenses">â‚ª0</div>
                        <div class="metric-label">×¡×”"×› ×”×•×¦××•×ª</div>
                        <div class="metric-change positive" id="report-expense-change"></div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon green">
                            <i class="fas fa-project-diagram"></i>
                        </div>
                        <div class="metric-value" id="report-active-projects">0</div>
                        <div class="metric-label">×¤×¨×•×™×§×˜×™× ×¤×¢×™×œ×™×</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon purple">
                            <i class="fas fa-calendar"></i>
                        </div>
                        <div class="metric-value" id="report-monthly-expenses">â‚ª0</div>
                        <div class="metric-label">×”×•×¦××•×ª ×”×—×•×“×©</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon orange">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="metric-value" id="report-avg-expense">â‚ª0</div>
                        <div class="metric-label">×××•×¦×¢ ×”×•×¦××”</div>
                    </div>
                </div>

                <!-- Charts Row -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px;">
                    <div class="chart-container">
                        <div class="chart-header">
                            <div class="chart-title">××’××ª ×”×•×¦××•×ª (6 ×—×•×“×©×™× ××—×¨×•× ×™×)</div>
                        </div>
                        <div class="chart-canvas">
                            <canvas id="expenseTrendChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                        <div class="chart-header">
                            <div class="chart-title">×”×ª×¤×œ×’×•×ª ×”×•×¦××•×ª ×œ×¤×™ ×¤×¨×•×™×§×˜</div>
                        </div>
                        <div class="chart-canvas">
                            <canvas id="projectDistributionChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Report Categories -->
                <h3 style="margin: 32px 0 16px 0;">×“×•×—×•×ª ××¤×•×¨×˜×™×</h3>
                <div class="reports-grid">
                    <div class="report-card" onclick="showProjectBudgetReport()">
                        <div class="report-icon">
                            <i class="fas fa-chart-bar"></i>
                        </div>
                        <div class="report-title">×ª×§×¦×™×‘ ×¤×¨×•×™×§×˜×™×</div>
                        <div class="report-description">×”×©×•×•××ª ×ª×§×¦×™×‘ ××•×œ ×”×•×¦××•×ª ×‘×¤×•×¢×œ ×œ×›×œ ×¤×¨×•×™×§×˜</div>
                    </div>
                    <div class="report-card" onclick="showContractorReport()">
                        <div class="report-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="report-title">× ×™×ª×•×— ×§×‘×œ× ×™×</div>
                        <div class="report-description">×¡×™×›×•× ×”×•×¦××•×ª ×œ×¤×™ ×§×‘×œ×Ÿ ×•×¤×¨×˜×™ ×‘×™×¦×•×¢×™×</div>
                    </div>
                    <div class="report-card" onclick="showMonthlyReport()">
                        <div class="report-icon">
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                        <div class="report-title">×¡×™×›×•× ×—×•×“×©×™</div>
                        <div class="report-description">×“×•×— ×”×•×¦××•×ª ×—×•×“×©×™ ×¢× ×”×©×•×•××” ×œ×—×•×“×© ×”×§×•×“×</div>
                    </div>
                    <div class="report-card" onclick="showMissingReceiptsReport()">
                        <div class="report-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="report-title">×§×‘×œ×•×ª ×—×¡×¨×•×ª</div>
                        <div class="report-description">×¨×©×™××ª ×”×•×¦××•×ª ×œ×œ× ×ª××•× ×ª ×§×‘×œ×”</div>
                    </div>
                </div>
            `;

            // Initialize dashboard data
            initializeReportsDashboard();
        }

        // Show Billing Tab (Clerk Billing)
        function showBillingTab(container) {
            container.innerHTML = `
                <h2>×—×™×•×‘ ×•×× ×•×™</h2>
                <div class="card">
                    <h3>×”×× ×•×™ ×©×œ×š</h3>
                    <p>××¢×¨×›×ª ×”×—×™×•×‘ ×”×—×“×©×” ×©×œ Clerk ×ª×”×™×” ×–××™× ×” ×‘×§×¨×•×‘</p>
                    <p>×‘××§×•× Paddle, × ×©×ª××© ×‘××¢×¨×›×ª ×”×—×™×•×‘ ×”××•×‘× ×™×ª ×©×œ Clerk</p>
                    <div style="margin-top: 20px;">
                        <button class="btn-primary" onclick="alert('Clerk Billing - ×‘×§×¨×•×‘!')">
                            <i class="fas fa-credit-card"></i> × ×”×œ ×× ×•×™
                        </button>
                    </div>
                </div>
            `;
        }

        // Sign Out
        async function signOut() {
            if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×¦××ª ××”××¢×¨×›×ª?')) {
                await ClerkAuth.signOut();
            }
        }

        // Message Functions
        function showSuccess(message) {
            showMessage(message, 'success');
        }

        // Modal Control Functions
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
                // Clear form inputs
                const form = modal.querySelector('form');
                if (form) form.reset();

                // Reset editing states and modal titles
                if (modalId === 'projectModal') {
                    editingProjectId = null;
                    document.querySelector('#projectModal h2').textContent = '×”×•×¡×£ ×¤×¨×•×™×§×˜ ×—×“×©';
                } else if (modalId === 'contractorModal') {
                    editingContractorId = null;
                    document.querySelector('#contractorModal h2').textContent = '×”×•×¡×£ ×§×‘×œ×Ÿ ×—×“×©';
                } else if (modalId === 'workModal') {
                    editingWorkId = null;
                    document.querySelector('#workModal h2').textContent = '×”×•×¡×£ ×¢×‘×•×“×” ×—×“×©×”';
                } else if (modalId === 'expenseModal') {
                    editingExpenseId = null;
                    document.querySelector('#expenseModal h2').textContent = '×”×•×¡×£ ×”×•×¦××” ×—×“×©×”';
                    // Clear receipt preview
                    const preview = document.getElementById('receiptPreview');
                    if (preview) {
                        preview.style.display = 'none';
                        preview.innerHTML = '';
                    }
                }
            }
        }

        // Form Display Functions - Open Modals
        function showAddProjectForm() {
            document.getElementById('projectModal').style.display = 'block';
        }

        function showAddContractorForm() {
            document.getElementById('contractorModal').style.display = 'block';
        }

        async function showAddWorkForm() {
            // Load projects and contractors for dropdowns
            try {
                const projects = await apiCall('/projects', 'GET');
                const contractors = await apiCall('/contractors', 'GET');

                if (!projects.projects || projects.projects.length === 0) {
                    showError('××™×Ÿ ×¤×¨×•×™×§×˜×™×. ×¦×•×¨ ×¤×¨×•×™×§×˜ ×ª×—×™×œ×”.');
                    return;
                }
                if (!contractors.contractors || contractors.contractors.length === 0) {
                    showError('××™×Ÿ ×§×‘×œ× ×™×. ×¦×•×¨ ×§×‘×œ×Ÿ ×ª×—×™×œ×”.');
                    return;
                }

                // Populate project dropdown
                const projectSelect = document.getElementById('workProjectId');
                projectSelect.innerHTML = '<option value="">×‘×—×¨ ×¤×¨×•×™×§×˜ *</option>';
                projects.projects.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.projectId;
                    option.textContent = p.name;
                    projectSelect.appendChild(option);
                });

                // Populate contractor dropdown
                const contractorSelect = document.getElementById('workContractorId');
                contractorSelect.innerHTML = '<option value="">×‘×—×¨ ×§×‘×œ×Ÿ *</option>';
                contractors.contractors.forEach(c => {
                    const option = document.createElement('option');
                    option.value = c.contractorId;
                    option.textContent = c.name;
                    contractorSelect.appendChild(option);
                });

                document.getElementById('workModal').style.display = 'block';
            } catch (error) {
                showError('×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™×: ' + error.message);
            }
        }

        // Global variable to store works data for expense form
        let expenseFormWorks = [];

        async function showAddExpenseForm() {
            // Load projects, contractors, and works for dropdowns
            try {
                const projects = await apiCall('/projects', 'GET');
                const contractors = await apiCall('/contractors', 'GET');
                const works = await apiCall('/works', 'GET');

                // Store works data globally for onWorkSelected function
                expenseFormWorks = works.works || [];

                // Populate works dropdown
                const workSelect = document.getElementById('expenseWorkId');
                workSelect.innerHTML = '<option value="">×‘×—×¨ ×¢×‘×•×“×” (×××œ× ××•×˜×•××˜×™×ª ×¤×¨×•×™×§×˜ ×•×§×‘×œ×Ÿ)</option>';
                if (works.works) {
                    works.works.forEach(w => {
                        const option = document.createElement('option');
                        option.value = w.workId;
                        option.textContent = w.workName;
                        workSelect.appendChild(option);
                    });
                }

                // Populate project dropdown (optional)
                const projectSelect = document.getElementById('expenseProjectId');
                projectSelect.innerHTML = '<option value="">×‘×—×¨ ×¤×¨×•×™×§×˜ (××•×¤×¦×™×•× ×œ×™)</option>';
                if (projects.projects) {
                    projects.projects.forEach(p => {
                        const option = document.createElement('option');
                        option.value = p.projectId;
                        option.textContent = p.name;
                        projectSelect.appendChild(option);
                    });
                }

                // Populate contractor dropdown (optional)
                const contractorSelect = document.getElementById('expenseContractorId');
                contractorSelect.innerHTML = '<option value="">×‘×—×¨ ×§×‘×œ×Ÿ (××•×¤×¦×™×•× ×œ×™)</option>';
                if (contractors.contractors) {
                    contractors.contractors.forEach(c => {
                        const option = document.createElement('option');
                        option.value = c.contractorId;
                        option.textContent = c.name;
                        contractorSelect.appendChild(option);
                    });
                }

                document.getElementById('expenseModal').style.display = 'block';
            } catch (error) {
                showError('×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™×: ' + error.message);
            }
        }

        // Auto-fill project and contractor when work is selected
        function onWorkSelected() {
            const workId = document.getElementById('expenseWorkId').value;

            if (!workId) {
                // Clear selections if no work selected
                document.getElementById('expenseProjectId').value = '';
                document.getElementById('expenseContractorId').value = '';
                return;
            }

            // Find the selected work
            const selectedWork = expenseFormWorks.find(w => w.workId === workId);

            if (selectedWork) {
                // Auto-fill project and contractor
                document.getElementById('expenseProjectId').value = selectedWork.projectId || '';
                document.getElementById('expenseContractorId').value = selectedWork.contractorId || '';
            }
        }

        // Form Submission Functions
        async function submitProject(event) {
            event.preventDefault();

            try {
                const project = {
                    name: document.getElementById('projectName').value,
                    description: document.getElementById('projectDescription').value || '',
                    startDate: document.getElementById('projectStartDate').value,
                    endDate: document.getElementById('projectEndDate').value || undefined,
                    budget: parseFloat(document.getElementById('projectBudget').value) || 0,
                    location: document.getElementById('projectLocation').value || '',
                    clientName: document.getElementById('projectClient').value || ''
                };

                if (editingProjectId) {
                    // Update existing project
                    project.projectId = editingProjectId;
                    await apiCall('/projects', 'PUT', project);
                    showSuccess('×¤×¨×•×™×§×˜ ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”');
                    editingProjectId = null;
                } else {
                    // Create new project
                    await apiCall('/projects', 'POST', project);
                    showSuccess('×¤×¨×•×™×§×˜ × ×•×¡×£ ×‘×”×¦×œ×—×”');
                }

                closeModal('projectModal');
                await loadAppData();
                // Always stay on current tab after creating/updating
                refreshCurrentTab();
            } catch (error) {
                showError('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×¤×¨×•×™×§×˜: ' + error.message);
            }
        }

        async function submitContractor(event) {
            event.preventDefault();

            try {
                const contractor = {
                    name: document.getElementById('contractorName').value,
                    phone: document.getElementById('contractorPhone').value || '',
                    specialty: document.getElementById('contractorSpecialty').value || ''
                };

                if (editingContractorId) {
                    // Update existing contractor
                    contractor.contractorId = editingContractorId;
                    await apiCall('/contractors', 'PUT', contractor);
                    showSuccess('×§×‘×œ×Ÿ ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”');
                    editingContractorId = null;
                } else {
                    // Create new contractor
                    await apiCall('/contractors', 'POST', contractor);
                    showSuccess('×§×‘×œ×Ÿ × ×•×¡×£ ×‘×”×¦×œ×—×”');
                }

                closeModal('contractorModal');
                await loadAppData();
                // Always stay on current tab after creating/updating
                refreshCurrentTab();
            } catch (error) {
                showError('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×§×‘×œ×Ÿ: ' + error.message);
            }
        }

        async function submitWork(event) {
            event.preventDefault();

            try {
                const work = {
                    workName: document.getElementById('workName').value,
                    projectId: document.getElementById('workProjectId').value,
                    contractorId: document.getElementById('workContractorId').value,
                    startDate: document.getElementById('workStartDate').value || null,
                    totalWorkCost: parseFloat(document.getElementById('workCost').value) || 0,
                    status: 'planned'
                };

                if (editingWorkId) {
                    // Update existing work
                    work.workId = editingWorkId;
                    await apiCall('/works', 'PUT', work);
                    showSuccess('×¢×‘×•×“×” ×¢×•×“×›× ×” ×‘×”×¦×œ×—×”');
                    editingWorkId = null;
                } else {
                    // Create new work
                    await apiCall('/works', 'POST', work);
                    showSuccess('×¢×‘×•×“×” × ×•×¡×¤×” ×‘×”×¦×œ×—×”');
                }

                closeModal('workModal');
                await loadAppData();
                // Always stay on current tab after creating/updating
                refreshCurrentTab();
            } catch (error) {
                showError('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×¢×‘×•×“×”: ' + error.message);
            }
        }

        async function submitExpense(event) {
            event.preventDefault();

            try {
                let receiptUrl = '';

                // If editing, get existing receipt URL
                if (editingExpenseId) {
                    const existingExpense = appData.expenses.find(e => e.expenseId === editingExpenseId);
                    receiptUrl = existingExpense?.receiptUrl || '';
                }

                // Check if a new receipt file was selected
                const fileInput = document.getElementById('expenseReceipt');
                if (fileInput.files && fileInput.files[0]) {
                    const file = fileInput.files[0];

                    // Show uploading message
                    const preview = document.getElementById('receiptPreview');
                    preview.textContent = '××¢×œ×” ×§×‘×œ×”...';
                    preview.style.display = 'block';

                    // Get presigned URL from Lambda
                    const uploadData = await apiCall('/upload-receipt', 'POST', {
                        fileName: file.name,
                        fileType: file.type
                    });

                    // Upload file to S3 using presigned URL
                    const uploadResponse = await fetch(uploadData.data.uploadUrl, {
                        method: 'PUT',
                        body: file,
                        headers: {
                            'Content-Type': file.type
                        }
                    });

                    if (!uploadResponse.ok) {
                        throw new Error('Failed to upload receipt to S3');
                    }

                    receiptUrl = uploadData.data.receiptUrl;
                    preview.textContent = 'âœ“ ×§×‘×œ×” ×”×•×¢×œ×ª×” ×‘×”×¦×œ×—×”';
                }

                const expense = {
                    description: document.getElementById('expenseDescription').value,
                    amount: parseFloat(document.getElementById('expenseAmount').value) || 0,
                    date: document.getElementById('expenseDate').value,
                    invoiceNum: document.getElementById('expenseInvoice').value || 'N/A',
                    paymentMethod: document.getElementById('expensePayment').value || 'Cash',
                    workId: document.getElementById('expenseWorkId').value || '',
                    projectId: document.getElementById('expenseProjectId').value || '',
                    contractorId: document.getElementById('expenseContractorId').value || '',
                    receiptUrl: receiptUrl,
                    category: 'General'
                };

                if (editingExpenseId) {
                    // Update existing expense
                    expense.expenseId = editingExpenseId;
                    await apiCall('/expenses', 'PUT', expense);
                    showSuccess('×”×•×¦××” ×¢×•×“×›× ×” ×‘×”×¦×œ×—×”');
                    editingExpenseId = null;
                } else {
                    // Create new expense
                    await apiCall('/expenses', 'POST', expense);
                    showSuccess('×”×•×¦××” × ×•×¡×¤×” ×‘×”×¦×œ×—×”');
                }

                closeModal('expenseModal');
                await loadAppData();
                // Always stay on current tab after creating/updating
                refreshCurrentTab();
            } catch (error) {
                showError('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×”×•×¦××”: ' + error.message);
            }
        }

        // ===== EDIT FUNCTIONS =====

        // Track if we're editing (stores entity ID being edited)
        let editingProjectId = null;
        let editingContractorId = null;
        let editingWorkId = null;
        let editingExpenseId = null;

        function editProject(projectId) {
            const project = appData.projects.find(p => p.projectId === projectId);
            if (!project) {
                showError('×¤×¨×•×™×§×˜ ×œ× × ××¦×');
                return;
            }

            // Store that we're editing
            editingProjectId = projectId;

            // Populate form
            document.getElementById('projectName').value = project.name || '';
            document.getElementById('projectDescription').value = project.description || '';
            document.getElementById('projectStartDate').value = project.startDate || '';
            document.getElementById('projectEndDate').value = project.endDate || '';
            document.getElementById('projectBudget').value = project.budget || '';
            document.getElementById('projectLocation').value = project.location || '';
            document.getElementById('projectClient').value = project.clientName || '';

            // Change modal title
            document.querySelector('#projectModal h2').textContent = '×¢×¨×•×š ×¤×¨×•×™×§×˜';

            // Show modal
            document.getElementById('projectModal').style.display = 'block';
        }

        function editContractor(contractorId) {
            const contractor = appData.contractors.find(c => c.contractorId === contractorId);
            if (!contractor) {
                showError('×§×‘×œ×Ÿ ×œ× × ××¦×');
                return;
            }

            console.log('[EDIT CONTRACTOR] Full contractor object:', contractor);
            console.log('[EDIT CONTRACTOR] contractor.specialty:', contractor.specialty);
            console.log('[EDIT CONTRACTOR] contractor.speciality:', contractor.speciality);

            // Store that we're editing
            editingContractorId = contractorId;

            // Populate form
            document.getElementById('contractorName').value = contractor.name || '';
            document.getElementById('contractorPhone').value = contractor.phone || '';
            // Support both spellings for backwards compatibility
            const specialtyValue = contractor.specialty || contractor.speciality || '';
            console.log('[EDIT CONTRACTOR] Using specialty value:', specialtyValue);
            document.getElementById('contractorSpecialty').value = specialtyValue;

            // Change modal title
            document.querySelector('#contractorModal h2').textContent = '×¢×¨×•×š ×§×‘×œ×Ÿ';

            // Show modal
            document.getElementById('contractorModal').style.display = 'block';
        }

        async function editWork(workId) {
            console.log('[EDIT WORK] Starting edit for workId:', workId);
            const work = appData.works.find(w => w.workId === workId);
            if (!work) {
                showError('×¢×‘×•×“×” ×œ× × ××¦××”');
                return;
            }
            console.log('[EDIT WORK] Found work:', work);

            // Store that we're editing
            editingWorkId = workId;

            // Load projects and contractors for dropdowns
            try {
                console.log('[EDIT WORK] Loading projects and contractors...');
                const projects = await apiCall('/projects', 'GET');
                const contractors = await apiCall('/contractors', 'GET');
                console.log('[EDIT WORK] Loaded projects:', projects.projects?.length, 'contractors:', contractors.contractors?.length);

                // Populate project dropdown
                const projectSelect = document.getElementById('workProjectId');
                if (!projectSelect) {
                    console.error('[EDIT WORK] ERROR: workProjectId element not found!');
                    showError('×©×’×™××”: ×©×“×” ×¤×¨×•×™×§×˜ ×œ× × ××¦×');
                    return;
                }
                projectSelect.innerHTML = '<option value="">×‘×—×¨ ×¤×¨×•×™×§×˜ *</option>';
                if (projects.projects) {
                    projects.projects.forEach(p => {
                        const option = document.createElement('option');
                        option.value = p.projectId;
                        option.textContent = p.name;
                        if (p.projectId === work.projectId) option.selected = true;
                        projectSelect.appendChild(option);
                    });
                }
                console.log('[EDIT WORK] Populated project dropdown, selected:', work.projectId);

                // Populate contractor dropdown
                const contractorSelect = document.getElementById('workContractorId');
                if (!contractorSelect) {
                    console.error('[EDIT WORK] ERROR: workContractorId element not found!');
                    showError('×©×’×™××”: ×©×“×” ×§×‘×œ×Ÿ ×œ× × ××¦×');
                    return;
                }
                contractorSelect.innerHTML = '<option value="">×‘×—×¨ ×§×‘×œ×Ÿ *</option>';
                if (contractors.contractors) {
                    contractors.contractors.forEach(c => {
                        const option = document.createElement('option');
                        option.value = c.contractorId;
                        option.textContent = c.name;
                        if (c.contractorId === work.contractorId) option.selected = true;
                        contractorSelect.appendChild(option);
                    });
                }
                console.log('[EDIT WORK] Populated contractor dropdown, selected:', work.contractorId);

                // Populate form fields
                const workNameField = document.getElementById('workName');
                const workStartDateField = document.getElementById('workStartDate');
                const workCostField = document.getElementById('workCost');

                if (!workNameField || !workStartDateField || !workCostField) {
                    console.error('[EDIT WORK] ERROR: Missing form fields!', {
                        workName: !!workNameField,
                        workStartDate: !!workStartDateField,
                        workCost: !!workCostField
                    });
                    showError('×©×’×™××”: ×©×“×•×ª ×˜×•×¤×¡ ×—×¡×¨×™×');
                    return;
                }

                workNameField.value = work.workName || '';
                workStartDateField.value = work.startDate || '';
                workCostField.value = work.totalWorkCost || '';
                console.log('[EDIT WORK] Populated form fields');

                // Change modal title
                document.querySelector('#workModal h2').textContent = '×¢×¨×•×š ×¢×‘×•×“×”';

                // Show modal
                document.getElementById('workModal').style.display = 'block';
                console.log('[EDIT WORK] Modal displayed');

            } catch (error) {
                console.error('[EDIT WORK] ERROR:', error);
                showError('×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™×: ' + error.message);
            }
        }

        async function editExpense(expenseId) {
            const expense = appData.expenses.find(e => e.expenseId === expenseId);
            if (!expense) {
                showError('×”×•×¦××” ×œ× × ××¦××”');
                return;
            }

            // Store that we're editing
            editingExpenseId = expenseId;

            // Load projects, contractors, and works for dropdowns
            try {
                const projects = await apiCall('/projects', 'GET');
                const contractors = await apiCall('/contractors', 'GET');
                const works = await apiCall('/works', 'GET');

                // Store works data globally for onWorkSelected function
                expenseFormWorks = works.works || [];

                // Populate works dropdown
                const workSelect = document.getElementById('expenseWorkId');
                workSelect.innerHTML = '<option value="">×‘×—×¨ ×¢×‘×•×“×” (×××œ× ××•×˜×•××˜×™×ª ×¤×¨×•×™×§×˜ ×•×§×‘×œ×Ÿ)</option>';
                if (works.works) {
                    works.works.forEach(w => {
                        const option = document.createElement('option');
                        option.value = w.workId;
                        option.textContent = w.workName;
                        if (w.workId === expense.workId) option.selected = true;
                        workSelect.appendChild(option);
                    });
                }

                // Populate project dropdown
                const projectSelect = document.getElementById('expenseProjectId');
                projectSelect.innerHTML = '<option value="">×‘×—×¨ ×¤×¨×•×™×§×˜ *</option>';
                if (projects.projects) {
                    projects.projects.forEach(p => {
                        const option = document.createElement('option');
                        option.value = p.projectId;
                        option.textContent = p.name;
                        if (p.projectId === expense.projectId) option.selected = true;
                        projectSelect.appendChild(option);
                    });
                }

                // Populate contractor dropdown
                const contractorSelect = document.getElementById('expenseContractorId');
                contractorSelect.innerHTML = '<option value="">×‘×—×¨ ×§×‘×œ×Ÿ *</option>';
                if (contractors.contractors) {
                    contractors.contractors.forEach(c => {
                        const option = document.createElement('option');
                        option.value = c.contractorId;
                        option.textContent = c.name;
                        if (c.contractorId === expense.contractorId) option.selected = true;
                        contractorSelect.appendChild(option);
                    });
                }

                // Populate form fields
                document.getElementById('expenseDescription').value = expense.description || '';
                document.getElementById('expenseAmount').value = expense.amount || '';
                document.getElementById('expenseDate').value = expense.date || '';
                document.getElementById('expenseInvoice').value = expense.invoiceNum || '';
                document.getElementById('expensePayment').value = expense.paymentMethod || 'Cash';

                // Note: File input cannot be pre-populated for security reasons
                // Show existing receipt if available
                if (expense.receiptUrl) {
                    const preview = document.getElementById('receiptPreview');
                    preview.innerHTML = `<a href="${expense.receiptUrl}" target="_blank">×§×‘×œ×” ×§×™×™××ª</a>`;
                    preview.style.display = 'block';
                }

                // Change modal title
                document.querySelector('#expenseModal h2').textContent = '×¢×¨×•×š ×”×•×¦××”';

                // Show modal
                document.getElementById('expenseModal').style.display = 'block';

            } catch (error) {
                showError('×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™×: ' + error.message);
            }
        }

        function showError(message) {
            showMessage(message, 'error');
        }

        function showMessage(message, type) {
            const messageArea = document.getElementById('messageArea');
            messageArea.className = `message ${type}`;
            messageArea.textContent = message;
            messageArea.style.display = 'block';

            setTimeout(() => {
                messageArea.style.display = 'none';
            }, 5000);
        }

        // ===== REPORTS AND ANALYTICS FUNCTIONS =====

        let expenseTrendChartInstance = null;
        let projectDistributionChartInstance = null;

        function initializeReportsDashboard() {
            // Calculate key metrics
            const totalExpenses = appData.expenses.reduce((sum, exp) => sum + (exp.amount || 0), 0);
            const activeProjects = appData.projects.length;

            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const monthlyExpenses = appData.expenses
                .filter(exp => {
                    const date = new Date(exp.date);
                    return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
                })
                .reduce((sum, exp) => sum + (exp.amount || 0), 0);

            const avgExpense = appData.expenses.length > 0 ? totalExpenses / appData.expenses.length : 0;

            // Calculate previous month for comparison
            const lastMonth = currentMonth === 0 ? 11 : currentMonth - 1;
            const lastMonthYear = currentMonth === 0 ? currentYear - 1 : currentYear;
            const lastMonthExpenses = appData.expenses
                .filter(exp => {
                    const date = new Date(exp.date);
                    return date.getMonth() === lastMonth && date.getFullYear() === lastMonthYear;
                })
                .reduce((sum, exp) => sum + (exp.amount || 0), 0);

            const change = lastMonthExpenses > 0
                ? ((monthlyExpenses - lastMonthExpenses) / lastMonthExpenses * 100).toFixed(1)
                : 0;

            // Update UI
            document.getElementById('report-total-expenses').textContent = `â‚ª${totalExpenses.toLocaleString('he-IL')}`;
            document.getElementById('report-active-projects').textContent = activeProjects;
            document.getElementById('report-monthly-expenses').textContent = `â‚ª${monthlyExpenses.toLocaleString('he-IL')}`;
            document.getElementById('report-avg-expense').textContent = `â‚ª${Math.round(avgExpense).toLocaleString('he-IL')}`;

            const changeEl = document.getElementById('report-expense-change');
            if (change > 0) {
                changeEl.textContent = `â†‘ ${change}% ××”×—×•×“×© ×”×§×•×“×`;
                changeEl.className = 'metric-change negative';
            } else if (change < 0) {
                changeEl.textContent = `â†“ ${Math.abs(change)}% ××”×—×•×“×© ×”×§×•×“×`;
                changeEl.className = 'metric-change positive';
            } else {
                changeEl.textContent = '×œ×œ× ×©×™× ×•×™';
                changeEl.className = 'metric-change';
            }

            // Initialize charts
            createExpenseTrendChart();
            createProjectDistributionChart();
        }

        function createExpenseTrendChart() {
            const canvas = document.getElementById('expenseTrendChart');
            if (!canvas) return;

            // Destroy existing chart
            if (expenseTrendChartInstance) {
                expenseTrendChartInstance.destroy();
            }

            // Get last 6 months data
            const monthsData = [];
            const today = new Date();

            for (let i = 5; i >= 0; i--) {
                const month = new Date(today.getFullYear(), today.getMonth() - i, 1);
                const monthExpenses = appData.expenses
                    .filter(exp => {
                        const expDate = new Date(exp.date);
                        return expDate.getMonth() === month.getMonth() &&
                               expDate.getFullYear() === month.getFullYear();
                    })
                    .reduce((sum, exp) => sum + (exp.amount || 0), 0);

                monthsData.push({
                    label: month.toLocaleDateString('he-IL', { month: 'short', year: 'numeric' }),
                    value: monthExpenses
                });
            }

            const ctx = canvas.getContext('2d');
            expenseTrendChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: monthsData.map(d => d.label),
                    datasets: [{
                        label: '×”×•×¦××•×ª',
                        data: monthsData.map(d => d.value),
                        borderColor: '#3182ce',
                        backgroundColor: 'rgba(49, 130, 206, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'â‚ª' + value.toLocaleString('he-IL');
                                }
                            }
                        }
                    }
                }
            });
        }

        function createProjectDistributionChart() {
            const canvas = document.getElementById('projectDistributionChart');
            if (!canvas) return;

            // Destroy existing chart
            if (projectDistributionChartInstance) {
                projectDistributionChartInstance.destroy();
            }

            // Calculate expenses per project
            const projectExpenses = {};
            appData.expenses.forEach(exp => {
                const projectName = exp.projectName || '×œ×œ× ×¤×¨×•×™×§×˜';
                projectExpenses[projectName] = (projectExpenses[projectName] || 0) + exp.amount;
            });

            // Sort and get top 5
            const sorted = Object.entries(projectExpenses)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            const colors = ['#3182ce', '#10b981', '#f97316', '#9333ea', '#ef4444'];

            const ctx = canvas.getContext('2d');
            projectDistributionChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: sorted.map(d => d[0]),
                    datasets: [{
                        data: sorted.map(d => d[1]),
                        backgroundColor: colors
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function showProjectBudgetReport() {
            const container = document.getElementById('tabContent');

            // Calculate budget vs actual for each project
            const projectData = appData.projects.map(project => {
                const spent = appData.expenses
                    .filter(exp => exp.projectId === project.projectId)
                    .reduce((sum, exp) => sum + exp.amount, 0);

                const budget = project.budget || 0;
                const remaining = budget - spent;
                const percentage = budget > 0 ? (spent / budget * 100).toFixed(1) : 0;

                let status = 'success';
                if (percentage > 100) status = 'danger';
                else if (percentage > 80) status = 'warning';

                return {
                    name: project.name,
                    budget,
                    spent,
                    remaining,
                    percentage,
                    status
                };
            });

            container.innerHTML = `
                <h2>×“×•×— ×ª×§×¦×™×‘ ×¤×¨×•×™×§×˜×™×</h2>
                <button class="btn-primary" onclick="showTab('reports')" style="margin-bottom: 20px;">
                    <i class="fas fa-arrow-right"></i> ×—×–×¨×” ×œ×“×•×—×•×ª
                </button>

                <table class="budget-table">
                    <thead>
                        <tr>
                            <th>×¤×¨×•×™×§×˜</th>
                            <th>×ª×§×¦×™×‘</th>
                            <th>×‘×•×¦×¢</th>
                            <th>× ×•×ª×¨</th>
                            <th>% ×‘×™×¦×•×¢</th>
                            <th>×¡×˜×˜×•×¡</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${projectData.map(p => `
                            <tr>
                                <td><strong>${p.name}</strong></td>
                                <td>â‚ª${p.budget.toLocaleString('he-IL')}</td>
                                <td>â‚ª${p.spent.toLocaleString('he-IL')}</td>
                                <td>â‚ª${p.remaining.toLocaleString('he-IL')}</td>
                                <td>
                                    <div>${p.percentage}%</div>
                                    <div class="progress-bar">
                                        <div class="progress-fill ${p.status}" style="width: ${Math.min(p.percentage, 100)}%"></div>
                                    </div>
                                </td>
                                <td>
                                    <span class="alert-badge ${p.status}">
                                        ${p.status === 'success' ? '×ª×§×™×Ÿ' : p.status === 'warning' ? '×”×ª×¨××”' : '×—×¨×™×’×”'}
                                    </span>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function showContractorReport() {
            const container = document.getElementById('tabContent');

            // Calculate data per contractor
            const contractorData = appData.contractors.map(contractor => {
                const expenses = appData.expenses.filter(exp => exp.contractorId === contractor.contractorId);
                const totalPaid = expenses.reduce((sum, exp) => sum + exp.amount, 0);
                const transactionCount = expenses.length;
                const avgTransaction = transactionCount > 0 ? totalPaid / transactionCount : 0;

                return {
                    name: contractor.name,
                    specialty: contractor.speciality || '-',
                    totalPaid,
                    transactionCount,
                    avgTransaction
                };
            }).sort((a, b) => b.totalPaid - a.totalPaid);

            container.innerHTML = `
                <h2>×“×•×— × ×™×ª×•×— ×§×‘×œ× ×™×</h2>
                <button class="btn-primary" onclick="showTab('reports')" style="margin-bottom: 20px;">
                    <i class="fas fa-arrow-right"></i> ×—×–×¨×” ×œ×“×•×—×•×ª
                </button>

                <table>
                    <thead>
                        <tr>
                            <th>×§×‘×œ×Ÿ</th>
                            <th>×”×ª××—×•×ª</th>
                            <th>×¡×”"×› ×©×•×œ×</th>
                            <th>××¡' ×¢×¡×§××•×ª</th>
                            <th>×××•×¦×¢ ×œ×¢×¡×§×”</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${contractorData.map(c => `
                            <tr>
                                <td><strong>${c.name}</strong></td>
                                <td>${c.specialty}</td>
                                <td>â‚ª${c.totalPaid.toLocaleString('he-IL')}</td>
                                <td>${c.transactionCount}</td>
                                <td>â‚ª${Math.round(c.avgTransaction).toLocaleString('he-IL')}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function showMonthlyReport() {
            const container = document.getElementById('tabContent');

            const currentDate = new Date();
            const currentMonth = currentDate.getMonth();
            const currentYear = currentDate.getFullYear();

            const currentMonthExpenses = appData.expenses.filter(exp => {
                const date = new Date(exp.date);
                return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
            });

            const lastMonth = currentMonth === 0 ? 11 : currentMonth - 1;
            const lastMonthYear = currentMonth === 0 ? currentYear - 1 : currentYear;

            const lastMonthExpenses = appData.expenses.filter(exp => {
                const date = new Date(exp.date);
                return date.getMonth() === lastMonth && date.getFullYear() === lastMonthYear;
            });

            const currentTotal = currentMonthExpenses.reduce((sum, exp) => sum + exp.amount, 0);
            const lastTotal = lastMonthExpenses.reduce((sum, exp) => sum + exp.amount, 0);
            const change = lastTotal > 0 ? ((currentTotal - lastTotal) / lastTotal * 100).toFixed(1) : 0;

            container.innerHTML = `
                <h2>×¡×™×›×•× ×—×•×“×©×™ - ${currentDate.toLocaleDateString('he-IL', { month: 'long', year: 'numeric' })}</h2>
                <button class="btn-primary" onclick="showTab('reports')" style="margin-bottom: 20px;">
                    <i class="fas fa-arrow-right"></i> ×—×–×¨×” ×œ×“×•×—×•×ª
                </button>

                <div class="dashboard-grid">
                    <div class="metric-card">
                        <div class="metric-icon blue">
                            <i class="fas fa-calendar-check"></i>
                        </div>
                        <div class="metric-value">â‚ª${currentTotal.toLocaleString('he-IL')}</div>
                        <div class="metric-label">×”×—×•×“×© ×”× ×•×›×—×™</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon purple">
                            <i class="fas fa-calendar"></i>
                        </div>
                        <div class="metric-value">â‚ª${lastTotal.toLocaleString('he-IL')}</div>
                        <div class="metric-label">×”×—×•×“×© ×”×§×•×“×</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon ${change > 0 ? 'orange' : 'green'}">
                            <i class="fas fa-${change > 0 ? 'arrow-up' : 'arrow-down'}"></i>
                        </div>
                        <div class="metric-value">${Math.abs(change)}%</div>
                        <div class="metric-label">${change > 0 ? '×¢×œ×™×™×”' : '×™×¨×™×“×”'}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon green">
                            <i class="fas fa-receipt"></i>
                        </div>
                        <div class="metric-value">${currentMonthExpenses.length}</div>
                        <div class="metric-label">×”×•×¦××•×ª ×”×—×•×“×©</div>
                    </div>
                </div>

                <h3 style="margin-top: 32px;">×”×•×¦××•×ª ×”×—×•×“×©</h3>
                <table>
                    <thead>
                        <tr>
                            <th>×ª××¨×™×š</th>
                            <th>×ª×™××•×¨</th>
                            <th>×¡×›×•×</th>
                            <th>×¤×¨×•×™×§×˜</th>
                            <th>×§×‘×œ×Ÿ</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${currentMonthExpenses.map(exp => `
                            <tr>
                                <td>${new Date(exp.date).toLocaleDateString('he-IL')}</td>
                                <td>${exp.description}</td>
                                <td>â‚ª${exp.amount.toLocaleString('he-IL')}</td>
                                <td>${exp.projectName || '-'}</td>
                                <td>${exp.contractorName || '-'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function showMissingReceiptsReport() {
            const container = document.getElementById('tabContent');

            const missingReceipts = appData.expenses.filter(exp => !exp.receiptUrl || exp.receiptUrl === '');
            const total = missingReceipts.reduce((sum, exp) => sum + exp.amount, 0);

            container.innerHTML = `
                <h2>×“×•×— ×§×‘×œ×•×ª ×—×¡×¨×•×ª</h2>
                <button class="btn-primary" onclick="showTab('reports')" style="margin-bottom: 20px;">
                    <i class="fas fa-arrow-right"></i> ×—×–×¨×” ×œ×“×•×—×•×ª
                </button>

                <div class="chart-container" style="margin-bottom: 24px;">
                    <h3>×¡×™×›×•×</h3>
                    <p><strong>${missingReceipts.length}</strong> ×”×•×¦××•×ª ×œ×œ× ×§×‘×œ×”</p>
                    <p>×¡×š ×”×›×œ: <strong>â‚ª${total.toLocaleString('he-IL')}</strong></p>
                </div>

                ${missingReceipts.length > 0 ? `
                    <table>
                        <thead>
                            <tr>
                                <th>×ª××¨×™×š</th>
                                <th>×ª×™××•×¨</th>
                                <th>×¡×›×•×</th>
                                <th>×¤×¨×•×™×§×˜</th>
                                <th>×§×‘×œ×Ÿ</th>
                                <th>×¤×¢×•×œ×•×ª</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${missingReceipts.map(exp => `
                                <tr>
                                    <td>${new Date(exp.date).toLocaleDateString('he-IL')}</td>
                                    <td>${exp.description}</td>
                                    <td>â‚ª${exp.amount.toLocaleString('he-IL')}</td>
                                    <td>${exp.projectName || '-'}</td>
                                    <td>${exp.contractorName || '-'}</td>
                                    <td>
                                        <button class="btn-edit" onclick="editExpense('${exp.expenseId}')">×”×¢×œ×” ×§×‘×œ×”</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                ` : '<p style="text-align: center; padding: 40px; color: #10b981;"><i class="fas fa-check-circle"></i> ×›×œ ×”×”×•×¦××•×ª ×›×•×œ×œ×•×ª ×§×‘×œ×•×ª!</p>'}
            `;
        }
    </script>
</body>
</html>