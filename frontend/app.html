<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××¢×¨×›×ª ××¢×§×‘ ×”×•×¦××•×ª ×‘× ×™×”</title>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <!-- html2pdf.js for PDF export with Hebrew support -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <!-- Paddle.js for payment checkout -->
    <script src="https://cdn.paddle.com/paddle/v2/paddle.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Rubik', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            color: #1a202c;
        }

        /* Clerk Auth Container */
        #clerkAuthContainer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #ffffff;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .clerk-loading {
            text-align: center;
            color: #4a5568;
        }

        .clerk-loading h2 {
            font-size: 1.5rem;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .spinner {
            border: 3px solid #e2e8f0;
            border-radius: 50%;
            border-top: 3px solid #3182ce;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Main App Container */
        #mainContent {
            display: none;
            width: 100%;
        }

        /* Header */
        .header {
            background: #ffffff;
            padding: 20px 40px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #1a202c;
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header h1 i {
            color: #3182ce;
            font-size: 1.3rem;
        }

        /* User Info */
        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-details {
            text-align: left;
        }

        .user-name {
            font-weight: 500;
            color: #2d3748;
            font-size: 1rem;
        }

        .company-name {
            font-size: 0.85rem;
            color: #718096;
        }

        .user-menu {
            display: flex;
            gap: 10px;
        }

        .btn-user {
            padding: 8px 16px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
            background: #ffffff;
        }

        .btn-profile {
            color: #3182ce;
            border-color: #3182ce;
        }

        .btn-profile:hover {
            background: #3182ce;
            color: white;
        }

        .btn-org {
            color: #38a169;
            border-color: #38a169;
        }

        .btn-org:hover {
            background: #38a169;
            color: white;
        }

        .btn-signout {
            color: #e53e3e;
            border-color: #e53e3e;
        }

        .btn-signout:hover {
            background: #e53e3e;
            color: white;
        }

        /* Main Container */
        .container {
            padding: 30px;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        /* Dashboard Cards */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
            transition: all 0.2s;
        }

        .card:hover {
            border-color: #cbd5e0;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        .card-icon {
            font-size: 1.25rem;
            margin-bottom: 12px;
            color: #718096;
        }

        .card-title {
            color: #718096;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .card-value {
            color: #1a202c;
            font-size: 2rem;
            font-weight: 700;
            line-height: 1;
        }

        /* Tabs */
        .tabs {
            background: white;
            border-radius: 12px;
            padding: 8px;
            margin-bottom: 24px;
            display: flex;
            gap: 4px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
        }

        .tab-button {
            padding: 10px 20px;
            border: none;
            background: transparent;
            color: #718096;
            cursor: pointer;
            border-radius: 8px;
            font-size: 0.9375rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .tab-button.active {
            background: #3182ce;
            color: white;
        }

        .tab-button:hover:not(.active) {
            background: #f7fafc;
            color: #4a5568;
        }

        /* Content Area */
        .content-area {
            background: white;
            border-radius: 12px;
            padding: 32px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
            min-height: 500px;
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #4a5568;
            font-weight: 500;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3182ce;
            box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.1);
        }

        .btn-primary {
            background: #3182ce;
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 8px;
            font-size: 0.9375rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .btn-primary:hover {
            background: #2c5282;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .btn-secondary {
            background: white;
            color: #3182ce;
            border: 1px solid #3182ce;
            padding: 10px 24px;
            border-radius: 8px;
            font-size: 0.9375rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .btn-secondary:hover {
            background: #f7fafc;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Message */
        .message {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .message.success {
            background: #c6f6d5;
            color: #22543d;
            border-left: 4px solid #48bb78;
        }

        .message.error {
            background: #fed7d7;
            color: #742a2a;
            border-left: 4px solid #f56565;
        }

        /* Role Badges */
        .role-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
            display: inline-block;
        }
        .role-admin {
            background: #3182ce;
            color: white;
        }
        .role-editor {
            background: #48bb78;
            color: white;
        }
        .role-viewer {
            background: #718096;
            color: white;
        }

        /* Table */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 24px;
        }

        th {
            background: #f7fafc;
            padding: 14px 16px;
            text-align: right;
            color: #4a5568;
            font-weight: 600;
            font-size: 0.875rem;
            border-bottom: 1px solid #e2e8f0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            padding: 16px;
            border-bottom: 1px solid #f0f0f0;
            color: #1a202c;
            font-size: 0.9375rem;
        }

        tr:hover {
            background: #fafafa;
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        /* Action Buttons */
        .btn-edit, .btn-delete {
            padding: 6px 16px;
            background: white;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            margin: 0 4px;
            font-family: 'Rubik', sans-serif;
        }

        .btn-edit {
            border: 1.5px solid #1a202c;
            color: #1a202c;
        }

        .btn-edit:hover {
            background: #1a202c;
            color: white;
        }

        .btn-delete {
            border: 1.5px solid #e53e3e;
            color: #e53e3e;
        }

        .btn-delete:hover {
            background: #c53030;
            border-color: #c53030;
            color: white;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: #718096;
        }

        .loading i {
            font-size: 3rem;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 32px;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            animation: slideDown 0.3s;
            border: 1px solid #e2e8f0;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-content h2 {
            color: #1a202c;
            margin-bottom: 28px;
            font-size: 1.5rem;
            font-weight: 700;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 16px;
        }

        .close {
            color: #718096;
            float: left;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close:hover,
        .close:focus {
            color: #2d3748;
        }

        .modal-content form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-height: calc(85vh - 180px);
            overflow-y: auto;
            overflow-x: hidden;
            padding-right: 8px;
        }

        .modal-content form::-webkit-scrollbar {
            width: 8px;
        }

        .modal-content form::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .modal-content form::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 4px;
        }

        .modal-content form::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }

        .modal-content .form-group {
            margin-bottom: 0;
        }

        .modal-content label {
            display: block;
            margin-bottom: 6px;
            color: #4a5568;
            font-weight: 500;
            font-size: 0.875rem;
        }

        .modal-content input,
        .modal-content select,
        .modal-content textarea {
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 1rem;
            font-family: 'Rubik', sans-serif;
            transition: border-color 0.3s;
        }

        .modal-content input[type="file"] {
            padding: 8px;
            cursor: pointer;
        }

        .modal-content input[type="file"]::file-selector-button {
            background: #3182ce;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
            font-family: 'Rubik', sans-serif;
        }

        .modal-content input[type="file"]::file-selector-button:hover {
            background: #2c5aa0;
        }

        .modal-content input:focus,
        .modal-content select:focus,
        .modal-content textarea:focus {
            outline: none;
            border-color: #3182ce;
            box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.1);
        }

        .modal-content textarea {
            min-height: 100px;
            resize: vertical;
        }

        .modal-content button[type="submit"] {
            background: #3182ce;
            color: white;
            padding: 11px 24px;
            border: none;
            border-radius: 8px;
            font-size: 0.9375rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .modal-content button[type="submit"]:hover {
            background: #2c5282;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .modal-content button[type="button"] {
            background: #ffffff;
            color: #4a5568;
            padding: 11px 24px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.9375rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-content button[type="button"]:hover {
            background: #f7fafc;
            border-color: #cbd5e0;
        }

        /* Charts and Reports */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.08);
        }

        .metric-icon {
            width: 48px;
            height: 48px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 12px;
        }

        .metric-icon.blue { background: #dbeafe; color: #3182ce; }
        .metric-icon.green { background: #d1fae5; color: #10b981; }
        .metric-icon.purple { background: #e9d5ff; color: #9333ea; }
        .metric-icon.orange { background: #fed7aa; color: #f97316; }

        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: #1a202c;
            margin: 8px 0;
        }

        .metric-label {
            color: #718096;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .metric-change {
            font-size: 0.875rem;
            margin-top: 8px;
            font-weight: 500;
        }

        .metric-change.positive { color: #10b981; }
        .metric-change.negative { color: #ef4444; }

        .chart-container {
            background: white;
            padding: 24px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
            margin-bottom: 24px;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        /* Billing Plan Cards */
        .billing-plan-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.12);
        }

        .billing-plan-card.current-plan {
            background: #f0fdf4;
        }

        .billing-plan-card.featured-plan {
            transform: scale(1.02);
        }

        .billing-plan-card.featured-plan:hover {
            transform: scale(1.02) translateY(-3px);
        }

        .chart-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1a202c;
        }

        .chart-canvas {
            position: relative;
            height: 300px;
        }

        .reports-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 24px;
        }

        .report-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.2s;
        }

        .report-card:hover {
            border-color: #3182ce;
            box-shadow: 0 4px 6px rgba(0,0,0,0.08);
        }

        .report-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin-bottom: 12px;
            background: #dbeafe;
            color: #3182ce;
        }

        .report-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1a202c;
            margin-bottom: 8px;
        }

        .report-description {
            font-size: 0.875rem;
            color: #718096;
        }

        .filter-bar {
            background: white;
            padding: 16px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            margin-bottom: 20px;
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-bar label {
            margin: 0;
            font-size: 0.875rem;
        }

        .filter-bar select, .filter-bar input {
            padding: 8px 12px;
            font-size: 0.875rem;
            min-width: 150px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            background: #3182ce;
            transition: width 0.3s;
        }

        .progress-fill.warning { background: #f97316; }
        .progress-fill.danger { background: #ef4444; }

        .budget-table {
            width: 100%;
            margin-top: 20px;
        }

        .budget-table td {
            padding: 12px;
        }

        .alert-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .alert-badge.success { background: #d1fae5; color: #065f46; }
        .alert-badge.warning { background: #fed7aa; color: #9a3412; }
        .alert-badge.danger { background: #fee2e2; color: #991b1b; }

        /* Details Modal Styles */
        .details-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .details-modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            padding: 24px 30px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .modal-tabs {
            display: flex;
            border-bottom: 1px solid #e2e8f0;
            background: #f8f9fa;
        }

        .modal-tab {
            flex: 1;
            padding: 16px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            color: #64748b;
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
        }

        .modal-tab:hover {
            background: #e2e8f0;
        }

        .modal-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: white;
        }

        .modal-body {
            padding: 30px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-tab-content {
            display: none;
        }

        .modal-tab-content.active {
            display: block;
        }

        .detail-row {
            display: flex;
            padding: 16px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-weight: 600;
            color: #475569;
            min-width: 150px;
            flex-shrink: 0;
        }

        .detail-value {
            color: #1e293b;
            flex: 1;
        }

        .receipts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .receipt-card {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            transition: all 0.2s;
        }

        .receipt-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-color: #667eea;
        }

        .receipt-date {
            font-size: 0.875rem;
            color: #64748b;
            margin-bottom: 8px;
        }

        .receipt-description {
            font-weight: 600;
            margin-bottom: 8px;
            color: #1e293b;
        }

        .receipt-amount {
            font-size: 1.25rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 12px;
        }

        .receipt-image-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #667eea;
            text-decoration: none;
            font-size: 0.875rem;
            padding: 8px 16px;
            border: 1px solid #667eea;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .receipt-image-link:hover {
            background: #667eea;
            color: white;
        }

        .no-receipts {
            text-align: center;
            padding: 60px 20px;
            color: #94a3b8;
        }

        .no-receipts i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .clickable-card {
            cursor: pointer;
            transition: all 0.2s;
        }

        .clickable-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
        }

        .clickable-row {
            cursor: pointer;
            transition: background 0.2s;
        }

        .clickable-row:hover {
            background: #f1f5f9;
        }

        /* ============================================ */
        /* MOBILE RESPONSIVE STYLES */
        /* ============================================ */

        /* Tablet and below (768px) */
        @media (max-width: 768px) {
            /* Navigation */
            nav {
                padding: 0.75rem 1rem;
            }

            nav .logo {
                font-size: 1.2rem;
            }

            nav .nav-links {
                gap: 0.75rem;
            }

            nav .nav-links a {
                font-size: 0.85rem;
                padding: 0.5rem 0.75rem;
            }

            /* Dashboard Stats Cards */
            .stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.75rem;
                padding: 1rem;
            }

            .stat-card {
                padding: 1rem;
            }

            .stat-card h3 {
                font-size: 0.85rem;
            }

            .stat-card .stat-value {
                font-size: 1.5rem;
            }

            /* Content Area */
            .content {
                padding: 1rem;
            }

            /* Tabs */
            .tabs {
                padding: 0 1rem;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .tab {
                white-space: nowrap;
                padding: 0.75rem 1rem;
                font-size: 0.9rem;
            }

            /* Buttons */
            .btn-primary, .btn-secondary, .btn-danger {
                padding: 0.75rem 1.25rem;
                font-size: 0.95rem;
                min-height: 44px; /* Touch-friendly */
            }

            /* Modal */
            .modal-content {
                width: 95%;
                max-width: 95%;
                margin: 1rem auto;
                max-height: 90vh;
                overflow-y: auto;
            }

            .modal-content h2 {
                font-size: 1.3rem;
            }

            /* Onboarding Modal - Stack tier cards */
            #onboardingModal .modal-content {
                max-width: 100%;
                padding: 1.5rem 1rem;
            }

            #onboardingModal .tier-card {
                padding: 1rem;
            }

            #onboardingModal .tier-card h4 {
                font-size: 1.1rem;
            }

            #onboardingModal .tier-card ul li {
                font-size: 0.85rem;
                padding: 6px 0;
            }

            /* Forms */
            form label {
                font-size: 0.9rem;
            }

            form input, form select, form textarea {
                padding: 0.75rem;
                font-size: 1rem; /* Prevent zoom on iOS */
                min-height: 44px;
            }

            /* Tables */
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            table {
                min-width: 600px;
            }

            table th, table td {
                padding: 0.75rem 0.5rem;
                font-size: 0.85rem;
            }

            /* Charts */
            .chart-card {
                padding: 1rem;
            }

            .chart-card h3 {
                font-size: 1.1rem;
            }

            /* Close button */
            .close {
                font-size: 2rem;
                padding: 0.25rem;
                min-width: 44px;
                min-height: 44px;
            }
        }

        /* Mobile phones (480px) */
        @media (max-width: 480px) {
            /* Single column layout */
            .stats {
                grid-template-columns: 1fr;
            }

            /* Navigation - minimal */
            nav .logo {
                font-size: 1rem;
            }

            nav .nav-links {
                gap: 0.5rem;
            }

            nav .nav-links a {
                font-size: 0.75rem;
                padding: 0.4rem 0.6rem;
            }

            nav .nav-links a i {
                font-size: 1rem;
            }

            nav .nav-links a span {
                display: none; /* Hide text, show only icons */
            }

            /* Tabs - scrollable */
            .tabs {
                padding: 0 0.5rem;
            }

            .tab {
                padding: 0.75rem 0.75rem;
                font-size: 0.85rem;
            }

            /* Content */
            .content {
                padding: 0.75rem;
            }

            .content h1 {
                font-size: 1.3rem;
            }

            /* Modal */
            .modal-content {
                width: 100%;
                max-width: 100%;
                margin: 0;
                border-radius: 0;
                max-height: 100vh;
                padding: 1rem;
            }

            .modal-content h2 {
                font-size: 1.2rem;
            }

            /* Onboarding - Stack tier cards vertically */
            #onboardingModal [style*="grid-template-columns: 1fr 1fr 1fr"] {
                display: flex !important;
                flex-direction: column !important;
                gap: 1rem !important;
            }

            #onboardingModal .tier-card {
                width: 100% !important;
            }

            #onboardingModal .tier-card div[style*="font-size: 36px"] {
                font-size: 24px !important;
            }

            /* Upgrade Modal - Stack tier cards */
            #upgradeModal [style*="grid-template-columns: 1fr 1fr"] {
                display: flex !important;
                flex-direction: column !important;
                gap: 1rem !important;
            }

            /* Buttons */
            .btn-primary, .btn-secondary, .btn-danger {
                width: 100%;
                padding: 1rem;
                font-size: 1rem;
            }

            /* Form inputs */
            form input, form select, form textarea {
                font-size: 16px !important; /* Prevent iOS zoom */
            }

            /* Table actions */
            table .actions {
                display: flex;
                flex-direction: column;
                gap: 0.25rem;
            }

            table .actions button {
                width: 100%;
                padding: 0.5rem;
                font-size: 0.8rem;
            }

            /* Receipt grid */
            .receipt-grid {
                grid-template-columns: 1fr !important;
            }

            /* Chart container */
            .chart-card canvas {
                max-height: 250px !important;
            }
        }

        /* Touch device optimizations */
        @media (hover: none) and (pointer: coarse) {
            /* Larger touch targets */
            button, a, input, select, textarea {
                min-height: 44px;
                min-width: 44px;
            }

            /* Remove hover effects on touch devices */
            .clickable-card:hover,
            .clickable-row:hover,
            .btn-primary:hover,
            .btn-secondary:hover,
            nav .nav-links a:hover,
            .tab:hover {
                transform: none;
            }

            /* Add active state for touch feedback */
            button:active, a:active {
                opacity: 0.7;
            }
        }

        /* Landscape mobile optimization */
        @media (max-width: 896px) and (orientation: landscape) {
            .modal-content {
                max-height: 85vh;
                overflow-y: auto;
            }

            .stats {
                grid-template-columns: repeat(4, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- Clerk Auth Container -->
    <div id="clerkAuthContainer">
        <div class="clerk-loading">
            <h2>××¢×¨×›×ª ××¢×§×‘ ×”×•×¦××•×ª ×‘× ×™×”</h2>
            <div class="spinner"></div>
            <p>×××ª×—×œ ××¢×¨×›×ª ××‘×˜×—×”...</p>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainContent">
        <div class="header">
            <h1>
                <i class="fas fa-hard-hat"></i>
                ××¢×¨×›×ª ××¢×§×‘ ×”×•×¦××•×ª ×‘× ×™×”
            </h1>
            <div class="user-info" id="userInfo">
                <div class="user-details">
                    <div class="user-name" id="userName">×˜×•×¢×Ÿ...</div>
                    <div class="company-name" id="headerCompanyName">×˜×•×¢×Ÿ...</div>
                </div>
                <div class="user-menu">
                    <button class="btn-user btn-profile" onclick="ClerkAuth.showUserProfile()">
                        <i class="fas fa-user"></i> ×¤×¨×•×¤×™×œ
                    </button>
                    <button class="btn-user btn-org" onclick="ClerkAuth.showOrganizationSwitcher()">
                        <i class="fas fa-building"></i> ×”×—×œ×£ ×—×‘×¨×”
                    </button>
                    <button class="btn-user btn-signout" onclick="signOut()">
                        <i class="fas fa-sign-out-alt"></i> ×™×¦×™××”
                    </button>
                </div>
            </div>
        </div>

        <div class="container">
            <!-- Dashboard Cards -->
            <div class="dashboard-cards">
                <div class="card">
                    <div class="card-title">×¡×”"×› ×”×•×¦××•×ª</div>
                    <div class="card-value" id="totalExpenses">â‚ª0</div>
                </div>
                <div class="card">
                    <div class="card-title">×¤×¨×•×™×§×˜×™× ×¤×¢×™×œ×™×</div>
                    <div class="card-value" id="activeProjects">0</div>
                </div>
                <div class="card">
                    <div class="card-title">×§×‘×œ× ×™×</div>
                    <div class="card-value" id="totalContractors">0</div>
                </div>
                <div class="card">
                    <div class="card-title">×”×•×¦××•×ª ×”×—×•×“×©</div>
                    <div class="card-value" id="monthlyExpenses">â‚ª0</div>
                </div>
            </div>

            <!-- Main Tabs -->
            <div class="tabs">
                <button class="tab-button active" onclick="showTab('expenses')">
                    <i class="fas fa-receipt"></i> ×”×•×¦××•×ª
                </button>
                <button class="tab-button" onclick="showTab('projects')">
                    <i class="fas fa-project-diagram"></i> ×¤×¨×•×™×§×˜×™×
                </button>
                <button class="tab-button" onclick="showTab('contractors')">
                    <i class="fas fa-users"></i> ×§×‘×œ× ×™×
                </button>
                <button class="tab-button" onclick="showTab('works')">
                    <i class="fas fa-hammer"></i> ×¢×‘×•×“×•×ª
                </button>
                <button class="tab-button" onclick="showTab('reports')">
                    <i class="fas fa-chart-bar"></i> ×“×•×—×•×ª
                </button>
                <button class="tab-button" onclick="showTab('billing')">
                    <i class="fas fa-credit-card"></i> ×—×™×•×‘ ×•×× ×•×™
                </button>
                <button class="tab-button" onclick="showTab('users')">
                    <i class="fas fa-user-friends"></i> ××©×ª××©×™×
                </button>
            </div>

            <!-- Content Area -->
            <div class="content-area">
                <div id="messageArea" class="message"></div>
                <div id="tabContent">
                    <!-- Tab content will be loaded here -->
                    <div class="loading">
                        <i class="fas fa-spinner"></i>
                        <p>×˜×•×¢×Ÿ × ×ª×•× ×™×...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Forms -->
    <div id="projectModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('projectModal')">&times;</span>
            <h2>×”×•×¡×£ ×¤×¨×•×™×§×˜ ×—×“×©</h2>
            <form id="projectForm" onsubmit="submitProject(event)">
                <input type="text" id="projectName" placeholder="×©× ×¤×¨×•×™×§×˜ *" required>
                <textarea id="projectDescription" placeholder="×ª×™××•×¨" rows="3"></textarea>
                <div class="form-group">
                    <label for="projectStartDate">×ª××¨×™×š ×”×ª×—×œ×” *</label>
                    <input type="date" id="projectStartDate" required>
                </div>
                <div class="form-group">
                    <label for="projectEndDate">×ª××¨×™×š ×¡×™×•×</label>
                    <input type="date" id="projectEndDate">
                </div>
                <input type="number" id="projectBudget" placeholder="×ª×§×¦×™×‘" step="0.01">
                <input type="text" id="projectLocation" placeholder="××™×§×•×">
                <input type="text" id="projectClient" placeholder="×©× ×œ×§×•×—">
                <button type="submit" class="btn-primary">×©××•×¨</button>
                <button type="button" class="btn-secondary" onclick="closeModal('projectModal')">×‘×™×˜×•×œ</button>
            </form>
        </div>
    </div>

    <div id="contractorModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('contractorModal')">&times;</span>
            <h2>×”×•×¡×£ ×§×‘×œ×Ÿ ×—×“×©</h2>
            <form id="contractorForm" onsubmit="submitContractor(event)">
                <input type="text" id="contractorName" placeholder="×©× ×§×‘×œ×Ÿ *" required>
                <input type="tel" id="contractorPhone" placeholder="×˜×œ×¤×•×Ÿ">
                <input type="text" id="contractorSpecialty" placeholder="×”×ª××—×•×ª">
                <button type="submit" class="btn-primary">×©××•×¨</button>
                <button type="button" class="btn-secondary" onclick="closeModal('contractorModal')">×‘×™×˜×•×œ</button>
            </form>
        </div>
    </div>

    <div id="workModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('workModal')">&times;</span>
            <h2>×”×•×¡×£ ×¢×‘×•×“×” ×—×“×©×”</h2>
            <form id="workForm" onsubmit="submitWork(event)">
                <input type="text" id="workName" placeholder="×©× ×¢×‘×•×“×” *" required>
                <select id="workProjectId" required>
                    <option value="">×‘×—×¨ ×¤×¨×•×™×§×˜ *</option>
                </select>
                <select id="workContractorId" required>
                    <option value="">×‘×—×¨ ×§×‘×œ×Ÿ *</option>
                </select>
                <input type="number" id="workCost" placeholder="×¢×œ×•×ª ×›×•×œ×œ×ª *" step="0.01" required>
                <textarea id="workDescription" placeholder="×ª×™××•×¨" rows="3"></textarea>
                <button type="submit" class="btn-primary">×©××•×¨</button>
                <button type="button" class="btn-secondary" onclick="closeModal('workModal')">×‘×™×˜×•×œ</button>
            </form>
        </div>
    </div>

    <div id="expenseModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('expenseModal')">&times;</span>
            <h2>×”×•×¡×£ ×”×•×¦××” ×—×“×©×”</h2>
            <form id="expenseForm" onsubmit="submitExpense(event)">
                <input type="text" id="expenseDescription" placeholder="×ª×™××•×¨ *" required>
                <input type="number" id="expenseAmount" placeholder="×¡×›×•× *" step="0.01" required>
                <input type="date" id="expenseDate" placeholder="×ª××¨×™×š *" required>
                <input type="text" id="expenseInvoice" placeholder="××¡×¤×¨ ×—×©×‘×•× ×™×ª *" required>
                <div class="form-group">
                    <label for="expenseReceipt">×ª××•× ×ª ×—×©×‘×•× ×™×ª / ×§×‘×œ×”</label>
                    <input type="file" id="expenseReceipt" accept="image/*,application/pdf">
                    <small id="receiptPreview" style="display: none; color: #3182ce; margin-top: 5px;"></small>
                </div>
                <select id="expensePayment" required>
                    <option value="">×××¦×¢×™ ×ª×©×œ×•× *</option>
                    <option value="Cash">××–×•××Ÿ</option>
                    <option value="Credit Card">×›×¨×˜×™×¡ ××©×¨××™</option>
                    <option value="Bank Transfer">×”×¢×‘×¨×” ×‘× ×§××™×ª</option>
                    <option value="Check">×”××—××”</option>
                </select>
                <select id="expenseWorkId" onchange="onWorkSelected()">
                    <option value="">×‘×—×¨ ×¢×‘×•×“×” (×××œ× ××•×˜×•××˜×™×ª ×¤×¨×•×™×§×˜ ×•×§×‘×œ×Ÿ)</option>
                </select>
                <select id="expenseProjectId">
                    <option value="">×‘×—×¨ ×¤×¨×•×™×§×˜ (××•×¤×¦×™×•× ×œ×™)</option>
                </select>
                <select id="expenseContractorId">
                    <option value="">×‘×—×¨ ×§×‘×œ×Ÿ (××•×¤×¦×™×•× ×œ×™)</option>
                </select>
                <button type="submit" class="btn-primary">×©××•×¨</button>
                <button type="button" class="btn-secondary" onclick="closeModal('expenseModal')">×‘×™×˜×•×œ</button>
            </form>
        </div>
    </div>

    <!-- Upgrade Modal -->
    <div id="upgradeModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <span class="close" onclick="closeModal('upgradeModal')">&times;</span>
            <div style="text-align: center; margin-bottom: 20px;">
                <div style="font-size: 48px; color: #e53e3e; margin-bottom: 10px;">âš ï¸</div>
                <h2 id="upgradeLimitMessage" style="color: #2d3748; margin: 0;">×”×’×¢×ª ×œ××’×‘×œ×ª ×”×ª×•×›× ×™×ª</h2>
            </div>

            <div id="upgradeUsageInfo" style="background: #f7fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center;">
                <p style="margin: 0; font-size: 16px; color: #4a5568;"></p>
            </div>

            <div style="margin-bottom: 20px;">
                <h3 style="text-align: center; color: #2d3748; margin-bottom: 15px;">×©×“×¨×’ ××ª ×”×ª×•×›× ×™×ª ×©×œ×š</h3>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <!-- Professional Tier -->
                    <div class="tier-card" data-tier="professional" style="border: 2px solid #3182ce; border-radius: 8px; padding: 20px; background: white; cursor: pointer; transition: all 0.3s;">
                        <h4 style="margin: 0 0 10px 0; color: #3182ce; font-size: 20px;">Professional</h4>
                        <div style="font-size: 32px; font-weight: bold; color: #2d3748; margin-bottom: 10px;">â‚ª200<span style="font-size: 14px; font-weight: normal; color: #718096;">/×—×•×“×©</span></div>
                        <ul style="list-style: none; padding: 0; margin: 0; text-align: right;">
                            <li style="padding: 5px 0; color: #4a5568;">âœ“ 3 ××©×ª××©×™×</li>
                            <li style="padding: 5px 0; color: #4a5568;">âœ“ 10 ×¤×¨×•×™×§×˜×™×</li>
                            <li style="padding: 5px 0; color: #4a5568;">âœ“ ×”×•×¦××•×ª ×œ×œ× ×”×’×‘×œ×”</li>
                            <li style="padding: 5px 0; color: #4a5568;">âœ“ ×”×¢×œ××ª ×§×‘×œ×•×ª</li>
                        </ul>
                    </div>

                    <!-- Enterprise Tier -->
                    <div class="tier-card" data-tier="enterprise" style="border: 2px solid #805ad5; border-radius: 8px; padding: 20px; background: white; cursor: pointer; transition: all 0.3s;">
                        <h4 style="margin: 0 0 10px 0; color: #805ad5; font-size: 20px;">Enterprise</h4>
                        <div style="font-size: 32px; font-weight: bold; color: #2d3748; margin-bottom: 10px;">â‚ª300<span style="font-size: 14px; font-weight: normal; color: #718096;">/×—×•×“×©</span></div>
                        <ul style="list-style: none; padding: 0; margin: 0; text-align: right;">
                            <li style="padding: 5px 0; color: #4a5568;">âœ“ 10 ××©×ª××©×™×</li>
                            <li style="padding: 5px 0; color: #4a5568;">âœ“ ×¤×¨×•×™×§×˜×™× ×œ×œ× ×”×’×‘×œ×”</li>
                            <li style="padding: 5px 0; color: #4a5568;">âœ“ ×”×•×¦××•×ª ×œ×œ× ×”×’×‘×œ×”</li>
                            <li style="padding: 5px 0; color: #4a5568;">âœ“ ×ª××™×›×” ××•×¢×“×¤×ª</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div style="text-align: center;">
                <button onclick="viewPricing()" class="btn-primary" style="padding: 12px 30px; font-size: 16px;">×¦×¤×” ×‘×›×œ ×”×ª×•×›× ×™×•×ª</button>
                <button onclick="closeModal('upgradeModal')" class="btn-secondary" style="padding: 12px 30px; font-size: 16px; margin-right: 10px;">×¡×’×•×¨</button>
            </div>
        </div>
    </div>

    <!-- Invite User Modal -->
    <div id="inviteUserModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('inviteUserModal')">&times;</span>
            <h2>×”×–××Ÿ ××©×ª××© ×—×“×©</h2>
            <form onsubmit="sendInvitation(event)">
                <label>××™××™×™×œ *</label>
                <input type="email" id="inviteEmail" required placeholder="user@example.com">
                <label>×©× ××œ× *</label>
                <input type="text" id="inviteName" required placeholder="×©× ××œ×">
                <label>×˜×œ×¤×•×Ÿ *</label>
                <input type="tel" id="invitePhone" required placeholder="050-1234567" pattern="[0-9\-]{9,12}">
                <label>×ª×¤×§×™×“ *</label>
                <select id="inviteRole" required>
                    <option value="">×‘×—×¨ ×ª×¤×§×™×“</option>
                    <option value="admin">×× ×”×œ</option>
                    <option value="editor">×¢×•×¨×š</option>
                    <option value="viewer">×¦×•×¤×”</option>
                </select>
                <button type="submit" class="btn-primary">×©×œ×— ×”×–×× ×”</button>
                <button type="button" class="btn-secondary" onclick="closeModal('inviteUserModal')">×‘×™×˜×•×œ</button>
            </form>
        </div>
    </div>

    <!-- Onboarding Modal -->
    <div id="onboardingModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 800px;">
            <div style="text-align: center; margin-bottom: 30px;">
                <div style="font-size: 64px; margin-bottom: 15px;">ğŸ—ï¸</div>
                <h2 style="color: #2d3748; margin: 0 0 10px 0;">×‘×¨×•×›×™× ×”×‘××™× ×œ-Builder Expenses!</h2>
                <p style="color: #718096; font-size: 16px;">×‘×•××• × ×’×“×™×¨ ××ª ×”×—×‘×¨×” ×©×œ×›× ×•× ×‘×—×¨ ×ª×•×›× ×™×ª ××ª××™××”</p>
            </div>

            <form id="onboardingForm" onsubmit="submitOnboarding(event)">
                <div style="margin-bottom: 30px;">
                    <label for="companyName" style="display: block; margin-bottom: 8px; font-weight: 500; color: #2d3748;">×©× ×”×—×‘×¨×”</label>
                    <input
                        type="text"
                        id="companyName"
                        name="companyName"
                        required
                        placeholder="×”×–×Ÿ ××ª ×©× ×”×—×‘×¨×”"
                        style="width: 100%; padding: 12px; border: 1px solid #cbd5e0; border-radius: 8px; font-size: 16px;"
                    >
                </div>

                <div style="margin-bottom: 30px;">
                    <label style="display: block; margin-bottom: 15px; font-weight: 500; color: #2d3748; font-size: 18px;">×‘×—×¨ ×ª×•×›× ×™×ª</label>

                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                        <!-- Starter Tier -->
                        <div class="tier-card" onclick="selectTier('starter')" data-tier="starter" style="border: 2px solid #cbd5e0; border-radius: 12px; padding: 20px; background: white; cursor: pointer; transition: all 0.3s; position: relative;">
                            <div style="position: absolute; top: 10px; left: 10px; background: #48bb78; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">×—×•×“×© × ×™×¡×™×•×Ÿ ×—×™× ×</div>
                            <h4 style="margin: 30px 0 10px 0; color: #48bb78; font-size: 22px; text-align: center;">Starter</h4>
                            <div style="text-align: center; font-size: 36px; font-weight: bold; color: #2d3748; margin-bottom: 15px;">â‚ª100<span style="font-size: 14px; font-weight: normal; color: #718096;">/×—×•×“×©</span></div>
                            <ul style="list-style: none; padding: 0; margin: 0; text-align: right;">
                                <li style="padding: 8px 0; color: #4a5568; border-bottom: 1px solid #e2e8f0;">âœ“ ××©×ª××© ××—×“</li>
                                <li style="padding: 8px 0; color: #4a5568; border-bottom: 1px solid #e2e8f0;">âœ“ 3 ×¤×¨×•×™×§×˜×™×</li>
                                <li style="padding: 8px 0; color: #4a5568; border-bottom: 1px solid #e2e8f0;">âœ“ 50 ×”×•×¦××•×ª ×‘×—×•×“×©</li>
                                <li style="padding: 8px 0; color: #4a5568;">âœ“ ×§×‘×œ× ×™× ×•×¢×‘×•×“×•×ª ×œ×œ× ×”×’×‘×œ×”</li>
                            </ul>
                            <p style="text-align: center; color: #718096; font-size: 13px; margin-top: 15px;">××•×©×œ× ×œ×¢×¡×§×™× ×§×˜× ×™×</p>
                        </div>

                        <!-- Professional Tier -->
                        <div class="tier-card" onclick="selectTier('professional')" data-tier="professional" style="border: 2px solid #cbd5e0; border-radius: 12px; padding: 20px; background: white; cursor: pointer; transition: all 0.3s; position: relative;">
                            <div style="position: absolute; top: 10px; left: 10px; background: #3182ce; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">××•××œ×¥ + ×—×•×“×© × ×™×¡×™×•×Ÿ</div>
                            <h4 style="margin: 30px 0 10px 0; color: #3182ce; font-size: 22px; text-align: center;">Professional</h4>
                            <div style="text-align: center; font-size: 36px; font-weight: bold; color: #2d3748; margin-bottom: 15px;">â‚ª200<span style="font-size: 14px; font-weight: normal; color: #718096;">/×—×•×“×©</span></div>
                            <ul style="list-style: none; padding: 0; margin: 0; text-align: right;">
                                <li style="padding: 8px 0; color: #4a5568; border-bottom: 1px solid #e2e8f0;">âœ“ 3 ××©×ª××©×™×</li>
                                <li style="padding: 8px 0; color: #4a5568; border-bottom: 1px solid #e2e8f0;">âœ“ 10 ×¤×¨×•×™×§×˜×™×</li>
                                <li style="padding: 8px 0; color: #4a5568; border-bottom: 1px solid #e2e8f0;">âœ“ ×”×•×¦××•×ª ×œ×œ× ×”×’×‘×œ×”</li>
                                <li style="padding: 8px 0; color: #4a5568;">âœ“ ×”×¢×œ××ª ×§×‘×œ×•×ª</li>
                            </ul>
                            <p style="text-align: center; color: #718096; font-size: 13px; margin-top: 15px;">×œ×¢×¡×§×™× ×§×˜× ×™× ×•×‘×™× ×•× ×™×™×</p>
                        </div>

                        <!-- Enterprise Tier -->
                        <div class="tier-card" onclick="selectTier('enterprise')" data-tier="enterprise" style="border: 2px solid #cbd5e0; border-radius: 12px; padding: 20px; background: white; cursor: pointer; transition: all 0.3s; position: relative;">
                            <div style="position: absolute; top: 10px; left: 10px; background: #805ad5; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">×—×•×“×© × ×™×¡×™×•×Ÿ ×—×™× ×</div>
                            <h4 style="margin: 30px 0 10px 0; color: #805ad5; font-size: 22px; text-align: center;">Enterprise</h4>
                            <div style="text-align: center; font-size: 36px; font-weight: bold; color: #2d3748; margin-bottom: 15px;">â‚ª300<span style="font-size: 14px; font-weight: normal; color: #718096;">/×—×•×“×©</span></div>
                            <ul style="list-style: none; padding: 0; margin: 0; text-align: right;">
                                <li style="padding: 8px 0; color: #4a5568; border-bottom: 1px solid #e2e8f0;">âœ“ 10 ××©×ª××©×™×</li>
                                <li style="padding: 8px 0; color: #4a5568; border-bottom: 1px solid #e2e8f0;">âœ“ ×¤×¨×•×™×§×˜×™× ×œ×œ× ×”×’×‘×œ×”</li>
                                <li style="padding: 8px 0; color: #4a5568; border-bottom: 1px solid #e2e8f0;">âœ“ ×”×•×¦××•×ª ×œ×œ× ×”×’×‘×œ×”</li>
                                <li style="padding: 8px 0; color: #4a5568;">âœ“ ×ª××™×›×” ××•×¢×“×¤×ª</li>
                            </ul>
                            <p style="text-align: center; color: #718096; font-size: 13px; margin-top: 15px;">×œ×¢×¡×§×™× ×’×“×•×œ×™×</p>
                        </div>
                    </div>

                    <input type="hidden" id="selectedTier" name="subscriptionTier">
                    <p id="tierError" style="color: #e53e3e; margin-top: 10px; display: none; text-align: center;">×× × ×‘×—×¨ ×ª×•×›× ×™×ª</p>
                </div>

                <div style="text-align: center; padding-top: 20px; border-top: 1px solid #e2e8f0;">
                    <button type="submit" class="btn-primary" style="padding: 14px 40px; font-size: 18px; font-weight: 600;">
                        ×”×ª×—×œ ×¢×›×©×™×•
                    </button>
                    <p style="color: #718096; font-size: 13px; margin-top: 15px;">× ×“×¨×© ××™××•×ª ×›×¨×˜×™×¡ ××©×¨××™ â€¢ ×œ×œ× ×—×™×•×‘ ×œ-30 ×™×•×</p>
                </div>
            </form>
        </div>
    </div>

    <!-- Clerk Configuration -->
    <script>
        // Clerk Configuration
        window.CLERK_PUBLISHABLE_KEY = 'pk_test_bW92ZWQtaHVza3ktOTguY2xlcmsuYWNjb3VudHMuZGV2JA';
        window.CLERK_FRONTEND_API = 'https://Builder-expenses.clerk.accounts.dev';

        // API Configuration
        const API_CONFIG = {
            endpoint: 'https://2woj5i92td.execute-api.us-east-1.amazonaws.com/prod'
        };

        // Set global API_BASE_URL for use throughout the app
        window.API_BASE_URL = API_CONFIG.endpoint;

        // Application State
        let currentUser = null;
        let currentOrganization = null;
        let currentCompany = null;
        let authToken = null;
        let currentTab = 'expenses'; // Track current active tab
        let appData = {
            expenses: [],
            projects: [],
            contractors: [],
            works: []
        };
    </script>

    <!-- Clerk Authentication Module -->
    <script src="clerk-auth.js"></script>

    <!-- Main Application Script -->
    <script>
        // Initialize Clerk when page loads
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Initialize Clerk
                await ClerkAuth.initialize();

                // Initialize Paddle (MUST be called once at page load)
                console.log('Initializing Paddle at page load');
                // Set Paddle environment to sandbox BEFORE Initialize
                Paddle.Environment.set("sandbox");
                Paddle.Initialize({
                    token: 'test_db12c8b3a07159acbe3dff44dba',
                    eventCallback: function(data) {
                        if (data.name === "checkout.completed") {
                            console.log('Paddle checkout completed!', data);
                            // Handle successful payment
                            handleCheckoutSuccess(data);
                        }
                    }
                });
                window.paddleInitialized = true;

                // Don't call initializeApp here - wait for onUserAuthenticated callback
                // Clerk will fire the callback when it finishes loading the session
                console.log('Clerk and Paddle initialized, waiting for auth callback...');

            } catch (error) {
                console.error('Failed to initialize Clerk:', error);
                showError('Failed to initialize authentication system');
            }
        });

        // Set up authentication callback
        window.onUserAuthenticated = async (user) => {
            console.log('User authenticated:', user);
            currentUser = user;
            await initializeApp();
        };

        window.onUserSignedOut = () => {
            console.log('User signed out');
            currentUser = null;
            currentOrganization = null;
            authToken = null;
            showClerkAuth();
        };

        // Show Clerk Authentication
        async function showClerkAuth() {
            document.getElementById('clerkAuthContainer').style.display = 'flex';
            document.getElementById('mainContent').style.display = 'none';

            // Update loading message
            const loadingDiv = document.querySelector('.clerk-loading');
            loadingDiv.innerHTML = `
                <h2>××¢×¨×›×ª ××¢×§×‘ ×”×•×¦××•×ª ×‘× ×™×”</h2>
                <div style="margin: 30px 0;">
                    <button class="btn-primary" onclick="ClerkAuth.showSignIn()" style="margin: 10px;">
                        <i class="fas fa-sign-in-alt"></i> ×”×ª×—×‘×¨×•×ª
                    </button>
                    <button class="btn-primary" onclick="ClerkAuth.showSignUp()" style="margin: 10px;">
                        <i class="fas fa-user-plus"></i> ×”×¨×©××”
                    </button>
                </div>
                <p style="color: white; margin-top: 20px;">××¢×¨×›×ª ×××•×‘×˜×—×ª ×¢× Clerk Authentication</p>
            `;
        }

        // Handle successful Paddle checkout (called by eventCallback)
        async function handleCheckoutSuccess(data) {
            console.log('Paddle checkout.completed event received:', data);

            try {
                // Get company details from sessionStorage
                const companyName = sessionStorage.getItem('paddle_company_name');
                const subscriptionTier = sessionStorage.getItem('paddle_tier');

                if (!companyName || !subscriptionTier) {
                    // This checkout.completed event is for an UPGRADE (or downgrade), not new registration
                    console.log('[CHECKOUT] No sessionStorage - this is an upgrade/tier change for existing customer');

                    // Check if user is logged in
                    if (currentUser && appData.company) {
                        console.log('[CHECKOUT] User is logged in. Refreshing company data after upgrade...');

                        const oldTier = appData.company.subscriptionTier;
                        console.log('[CHECKOUT] Current tier before webhook:', oldTier);

                        showSuccess('×”×ª×©×œ×•× ×”×•×©×œ× ×‘×”×¦×œ×—×”! ××—×›×” ×œ××™×©×•×¨ ××”×©×¨×ª...');

                        // Poll for tier update (webhook processing can take 5-15 seconds)
                        let tierUpdated = false;
                        const maxRetries = 15; // 15 attempts = up to 15 seconds

                        for (let i = 0; i < maxRetries; i++) {
                            console.log(`[CHECKOUT] Polling attempt ${i + 1}/${maxRetries}`);

                            // Wait 1 second before each check
                            await new Promise(resolve => setTimeout(resolve, 1000));

                            // Reload company data
                            await loadAppData();

                            // Check if tier changed
                            const newTier = appData.company?.subscriptionTier;
                            console.log(`[CHECKOUT] Tier check: ${oldTier} -> ${newTier}`);

                            if (newTier && newTier !== oldTier) {
                                tierUpdated = true;
                                console.log('[CHECKOUT] âœ… Tier updated successfully!');
                                break;
                            }
                        }

                        if (tierUpdated) {
                            console.log('[CHECKOUT] Final tier:', appData.company?.subscriptionTier);

                            // Refresh the billing tab if we're on it AND the container exists
                            const appContainer = document.getElementById('app');
                            if (currentTab === 'billing' && appContainer) {
                                console.log('[CHECKOUT] Refreshing billing tab...');
                                showBillingTab(appContainer);
                            } else {
                                console.log('[CHECKOUT] Not on billing tab. User will see updated tier when they navigate to billing.');
                            }

                            showSuccess('×”×× ×•×™ ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”!');
                        } else {
                            console.warn('[CHECKOUT] Timeout waiting for tier update. Webhook may still be processing.');
                            showSuccess('×”×ª×©×œ×•× ×”×ª×§×‘×œ! ×”×× ×•×™ ××ª×¢×“×›×Ÿ ×‘×¨×§×¢. ×¨×¢× ×Ÿ ××ª ×”×“×£ ×ª×•×š ××¡×¤×¨ ×©× ×™×•×ª.');
                        }
                    } else {
                        console.log('[CHECKOUT] User not logged in or no company - ignoring checkout event');
                    }

                    return;
                }

                console.log(`Creating company: ${companyName} with tier: ${subscriptionTier}`);

                // Show loading message
                showSuccess(`××¢×‘×“ ×¨×™×©×•× ×—×‘×¨×”... ×× × ×”××ª×Ÿ`);

                // Call register-company-clerk API to create the company
                const response = await apiCall('/register-company-clerk', 'POST', {
                    companyName: companyName,
                    subscriptionTier: subscriptionTier.toLowerCase()
                });

                if (response.success) {
                    console.log('Company registered successfully!', response);

                    // Clear sessionStorage
                    sessionStorage.removeItem('paddle_checkout_in_progress');
                    sessionStorage.removeItem('paddle_company_name');
                    sessionStorage.removeItem('paddle_tier');

                    // Close the onboarding modal
                    document.getElementById('onboardingModal').style.display = 'none';

                    // Show success message
                    showSuccess(`×‘×¨×•×š ×”×‘×! ×”×—×‘×¨×” "${companyName}" × ×•×¦×¨×” ×‘×”×¦×œ×—×”! ×ª×§×•×¤×ª × ×™×¡×™×•×Ÿ ×©×œ 30 ×™×•× ×”×—×œ×”.`);

                    // Reload the app to initialize with the new company
                    setTimeout(() => {
                        location.reload();
                    }, 1500);

                } else {
                    throw new Error(response.message || 'Failed to register company');
                }

            } catch (error) {
                console.error('Error in handleCheckoutSuccess:', error);
                showError('×©×’×™××” ×‘×¨×™×©×•× ×”×—×‘×¨×”. ×× × ×¤× ×” ×œ×ª××™×›×”.');
            }
        }

        // Handle return from Paddle checkout
        async function handlePaddleCheckoutReturn() {
            const companyName = sessionStorage.getItem('paddle_company_name');
            const tier = sessionStorage.getItem('paddle_tier');

            // Show loading message
            showSuccess(`××¢×‘×“ ×ª×©×œ×•× ×¢×‘×•×¨ ${companyName}... ×× × ×”××ª×Ÿ ×œ××™×©×•×¨ (×¢×“ 30 ×©× ×™×•×ª)`);

            // Poll for company creation (webhook might take a few seconds)
            const maxAttempts = 30; // 30 attempts = 30 seconds with 1 second delay
            let attempts = 0;

            const pollForCompany = async () => {
                attempts++;
                console.log(`Polling for company creation attempt ${attempts}/${maxAttempts}...`);

                try {
                    // Try to load app data (which checks for company)
                    await loadAppData();

                    // If we got here, company was created successfully
                    console.log('Company created successfully! Welcome!');

                    // Clear session storage
                    sessionStorage.removeItem('paddle_checkout_in_progress');
                    sessionStorage.removeItem('paddle_company_name');
                    sessionStorage.removeItem('paddle_tier');

                    // Show success message
                    showSuccess(`×‘×¨×•×š ×”×‘×! ×”×—×‘×¨×” ${companyName} × ×•×¦×¨×” ×‘×”×¦×œ×—×”! ×ª×§×•×¤×ª × ×™×¡×™×•×Ÿ ×©×œ 30 ×™×•× ×”×—×œ×”.`);

                    // Show expenses tab
                    showTab('expenses');

                } catch (error) {
                    if (attempts < maxAttempts) {
                        // Company not created yet, try again in 1 second
                        setTimeout(pollForCompany, 1000);
                    } else {
                        // Max attempts reached
                        console.error('Failed to confirm company creation after', maxAttempts, 'attempts');

                        // Clear session storage
                        sessionStorage.removeItem('paddle_checkout_in_progress');
                        sessionStorage.removeItem('paddle_company_name');
                        sessionStorage.removeItem('paddle_tier');

                        showError('×ª×©×œ×•× ×‘×•×¦×¢, ××š ×™×¦×™×¨×ª ×”×—×‘×¨×” ×œ×•×§×—×ª ×™×•×ª×¨ ×–××Ÿ ××”×¨×’×™×œ. × ×¡×” ×œ×˜×¢×•×Ÿ ××—×“×© ××ª ×”×“×£ ×‘×¢×•×“ ×›××” ×©× ×™×•×ª.');

                        // Try to load app data anyway - might show onboarding modal
                        await loadAppData();
                    }
                }
            };

            // Start polling
            await pollForCompany();
        }

        // Initialize Application
        async function initializeApp() {
            try {
                // Hide auth container
                document.getElementById('clerkAuthContainer').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';

                // Get auth token
                authToken = await ClerkAuth.getAuthToken();

                // Get user info
                currentUser = window.currentUser;
                if (currentUser) {
                    document.getElementById('userName').textContent = currentUser.name || currentUser.email;

                    // Company name will be loaded by loadAppData()
                    document.getElementById('headerCompanyName').textContent = '×˜×•×¢×Ÿ...';
                }

                // Check if returning from Paddle checkout
                if (sessionStorage.getItem('paddle_checkout_in_progress') === 'true') {
                    console.log('Returning from Paddle checkout - polling for company creation...');
                    await handlePaddleCheckoutReturn();
                    return; // handlePaddleCheckoutReturn will call loadAppData when ready
                }

                // Load application data
                await loadAppData();

                // Show initial tab only if not already on a tab (initial load)
                if (!currentTab) {
                    console.log('[INIT] First load - showing expenses tab');
                    showTab('expenses');
                } else {
                    console.log('[INIT] Re-authentication - staying on current tab:', currentTab);
                    // Refresh the current tab to update data
                    refreshCurrentTab();
                }

            } catch (error) {
                console.error('Failed to initialize app:', error);
                showError('Failed to initialize application');
            }
        }

        // Load Application Data
        async function loadAppData(skipCompanyCheck = false) {
            try {
                // Check if company exists and load company data
                const companyResp = await apiCall('/get-company');

                // If company doesn't exist, show onboarding modal
                if (!companyResp.companyExists) {
                    console.log('[ONBOARDING] No company found - showing onboarding modal');
                    showOnboardingModal();
                    return;
                }

                // Store company data and update header
                currentCompany = companyResp.company;
                appData.company = companyResp.company; // Store in appData for billing functionality
                console.log('[LOAD] Company loaded:', currentCompany.name);
                document.getElementById('headerCompanyName').textContent = currentCompany.name;

                // Update user role with actual DynamoDB role
                if (window.currentUser && companyResp.userInfo) {
                    window.currentUser.role = companyResp.userInfo.role;
                    window.currentUser.isAdmin = companyResp.userInfo.isAdmin;
                    console.log('[LOAD] User role updated from DynamoDB:', {
                        userId: window.currentUser.id,
                        email: window.currentUser.email,
                        role: window.currentUser.role,
                        isAdmin: window.currentUser.isAdmin
                    });
                }

                // Company exists - load all data in parallel
                const [expensesResp, projectsResp, contractorsResp, worksResp] = await Promise.all([
                    apiCall('/expenses'),
                    apiCall('/projects'),
                    apiCall('/contractors'),
                    apiCall('/works')
                ]);

                appData.expenses = expensesResp.expenses || [];
                appData.projects = projectsResp.projects || [];
                appData.contractors = contractorsResp.contractors || [];
                appData.works = worksResp.works || [];

                updateDashboard();

            } catch (error) {
                console.error('Failed to load data:', error);
                showError('Failed to load application data');
            }
        }

        // API Call Helper with Clerk Authentication
        async function apiCall(endpoint, method = 'GET', data = null) {
            try {
                // Ensure we have a valid token
                const token = await ClerkAuth.ensureValidToken();

                const response = await fetch(`${API_CONFIG.endpoint}${endpoint}`, {
                    method,
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: data ? JSON.stringify(data) : null
                });

                if (!response.ok) {
                    // Try to parse error response
                    let errorMessage = response.statusText;
                    try {
                        const errorData = await response.json();

                        // Handle tier limit errors
                        if (response.status === 403 && errorData.data?.reason && errorData.data.reason.includes('LIMIT')) {
                            showUpgradeModal(errorData);
                            throw new Error('TIER_LIMIT'); // Special error to prevent generic error display
                        }

                        // Use the error message from the API response if available
                        if (errorData.message) {
                            errorMessage = errorData.message;
                        }

                        console.error('API Error Details:', errorData);
                    } catch (e) {
                        if (e.message === 'TIER_LIMIT') throw e;
                        // If JSON parsing fails, use statusText
                    }
                    throw new Error(`API call failed: ${errorMessage}`);
                }

                return await response.json();

            } catch (error) {
                console.error('API call error:', error);
                throw error;
            }
        }

        // Update Dashboard
        function updateDashboard() {
            // Calculate totals
            const totalExpenses = appData.expenses.reduce((sum, exp) => sum + (exp.amount || 0), 0);
            const activeProjects = appData.projects.length;
            const totalContractors = appData.contractors.length;

            // Calculate monthly expenses
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const monthlyExpenses = appData.expenses
                .filter(exp => {
                    const date = new Date(exp.date);
                    return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
                })
                .reduce((sum, exp) => sum + (exp.amount || 0), 0);

            // Update UI
            document.getElementById('totalExpenses').textContent = `â‚ª${totalExpenses.toLocaleString('he-IL')}`;
            document.getElementById('activeProjects').textContent = activeProjects;
            document.getElementById('totalContractors').textContent = totalContractors;
            document.getElementById('monthlyExpenses').textContent = `â‚ª${monthlyExpenses.toLocaleString('he-IL')}`;
        }

        // Show Tab
        function showTab(tabName) {
            console.log('[TAB DEBUG] showTab called with:', tabName);
            console.log('[TAB DEBUG] Current tab before change:', currentTab);

            // Store current tab
            currentTab = tabName;

            // Update active tab
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            // Find and activate the button for this tab
            const activeButton = Array.from(document.querySelectorAll('.tab-button')).find(btn =>
                btn.textContent.includes(tabName) || btn.onclick?.toString().includes(`'${tabName}'`)
            );
            if (activeButton) {
                activeButton.classList.add('active');
                console.log('[TAB DEBUG] Activated button:', activeButton.textContent.trim());
            } else {
                console.warn('[TAB DEBUG] No button found for tab:', tabName);
            }

            // Load tab content
            const tabContent = document.getElementById('tabContent');

            try {
                switch(tabName) {
                    case 'expenses':
                        showExpensesTab(tabContent);
                        break;
                    case 'projects':
                        showProjectsTab(tabContent);
                        break;
                    case 'contractors':
                        showContractorsTab(tabContent);
                        break;
                    case 'works':
                        showWorksTab(tabContent);
                        break;
                    case 'reports':
                        showReportsTab(tabContent);
                        break;
                    case 'billing':
                        showBillingTab(tabContent);
                        break;
                    case 'users':
                        showUsersTab(tabContent);
                        break;
                    default:
                        console.error('[TAB DEBUG] Unknown tab:', tabName);
                }
                console.log('[TAB DEBUG] Tab content loaded successfully for:', tabName);
            } catch (error) {
                console.error('[TAB DEBUG] Error loading tab content:', error);
            }
        }

        // Refresh current tab (used after data updates)
        function refreshCurrentTab() {
            showTab(currentTab);
        }

        // Show Expenses Tab
        function showExpensesTab(container) {
            container.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">×”×•×¦××•×ª</h2>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn-secondary" onclick="exportExpensesToPDF()">
                            <i class="fas fa-file-pdf"></i> ×™×™×¦× ×œ-PDF
                        </button>
                        <button class="btn-primary" onclick="showAddExpenseForm()">
                            <i class="fas fa-plus"></i> ×”×•×¡×£ ×”×•×¦××”
                        </button>
                    </div>
                </div>

                <!-- Search and Filters -->
                <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #475569;">×—×™×¤×•×©</label>
                            <input type="text" id="expenseSearch" placeholder="×—×¤×© ×œ×¤×™ ×ª×™××•×¨..."
                                   style="width: 100%; padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 6px;"
                                   oninput="filterExpenses()">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #475569;">×¤×¨×•×™×§×˜</label>
                            <select id="projectFilter" style="width: 100%; padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 6px;" onchange="filterExpenses()">
                                <option value="">×›×œ ×”×¤×¨×•×™×§×˜×™×</option>
                                ${appData.projects.map(p => `<option value="${p.projectId}">${p.name}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #475569;">×§×‘×œ×Ÿ</label>
                            <select id="contractorFilter" style="width: 100%; padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 6px;" onchange="filterExpenses()">
                                <option value="">×›×œ ×”×§×‘×œ× ×™×</option>
                                ${appData.contractors.map(c => `<option value="${c.contractorId}">${c.name}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #475569;">×ª×§×•×¤×”</label>
                            <select id="dateRangeFilter" style="width: 100%; padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 6px;" onchange="handleDateRangeChange()">
                                <option value="all">×›×œ ×”×ª×§×•×¤×•×ª</option>
                                <option value="today">×”×™×•×</option>
                                <option value="week">×”×©×‘×•×¢</option>
                                <option value="month">×”×—×•×“×©</option>
                                <option value="year">×”×©× ×”</option>
                                <option value="custom">×ª×§×•×¤×” ××•×ª×××ª ××™×©×™×ª</option>
                            </select>
                        </div>
                        <div id="customDateRange" style="display: none;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #475569;">××ª××¨×™×š</label>
                            <input type="date" id="startDate" style="width: 100%; padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 6px;" onchange="filterExpenses()">
                        </div>
                        <div id="customDateRangeEnd" style="display: none;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #475569;">×¢×“ ×ª××¨×™×š</label>
                            <input type="date" id="endDate" style="width: 100%; padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 6px;" onchange="filterExpenses()">
                        </div>
                    </div>
                </div>

                <table id="expensesTable">
                    <thead>
                        <tr>
                            <th>×ª××¨×™×š</th>
                            <th>×ª×™××•×¨</th>
                            <th>×¡×›×•×</th>
                            <th>×¢×‘×•×“×”</th>
                            <th>×¤×¨×•×™×§×˜</th>
                            <th>×§×‘×œ×Ÿ</th>
                            <th>×§×‘×œ×”</th>
                            <th>×¤×¢×•×œ×•×ª</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${appData.expenses.map(expense => `
                            <tr>
                                <td>${new Date(expense.date).toLocaleDateString('he-IL')}</td>
                                <td>${expense.description}</td>
                                <td>â‚ª${expense.amount.toLocaleString('he-IL')}</td>
                                <td>${expense.workName || '-'}</td>
                                <td>${expense.projectName || '-'}</td>
                                <td>${expense.contractorName || '-'}</td>
                                <td>
                                    ${expense.receiptUrl ? `<a href="${expense.receiptUrl}" target="_blank" class="btn-secondary" style="display: inline-block; padding: 6px 12px; text-decoration: none;"><i class="fas fa-file-image"></i> ×¦×¤×”</a>` : '-'}
                                </td>
                                <td>
                                    <button class="btn-edit" onclick="editExpense('${expense.expenseId}')">×¢×¨×•×š</button>
                                    <button class="btn-delete" onclick="deleteExpense('${expense.expenseId}')">××—×§</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            // Initial render
            filterExpenses();
        }

        // Handle Date Range Change
        window.handleDateRangeChange = function() {
            const dateRangeFilter = document.getElementById('dateRangeFilter')?.value;
            const customDateRange = document.getElementById('customDateRange');
            const customDateRangeEnd = document.getElementById('customDateRangeEnd');

            if (dateRangeFilter === 'custom') {
                customDateRange.style.display = 'block';
                customDateRangeEnd.style.display = 'block';
            } else {
                customDateRange.style.display = 'none';
                customDateRangeEnd.style.display = 'none';
            }
            filterExpenses();
        }

        // Filter Expenses
        window.filterExpenses = function() {
            const searchTerm = document.getElementById('expenseSearch')?.value.toLowerCase() || '';
            const projectFilter = document.getElementById('projectFilter')?.value || '';
            const contractorFilter = document.getElementById('contractorFilter')?.value || '';
            const dateRangeFilter = document.getElementById('dateRangeFilter')?.value || 'all';
            const startDate = document.getElementById('startDate')?.value;
            const endDate = document.getElementById('endDate')?.value;

            let filtered = appData.expenses.filter(expense => {
                // Search filter
                const matchesSearch = !searchTerm ||
                    expense.description.toLowerCase().includes(searchTerm) ||
                    (expense.projectName && expense.projectName.toLowerCase().includes(searchTerm)) ||
                    (expense.contractorName && expense.contractorName.toLowerCase().includes(searchTerm));

                // Project filter
                const matchesProject = !projectFilter || expense.projectId === projectFilter;

                // Contractor filter
                const matchesContractor = !contractorFilter || expense.contractorId === contractorFilter;

                // Date range filter
                let matchesDate = true;
                if (dateRangeFilter !== 'all') {
                    const expenseDate = new Date(expense.date);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);

                    if (dateRangeFilter === 'custom') {
                        // Custom date range
                        if (startDate) {
                            const start = new Date(startDate);
                            start.setHours(0, 0, 0, 0);
                            matchesDate = matchesDate && expenseDate >= start;
                        }
                        if (endDate) {
                            const end = new Date(endDate);
                            end.setHours(23, 59, 59, 999);
                            matchesDate = matchesDate && expenseDate <= end;
                        }
                    } else {
                        switch(dateRangeFilter) {
                            case 'today':
                                matchesDate = expenseDate >= today;
                                break;
                            case 'week':
                                const weekAgo = new Date(today);
                                weekAgo.setDate(weekAgo.getDate() - 7);
                                matchesDate = expenseDate >= weekAgo;
                                break;
                            case 'month':
                                const monthAgo = new Date(today);
                                monthAgo.setMonth(monthAgo.getMonth() - 1);
                                matchesDate = expenseDate >= monthAgo;
                                break;
                            case 'year':
                                const yearAgo = new Date(today);
                                yearAgo.setFullYear(yearAgo.getFullYear() - 1);
                                matchesDate = expenseDate >= yearAgo;
                                break;
                        }
                    }
                }

                return matchesSearch && matchesProject && matchesContractor && matchesDate;
            });

            // Render filtered expenses
            const tbody = document.querySelector('#expensesTable tbody');
            if (tbody) {
                tbody.innerHTML = filtered.map(expense => `
                    <tr>
                        <td>${new Date(expense.date).toLocaleDateString('he-IL')}</td>
                        <td>${expense.description}</td>
                        <td>â‚ª${expense.amount.toLocaleString('he-IL')}</td>
                        <td>${expense.workName || '-'}</td>
                        <td>${expense.projectName || '-'}</td>
                        <td>${expense.contractorName || '-'}</td>
                        <td>
                            ${expense.receiptUrl ? `<a href="${expense.receiptUrl}" target="_blank" class="btn-secondary" style="display: inline-block; padding: 6px 12px; text-decoration: none;"><i class="fas fa-file-image"></i> ×¦×¤×”</a>` : '-'}
                        </td>
                        <td>
                            <button class="btn-edit" onclick="editExpense('${expense.expenseId}')">×¢×¨×•×š</button>
                            <button class="btn-delete" onclick="deleteExpense('${expense.expenseId}')">××—×§</button>
                        </td>
                    </tr>
                `).join('');
            }
        }

        // Export Expenses to CSV
        window.exportExpensesToCSV = function() {
            const searchTerm = document.getElementById('expenseSearch')?.value.toLowerCase() || '';
            const projectFilter = document.getElementById('projectFilter')?.value || '';
            const contractorFilter = document.getElementById('contractorFilter')?.value || '';
            const dateRangeFilter = document.getElementById('dateRangeFilter')?.value || 'all';
            const startDate = document.getElementById('startDate')?.value;
            const endDate = document.getElementById('endDate')?.value;

            // Use same filter logic as filterExpenses
            let filtered = appData.expenses.filter(expense => {
                const matchesSearch = !searchTerm ||
                    expense.description.toLowerCase().includes(searchTerm) ||
                    (expense.projectName && expense.projectName.toLowerCase().includes(searchTerm)) ||
                    (expense.contractorName && expense.contractorName.toLowerCase().includes(searchTerm));

                const matchesProject = !projectFilter || expense.projectId === projectFilter;
                const matchesContractor = !contractorFilter || expense.contractorId === contractorFilter;

                let matchesDate = true;
                if (dateRangeFilter !== 'all') {
                    const expenseDate = new Date(expense.date);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);

                    if (dateRangeFilter === 'custom') {
                        if (startDate) {
                            const start = new Date(startDate);
                            start.setHours(0, 0, 0, 0);
                            matchesDate = matchesDate && expenseDate >= start;
                        }
                        if (endDate) {
                            const end = new Date(endDate);
                            end.setHours(23, 59, 59, 999);
                            matchesDate = matchesDate && expenseDate <= end;
                        }
                    } else {
                        switch(dateRangeFilter) {
                            case 'today': matchesDate = expenseDate >= today; break;
                            case 'week':
                                const weekAgo = new Date(today);
                                weekAgo.setDate(weekAgo.getDate() - 7);
                                matchesDate = expenseDate >= weekAgo;
                                break;
                            case 'month':
                                const monthAgo = new Date(today);
                                monthAgo.setMonth(monthAgo.getMonth() - 1);
                                matchesDate = expenseDate >= monthAgo;
                                break;
                            case 'year':
                                const yearAgo = new Date(today);
                                yearAgo.setFullYear(yearAgo.getFullYear() - 1);
                                matchesDate = expenseDate >= yearAgo;
                                break;
                        }
                    }
                }
                return matchesSearch && matchesProject && matchesContractor && matchesDate;
            });

            // Group by project, then by contractor
            const groupedData = {};
            filtered.forEach(expense => {
                const projectKey = expense.projectName || '×œ×œ× ×¤×¨×•×™×§×˜';
                const contractorKey = expense.contractorName || '×œ×œ× ×§×‘×œ×Ÿ';

                if (!groupedData[projectKey]) {
                    groupedData[projectKey] = {};
                }
                if (!groupedData[projectKey][contractorKey]) {
                    groupedData[projectKey][contractorKey] = [];
                }
                groupedData[projectKey][contractorKey].push(expense);
            });

            // Build comprehensive CSV content
            let csvRows = [];

            // Report Header
            const reportDate = new Date().toLocaleString('he-IL');
            const dateRangeText = dateRangeFilter === 'custom' && startDate && endDate
                ? `${startDate} ×¢×“ ${endDate}`
                : dateRangeFilter === 'all' ? '×›×œ ×”×ª×§×•×¤×•×ª' : dateRangeFilter;

            csvRows.push('\ufeff"×“×•×— ×”×•×¦××•×ª - ××¢×¨×›×ª ××¢×§×‘ ×”×•×¦××•×ª ×‘× ×™×”"');
            csvRows.push(`"×ª××¨×™×š ×“×•×—: ${reportDate}"`);
            csvRows.push(`"×ª×§×•×¤×ª ×”×“×•×—: ${dateRangeText}"`);
            csvRows.push(`"×¡×”\\"×› ×”×•×¦××•×ª: ${filtered.length}"`);
            csvRows.push(`"×¡×›×•× ×›×•×œ×œ: â‚ª${filtered.reduce((sum, e) => sum + e.amount, 0).toLocaleString('he-IL')}"`);
            csvRows.push('');

            // Detailed headers for all fields (reversed for RTL display in Excel)
            const rlm = '\u200F'; // Right-to-Left Mark
            const headers = [
                `${rlm}×§×™×©×•×¨ ×œ×§×‘×œ×”`,
                `${rlm}××–×”×” ×¢×‘×•×“×”`,
                `${rlm}××–×”×” ×§×‘×œ×Ÿ`,
                `${rlm}××–×”×” ×¤×¨×•×™×§×˜`,
                `${rlm}××–×”×” ×”×•×¦××”`,
                `${rlm}×¢×‘×•×“×”`,
                `${rlm}×§×‘×œ×Ÿ`,
                `${rlm}×¤×¨×•×™×§×˜`,
                `${rlm}×¡×›×•×`,
                `${rlm}×ª×™××•×¨`,
                `${rlm}×ª××¨×™×š`
            ];

            // Process each project
            Object.keys(groupedData).sort().forEach(projectName => {
                const projectExpenses = Object.values(groupedData[projectName]).flat();
                const projectTotal = projectExpenses.reduce((sum, e) => sum + e.amount, 0);

                csvRows.push('');
                csvRows.push(`"=== ×¤×¨×•×™×§×˜: ${projectName} ==="`);
                csvRows.push(`"×¡×”\\"×› ×”×•×¦××•×ª ×‘×¤×¨×•×™×§×˜: ${projectExpenses.length}"`);
                csvRows.push(`"×¡×›×•× ×›×•×œ×œ: â‚ª${projectTotal.toLocaleString('he-IL')}"`);
                csvRows.push('');

                // Process each contractor in this project
                Object.keys(groupedData[projectName]).sort().forEach(contractorName => {
                    const contractorExpenses = groupedData[projectName][contractorName];
                    const contractorTotal = contractorExpenses.reduce((sum, e) => sum + e.amount, 0);

                    csvRows.push(`"--- ×§×‘×œ×Ÿ: ${contractorName} ---"`);
                    csvRows.push(`"×¡×”\\"×› ×”×•×¦××•×ª ×œ×§×‘×œ×Ÿ: ${contractorExpenses.length} | ×¡×›×•×: â‚ª${contractorTotal.toLocaleString('he-IL')}"`);
                    csvRows.push(headers.join(','));

                    // Add expense rows with RTL markers
                    contractorExpenses.forEach(expense => {
                        const rlm = '\u200F'; // Right-to-Left Mark for proper RTL display
                        const row = [
                            expense.receiptUrl || '',
                            expense.workId || '',
                            expense.contractorId || '',
                            expense.projectId || '',
                            expense.expenseId || '',
                            `"${rlm}${(expense.workName || '').replace(/"/g, '""')}"`,
                            `"${rlm}${(expense.contractorName || '').replace(/"/g, '""')}"`,
                            `"${rlm}${(expense.projectName || '').replace(/"/g, '""')}"`,
                            expense.amount,
                            `"${rlm}${(expense.description || '').replace(/"/g, '""')}"`,
                            `"${rlm}${new Date(expense.date).toLocaleDateString('he-IL')}"`
                        ];
                        csvRows.push(row.join(','));
                    });

                    csvRows.push('');
                });
            });

            // Create final CSV content
            const csvContent = csvRows.join('\n');

            // Download CSV
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            const filename = `expenses_report_${new Date().toISOString().split('T')[0]}.csv`;
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showSuccess(`×“×•×— ××¤×•×¨×˜ ×¢× ${filtered.length} ×”×•×¦××•×ª ×™×•×¦× ×‘×”×¦×œ×—×”`);
        }

        // Export Expenses to PDF
        window.exportExpensesToPDF = function() {
            const searchTerm = document.getElementById('expenseSearch')?.value.toLowerCase() || '';
            const projectFilter = document.getElementById('projectFilter')?.value || '';
            const contractorFilter = document.getElementById('contractorFilter')?.value || '';
            const dateRangeFilter = document.getElementById('dateRangeFilter')?.value || 'all';
            const startDate = document.getElementById('startDate')?.value;
            const endDate = document.getElementById('endDate')?.value;

            // Use same filter logic as filterExpenses
            let filtered = appData.expenses.filter(expense => {
                const matchesSearch = !searchTerm ||
                    expense.description.toLowerCase().includes(searchTerm) ||
                    (expense.projectName && expense.projectName.toLowerCase().includes(searchTerm)) ||
                    (expense.contractorName && expense.contractorName.toLowerCase().includes(searchTerm));

                const matchesProject = !projectFilter || expense.projectId === projectFilter;
                const matchesContractor = !contractorFilter || expense.contractorId === contractorFilter;

                let matchesDate = true;
                if (dateRangeFilter !== 'all') {
                    const expenseDate = new Date(expense.date);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);

                    if (dateRangeFilter === 'custom') {
                        if (startDate) {
                            const start = new Date(startDate);
                            start.setHours(0, 0, 0, 0);
                            matchesDate = matchesDate && expenseDate >= start;
                        }
                        if (endDate) {
                            const end = new Date(endDate);
                            end.setHours(23, 59, 59, 999);
                            matchesDate = matchesDate && expenseDate <= end;
                        }
                    } else {
                        switch(dateRangeFilter) {
                            case 'today': matchesDate = expenseDate >= today; break;
                            case 'week':
                                const weekAgo = new Date(today);
                                weekAgo.setDate(weekAgo.getDate() - 7);
                                matchesDate = expenseDate >= weekAgo;
                                break;
                            case 'month':
                                const monthAgo = new Date(today);
                                monthAgo.setMonth(monthAgo.getMonth() - 1);
                                matchesDate = expenseDate >= monthAgo;
                                break;
                            case 'year':
                                const yearAgo = new Date(today);
                                yearAgo.setFullYear(yearAgo.getFullYear() - 1);
                                matchesDate = expenseDate >= yearAgo;
                                break;
                        }
                    }
                }
                return matchesSearch && matchesProject && matchesContractor && matchesDate;
            });

            // Group by project -> contractor -> work
            const groupedData = {};
            filtered.forEach(expense => {
                const projectKey = expense.projectName || '×œ×œ× ×¤×¨×•×™×§×˜';
                const contractorKey = expense.contractorName || '×œ×œ× ×§×‘×œ×Ÿ';
                const workKey = expense.workName || '×œ×œ× ×¢×‘×•×“×”';

                if (!groupedData[projectKey]) {
                    groupedData[projectKey] = {};
                }
                if (!groupedData[projectKey][contractorKey]) {
                    groupedData[projectKey][contractorKey] = {};
                }
                if (!groupedData[projectKey][contractorKey][workKey]) {
                    groupedData[projectKey][contractorKey][workKey] = [];
                }
                groupedData[projectKey][contractorKey][workKey].push(expense);
            });

            // Build HTML content for PDF
            const reportDate = new Date().toLocaleString('he-IL');
            const dateRangeText = dateRangeFilter === 'custom' && startDate && endDate
                ? `${startDate} ×¢×“ ${endDate}`
                : dateRangeFilter === 'all' ? '×›×œ ×”×ª×§×•×¤×•×ª' : dateRangeFilter;
            const totalAmount = filtered.reduce((sum, e) => sum + e.amount, 0);

            let htmlContent = `
                <div dir="rtl" style="font-family: 'Rubik', Arial, sans-serif; padding: 20px; color: #1a202c;">
                    <h1 style="text-align: center; color: #2c3e50; margin-bottom: 20px;">×“×•×— ×”×•×¦××•×ª - ××¢×¨×›×ª ××¢×§×‘ ×”×•×¦××•×ª ×‘× ×™×”</h1>

                    <div style="margin-bottom: 20px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                        <p style="margin: 5px 0;"><strong>×ª××¨×™×š ×“×•×—:</strong> ${reportDate}</p>
                        <p style="margin: 5px 0;"><strong>×ª×§×•×¤×ª ×”×“×•×—:</strong> ${dateRangeText}</p>
                        <p style="margin: 5px 0;"><strong>×¡×”"×› ×”×•×¦××•×ª:</strong> ${filtered.length}</p>
                        <p style="margin: 5px 0;"><strong>×¡×›×•× ×›×•×œ×œ:</strong> â‚ª${totalAmount.toLocaleString('he-IL')}</p>
                    </div>
            `;

            // Process each project
            Object.keys(groupedData).sort().forEach(projectName => {
                const projectData = groupedData[projectName];
                const projectExpenses = Object.values(projectData).flatMap(contractors =>
                    Object.values(contractors).flat()
                );
                const projectTotal = projectExpenses.reduce((sum, e) => sum + e.amount, 0);

                htmlContent += `
                    <div style="margin-top: 20px; page-break-inside: avoid;">
                        <div style="background: #2c3e50; color: white; padding: 10px; border-radius: 5px;">
                            <h2 style="margin: 0; font-size: 16px;">×¤×¨×•×™×§×˜: ${projectName}</h2>
                        </div>
                        <p style="margin: 5px 0 10px 0; padding-right: 10px;">
                            <strong>×¡×”"×› ×”×•×¦××•×ª:</strong> ${projectExpenses.length} | <strong>×¡×›×•×:</strong> â‚ª${projectTotal.toLocaleString('he-IL')}
                        </p>
                `;

                // Process each contractor
                Object.keys(projectData).sort().forEach(contractorName => {
                    const contractorData = projectData[contractorName];
                    const contractorExpenses = Object.values(contractorData).flat();
                    const contractorTotal = contractorExpenses.reduce((sum, e) => sum + e.amount, 0);

                    htmlContent += `
                        <div style="margin: 10px 0; margin-right: 15px; page-break-inside: avoid;">
                            <div style="background: #7f8c8d; color: white; padding: 8px; border-radius: 4px;">
                                <h3 style="margin: 0; font-size: 14px;">×§×‘×œ×Ÿ: ${contractorName}</h3>
                            </div>
                            <p style="margin: 5px 0; padding-right: 10px; font-size: 12px;">
                                <strong>×¡×”"×› ×”×•×¦××•×ª:</strong> ${contractorExpenses.length} | <strong>×¡×›×•×:</strong> â‚ª${contractorTotal.toLocaleString('he-IL')}
                            </p>
                    `;

                    // Process each work
                    Object.keys(contractorData).sort().forEach(workName => {
                        const workExpenses = contractorData[workName];
                        const workTotal = workExpenses.reduce((sum, e) => sum + e.amount, 0);

                        htmlContent += `
                            <div style="margin: 10px 0; margin-right: 25px; page-break-inside: avoid;">
                                <h4 style="margin: 5px 0; color: #34495e; font-size: 13px;">×¢×‘×•×“×”: ${workName}</h4>
                                <p style="margin: 3px 0; font-size: 11px;"><strong>×¡×›×•×:</strong> â‚ª${workTotal.toLocaleString('he-IL')}</p>

                                <table style="width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 10px;">
                                    <thead>
                                        <tr style="background: #95a5a6; color: white;">
                                            <th style="border: 1px solid #ddd; padding: 6px; text-align: center;">×§×‘×œ×”</th>
                                            <th style="border: 1px solid #ddd; padding: 6px; text-align: center;">×¡×›×•×</th>
                                            <th style="border: 1px solid #ddd; padding: 6px; text-align: right;">×ª×™××•×¨</th>
                                            <th style="border: 1px solid #ddd; padding: 6px; text-align: center;">×ª××¨×™×š</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                        `;

                        workExpenses.forEach((expense, idx) => {
                            const bgColor = idx % 2 === 0 ? '#ffffff' : '#f8f9fa';
                            htmlContent += `
                                <tr style="background: ${bgColor};">
                                    <td style="border: 1px solid #ddd; padding: 6px; text-align: center;">${expense.receiptUrl ? '×™×© ×§×‘×œ×”' : '××™×Ÿ ×§×‘×œ×”'}</td>
                                    <td style="border: 1px solid #ddd; padding: 6px; text-align: center;">â‚ª${expense.amount.toLocaleString('he-IL')}</td>
                                    <td style="border: 1px solid #ddd; padding: 6px; text-align: right;">${expense.description || ''}</td>
                                    <td style="border: 1px solid #ddd; padding: 6px; text-align: center;">${new Date(expense.date).toLocaleDateString('he-IL')}</td>
                                </tr>
                            `;
                        });

                        htmlContent += `
                                    </tbody>
                                </table>
                            </div>
                        `;
                    });

                    htmlContent += `</div>`;
                });

                htmlContent += `</div>`;
            });

            htmlContent += `</div>`;

            // Create a temporary element to hold the HTML
            const element = document.createElement('div');
            element.innerHTML = htmlContent;
            element.style.position = 'absolute';
            element.style.left = '-9999px';
            document.body.appendChild(element);

            // Generate PDF
            const filename = `expenses_report_${new Date().toISOString().split('T')[0]}.pdf`;
            const opt = {
                margin: 10,
                filename: filename,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(element).save().then(() => {
                document.body.removeChild(element);
                showSuccess(`×“×•×— PDF ×¢× ${filtered.length} ×”×•×¦××•×ª ×™×•×¦× ×‘×”×¦×œ×—×”`);
            });
        }

        // Show Projects Tab
        function showProjectsTab(container) {
            container.innerHTML = `
                <h2>×¤×¨×•×™×§×˜×™×</h2>
                <button class="btn-primary" onclick="showAddProjectForm()">
                    <i class="fas fa-plus"></i> ×”×•×¡×£ ×¤×¨×•×™×§×˜
                </button>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; margin-top: 20px;">
                    ${appData.projects.map(project => {
                        // Calculate total expenses for this project
                        const projectExpenses = appData.expenses.filter(e => e.projectId === project.projectId);
                        const totalSpent = projectExpenses.reduce((sum, e) => sum + e.amount, 0);
                        const budget = project.budget || 0;
                        const percentUsed = budget > 0 ? (totalSpent / budget) * 100 : 0;

                        // Determine alert level
                        let alertClass = 'success';
                        let alertIcon = 'fa-check-circle';
                        if (percentUsed >= 90) {
                            alertClass = 'danger';
                            alertIcon = 'fa-exclamation-triangle';
                        } else if (percentUsed >= 75) {
                            alertClass = 'warning';
                            alertIcon = 'fa-exclamation-circle';
                        }

                        return `
                        <div class="card clickable-card" onclick="showProjectDetails('${project.projectId}')">
                            <h3>${project.name}</h3>
                            <p>${project.description || '××™×Ÿ ×ª×™××•×¨'}</p>

                            <!-- Budget Tracking -->
                            <div style="margin-top: 15px; padding: 12px; background: #f8f9fa; border-radius: 6px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="font-size: 0.875rem; color: #64748b;">×ª×§×¦×™×‘:</span>
                                    <span style="font-weight: 600;">â‚ª${budget.toLocaleString('he-IL')}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="font-size: 0.875rem; color: #64748b;">×”×•×¦××•:</span>
                                    <span style="font-weight: 600; color: ${alertClass === 'danger' ? '#dc2626' : alertClass === 'warning' ? '#f59e0b' : '#10b981'};">
                                        â‚ª${totalSpent.toLocaleString('he-IL')}
                                    </span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                    <span style="font-size: 0.875rem; color: #64748b;">× ×•×ª×¨:</span>
                                    <span style="font-weight: 600;">â‚ª${(budget - totalSpent).toLocaleString('he-IL')}</span>
                                </div>

                                <!-- Progress Bar -->
                                <div style="background: #e2e8f0; height: 8px; border-radius: 4px; overflow: hidden; margin-bottom: 8px;">
                                    <div style="background: ${alertClass === 'danger' ? '#dc2626' : alertClass === 'warning' ? '#f59e0b' : '#10b981'};
                                               width: ${Math.min(percentUsed, 100)}%; height: 100%; transition: width 0.3s;"></div>
                                </div>

                                <!-- Alert Badge -->
                                <div class="alert-badge ${alertClass}" style="display: inline-flex; align-items: center; gap: 6px;">
                                    <i class="fas ${alertIcon}"></i>
                                    ${percentUsed.toFixed(1)}% ×‘×©×™××•×©
                                </div>
                            </div>

                            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e2e8f0;">
                                <button class="btn-edit" onclick="event.stopPropagation(); editProject('${project.projectId}')">×¢×¨×•×š</button>
                                <button class="btn-delete" onclick="event.stopPropagation(); deleteProject('${project.projectId}')">××—×§</button>
                            </div>
                        </div>
                    `}).join('')}
                </div>
            `;
        }

        // Delete Functions using Clerk Auth
        async function deleteProject(projectId) {
            if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ×¤×¨×•×™×§×˜ ×–×”?')) {
                return;
            }

            try {
                await apiCall(`/projects/${projectId}`, 'DELETE');
                showSuccess('×”×¤×¨×•×™×§×˜ × ××—×§ ×‘×”×¦×œ×—×”');
                await loadAppData();
                refreshCurrentTab();
            } catch (error) {
                showError('×©×’×™××” ×‘××—×™×§×ª ×”×¤×¨×•×™×§×˜');
            }
        }

        async function deleteExpense(expenseId) {
            if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ×”×•×¦××” ×–×•?')) {
                return;
            }

            try {
                await apiCall(`/expenses/${expenseId}`, 'DELETE');
                showSuccess('×”×”×•×¦××” × ××—×§×” ×‘×”×¦×œ×—×”');
                await loadAppData();
                refreshCurrentTab();
            } catch (error) {
                showError('×©×’×™××” ×‘××—×™×§×ª ×”×”×•×¦××”');
            }
        }

        // Show Contractors Tab
        function showContractorsTab(container) {
            container.innerHTML = `
                <h2>×§×‘×œ× ×™×</h2>
                <button class="btn-primary" onclick="showAddContractorForm()">
                    <i class="fas fa-plus"></i> ×”×•×¡×£ ×§×‘×œ×Ÿ
                </button>
                <table>
                    <thead>
                        <tr>
                            <th>×©×</th>
                            <th>×˜×œ×¤×•×Ÿ</th>
                            <th>×”×ª××—×•×ª</th>
                            <th>×¤×¢×•×œ×•×ª</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${appData.contractors.map(contractor => `
                            <tr class="clickable-row" onclick="showContractorDetails('${contractor.contractorId}')">
                                <td>${contractor.name}</td>
                                <td>${contractor.phone || '-'}</td>
                                <td>${contractor.specialty || contractor.speciality || '-'}</td>
                                <td>
                                    <button class="btn-edit" onclick="event.stopPropagation(); editContractor('${contractor.contractorId}')">×¢×¨×•×š</button>
                                    <button class="btn-delete" onclick="event.stopPropagation(); deleteContractor('${contractor.contractorId}')">××—×§</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        async function deleteContractor(contractorId) {
            if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ×§×‘×œ×Ÿ ×–×”?')) {
                return;
            }

            try {
                await apiCall(`/contractors/${contractorId}`, 'DELETE');
                showSuccess('×”×§×‘×œ×Ÿ × ××—×§ ×‘×”×¦×œ×—×”');
                await loadAppData();
                refreshCurrentTab();
            } catch (error) {
                showError('×©×’×™××” ×‘××—×™×§×ª ×”×§×‘×œ×Ÿ');
            }
        }

        // Show Works Tab
        function showWorksTab(container) {
            container.innerHTML = `
                <h2>×¢×‘×•×“×•×ª</h2>
                <button class="btn-primary" onclick="showAddWorkForm()">
                    <i class="fas fa-plus"></i> ×”×•×¡×£ ×¢×‘×•×“×”
                </button>
                <table>
                    <thead>
                        <tr>
                            <th>×©× ×”×¢×‘×•×“×”</th>
                            <th>×¤×¨×•×™×§×˜</th>
                            <th>×§×‘×œ×Ÿ</th>
                            <th>×ª××¨×™×š ×”×ª×—×œ×”</th>
                            <th>×¡×˜×˜×•×¡</th>
                            <th>×¤×¢×•×œ×•×ª</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${appData.works.map(work => `
                            <tr class="clickable-row" onclick="showWorkDetails('${work.workId}')">
                                <td>${work.workName || '-'}</td>
                                <td>${work.projectName || '-'}</td>
                                <td>${work.contractorName || '-'}</td>
                                <td>${work.startDate ? new Date(work.startDate).toLocaleDateString('he-IL') : '-'}</td>
                                <td>${work.status || 'planned'}</td>
                                <td>
                                    <button class="btn-edit" onclick="event.stopPropagation(); editWork('${work.workId}')">×¢×¨×•×š</button>
                                    <button class="btn-delete" onclick="event.stopPropagation(); deleteWork('${work.workId}')">××—×§</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        async function deleteWork(workId) {
            if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ×¢×‘×•×“×” ×–×•?')) {
                return;
            }

            try {
                await apiCall(`/works/${workId}`, 'DELETE');
                showSuccess('×”×¢×‘×•×“×” × ××—×§×” ×‘×”×¦×œ×—×”');
                await loadAppData();
                refreshCurrentTab();
            } catch (error) {
                showError('×©×’×™××” ×‘××—×™×§×ª ×”×¢×‘×•×“×”');
            }
        }

        // Details Modal Functions (exposed globally for onclick handlers)
        window.openDetailsModal = function() {
            document.getElementById('detailsModal').classList.add('active');
        }

        window.closeDetailsModal = function(event) {
            if (event && event.target !== event.currentTarget) {
                return;
            }
            document.getElementById('detailsModal').classList.remove('active');
        }

        window.switchModalTab = function(tabName, event) {
            // Update tab buttons
            const tabs = document.querySelectorAll('.modal-tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            if (event && event.target) {
                event.target.closest('.modal-tab').classList.add('active');
            } else {
                // Fallback for programmatic calls
                tabs[0].classList.add('active');
            }

            // Update tab content
            const contents = document.querySelectorAll('.modal-tab-content');
            contents.forEach(content => content.classList.remove('active'));
            document.getElementById(`modalTab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`).classList.add('active');
        }

        window.showProjectDetails = function(projectId) {
            const project = appData.projects.find(p => p.projectId === projectId);
            if (!project) return;

            // Set modal title
            document.getElementById('modalTitle').textContent = project.name;

            // Populate info tab
            document.getElementById('modalTabInfo').innerHTML = `
                <div class="detail-row">
                    <div class="detail-label">×©× ×”×¤×¨×•×™×§×˜</div>
                    <div class="detail-value">${project.name}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">×ª×™××•×¨</div>
                    <div class="detail-value">${project.description || '××™×Ÿ ×ª×™××•×¨'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">×ª×§×¦×™×‘</div>
                    <div class="detail-value">â‚ª${(project.budget || 0).toLocaleString('he-IL')}</div>
                </div>
            `;

            // Populate receipts tab
            const projectExpenses = appData.expenses.filter(e => e.projectId === projectId);
            window.renderReceipts(projectExpenses);

            // Reset to info tab
            window.switchModalTab('info');
            const tabs = document.querySelectorAll('.modal-tab');
            tabs[0].classList.add('active');
            tabs[1].classList.remove('active');

            window.openDetailsModal();
        }

        window.showContractorDetails = function(contractorId) {
            const contractor = appData.contractors.find(c => c.contractorId === contractorId);
            if (!contractor) return;

            // Set modal title
            document.getElementById('modalTitle').textContent = contractor.name;

            // Populate info tab
            document.getElementById('modalTabInfo').innerHTML = `
                <div class="detail-row">
                    <div class="detail-label">×©× ×”×§×‘×œ×Ÿ</div>
                    <div class="detail-value">${contractor.name}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">×˜×œ×¤×•×Ÿ</div>
                    <div class="detail-value">${contractor.phone || '-'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">×”×ª××—×•×ª</div>
                    <div class="detail-value">${contractor.specialty || contractor.speciality || '-'}</div>
                </div>
            `;

            // Populate receipts tab
            const contractorExpenses = appData.expenses.filter(e => e.contractorId === contractorId);
            window.renderReceipts(contractorExpenses);

            // Reset to info tab
            window.switchModalTab('info');
            const tabs = document.querySelectorAll('.modal-tab');
            tabs[0].classList.add('active');
            tabs[1].classList.remove('active');

            window.openDetailsModal();
        }

        window.showWorkDetails = function(workId) {
            const work = appData.works.find(w => w.workId === workId);
            if (!work) return;

            // Set modal title
            document.getElementById('modalTitle').textContent = work.workName || '×¢×‘×•×“×”';

            // Populate info tab
            document.getElementById('modalTabInfo').innerHTML = `
                <div class="detail-row">
                    <div class="detail-label">×©× ×”×¢×‘×•×“×”</div>
                    <div class="detail-value">${work.workName || '-'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">×¤×¨×•×™×§×˜</div>
                    <div class="detail-value">${work.projectName || '-'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">×§×‘×œ×Ÿ</div>
                    <div class="detail-value">${work.contractorName || '-'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">×ª××¨×™×š ×”×ª×—×œ×”</div>
                    <div class="detail-value">${work.startDate ? new Date(work.startDate).toLocaleDateString('he-IL') : '-'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">×¡×˜×˜×•×¡</div>
                    <div class="detail-value">${work.status || 'planned'}</div>
                </div>
            `;

            // Populate receipts tab
            const workExpenses = appData.expenses.filter(e => e.workId === workId);
            window.renderReceipts(workExpenses);

            // Reset to info tab
            window.switchModalTab('info');
            const tabs = document.querySelectorAll('.modal-tab');
            tabs[0].classList.add('active');
            tabs[1].classList.remove('active');

            window.openDetailsModal();
        }

        window.renderReceipts = function(expenses) {
            const receiptsContainer = document.getElementById('modalTabReceipts');

            if (expenses.length === 0) {
                receiptsContainer.innerHTML = `
                    <div class="no-receipts">
                        <i class="fas fa-receipt"></i>
                        <p>××™×Ÿ ×§×‘×œ×•×ª ×§×©×•×¨×•×ª</p>
                    </div>
                `;
                return;
            }

            receiptsContainer.innerHTML = `
                <div class="receipts-grid">
                    ${expenses.map(expense => `
                        <div class="receipt-card">
                            <div class="receipt-date">${new Date(expense.date).toLocaleDateString('he-IL')}</div>
                            <div class="receipt-description">${expense.description}</div>
                            <div class="receipt-amount">â‚ª${expense.amount.toLocaleString('he-IL')}</div>
                            ${expense.receiptUrl
                                ? `<a href="${expense.receiptUrl}" target="_blank" class="receipt-image-link">
                                    <i class="fas fa-file-image"></i> ×¦×¤×” ×‘×§×‘×œ×”
                                   </a>`
                                : '<span style="color: #94a3b8; font-size: 0.875rem;">××™×Ÿ ×§×‘×œ×”</span>'}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Show Reports Tab
        function showReportsTab(container) {
            container.innerHTML = `
                <h2>×“×•×—×•×ª ×•× ×™×ª×•×—×™×</h2>

                <!-- Key Metrics -->
                <div class="dashboard-grid">
                    <div class="metric-card">
                        <div class="metric-icon blue">
                            <i class="fas fa-coins"></i>
                        </div>
                        <div class="metric-value" id="report-total-expenses">â‚ª0</div>
                        <div class="metric-label">×¡×”"×› ×”×•×¦××•×ª</div>
                        <div class="metric-change positive" id="report-expense-change"></div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon green">
                            <i class="fas fa-project-diagram"></i>
                        </div>
                        <div class="metric-value" id="report-active-projects">0</div>
                        <div class="metric-label">×¤×¨×•×™×§×˜×™× ×¤×¢×™×œ×™×</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon purple">
                            <i class="fas fa-calendar"></i>
                        </div>
                        <div class="metric-value" id="report-monthly-expenses">â‚ª0</div>
                        <div class="metric-label">×”×•×¦××•×ª ×”×—×•×“×©</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon orange">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="metric-value" id="report-avg-expense">â‚ª0</div>
                        <div class="metric-label">×××•×¦×¢ ×”×•×¦××”</div>
                    </div>
                </div>

                <!-- Charts Row -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px;">
                    <div class="chart-container">
                        <div class="chart-header">
                            <div class="chart-title">××’××ª ×”×•×¦××•×ª (6 ×—×•×“×©×™× ××—×¨×•× ×™×)</div>
                        </div>
                        <div class="chart-canvas">
                            <canvas id="expenseTrendChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                        <div class="chart-header">
                            <div class="chart-title">×”×ª×¤×œ×’×•×ª ×”×•×¦××•×ª ×œ×¤×™ ×¤×¨×•×™×§×˜</div>
                        </div>
                        <div class="chart-canvas">
                            <canvas id="projectDistributionChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Report Categories -->
                <h3 style="margin: 32px 0 16px 0;">×“×•×—×•×ª ××¤×•×¨×˜×™×</h3>
                <div class="reports-grid">
                    <div class="report-card" onclick="showProjectBudgetReport()">
                        <div class="report-icon">
                            <i class="fas fa-chart-bar"></i>
                        </div>
                        <div class="report-title">×ª×§×¦×™×‘ ×¤×¨×•×™×§×˜×™×</div>
                        <div class="report-description">×”×©×•×•××ª ×ª×§×¦×™×‘ ××•×œ ×”×•×¦××•×ª ×‘×¤×•×¢×œ ×œ×›×œ ×¤×¨×•×™×§×˜</div>
                    </div>
                    <div class="report-card" onclick="showContractorReport()">
                        <div class="report-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="report-title">× ×™×ª×•×— ×§×‘×œ× ×™×</div>
                        <div class="report-description">×¡×™×›×•× ×”×•×¦××•×ª ×œ×¤×™ ×§×‘×œ×Ÿ ×•×¤×¨×˜×™ ×‘×™×¦×•×¢×™×</div>
                    </div>
                    <div class="report-card" onclick="showMonthlyReport()">
                        <div class="report-icon">
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                        <div class="report-title">×¡×™×›×•× ×—×•×“×©×™</div>
                        <div class="report-description">×“×•×— ×”×•×¦××•×ª ×—×•×“×©×™ ×¢× ×”×©×•×•××” ×œ×—×•×“×© ×”×§×•×“×</div>
                    </div>
                    <div class="report-card" onclick="showMissingReceiptsReport()">
                        <div class="report-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="report-title">×§×‘×œ×•×ª ×—×¡×¨×•×ª</div>
                        <div class="report-description">×¨×©×™××ª ×”×•×¦××•×ª ×œ×œ× ×ª××•× ×ª ×§×‘×œ×”</div>
                    </div>
                </div>
            `;

            // Initialize dashboard data
            initializeReportsDashboard();
        }

        // Show Billing Tab (Paddle Billing)
        async function showBillingTab(container) {
            container.innerHTML = `
                <h2>×—×™×•×‘ ×•×× ×•×™</h2>

                <!-- Current Subscription Status -->
                <div class="card" style="margin-bottom: 24px;">
                    <h3 style="margin-bottom: 20px; color: #2c3e50;">
                        <i class="fas fa-credit-card"></i> ×”×× ×•×™ ×©×œ×š
                    </h3>
                    <div id="currentSubscriptionStatus">
                        <div style="text-align: center; padding: 20px; color: #666;">
                            <i class="fas fa-spinner fa-spin"></i> ×˜×•×¢×Ÿ ××¦×‘ ×× ×•×™...
                        </div>
                    </div>
                </div>

                <!-- Usage Metrics -->
                <div class="card" style="margin-bottom: 24px;">
                    <h3 style="margin-bottom: 20px; color: #2c3e50;">
                        <i class="fas fa-chart-bar"></i> ×©×™××•×© × ×•×›×—×™
                    </h3>
                    <div id="currentUsageMetrics">
                        <div style="text-align: center; padding: 20px; color: #666;">
                            <i class="fas fa-spinner fa-spin"></i> ×˜×•×¢×Ÿ × ×ª×•× ×™ ×©×™××•×©...
                        </div>
                    </div>
                </div>

                <!-- Available Plans -->
                <div class="card">
                    <h3 style="margin-bottom: 20px; color: #2c3e50;">
                        <i class="fas fa-layer-group"></i> ×ª×•×›× ×™×•×ª ×–××™× ×•×ª
                    </h3>
                    <div id="availablePlansGrid">
                        <div style="text-align: center; padding: 20px; color: #666;">
                            <i class="fas fa-spinner fa-spin"></i> ×˜×•×¢×Ÿ ×ª×•×›× ×™×•×ª...
                        </div>
                    </div>
                </div>
            `;

            // Load subscription data
            await loadCurrentSubscription();
            await loadCurrentUsage();
            await loadAvailablePlans();
        }

        // Load current subscription status
        async function loadCurrentSubscription() {
            const statusContainer = document.getElementById('currentSubscriptionStatus');
            if (!statusContainer) return;

            try {
                // Get current company data
                const currentTier = appData.company?.subscriptionTier || 'starter';
                const subscriptionStatus = appData.company?.subscriptionStatus || 'active';

                // Tier information from tier-config.js
                const tiers = {
                    starter: { name: '×‘×¡×™×¡×™', price: 100, color: '#3498db' },
                    professional: { name: '××§×¦×•×¢×™', price: 200, color: '#34495e' },
                    enterprise: { name: '××¨×’×•× ×™', price: 300, color: '#27ae60' }
                };

                const currentTierInfo = tiers[currentTier] || tiers.starter;

                statusContainer.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px;">
                        <div>
                            <div style="font-size: 1.8rem; font-weight: bold; color: ${currentTierInfo.color}; margin-bottom: 8px;">
                                ${currentTierInfo.name}
                            </div>
                            <div style="font-size: 2.5rem; font-weight: bold; color: #2c3e50;">
                                â‚ª${currentTierInfo.price}<span style="font-size: 1rem; color: #666; font-weight: normal;"> / ×—×•×“×©</span>
                            </div>
                        </div>
                        <div style="text-align: left;">
                            <div style="background: ${['active', 'trialing'].includes(subscriptionStatus) ? '#27ae60' : '#e74c3c'}; color: white; padding: 8px 20px; border-radius: 20px; font-weight: 600; margin-bottom: 10px;">
                                ${['active', 'trialing'].includes(subscriptionStatus) ? 'âœ“ ×¤×¢×™×œ' : 'âœ— ×œ× ×¤×¢×™×œ'}
                            </div>
                            <button class="btn-secondary" onclick="managePaddleBilling()" style="white-space: nowrap;">
                                <i class="fas fa-cog"></i> × ×”×œ ×¤×¨×˜×™ ×ª×©×œ×•×
                            </button>
                        </div>
                    </div>
                `;

            } catch (error) {
                console.error('Error loading subscription:', error);
                statusContainer.innerHTML = `
                    <div style="color: #e74c3c; text-align: center; padding: 20px;">
                        ×©×’×™××” ×‘×˜×¢×™× ×ª ××¦×‘ ×”×× ×•×™
                    </div>
                `;
            }
        }

        // Load current usage metrics
        async function loadCurrentUsage() {
            const usageContainer = document.getElementById('currentUsageMetrics');
            if (!usageContainer) return;

            try {
                const currentTier = appData.company?.subscriptionTier || 'starter';

                // Get limits from tier-config
                const tierLimits = {
                    starter: { maxUsers: 1, maxProjects: 3, maxExpensesPerMonth: 50 },
                    professional: { maxUsers: 3, maxProjects: 10, maxExpensesPerMonth: -1 },
                    enterprise: { maxUsers: 10, maxProjects: -1, maxExpensesPerMonth: -1 }
                };

                const limits = tierLimits[currentTier];

                // Calculate current usage
                const currentUsers = appData.users?.length || 1;
                const currentProjects = appData.projects?.length || 0;
                const currentExpenses = appData.expenses?.filter(e => {
                    const expenseDate = new Date(e.date);
                    const now = new Date();
                    return expenseDate.getMonth() === now.getMonth() &&
                           expenseDate.getFullYear() === now.getFullYear();
                }).length || 0;

                usageContainer.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                        ${createUsageCard('××©×ª××©×™×', currentUsers, limits.maxUsers, 'fa-users', '#3498db')}
                        ${createUsageCard('×¤×¨×•×™×§×˜×™×', currentProjects, limits.maxProjects, 'fa-project-diagram', '#34495e')}
                        ${createUsageCard('×”×•×¦××•×ª ×”×—×•×“×©', currentExpenses, limits.maxExpensesPerMonth, 'fa-receipt', '#27ae60')}
                    </div>
                `;

            } catch (error) {
                console.error('Error loading usage:', error);
                usageContainer.innerHTML = `
                    <div style="color: #e74c3c; text-align: center; padding: 20px;">
                        ×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™ ×©×™××•×©
                    </div>
                `;
            }
        }

        // Create usage card HTML
        function createUsageCard(label, current, max, icon, color) {
            const isUnlimited = max === -1;
            const percentage = isUnlimited ? 0 : Math.min((current / max) * 100, 100);
            const isNearLimit = percentage >= 80;

            return `
                <div style="background: #f8f9fa; border-radius: 8px; padding: 20px;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
                        <i class="fas ${icon}" style="font-size: 1.5rem; color: ${color};"></i>
                        <div style="font-weight: 600; color: #2c3e50;">${label}</div>
                    </div>
                    <div style="font-size: 2rem; font-weight: bold; color: #2c3e50; margin-bottom: 8px;">
                        ${current}${isUnlimited ? '' : ' / ' + max}
                    </div>
                    ${isUnlimited ? `
                        <div style="color: #27ae60; font-weight: 600;">
                            <i class="fas fa-infinity"></i> ×œ×œ× ×”×’×‘×œ×”
                        </div>
                    ` : `
                        <div style="background: #e2e8f0; border-radius: 10px; height: 8px; overflow: hidden; margin-bottom: 8px;">
                            <div style="background: ${isNearLimit ? '#e74c3c' : color}; height: 100%; width: ${percentage}%; transition: width 0.3s;"></div>
                        </div>
                        <div style="color: ${isNearLimit ? '#e74c3c' : '#666'}; font-size: 0.9rem; font-weight: ${isNearLimit ? '600' : 'normal'};">
                            ${isNearLimit ? 'âš ï¸ ××ª×§×¨×‘ ×œ××’×‘×œ×”' : Math.round(percentage) + '%'}
                        </div>
                    `}
                </div>
            `;
        }

        // Load available plans for upgrade/downgrade
        async function loadAvailablePlans() {
            const plansContainer = document.getElementById('availablePlansGrid');
            if (!plansContainer) return;

            try {
                const currentTier = appData.company?.subscriptionTier || 'starter';

                const plans = [
                    {
                        id: 'starter',
                        name: '×‘×¡×™×¡×™',
                        price: 100,
                        features: [
                            '××©×ª××© ××—×“',
                            '×¢×“ 3 ×¤×¨×•×™×§×˜×™×',
                            '×¢×“ 50 ×”×•×¦××•×ª ×‘×—×•×“×©',
                            '×¡×¤×§×™× ×œ×œ× ×”×’×‘×œ×”',
                            '×¢×‘×•×“×•×ª ×œ×œ× ×”×’×‘×œ×”',
                            '×™×™×¦×•× ×“×•×—×•×ª PDF',
                            '×“×©×‘×•×¨×“ × ×™×ª×•×—'
                        ]
                    },
                    {
                        id: 'professional',
                        name: '××§×¦×•×¢×™',
                        price: 200,
                        featured: true,
                        features: [
                            '×¢×“ 3 ××©×ª××©×™×',
                            '×¢×“ 10 ×¤×¨×•×™×§×˜×™×',
                            '×”×•×¦××•×ª ×œ×œ× ×”×’×‘×œ×”',
                            '×¡×¤×§×™× ×œ×œ× ×”×’×‘×œ×”',
                            '×¢×‘×•×“×•×ª ×œ×œ× ×”×’×‘×œ×”',
                            '×™×™×¦×•× PDF ××ª×§×“×',
                            '×ª××™×›×” ××•×¢×“×¤×ª'
                        ]
                    },
                    {
                        id: 'enterprise',
                        name: '××¨×’×•× ×™',
                        price: 300,
                        features: [
                            '×¢×“ 10 ××©×ª××©×™×',
                            '×¤×¨×•×™×§×˜×™× ×œ×œ× ×”×’×‘×œ×”',
                            '×”×•×¦××•×ª ×œ×œ× ×”×’×‘×œ×”',
                            '×¡×¤×§×™× ×œ×œ× ×”×’×‘×œ×”',
                            '×¢×‘×•×“×•×ª ×œ×œ× ×”×’×‘×œ×”',
                            '×™×™×¦×•× PDF ××ª×§×“×',
                            '×’×™×‘×•×™×™× ××•×˜×•××˜×™×™×',
                            '×ª××™×›×” ××•×¢×“×¤×ª'
                        ]
                    }
                ];

                plansContainer.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 24px; margin-top: 20px;">
                        ${plans.map(plan => `
                            <div class="billing-plan-card ${plan.id === currentTier ? 'current-plan' : ''} ${plan.featured ? 'featured-plan' : ''}" style="
                                background: white;
                                border: ${plan.id === currentTier ? '3px solid #27ae60' : plan.featured ? '3px solid #34495e' : '2px solid #e2e8f0'};
                                border-radius: 12px;
                                padding: 24px;
                                position: relative;
                                display: flex;
                                flex-direction: column;
                                transition: transform 0.3s, box-shadow 0.3s;
                            ">
                                ${plan.id === currentTier ? `
                                    <div style="position: absolute; top: -12px; right: 50%; transform: translateX(50%); background: #27ae60; color: white; padding: 6px 16px; border-radius: 16px; font-size: 0.85rem; font-weight: 600;">
                                        ×”×ª×•×›× ×™×ª ×”× ×•×›×—×™×ª ×©×œ×š
                                    </div>
                                ` : plan.featured ? `
                                    <div style="position: absolute; top: -12px; right: 50%; transform: translateX(50%); background: #34495e; color: white; padding: 6px 16px; border-radius: 16px; font-size: 0.85rem; font-weight: 600;">
                                        ×”××•××œ×¥ ×‘×™×•×ª×¨
                                    </div>
                                ` : ''}

                                <div style="font-size: 1.5rem; font-weight: bold; color: #2c3e50; margin-bottom: 12px; ${plan.id === currentTier || plan.featured ? 'margin-top: 12px;' : ''}">
                                    ${plan.name}
                                </div>
                                <div style="font-size: 2.5rem; font-weight: bold; color: #34495e; margin-bottom: 20px;">
                                    â‚ª${plan.price}<span style="font-size: 1rem; color: #666; font-weight: normal;"> / ×—×•×“×©</span>
                                </div>

                                <ul style="list-style: none; padding: 0; margin: 0 0 24px 0; flex-grow: 1;">
                                    ${plan.features.map(feature => `
                                        <li style="padding: 8px 0; color: #555; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #f0f0f0;">
                                            <i class="fas fa-check" style="color: #27ae60; font-size: 1rem;"></i>
                                            <span>${feature}</span>
                                        </li>
                                    `).join('')}
                                </ul>

                                ${plan.id === currentTier ? `
                                    <button class="btn-secondary" disabled style="width: 100%; opacity: 0.6; cursor: not-allowed;">
                                        ×”×ª×•×›× ×™×ª ×”× ×•×›×—×™×ª
                                    </button>
                                ` : `
                                    <button class="btn-primary" onclick="changePlanTo('${plan.id}')" style="width: 100%;">
                                        ${getPlanChangeAction(currentTier, plan.id)} ×œ${plan.name}
                                    </button>
                                `}
                            </div>
                        `).join('')}
                    </div>

                    <div style="margin-top: 24px; padding: 20px; background: #f8f9fa; border-radius: 8px; border-right: 4px solid #34495e;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px;">
                            <i class="fas fa-info-circle" style="color: #34495e; font-size: 1.2rem;"></i>
                            <strong style="color: #2c3e50;">××™×“×¢ ×—×©×•×‘</strong>
                        </div>
                        <ul style="margin-right: 28px; color: #555; line-height: 1.8;">
                            <li>×©×“×¨×•×’ × ×›× ×¡ ×œ×ª×•×§×£ ××™×™×“×™×ª ×¢× ×—×™×•×‘ ×™×—×¡×™</li>
                            <li>×”×•×¨×“×” ×‘×“×¨×’×” ×ª×™×›× ×¡ ×œ×ª×•×§×£ ×‘×ª×•× ×ª×§×•×¤×ª ×”×—×™×•×‘ ×”× ×•×›×—×™×ª</li>
                            <li>×›×œ ×”×ª×©×œ×•××™× ××¢×•×‘×“×™× ×‘×××¦×¢×•×ª Paddle.com</li>
                            <li>× ×™×ª×Ÿ ×œ×‘×˜×œ ×‘×›×œ ×¢×ª - ×¨××” <a href="refund.html" target="_blank" style="color: #34495e; font-weight: 600;">××“×™× ×™×•×ª ×‘×™×˜×•×œ×™×</a></li>
                        </ul>
                    </div>
                `;

            } catch (error) {
                console.error('Error loading plans:', error);
                plansContainer.innerHTML = `
                    <div style="color: #e74c3c; text-align: center; padding: 20px;">
                        ×©×’×™××” ×‘×˜×¢×™× ×ª ×ª×•×›× ×™×•×ª ×–××™× ×•×ª
                    </div>
                `;
            }
        }

        // Get action text for plan change (upgrade/downgrade)
        function getPlanChangeAction(currentPlan, targetPlan) {
            const tierOrder = { starter: 1, professional: 2, enterprise: 3 };
            const current = tierOrder[currentPlan] || 1;
            const target = tierOrder[targetPlan] || 1;

            if (target > current) {
                return '×©×“×¨×’';
            } else if (target < current) {
                return '×©× ××š';
            }
            return '×¢×‘×•×¨';
        }

        // Change plan (upgrade or downgrade)
        async function changePlanTo(newPlan) {
            const currentTier = appData.company?.subscriptionTier || 'starter';
            const tierOrder = { starter: 1, professional: 2, enterprise: 3 };
            const isUpgrade = tierOrder[newPlan] > tierOrder[currentTier];

            const planNames = {
                starter: '×‘×¡×™×¡×™',
                professional: '××§×¦×•×¢×™',
                enterprise: '××¨×’×•× ×™'
            };

            const actionText = isUpgrade ? '×œ×©×“×¨×’' : '×œ×”×•×¨×™×“ ×‘×“×¨×’×”';
            const confirmMessage = isUpgrade
                ? `×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×©×“×¨×’ ×œ×ª×•×›× ×™×ª ${planNames[newPlan]}?\n\n×”×©×“×¨×•×’ ×™×™×›× ×¡ ×œ×ª×•×§×£ ××™×™×“×™×ª ×•×ª×—×•×™×‘ ×‘××•×¤×Ÿ ×™×—×¡×™.`
                : `×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×”×•×¨×™×“ ×œ×ª×•×›× ×™×ª ${planNames[newPlan]}?\n\n×”×”×•×¨×“×” ×‘×“×¨×’×” ×ª×™×›× ×¡ ×œ×ª×•×§×£ ×‘×ª×•× ×ª×§×•×¤×ª ×”×—×™×•×‘ ×”× ×•×›×—×™×ª.`;

            if (!confirm(confirmMessage)) {
                return;
            }

            try {
                // If company exists, ALWAYS use API update path for tier changes
                // Never create new subscriptions for existing companies (prevents duplicate subscriptions)
                const hasExistingCompany = appData.company?.companyId;

                console.log('[TIER CHANGE] Decision factors:', {
                    hasCompany: hasExistingCompany,
                    currentTier: currentTier,
                    targetTier: newPlan,
                    companyId: appData.company?.companyId
                });

                if (hasExistingCompany) {
                    // EXISTING COMPANY: Always use API update path (upgrade/downgrade existing subscription)
                    console.log('[TIER CHANGE] Company exists - using API update path for:', newPlan);

                    const updateData = {
                        newTier: newPlan
                    };

                    const response = await apiCall('/update-paddle-subscription', 'POST', updateData);

                    if (response.success) {
                        // Update the appData immediately for instant UI feedback
                        if (appData.company && response.subscription) {
                            appData.company.subscriptionTier = response.subscription.currentTier;
                            console.log('[UPGRADE] Updated tier immediately to:', response.subscription.currentTier);
                        }

                        showSuccess(`×”×× ×•×™ ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×” ×œ-${planNames[newPlan]}!`);

                        // Refresh company data and billing tab to show new tier
                        setTimeout(async () => {
                            await loadAppData(); // Wait for data to load
                            showTab('billing'); // This will trigger a full billing tab re-render
                            console.log('[TIER CHANGE] Page refreshed with new tier');
                        }, 1500);
                    } else {
                        throw new Error(response.message || 'Failed to update subscription');
                    }

                } else {
                    // NO COMPANY EXISTS: Open Paddle checkout for NEW customer onboarding
                    // This should ONLY happen during initial registration/onboarding
                    console.log('[TIER CHANGE] No company exists - opening checkout for new customer onboarding:', newPlan);

                    const companyName = appData.company?.companyName || '×”×—×‘×¨×” ×©×œ×™';
                    const checkoutData = {
                        companyName: companyName,
                        subscriptionTier: newPlan
                    };

                    const response = await apiCall('/create-paddle-checkout', 'POST', checkoutData);

                    if (!response.success || !response.paddleConfig) {
                        throw new Error('×œ× ×”×ª×§×‘×œ ×ª×¦×•×¨×ª Paddle ×ª×§×™× ×”');
                    }

                    const { paddleConfig } = response;

                    if (typeof Paddle === 'undefined') {
                        throw new Error('Paddle.js ×œ× × ×˜×¢×Ÿ. ×× × ×¨×¢× ×Ÿ ××ª ×”×“×£ ×•× ×¡×” ×©× ×™×ª.');
                    }

                    Paddle.Environment.set(paddleConfig.environment || 'sandbox');
                    Paddle.Initialize({
                        token: paddleConfig.token,
                        eventCallback: function(data) {
                            console.log('Paddle event:', data);
                        }
                    });

                    console.log('[UPGRADE FLOW] Opening Paddle checkout with successCallback registered');

                    Paddle.Checkout.open({
                        items: [{
                            priceId: paddleConfig.priceId,
                            quantity: 1
                        }],
                        customer: paddleConfig.customerEmail ? {
                            email: paddleConfig.customerEmail
                        } : undefined,
                        customData: paddleConfig.customData,
                        settings: {
                            displayMode: "overlay",
                            theme: "light",
                            locale: "he"
                        }
                    });

                    // ALTERNATIVE APPROACH: Listen to global checkout.completed event
                    // and handle it THERE since successCallback isn't firing
                    console.log('[UPGRADE FLOW] Checkout opened. Will handle completion via global eventCallback.');
                }

            } catch (error) {
                console.error('Error changing plan:', error);
                showError(`×©×’×™××” ×‘${actionText} ×”×× ×•×™: ${error.message}`);
            }
        }

        // Manage billing info via Paddle
        async function managePaddleBilling() {
            try {
                // Get company subscription data from the correct location
                const subscriptionId = appData.paddleSubscription?.info?.subscriptionId;
                const paddleCustomerId = appData.paddleSubscription?.info?.paddleCustomerId;

                if (!subscriptionId) {
                    showError('×œ× × ××¦× ×× ×•×™ ×¤×¢×™×œ. ×× × ×¤× ×” ×œ×ª××™×›×” ×œ×§×‘×œ×ª ×¢×–×¨×”.');
                    return;
                }

                // Paddle Billing doesn't provide a direct customer portal URL
                // Redirect to email support with subscription details
                const subject = encodeURIComponent('×‘×§×©×” ×œ× ×™×”×•×œ ×× ×•×™ ×•×”×ª×©×œ×•××™×');
                const body = encodeURIComponent(
                    `×©×œ×•×,\n\n` +
                    `×× ×™ ××¢×•× ×™×™×Ÿ ×œ× ×”×œ ××ª ×”×× ×•×™ ×©×œ×™:\n` +
                    `××¡×¤×¨ ×× ×•×™: ${subscriptionId}\n` +
                    `××¡×¤×¨ ×œ×§×•×— Paddle: ${paddleCustomerId}\n\n` +
                    `××©××— ×œ×§×‘×œ ×¢×–×¨×” ×‘× ×•×©××™× ×”×‘××™×:\n` +
                    `â˜ ×¢×“×›×•×Ÿ ×¤×¨×˜×™ ×›×¨×˜×™×¡ ××©×¨××™\n` +
                    `â˜ ×”×•×¨×“×ª ×§×‘×œ×•×ª\n` +
                    `â˜ ×©×™× ×•×™ ×ª×•×›× ×™×ª ×× ×•×™\n` +
                    `â˜ ×‘×™×˜×•×œ ×× ×•×™\n` +
                    `â˜ ××—×¨: _______\n\n` +
                    `×ª×•×“×” ×¨×‘×”!`
                );

                // Open default email client with pre-filled message
                window.location.href = `mailto:maordaniel40@gmail.com?subject=${subject}&body=${body}`;

            } catch (error) {
                console.error('Error opening billing portal:', error);
                showError('×©×’×™××” ×‘×¤×ª×™×—×ª ×“×£ × ×™×”×•×œ ×”×ª×©×œ×•×');
            }
        }

        // Show Users Tab
        async function showUsersTab(container) {
            container.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">× ×™×”×•×œ ××©×ª××©×™×</h2>
                    <button class="btn-primary" onclick="showInviteUserModal()">
                        <i class="fas fa-user-plus"></i> ×©×œ×— ×”×–×× ×”
                    </button>
                </div>

                <!-- Tab Switcher -->
                <div style="background: white; padding: 8px; border-radius: 8px; margin-bottom: 20px; display: inline-flex; gap: 4px; border: 1px solid #e2e8f0;">
                    <button id="activeUsersBtn" class="btn-secondary" onclick="switchUsersView('active')" style="padding: 8px 16px;">
                        <i class="fas fa-user-check"></i> ××©×ª××©×™× ×¤×¢×™×œ×™×
                    </button>
                    <button id="pendingInvitationsBtn" class="btn-secondary" onclick="switchUsersView('pending')" style="padding: 8px 16px;">
                        <i class="fas fa-envelope"></i> ×”×–×× ×•×ª ×××ª×™× ×•×ª
                    </button>
                </div>

                <!-- Active Users Table -->
                <div id="activeUsersView" style="display: block;">
                    <table id="usersTable">
                        <thead>
                            <tr>
                                <th>×©×</th>
                                <th>××™××™×™×œ</th>
                                <th>×˜×œ×¤×•×Ÿ</th>
                                <th>×ª×¤×§×™×“</th>
                                <th>×ª××¨×™×š ×”×¦×˜×¨×¤×•×ª</th>
                                <th>×¤×¢×•×œ×•×ª</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 20px; color: #666;">
                                    <i class="fas fa-spinner fa-spin"></i> ×˜×•×¢×Ÿ ××©×ª××©×™×...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Pending Invitations Table -->
                <div id="pendingInvitationsView" style="display: none;">
                    <table id="invitationsTable">
                        <thead>
                            <tr>
                                <th>××™××™×™×œ</th>
                                <th>×©×</th>
                                <th>×˜×œ×¤×•×Ÿ</th>
                                <th>×ª×¤×§×™×“</th>
                                <th>×ª××¨×™×š ×©×œ×™×—×”</th>
                                <th>×¤×¢×•×œ×•×ª</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 20px; color: #666;">
                                    <i class="fas fa-spinner fa-spin"></i> ×˜×•×¢×Ÿ ×”×–×× ×•×ª...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;

            // Load initial data
            await loadActiveUsers();
            await loadPendingInvitations();
            switchUsersView('active');
        }

        // Switch between active users and pending invitations
        function switchUsersView(view) {
            const activeBtn = document.getElementById('activeUsersBtn');
            const pendingBtn = document.getElementById('pendingInvitationsBtn');
            const activeView = document.getElementById('activeUsersView');
            const pendingView = document.getElementById('pendingInvitationsView');

            if (view === 'active') {
                activeBtn.style.background = '#3182ce';
                activeBtn.style.color = 'white';
                pendingBtn.style.background = 'white';
                pendingBtn.style.color = '#3182ce';
                activeView.style.display = 'block';
                pendingView.style.display = 'none';
            } else {
                activeBtn.style.background = 'white';
                activeBtn.style.color = '#3182ce';
                pendingBtn.style.background = '#3182ce';
                pendingBtn.style.color = 'white';
                activeView.style.display = 'none';
                pendingView.style.display = 'block';
            }
        }

        // Show invite user modal with tier limit check
        async function showInviteUserModal() {
            // Check tier limits
            const currentTier = appData.company?.subscriptionTier || 'starter';
            const tierLimits = {
                starter: { maxUsers: 1 },
                professional: { maxUsers: 3 },
                enterprise: { maxUsers: 10 }
            };

            const currentUsers = appData.users?.length || 1;
            const maxUsers = tierLimits[currentTier].maxUsers;

            if (currentUsers >= maxUsers) {
                showUpgradeModal({
                    resource: 'users',
                    current: currentUsers,
                    max: maxUsers,
                    tier: currentTier
                });
                return;
            }

            // Show modal
            document.getElementById('inviteUserModal').style.display = 'block';
        }

        // Send invitation
        async function sendInvitation(event) {
            event.preventDefault();

            const email = document.getElementById('inviteEmail').value.trim();
            const name = document.getElementById('inviteName').value.trim();
            const phone = document.getElementById('invitePhone').value.trim();
            const role = document.getElementById('inviteRole').value;

            if (!email || !name || !phone || !role) {
                showError('× × ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª');
                return;
            }

            // Validate phone format (Israeli format)
            const phoneRegex = /^0\d{1,2}-?\d{7}$/;
            if (!phoneRegex.test(phone)) {
                showError('××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×œ× ×ª×§×™×Ÿ. × × ×œ×”×–×™×Ÿ ××¡×¤×¨ ×™×©×¨××œ×™ ×ª×§× ×™ (×œ××©×œ: 050-1234567)');
                return;
            }

            try {
                const response = await fetch(`${window.API_BASE_URL}/sendInvitation`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${await ClerkAuth.getAuthToken()}`
                    },
                    body: JSON.stringify({ email, name, phone, role })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || '×©×’×™××” ×‘×©×œ×™×—×ª ×”×”×–×× ×”');
                }

                showSuccess('×”×”×–×× ×” × ×©×œ×—×” ×‘×”×¦×œ×—×”!');
                closeModal('inviteUserModal');
                await loadPendingInvitations();
                switchUsersView('pending');

            } catch (error) {
                console.error('Error sending invitation:', error);
                showError(error.message || '×©×’×™××” ×‘×©×œ×™×—×ª ×”×”×–×× ×”');
            }
        }

        // Load active users
        async function loadActiveUsers() {
            try {
                const response = await fetch(`${window.API_BASE_URL}/listUsers`, {
                    headers: {
                        'Authorization': `Bearer ${await ClerkAuth.getAuthToken()}`
                    }
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || '×©×’×™××” ×‘×˜×¢×™× ×ª ××©×ª××©×™×');
                }

                const tbody = document.querySelector('#usersTable tbody');
                if (!tbody) return;

                if (!data.users || data.users.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px; color: #666;">
                                <i class="fas fa-users" style="font-size: 48px; opacity: 0.3; margin-bottom: 15px; display: block;"></i>
                                <p style="margin: 0;">××™×Ÿ ××©×ª××©×™× ×¤×¢×™×œ×™×</p>
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = data.users.map(user => {
                    const roleClass = `role-${user.role || 'viewer'}`;
                    const roleText = {
                        admin: '×× ×”×œ',
                        editor: '×¢×•×¨×š',
                        viewer: '×¦×•×¤×”'
                    }[user.role] || '×¦×•×¤×”';

                    return `
                        <tr>
                            <td>${user.name || '-'}</td>
                            <td>${user.email}</td>
                            <td>${user.phone || '-'}</td>
                            <td><span class="role-badge ${roleClass}">${roleText}</span></td>
                            <td>${user.joinedAt ? new Date(user.joinedAt).toLocaleDateString('he-IL') : '-'}</td>
                            <td>
                                ${user.userId !== appData.company?.ownerId ?
                                    `<button class="btn-delete" onclick="removeUser('${user.userId}', '${user.email}')">×”×¡×¨</button>` :
                                    '<span style="color: #718096; font-size: 0.875rem;">×‘×¢×œ×™×</span>'}
                            </td>
                        </tr>
                    `;
                }).join('');

                // Update appData
                appData.users = data.users;

            } catch (error) {
                console.error('Error loading users:', error);
                const tbody = document.querySelector('#usersTable tbody');
                if (tbody) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 20px; color: #e74c3c;">
                                ×©×’×™××” ×‘×˜×¢×™× ×ª ××©×ª××©×™×: ${error.message}
                            </td>
                        </tr>
                    `;
                }
            }
        }

        // Load pending invitations
        async function loadPendingInvitations() {
            try {
                const response = await fetch(`${window.API_BASE_URL}/listInvitations`, {
                    headers: {
                        'Authorization': `Bearer ${await ClerkAuth.getAuthToken()}`
                    }
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || '×©×’×™××” ×‘×˜×¢×™× ×ª ×”×–×× ×•×ª');
                }

                const tbody = document.querySelector('#invitationsTable tbody');
                if (!tbody) return;

                if (!data.invitations || data.invitations.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px; color: #666;">
                                <i class="fas fa-envelope-open" style="font-size: 48px; opacity: 0.3; margin-bottom: 15px; display: block;"></i>
                                <p style="margin: 0;">××™×Ÿ ×”×–×× ×•×ª ×××ª×™× ×•×ª</p>
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = data.invitations.map(invitation => {
                    const roleClass = `role-${invitation.role || 'viewer'}`;
                    const roleText = {
                        admin: '×× ×”×œ',
                        editor: '×¢×•×¨×š',
                        viewer: '×¦×•×¤×”'
                    }[invitation.role] || '×¦×•×¤×”';

                    return `
                        <tr>
                            <td>${invitation.email}</td>
                            <td>${invitation.name || '-'}</td>
                            <td>${invitation.phone || '-'}</td>
                            <td><span class="role-badge ${roleClass}">${roleText}</span></td>
                            <td>${invitation.sentAt ? new Date(invitation.sentAt).toLocaleDateString('he-IL') : '-'}</td>
                            <td>
                                <button class="btn-secondary" onclick="resendInvitation('${invitation.invitationId}', '${invitation.email}')" style="padding: 6px 12px; margin-left: 5px;">
                                    <i class="fas fa-redo"></i> ×©×œ×— ×©×•×‘
                                </button>
                                <button class="btn-delete" onclick="cancelInvitation('${invitation.invitationId}', '${invitation.email}')">
                                    <i class="fas fa-times"></i> ×‘×˜×œ
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading invitations:', error);
                const tbody = document.querySelector('#invitationsTable tbody');
                if (tbody) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 20px; color: #e74c3c;">
                                ×©×’×™××” ×‘×˜×¢×™× ×ª ×”×–×× ×•×ª: ${error.message}
                            </td>
                        </tr>
                    `;
                }
            }
        }

        // Remove user
        async function removeUser(userId, email) {
            if (!confirm(`×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×”×¡×™×¨ ××ª ×”××©×ª××© ${email}?`)) {
                return;
            }

            try {
                const response = await fetch(`${window.API_BASE_URL}/removeUser`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${await ClerkAuth.getAuthToken()}`
                    },
                    body: JSON.stringify({ userId })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || '×©×’×™××” ×‘×”×¡×¨×ª ××©×ª××©');
                }

                showSuccess('×”××©×ª××© ×”×•×¡×¨ ×‘×”×¦×œ×—×”');
                await loadActiveUsers();

            } catch (error) {
                console.error('Error removing user:', error);
                showError(error.message || '×©×’×™××” ×‘×”×¡×¨×ª ××©×ª××©');
            }
        }

        // Resend invitation
        async function resendInvitation(invitationId, email) {
            try {
                const response = await fetch(`${window.API_BASE_URL}/resendInvitation`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${await ClerkAuth.getAuthToken()}`
                    },
                    body: JSON.stringify({ invitationId })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || '×©×’×™××” ×‘×©×œ×™×—×ª ×”×”×–×× ×” ××—×“×©');
                }

                showSuccess(`×”×”×–×× ×” × ×©×œ×—×” ××—×“×© ×œ-${email}`);
                await loadPendingInvitations();

            } catch (error) {
                console.error('Error resending invitation:', error);
                showError(error.message || '×©×’×™××” ×‘×©×œ×™×—×ª ×”×”×–×× ×” ××—×“×©');
            }
        }

        // Cancel invitation
        async function cancelInvitation(invitationId, email) {
            if (!confirm(`×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×‘×˜×œ ××ª ×”×”×–×× ×” ×œ-${email}?`)) {
                return;
            }

            try {
                const response = await fetch(`${window.API_BASE_URL}/cancelInvitation`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${await ClerkAuth.getAuthToken()}`
                    },
                    body: JSON.stringify({ invitationId })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || '×©×’×™××” ×‘×‘×™×˜×•×œ ×”×”×–×× ×”');
                }

                showSuccess('×”×”×–×× ×” ×‘×•×˜×œ×” ×‘×”×¦×œ×—×”');
                await loadPendingInvitations();

            } catch (error) {
                console.error('Error canceling invitation:', error);
                showError(error.message || '×©×’×™××” ×‘×‘×™×˜×•×œ ×”×”×–×× ×”');
            }
        }

        // Sign Out
        async function signOut() {
            if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×¦××ª ××”××¢×¨×›×ª?')) {
                await ClerkAuth.signOut();
            }
        }

        // Message Functions
        function showSuccess(message) {
            showMessage(message, 'success');
        }

        // Modal Control Functions
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
                // Clear form inputs
                const form = modal.querySelector('form');
                if (form) form.reset();

                // Reset editing states and modal titles
                if (modalId === 'projectModal') {
                    editingProjectId = null;
                    document.querySelector('#projectModal h2').textContent = '×”×•×¡×£ ×¤×¨×•×™×§×˜ ×—×“×©';
                } else if (modalId === 'contractorModal') {
                    editingContractorId = null;
                    document.querySelector('#contractorModal h2').textContent = '×”×•×¡×£ ×§×‘×œ×Ÿ ×—×“×©';
                } else if (modalId === 'workModal') {
                    editingWorkId = null;
                    document.querySelector('#workModal h2').textContent = '×”×•×¡×£ ×¢×‘×•×“×” ×—×“×©×”';
                } else if (modalId === 'expenseModal') {
                    editingExpenseId = null;
                    document.querySelector('#expenseModal h2').textContent = '×”×•×¡×£ ×”×•×¦××” ×—×“×©×”';
                    // Clear receipt preview
                    const preview = document.getElementById('receiptPreview');
                    if (preview) {
                        preview.style.display = 'none';
                        preview.innerHTML = '';
                    }
                }
            }
        }

        // Upgrade Modal Functions
        function showUpgradeModal(errorData) {
            const modal = document.getElementById('upgradeModal');
            const messageEl = document.getElementById('upgradeLimitMessage');
            const usageInfoEl = document.getElementById('upgradeUsageInfo').querySelector('p');

            // Set the main message
            if (errorData.message) {
                messageEl.textContent = errorData.message;
            }

            // Set usage information
            if (errorData.data) {
                const { reason, currentUsage, limit } = errorData.data;
                let usageText = '';

                if (reason === 'PROJECT_LIMIT_REACHED') {
                    usageText = `×™×© ×œ×š ${currentUsage} ×¤×¨×•×™×§×˜×™× ×¤×¢×™×œ×™× ××ª×•×š ${limit} ×”××•×ª×¨×™×`;
                } else if (reason === 'EXPENSE_LIMIT_REACHED') {
                    usageText = `×™×© ×œ×š ${currentUsage} ×”×•×¦××•×ª ×”×—×•×“×© ××ª×•×š ${limit} ×”××•×ª×¨×™×`;
                } else if (reason === 'USER_LIMIT_REACHED') {
                    usageText = `×™×© ×œ×š ${currentUsage} ××©×ª××©×™× ××ª×•×š ${limit} ×”××•×ª×¨×™×`;
                }

                usageInfoEl.textContent = usageText;
            }

            // Show the modal
            modal.style.display = 'block';
        }

        function viewPricing() {
            // Redirect to pricing page or external pricing URL
            window.location.href = '/pricing.html';
        }

        // Onboarding Modal Functions
        function selectTier(tier) {
            // Clear previous selection
            document.querySelectorAll('#onboardingModal .tier-card').forEach(card => {
                card.style.border = '2px solid #cbd5e0';
                card.style.transform = 'scale(1)';
            });

            // Highlight selected tier
            const selectedCard = document.querySelector(`#onboardingModal .tier-card[data-tier="${tier}"]`);
            if (selectedCard) {
                selectedCard.style.border = `2px solid ${tier === 'trial' ? '#48bb78' : tier === 'professional' ? '#3182ce' : '#805ad5'}`;
                selectedCard.style.transform = 'scale(1.05)';
            }

            // Set hidden input value
            document.getElementById('selectedTier').value = tier;
            document.getElementById('tierError').style.display = 'none';
        }

        async function submitOnboarding(event) {
            event.preventDefault();

            const companyName = document.getElementById('companyName').value;
            const subscriptionTier = document.getElementById('selectedTier').value;

            // Validate tier selection
            if (!subscriptionTier) {
                document.getElementById('tierError').style.display = 'block';
                return;
            }

            try {
                // Show loading state
                const submitBtn = event.target.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;
                submitBtn.disabled = true;
                submitBtn.textContent = '×¤×•×ª×— ×ª×©×œ×•× ×××•×‘×˜×—...';

                // Get Paddle checkout configuration from backend
                const response = await apiCall('/create-paddle-checkout', 'POST', {
                    companyName,
                    subscriptionTier
                });

                if (response.success && response.paddleConfig) {
                    console.log('Paddle checkout config received:', response.paddleConfig.priceId);

                    // Store company creation state for webhook processing
                    sessionStorage.setItem('paddle_checkout_in_progress', 'true');
                    sessionStorage.setItem('paddle_company_name', companyName);
                    sessionStorage.setItem('paddle_tier', subscriptionTier);

                    // Open Paddle checkout overlay
                    const paddleConfig = response.paddleConfig;
                    const checkoutData = {
                        items: [{
                            priceId: paddleConfig.priceId,
                            quantity: 1
                        }],
                        customData: paddleConfig.customData
                    };

                    // Add customer email if available
                    if (paddleConfig.customerEmail) {
                        checkoutData.customer = {
                            email: paddleConfig.customerEmail
                        };
                    }

                    // Open Paddle checkout (Paddle is already initialized at page load)
                    console.log('Opening Paddle checkout with priceId:', paddleConfig.priceId);
                    Paddle.Checkout.open(checkoutData);

                    // Reset button state (checkout overlay is open)
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;

                } else {
                    throw new Error(response.message || 'Failed to get checkout configuration');
                }

            } catch (error) {
                console.error('Onboarding error:', error);

                // Show specific error message
                let errorMsg = '×©×’×™××” ×‘×™×¦×™×¨×ª ××¢×‘×¨ ×œ×ª×©×œ×•×. × ×¡×” ×©×•×‘.';
                if (error.message && error.message.includes('Payment provider')) {
                    errorMsg = '×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×¡×¤×§ ×”×ª×©×œ×•×. × ×¡×” ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨.';
                }
                showError(errorMsg);

                // Reset button
                const submitBtn = event.target.querySelector('button[type="submit"]');
                submitBtn.disabled = false;
                submitBtn.textContent = '×”×ª×—×œ ×¢×›×©×™×•';
            }
        }

        function showOnboardingModal() {
            document.getElementById('onboardingModal').style.display = 'block';
        }

        // Form Display Functions - Open Modals
        function showAddProjectForm() {
            document.getElementById('projectModal').style.display = 'block';
        }

        function showAddContractorForm() {
            document.getElementById('contractorModal').style.display = 'block';
        }

        async function showAddWorkForm() {
            // Load projects and contractors for dropdowns
            try {
                const projects = await apiCall('/projects', 'GET');
                const contractors = await apiCall('/contractors', 'GET');

                if (!projects.projects || projects.projects.length === 0) {
                    showError('××™×Ÿ ×¤×¨×•×™×§×˜×™×. ×¦×•×¨ ×¤×¨×•×™×§×˜ ×ª×—×™×œ×”.');
                    return;
                }
                if (!contractors.contractors || contractors.contractors.length === 0) {
                    showError('××™×Ÿ ×§×‘×œ× ×™×. ×¦×•×¨ ×§×‘×œ×Ÿ ×ª×—×™×œ×”.');
                    return;
                }

                // Populate project dropdown
                const projectSelect = document.getElementById('workProjectId');
                projectSelect.innerHTML = '<option value="">×‘×—×¨ ×¤×¨×•×™×§×˜ *</option>';
                projects.projects.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.projectId;
                    option.textContent = p.name;
                    projectSelect.appendChild(option);
                });

                // Populate contractor dropdown
                const contractorSelect = document.getElementById('workContractorId');
                contractorSelect.innerHTML = '<option value="">×‘×—×¨ ×§×‘×œ×Ÿ *</option>';
                contractors.contractors.forEach(c => {
                    const option = document.createElement('option');
                    option.value = c.contractorId;
                    option.textContent = c.name;
                    contractorSelect.appendChild(option);
                });

                document.getElementById('workModal').style.display = 'block';
            } catch (error) {
                showError('×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™×: ' + error.message);
            }
        }

        // Global variable to store works data for expense form
        let expenseFormWorks = [];

        async function showAddExpenseForm() {
            // Load projects, contractors, and works for dropdowns
            try {
                const projects = await apiCall('/projects', 'GET');
                const contractors = await apiCall('/contractors', 'GET');
                const works = await apiCall('/works', 'GET');

                // Store works data globally for onWorkSelected function
                expenseFormWorks = works.works || [];

                // Populate works dropdown
                const workSelect = document.getElementById('expenseWorkId');
                workSelect.innerHTML = '<option value="">×‘×—×¨ ×¢×‘×•×“×” (×××œ× ××•×˜×•××˜×™×ª ×¤×¨×•×™×§×˜ ×•×§×‘×œ×Ÿ)</option>';
                if (works.works) {
                    works.works.forEach(w => {
                        const option = document.createElement('option');
                        option.value = w.workId;
                        option.textContent = w.workName;
                        workSelect.appendChild(option);
                    });
                }

                // Populate project dropdown (optional)
                const projectSelect = document.getElementById('expenseProjectId');
                projectSelect.innerHTML = '<option value="">×‘×—×¨ ×¤×¨×•×™×§×˜ (××•×¤×¦×™×•× ×œ×™)</option>';
                if (projects.projects) {
                    projects.projects.forEach(p => {
                        const option = document.createElement('option');
                        option.value = p.projectId;
                        option.textContent = p.name;
                        projectSelect.appendChild(option);
                    });
                }

                // Populate contractor dropdown (optional)
                const contractorSelect = document.getElementById('expenseContractorId');
                contractorSelect.innerHTML = '<option value="">×‘×—×¨ ×§×‘×œ×Ÿ (××•×¤×¦×™×•× ×œ×™)</option>';
                if (contractors.contractors) {
                    contractors.contractors.forEach(c => {
                        const option = document.createElement('option');
                        option.value = c.contractorId;
                        option.textContent = c.name;
                        contractorSelect.appendChild(option);
                    });
                }

                document.getElementById('expenseModal').style.display = 'block';
            } catch (error) {
                showError('×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™×: ' + error.message);
            }
        }

        // Auto-fill project and contractor when work is selected
        function onWorkSelected() {
            const workId = document.getElementById('expenseWorkId').value;

            if (!workId) {
                // Clear selections if no work selected
                document.getElementById('expenseProjectId').value = '';
                document.getElementById('expenseContractorId').value = '';
                return;
            }

            // Find the selected work
            const selectedWork = expenseFormWorks.find(w => w.workId === workId);

            if (selectedWork) {
                // Auto-fill project and contractor
                document.getElementById('expenseProjectId').value = selectedWork.projectId || '';
                document.getElementById('expenseContractorId').value = selectedWork.contractorId || '';
            }
        }

        // Form Submission Functions
        async function submitProject(event) {
            event.preventDefault();

            try {
                const project = {
                    name: document.getElementById('projectName').value,
                    description: document.getElementById('projectDescription').value || '',
                    startDate: document.getElementById('projectStartDate').value,
                    endDate: document.getElementById('projectEndDate').value || undefined,
                    budget: parseFloat(document.getElementById('projectBudget').value) || 0,
                    location: document.getElementById('projectLocation').value || '',
                    clientName: document.getElementById('projectClient').value || ''
                };

                if (editingProjectId) {
                    // Update existing project
                    project.projectId = editingProjectId;
                    await apiCall('/projects', 'PUT', project);
                    showSuccess('×¤×¨×•×™×§×˜ ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”');
                    editingProjectId = null;
                } else {
                    // Create new project
                    await apiCall('/projects', 'POST', project);
                    showSuccess('×¤×¨×•×™×§×˜ × ×•×¡×£ ×‘×”×¦×œ×—×”');
                }

                closeModal('projectModal');
                await loadAppData();
                // Always stay on current tab after creating/updating
                refreshCurrentTab();
            } catch (error) {
                // Don't show error if upgrade modal is already displayed
                if (error.message !== 'TIER_LIMIT') {
                    showError('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×¤×¨×•×™×§×˜: ' + error.message);
                }
            }
        }

        async function submitContractor(event) {
            event.preventDefault();

            try {
                const contractor = {
                    name: document.getElementById('contractorName').value,
                    phone: document.getElementById('contractorPhone').value || '',
                    specialty: document.getElementById('contractorSpecialty').value || ''
                };

                if (editingContractorId) {
                    // Update existing contractor
                    contractor.contractorId = editingContractorId;
                    await apiCall('/contractors', 'PUT', contractor);
                    showSuccess('×§×‘×œ×Ÿ ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”');
                    editingContractorId = null;
                } else {
                    // Create new contractor
                    await apiCall('/contractors', 'POST', contractor);
                    showSuccess('×§×‘×œ×Ÿ × ×•×¡×£ ×‘×”×¦×œ×—×”');
                }

                closeModal('contractorModal');
                await loadAppData();
                // Always stay on current tab after creating/updating
                refreshCurrentTab();
            } catch (error) {
                // Don't show error if upgrade modal is already displayed
                if (error.message !== 'TIER_LIMIT') {
                    showError('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×§×‘×œ×Ÿ: ' + error.message);
                }
            }
        }

        async function submitWork(event) {
            event.preventDefault();

            try {
                const work = {
                    workName: document.getElementById('workName').value,
                    projectId: document.getElementById('workProjectId').value,
                    contractorId: document.getElementById('workContractorId').value,
                    startDate: document.getElementById('workStartDate').value || null,
                    totalWorkCost: parseFloat(document.getElementById('workCost').value) || 0,
                    status: 'planned'
                };

                if (editingWorkId) {
                    // Update existing work
                    work.workId = editingWorkId;
                    await apiCall('/works', 'PUT', work);
                    showSuccess('×¢×‘×•×“×” ×¢×•×“×›× ×” ×‘×”×¦×œ×—×”');
                    editingWorkId = null;
                } else {
                    // Create new work
                    await apiCall('/works', 'POST', work);
                    showSuccess('×¢×‘×•×“×” × ×•×¡×¤×” ×‘×”×¦×œ×—×”');
                }

                closeModal('workModal');
                await loadAppData();
                // Always stay on current tab after creating/updating
                refreshCurrentTab();
            } catch (error) {
                // Don't show error if upgrade modal is already displayed
                if (error.message !== 'TIER_LIMIT') {
                    showError('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×¢×‘×•×“×”: ' + error.message);
                }
            }
        }

        async function submitExpense(event) {
            event.preventDefault();

            try {
                let receiptUrl = '';

                // If editing, get existing receipt URL
                if (editingExpenseId) {
                    const existingExpense = appData.expenses.find(e => e.expenseId === editingExpenseId);
                    receiptUrl = existingExpense?.receiptUrl || '';
                }

                // Check if a new receipt file was selected
                const fileInput = document.getElementById('expenseReceipt');
                if (fileInput.files && fileInput.files[0]) {
                    const file = fileInput.files[0];

                    // Show uploading message
                    const preview = document.getElementById('receiptPreview');
                    preview.textContent = '××¢×œ×” ×§×‘×œ×”...';
                    preview.style.display = 'block';

                    // Get presigned URL from Lambda
                    const uploadData = await apiCall('/upload-receipt', 'POST', {
                        fileName: file.name,
                        fileType: file.type
                    });

                    // Upload file to S3 using presigned URL
                    const uploadResponse = await fetch(uploadData.data.uploadUrl, {
                        method: 'PUT',
                        body: file,
                        headers: {
                            'Content-Type': file.type
                        }
                    });

                    if (!uploadResponse.ok) {
                        throw new Error('Failed to upload receipt to S3');
                    }

                    receiptUrl = uploadData.data.receiptUrl;
                    preview.textContent = 'âœ“ ×§×‘×œ×” ×”×•×¢×œ×ª×” ×‘×”×¦×œ×—×”';
                }

                const expense = {
                    description: document.getElementById('expenseDescription').value,
                    amount: parseFloat(document.getElementById('expenseAmount').value) || 0,
                    date: document.getElementById('expenseDate').value,
                    invoiceNum: document.getElementById('expenseInvoice').value || 'N/A',
                    paymentMethod: document.getElementById('expensePayment').value || 'Cash',
                    workId: document.getElementById('expenseWorkId').value || '',
                    projectId: document.getElementById('expenseProjectId').value || '',
                    contractorId: document.getElementById('expenseContractorId').value || '',
                    receiptUrl: receiptUrl,
                    category: 'General'
                };

                if (editingExpenseId) {
                    // Update existing expense
                    expense.expenseId = editingExpenseId;
                    await apiCall('/expenses', 'PUT', expense);
                    showSuccess('×”×•×¦××” ×¢×•×“×›× ×” ×‘×”×¦×œ×—×”');
                    editingExpenseId = null;
                } else {
                    // Create new expense
                    await apiCall('/expenses', 'POST', expense);
                    showSuccess('×”×•×¦××” × ×•×¡×¤×” ×‘×”×¦×œ×—×”');
                }

                closeModal('expenseModal');
                await loadAppData();
                // Always stay on current tab after creating/updating
                refreshCurrentTab();
            } catch (error) {
                // Don't show error if upgrade modal is already displayed
                if (error.message !== 'TIER_LIMIT') {
                    showError('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×”×•×¦××”: ' + error.message);
                }
            }
        }

        // ===== EDIT FUNCTIONS =====

        // Track if we're editing (stores entity ID being edited)
        let editingProjectId = null;
        let editingContractorId = null;
        let editingWorkId = null;
        let editingExpenseId = null;

        function editProject(projectId) {
            const project = appData.projects.find(p => p.projectId === projectId);
            if (!project) {
                showError('×¤×¨×•×™×§×˜ ×œ× × ××¦×');
                return;
            }

            // Store that we're editing
            editingProjectId = projectId;

            // Populate form
            document.getElementById('projectName').value = project.name || '';
            document.getElementById('projectDescription').value = project.description || '';
            document.getElementById('projectStartDate').value = project.startDate || '';
            document.getElementById('projectEndDate').value = project.endDate || '';
            document.getElementById('projectBudget').value = project.budget || '';
            document.getElementById('projectLocation').value = project.location || '';
            document.getElementById('projectClient').value = project.clientName || '';

            // Change modal title
            document.querySelector('#projectModal h2').textContent = '×¢×¨×•×š ×¤×¨×•×™×§×˜';

            // Show modal
            document.getElementById('projectModal').style.display = 'block';
        }

        function editContractor(contractorId) {
            const contractor = appData.contractors.find(c => c.contractorId === contractorId);
            if (!contractor) {
                showError('×§×‘×œ×Ÿ ×œ× × ××¦×');
                return;
            }

            console.log('[EDIT CONTRACTOR] Full contractor object:', contractor);
            console.log('[EDIT CONTRACTOR] contractor.specialty:', contractor.specialty);
            console.log('[EDIT CONTRACTOR] contractor.speciality:', contractor.speciality);

            // Store that we're editing
            editingContractorId = contractorId;

            // Populate form
            document.getElementById('contractorName').value = contractor.name || '';
            document.getElementById('contractorPhone').value = contractor.phone || '';
            // Support both spellings for backwards compatibility
            const specialtyValue = contractor.specialty || contractor.speciality || '';
            console.log('[EDIT CONTRACTOR] Using specialty value:', specialtyValue);
            document.getElementById('contractorSpecialty').value = specialtyValue;

            // Change modal title
            document.querySelector('#contractorModal h2').textContent = '×¢×¨×•×š ×§×‘×œ×Ÿ';

            // Show modal
            document.getElementById('contractorModal').style.display = 'block';
        }

        async function editWork(workId) {
            console.log('[EDIT WORK] Starting edit for workId:', workId);
            const work = appData.works.find(w => w.workId === workId);
            if (!work) {
                showError('×¢×‘×•×“×” ×œ× × ××¦××”');
                return;
            }
            console.log('[EDIT WORK] Found work:', work);

            // Store that we're editing
            editingWorkId = workId;

            // Load projects and contractors for dropdowns
            try {
                console.log('[EDIT WORK] Loading projects and contractors...');
                const projects = await apiCall('/projects', 'GET');
                const contractors = await apiCall('/contractors', 'GET');
                console.log('[EDIT WORK] Loaded projects:', projects.projects?.length, 'contractors:', contractors.contractors?.length);

                // Populate project dropdown
                const projectSelect = document.getElementById('workProjectId');
                if (!projectSelect) {
                    console.error('[EDIT WORK] ERROR: workProjectId element not found!');
                    showError('×©×’×™××”: ×©×“×” ×¤×¨×•×™×§×˜ ×œ× × ××¦×');
                    return;
                }
                projectSelect.innerHTML = '<option value="">×‘×—×¨ ×¤×¨×•×™×§×˜ *</option>';
                if (projects.projects) {
                    projects.projects.forEach(p => {
                        const option = document.createElement('option');
                        option.value = p.projectId;
                        option.textContent = p.name;
                        if (p.projectId === work.projectId) option.selected = true;
                        projectSelect.appendChild(option);
                    });
                }
                console.log('[EDIT WORK] Populated project dropdown, selected:', work.projectId);

                // Populate contractor dropdown
                const contractorSelect = document.getElementById('workContractorId');
                if (!contractorSelect) {
                    console.error('[EDIT WORK] ERROR: workContractorId element not found!');
                    showError('×©×’×™××”: ×©×“×” ×§×‘×œ×Ÿ ×œ× × ××¦×');
                    return;
                }
                contractorSelect.innerHTML = '<option value="">×‘×—×¨ ×§×‘×œ×Ÿ *</option>';
                if (contractors.contractors) {
                    contractors.contractors.forEach(c => {
                        const option = document.createElement('option');
                        option.value = c.contractorId;
                        option.textContent = c.name;
                        if (c.contractorId === work.contractorId) option.selected = true;
                        contractorSelect.appendChild(option);
                    });
                }
                console.log('[EDIT WORK] Populated contractor dropdown, selected:', work.contractorId);

                // Populate form fields
                const workNameField = document.getElementById('workName');
                const workStartDateField = document.getElementById('workStartDate');
                const workCostField = document.getElementById('workCost');

                if (!workNameField || !workStartDateField || !workCostField) {
                    console.error('[EDIT WORK] ERROR: Missing form fields!', {
                        workName: !!workNameField,
                        workStartDate: !!workStartDateField,
                        workCost: !!workCostField
                    });
                    showError('×©×’×™××”: ×©×“×•×ª ×˜×•×¤×¡ ×—×¡×¨×™×');
                    return;
                }

                workNameField.value = work.workName || '';
                workStartDateField.value = work.startDate || '';
                workCostField.value = work.totalWorkCost || '';
                console.log('[EDIT WORK] Populated form fields');

                // Change modal title
                document.querySelector('#workModal h2').textContent = '×¢×¨×•×š ×¢×‘×•×“×”';

                // Show modal
                document.getElementById('workModal').style.display = 'block';
                console.log('[EDIT WORK] Modal displayed');

            } catch (error) {
                console.error('[EDIT WORK] ERROR:', error);
                showError('×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™×: ' + error.message);
            }
        }

        async function editExpense(expenseId) {
            const expense = appData.expenses.find(e => e.expenseId === expenseId);
            if (!expense) {
                showError('×”×•×¦××” ×œ× × ××¦××”');
                return;
            }

            // Store that we're editing
            editingExpenseId = expenseId;

            // Load projects, contractors, and works for dropdowns
            try {
                const projects = await apiCall('/projects', 'GET');
                const contractors = await apiCall('/contractors', 'GET');
                const works = await apiCall('/works', 'GET');

                // Store works data globally for onWorkSelected function
                expenseFormWorks = works.works || [];

                // Populate works dropdown
                const workSelect = document.getElementById('expenseWorkId');
                workSelect.innerHTML = '<option value="">×‘×—×¨ ×¢×‘×•×“×” (×××œ× ××•×˜×•××˜×™×ª ×¤×¨×•×™×§×˜ ×•×§×‘×œ×Ÿ)</option>';
                if (works.works) {
                    works.works.forEach(w => {
                        const option = document.createElement('option');
                        option.value = w.workId;
                        option.textContent = w.workName;
                        if (w.workId === expense.workId) option.selected = true;
                        workSelect.appendChild(option);
                    });
                }

                // Populate project dropdown
                const projectSelect = document.getElementById('expenseProjectId');
                projectSelect.innerHTML = '<option value="">×‘×—×¨ ×¤×¨×•×™×§×˜ *</option>';
                if (projects.projects) {
                    projects.projects.forEach(p => {
                        const option = document.createElement('option');
                        option.value = p.projectId;
                        option.textContent = p.name;
                        if (p.projectId === expense.projectId) option.selected = true;
                        projectSelect.appendChild(option);
                    });
                }

                // Populate contractor dropdown
                const contractorSelect = document.getElementById('expenseContractorId');
                contractorSelect.innerHTML = '<option value="">×‘×—×¨ ×§×‘×œ×Ÿ *</option>';
                if (contractors.contractors) {
                    contractors.contractors.forEach(c => {
                        const option = document.createElement('option');
                        option.value = c.contractorId;
                        option.textContent = c.name;
                        if (c.contractorId === expense.contractorId) option.selected = true;
                        contractorSelect.appendChild(option);
                    });
                }

                // Populate form fields
                document.getElementById('expenseDescription').value = expense.description || '';
                document.getElementById('expenseAmount').value = expense.amount || '';
                document.getElementById('expenseDate').value = expense.date || '';
                document.getElementById('expenseInvoice').value = expense.invoiceNum || '';
                document.getElementById('expensePayment').value = expense.paymentMethod || 'Cash';

                // Note: File input cannot be pre-populated for security reasons
                // Show existing receipt if available
                if (expense.receiptUrl) {
                    const preview = document.getElementById('receiptPreview');
                    preview.innerHTML = `<a href="${expense.receiptUrl}" target="_blank">×§×‘×œ×” ×§×™×™××ª</a>`;
                    preview.style.display = 'block';
                }

                // Change modal title
                document.querySelector('#expenseModal h2').textContent = '×¢×¨×•×š ×”×•×¦××”';

                // Show modal
                document.getElementById('expenseModal').style.display = 'block';

            } catch (error) {
                showError('×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™×: ' + error.message);
            }
        }

        function showError(message) {
            showMessage(message, 'error');
        }

        function showMessage(message, type) {
            const messageArea = document.getElementById('messageArea');
            messageArea.className = `message ${type}`;
            messageArea.textContent = message;
            messageArea.style.display = 'block';

            setTimeout(() => {
                messageArea.style.display = 'none';
            }, 5000);
        }

        // ===== REPORTS AND ANALYTICS FUNCTIONS =====

        let expenseTrendChartInstance = null;
        let projectDistributionChartInstance = null;

        function initializeReportsDashboard() {
            // Calculate key metrics
            const totalExpenses = appData.expenses.reduce((sum, exp) => sum + (exp.amount || 0), 0);
            const activeProjects = appData.projects.length;

            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const monthlyExpenses = appData.expenses
                .filter(exp => {
                    const date = new Date(exp.date);
                    return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
                })
                .reduce((sum, exp) => sum + (exp.amount || 0), 0);

            const avgExpense = appData.expenses.length > 0 ? totalExpenses / appData.expenses.length : 0;

            // Calculate previous month for comparison
            const lastMonth = currentMonth === 0 ? 11 : currentMonth - 1;
            const lastMonthYear = currentMonth === 0 ? currentYear - 1 : currentYear;
            const lastMonthExpenses = appData.expenses
                .filter(exp => {
                    const date = new Date(exp.date);
                    return date.getMonth() === lastMonth && date.getFullYear() === lastMonthYear;
                })
                .reduce((sum, exp) => sum + (exp.amount || 0), 0);

            const change = lastMonthExpenses > 0
                ? ((monthlyExpenses - lastMonthExpenses) / lastMonthExpenses * 100).toFixed(1)
                : 0;

            // Update UI
            document.getElementById('report-total-expenses').textContent = `â‚ª${totalExpenses.toLocaleString('he-IL')}`;
            document.getElementById('report-active-projects').textContent = activeProjects;
            document.getElementById('report-monthly-expenses').textContent = `â‚ª${monthlyExpenses.toLocaleString('he-IL')}`;
            document.getElementById('report-avg-expense').textContent = `â‚ª${Math.round(avgExpense).toLocaleString('he-IL')}`;

            const changeEl = document.getElementById('report-expense-change');
            if (change > 0) {
                changeEl.textContent = `â†‘ ${change}% ××”×—×•×“×© ×”×§×•×“×`;
                changeEl.className = 'metric-change negative';
            } else if (change < 0) {
                changeEl.textContent = `â†“ ${Math.abs(change)}% ××”×—×•×“×© ×”×§×•×“×`;
                changeEl.className = 'metric-change positive';
            } else {
                changeEl.textContent = '×œ×œ× ×©×™× ×•×™';
                changeEl.className = 'metric-change';
            }

            // Initialize charts
            createExpenseTrendChart();
            createProjectDistributionChart();
        }

        function createExpenseTrendChart() {
            const canvas = document.getElementById('expenseTrendChart');
            if (!canvas) return;

            // Destroy existing chart
            if (expenseTrendChartInstance) {
                expenseTrendChartInstance.destroy();
            }

            // Get last 6 months data
            const monthsData = [];
            const today = new Date();

            for (let i = 5; i >= 0; i--) {
                const month = new Date(today.getFullYear(), today.getMonth() - i, 1);
                const monthExpenses = appData.expenses
                    .filter(exp => {
                        const expDate = new Date(exp.date);
                        return expDate.getMonth() === month.getMonth() &&
                               expDate.getFullYear() === month.getFullYear();
                    })
                    .reduce((sum, exp) => sum + (exp.amount || 0), 0);

                monthsData.push({
                    label: month.toLocaleDateString('he-IL', { month: 'short', year: 'numeric' }),
                    value: monthExpenses
                });
            }

            const ctx = canvas.getContext('2d');
            expenseTrendChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: monthsData.map(d => d.label),
                    datasets: [{
                        label: '×”×•×¦××•×ª',
                        data: monthsData.map(d => d.value),
                        borderColor: '#3182ce',
                        backgroundColor: 'rgba(49, 130, 206, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'â‚ª' + value.toLocaleString('he-IL');
                                }
                            }
                        }
                    }
                }
            });
        }

        function createProjectDistributionChart() {
            const canvas = document.getElementById('projectDistributionChart');
            if (!canvas) return;

            // Destroy existing chart
            if (projectDistributionChartInstance) {
                projectDistributionChartInstance.destroy();
            }

            // Calculate expenses per project
            const projectExpenses = {};
            appData.expenses.forEach(exp => {
                const projectName = exp.projectName || '×œ×œ× ×¤×¨×•×™×§×˜';
                projectExpenses[projectName] = (projectExpenses[projectName] || 0) + exp.amount;
            });

            // Sort and get top 5
            const sorted = Object.entries(projectExpenses)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            const colors = ['#3182ce', '#10b981', '#f97316', '#9333ea', '#ef4444'];

            const ctx = canvas.getContext('2d');
            projectDistributionChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: sorted.map(d => d[0]),
                    datasets: [{
                        data: sorted.map(d => d[1]),
                        backgroundColor: colors
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function showProjectBudgetReport() {
            const container = document.getElementById('tabContent');

            // Calculate budget vs actual for each project
            const projectData = appData.projects.map(project => {
                const spent = appData.expenses
                    .filter(exp => exp.projectId === project.projectId)
                    .reduce((sum, exp) => sum + exp.amount, 0);

                const budget = project.budget || 0;
                const remaining = budget - spent;
                const percentage = budget > 0 ? (spent / budget * 100).toFixed(1) : 0;

                let status = 'success';
                if (percentage > 100) status = 'danger';
                else if (percentage > 80) status = 'warning';

                return {
                    name: project.name,
                    budget,
                    spent,
                    remaining,
                    percentage,
                    status
                };
            });

            container.innerHTML = `
                <h2>×“×•×— ×ª×§×¦×™×‘ ×¤×¨×•×™×§×˜×™×</h2>
                <button class="btn-primary" onclick="showTab('reports')" style="margin-bottom: 20px;">
                    <i class="fas fa-arrow-right"></i> ×—×–×¨×” ×œ×“×•×—×•×ª
                </button>

                <table class="budget-table">
                    <thead>
                        <tr>
                            <th>×¤×¨×•×™×§×˜</th>
                            <th>×ª×§×¦×™×‘</th>
                            <th>×‘×•×¦×¢</th>
                            <th>× ×•×ª×¨</th>
                            <th>% ×‘×™×¦×•×¢</th>
                            <th>×¡×˜×˜×•×¡</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${projectData.map(p => `
                            <tr>
                                <td><strong>${p.name}</strong></td>
                                <td>â‚ª${p.budget.toLocaleString('he-IL')}</td>
                                <td>â‚ª${p.spent.toLocaleString('he-IL')}</td>
                                <td>â‚ª${p.remaining.toLocaleString('he-IL')}</td>
                                <td>
                                    <div>${p.percentage}%</div>
                                    <div class="progress-bar">
                                        <div class="progress-fill ${p.status}" style="width: ${Math.min(p.percentage, 100)}%"></div>
                                    </div>
                                </td>
                                <td>
                                    <span class="alert-badge ${p.status}">
                                        ${p.status === 'success' ? '×ª×§×™×Ÿ' : p.status === 'warning' ? '×”×ª×¨××”' : '×—×¨×™×’×”'}
                                    </span>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function showContractorReport() {
            const container = document.getElementById('tabContent');

            // Calculate data per contractor
            const contractorData = appData.contractors.map(contractor => {
                const expenses = appData.expenses.filter(exp => exp.contractorId === contractor.contractorId);
                const totalPaid = expenses.reduce((sum, exp) => sum + exp.amount, 0);
                const transactionCount = expenses.length;
                const avgTransaction = transactionCount > 0 ? totalPaid / transactionCount : 0;

                return {
                    name: contractor.name,
                    specialty: contractor.speciality || '-',
                    totalPaid,
                    transactionCount,
                    avgTransaction
                };
            }).sort((a, b) => b.totalPaid - a.totalPaid);

            container.innerHTML = `
                <h2>×“×•×— × ×™×ª×•×— ×§×‘×œ× ×™×</h2>
                <button class="btn-primary" onclick="showTab('reports')" style="margin-bottom: 20px;">
                    <i class="fas fa-arrow-right"></i> ×—×–×¨×” ×œ×“×•×—×•×ª
                </button>

                <table>
                    <thead>
                        <tr>
                            <th>×§×‘×œ×Ÿ</th>
                            <th>×”×ª××—×•×ª</th>
                            <th>×¡×”"×› ×©×•×œ×</th>
                            <th>××¡' ×¢×¡×§××•×ª</th>
                            <th>×××•×¦×¢ ×œ×¢×¡×§×”</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${contractorData.map(c => `
                            <tr>
                                <td><strong>${c.name}</strong></td>
                                <td>${c.specialty}</td>
                                <td>â‚ª${c.totalPaid.toLocaleString('he-IL')}</td>
                                <td>${c.transactionCount}</td>
                                <td>â‚ª${Math.round(c.avgTransaction).toLocaleString('he-IL')}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function showMonthlyReport() {
            const container = document.getElementById('tabContent');

            const currentDate = new Date();
            const currentMonth = currentDate.getMonth();
            const currentYear = currentDate.getFullYear();

            const currentMonthExpenses = appData.expenses.filter(exp => {
                const date = new Date(exp.date);
                return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
            });

            const lastMonth = currentMonth === 0 ? 11 : currentMonth - 1;
            const lastMonthYear = currentMonth === 0 ? currentYear - 1 : currentYear;

            const lastMonthExpenses = appData.expenses.filter(exp => {
                const date = new Date(exp.date);
                return date.getMonth() === lastMonth && date.getFullYear() === lastMonthYear;
            });

            const currentTotal = currentMonthExpenses.reduce((sum, exp) => sum + exp.amount, 0);
            const lastTotal = lastMonthExpenses.reduce((sum, exp) => sum + exp.amount, 0);
            const change = lastTotal > 0 ? ((currentTotal - lastTotal) / lastTotal * 100).toFixed(1) : 0;

            container.innerHTML = `
                <h2>×¡×™×›×•× ×—×•×“×©×™ - ${currentDate.toLocaleDateString('he-IL', { month: 'long', year: 'numeric' })}</h2>
                <button class="btn-primary" onclick="showTab('reports')" style="margin-bottom: 20px;">
                    <i class="fas fa-arrow-right"></i> ×—×–×¨×” ×œ×“×•×—×•×ª
                </button>

                <div class="dashboard-grid">
                    <div class="metric-card">
                        <div class="metric-icon blue">
                            <i class="fas fa-calendar-check"></i>
                        </div>
                        <div class="metric-value">â‚ª${currentTotal.toLocaleString('he-IL')}</div>
                        <div class="metric-label">×”×—×•×“×© ×”× ×•×›×—×™</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon purple">
                            <i class="fas fa-calendar"></i>
                        </div>
                        <div class="metric-value">â‚ª${lastTotal.toLocaleString('he-IL')}</div>
                        <div class="metric-label">×”×—×•×“×© ×”×§×•×“×</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon ${change > 0 ? 'orange' : 'green'}">
                            <i class="fas fa-${change > 0 ? 'arrow-up' : 'arrow-down'}"></i>
                        </div>
                        <div class="metric-value">${Math.abs(change)}%</div>
                        <div class="metric-label">${change > 0 ? '×¢×œ×™×™×”' : '×™×¨×™×“×”'}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon green">
                            <i class="fas fa-receipt"></i>
                        </div>
                        <div class="metric-value">${currentMonthExpenses.length}</div>
                        <div class="metric-label">×”×•×¦××•×ª ×”×—×•×“×©</div>
                    </div>
                </div>

                <h3 style="margin-top: 32px;">×”×•×¦××•×ª ×”×—×•×“×©</h3>
                <table>
                    <thead>
                        <tr>
                            <th>×ª××¨×™×š</th>
                            <th>×ª×™××•×¨</th>
                            <th>×¡×›×•×</th>
                            <th>×¤×¨×•×™×§×˜</th>
                            <th>×§×‘×œ×Ÿ</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${currentMonthExpenses.map(exp => `
                            <tr>
                                <td>${new Date(exp.date).toLocaleDateString('he-IL')}</td>
                                <td>${exp.description}</td>
                                <td>â‚ª${exp.amount.toLocaleString('he-IL')}</td>
                                <td>${exp.projectName || '-'}</td>
                                <td>${exp.contractorName || '-'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function showMissingReceiptsReport() {
            const container = document.getElementById('tabContent');

            const missingReceipts = appData.expenses.filter(exp => !exp.receiptUrl || exp.receiptUrl === '');
            const total = missingReceipts.reduce((sum, exp) => sum + exp.amount, 0);

            container.innerHTML = `
                <h2>×“×•×— ×§×‘×œ×•×ª ×—×¡×¨×•×ª</h2>
                <button class="btn-primary" onclick="showTab('reports')" style="margin-bottom: 20px;">
                    <i class="fas fa-arrow-right"></i> ×—×–×¨×” ×œ×“×•×—×•×ª
                </button>

                <div class="chart-container" style="margin-bottom: 24px;">
                    <h3>×¡×™×›×•×</h3>
                    <p><strong>${missingReceipts.length}</strong> ×”×•×¦××•×ª ×œ×œ× ×§×‘×œ×”</p>
                    <p>×¡×š ×”×›×œ: <strong>â‚ª${total.toLocaleString('he-IL')}</strong></p>
                </div>

                ${missingReceipts.length > 0 ? `
                    <table>
                        <thead>
                            <tr>
                                <th>×ª××¨×™×š</th>
                                <th>×ª×™××•×¨</th>
                                <th>×¡×›×•×</th>
                                <th>×¤×¨×•×™×§×˜</th>
                                <th>×§×‘×œ×Ÿ</th>
                                <th>×¤×¢×•×œ×•×ª</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${missingReceipts.map(exp => `
                                <tr>
                                    <td>${new Date(exp.date).toLocaleDateString('he-IL')}</td>
                                    <td>${exp.description}</td>
                                    <td>â‚ª${exp.amount.toLocaleString('he-IL')}</td>
                                    <td>${exp.projectName || '-'}</td>
                                    <td>${exp.contractorName || '-'}</td>
                                    <td>
                                        <button class="btn-edit" onclick="editExpense('${exp.expenseId}')">×”×¢×œ×” ×§×‘×œ×”</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                ` : '<p style="text-align: center; padding: 40px; color: #10b981;"><i class="fas fa-check-circle"></i> ×›×œ ×”×”×•×¦××•×ª ×›×•×œ×œ×•×ª ×§×‘×œ×•×ª!</p>'}
            `;
        }
    </script>

    <!-- Details Modal -->
    <div id="detailsModal" class="details-modal" onclick="closeDetailsModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2 id="modalTitle">×¤×¨×˜×™×</h2>
                <button class="modal-close" onclick="closeDetailsModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-tabs">
                <button class="modal-tab active" onclick="switchModalTab('info', event)">
                    <i class="fas fa-info-circle"></i> ××™×“×¢
                </button>
                <button class="modal-tab" onclick="switchModalTab('receipts', event)">
                    <i class="fas fa-receipt"></i> ×§×‘×œ×•×ª
                </button>
            </div>
            <div class="modal-body">
                <div id="modalTabInfo" class="modal-tab-content active">
                    <!-- Details will be populated here -->
                </div>
                <div id="modalTabReceipts" class="modal-tab-content">
                    <!-- Receipts will be populated here -->
                </div>
            </div>
        </div>
    </div>
</body>
</html>