<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת מעקב הוצאות בניה</title>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- Font Awesome (with SRI) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha384-iw3OoTErCYJJB9mCa8LNS2hbsQ7M3C0EpIsO/H5+EGAkPGc6rk+V8i04oW/K5xq0" crossorigin="anonymous">

    <!-- Chart.js (with SRI) - Kept synchronous for Reports tab -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" integrity="sha384-e6nUZLBkQ86NJ6TVVKAeSaK8jWa3NhkYWZFomE39AvDbQWeie9PlQqM3pmYW5d1g" crossorigin="anonymous"></script>

    <!-- PDF/Excel Export Libraries - NOW LAZY LOADED ON DEMAND (~420KB saved on initial load) -->
    <!-- html2canvas, jspdf, html2pdf, xlsx are loaded via loadExportLibraries() when user clicks export -->

    <!-- Paddle.js for payment checkout (no SRI - dynamically updated) -->
    <script src="https://cdn.paddle.com/paddle/v2/paddle.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Rubik', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            color: #1a202c;
        }

        /* Clerk Auth Container */
        #clerkAuthContainer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #ffffff;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .clerk-loading {
            text-align: center;
            color: #4a5568;
        }

        .clerk-loading h2 {
            font-size: 1.5rem;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .spinner {
            border: 3px solid #e2e8f0;
            border-radius: 50%;
            border-top: 3px solid #3182ce;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Main App Container */
        #mainContent {
            display: none;
            width: 100%;
        }

        /* Header */
        .header {
            background: #ffffff;
            padding: 20px 40px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #1a202c;
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header h1 i {
            color: #3182ce;
            font-size: 1.3rem;
        }

        /* User Info */
        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-details {
            text-align: left;
        }

        .user-name {
            font-weight: 500;
            color: #2d3748;
            font-size: 1rem;
        }

        .company-name {
            font-size: 0.85rem;
            color: #718096;
        }

        .user-menu {
            display: flex;
            gap: 10px;
        }

        .btn-user {
            padding: 8px 16px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
            background: #ffffff;
        }

        .btn-profile {
            color: #3182ce;
            border-color: #3182ce;
        }

        .btn-profile:hover {
            background: #3182ce;
            color: white;
        }

        .btn-org {
            color: #38a169;
            border-color: #38a169;
        }

        .btn-org:hover {
            background: #38a169;
            color: white;
        }

        .btn-signout {
            color: #e53e3e;
            border-color: #e53e3e;
        }

        .btn-signout:hover {
            background: #e53e3e;
            color: white;
        }

        /* Main Container */
        .container {
            padding: 30px;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        /* Dashboard Cards */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
            transition: all 0.2s;
        }

        .card:hover {
            border-color: #cbd5e0;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        .card-icon {
            font-size: 1.25rem;
            margin-bottom: 12px;
            color: #718096;
        }

        .card-title {
            color: #718096;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .card-value {
            color: #1a202c;
            font-size: 2rem;
            font-weight: 700;
            line-height: 1;
        }

        /* Tabs */
        .tabs {
            background: white;
            border-radius: 12px;
            padding: 8px;
            margin-bottom: 24px;
            display: flex;
            gap: 4px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
        }

        .tab-button {
            padding: 10px 20px;
            border: none;
            background: transparent;
            color: #718096;
            cursor: pointer;
            border-radius: 8px;
            font-size: 0.9375rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .tab-button.active {
            background: #3182ce;
            color: white;
        }

        .tab-button:hover:not(.active) {
            background: #f7fafc;
            color: #4a5568;
        }

        /* Content Area */
        .content-area {
            background: white;
            border-radius: 12px;
            padding: 32px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
            min-height: 500px;
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #4a5568;
            font-weight: 500;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3182ce;
            box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.1);
        }

        .btn-primary {
            background: #3182ce;
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 8px;
            font-size: 0.9375rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .btn-primary:hover {
            background: #2c5282;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .btn-secondary {
            background: white;
            color: #3182ce;
            border: 1px solid #3182ce;
            padding: 10px 24px;
            border-radius: 8px;
            font-size: 0.9375rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .btn-secondary:hover {
            background: #f7fafc;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Message */
        .message {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .message.success {
            background: #c6f6d5;
            color: #22543d;
            border-left: 4px solid #48bb78;
        }

        .message.error {
            background: #fed7d7;
            color: #742a2a;
            border-left: 4px solid #f56565;
        }

        /* Role Badges */
        .role-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
            display: inline-block;
        }
        .role-admin {
            background: #3182ce;
            color: white;
        }
        .role-editor {
            background: #48bb78;
            color: white;
        }
        .role-viewer {
            background: #718096;
            color: white;
        }

        /* Table */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 24px;
        }

        th {
            background: #f7fafc;
            padding: 14px 16px;
            text-align: right;
            color: #4a5568;
            font-weight: 600;
            font-size: 0.875rem;
            border-bottom: 1px solid #e2e8f0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            padding: 16px;
            border-bottom: 1px solid #f0f0f0;
            color: #1a202c;
            font-size: 0.9375rem;
        }

        tr:hover {
            background: #fafafa;
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        /* Action Buttons */
        .btn-edit, .btn-delete {
            padding: 6px 16px;
            background: white;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            margin: 0 4px;
            font-family: 'Rubik', sans-serif;
        }

        .btn-edit {
            border: 1.5px solid #1a202c;
            color: #1a202c;
        }

        .btn-edit:hover {
            background: #1a202c;
            color: white;
        }

        .btn-delete {
            border: 1.5px solid #e53e3e;
            color: #e53e3e;
        }

        .btn-delete:hover {
            background: #c53030;
            border-color: #c53030;
            color: white;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: #718096;
        }

        .loading i {
            font-size: 3rem;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 32px;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            animation: slideDown 0.3s;
            border: 1px solid #e2e8f0;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-content h2 {
            color: #1a202c;
            margin-bottom: 28px;
            font-size: 1.5rem;
            font-weight: 700;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 16px;
        }

        .close {
            color: #718096;
            float: left;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close:hover,
        .close:focus {
            color: #2d3748;
        }

        .modal-content form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-height: calc(85vh - 180px);
            overflow-y: auto;
            overflow-x: hidden;
            padding-right: 8px;
        }

        .modal-content form::-webkit-scrollbar {
            width: 8px;
        }

        .modal-content form::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .modal-content form::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 4px;
        }

        .modal-content form::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }

        .modal-content .form-group {
            margin-bottom: 0;
        }

        .modal-content label {
            display: block;
            margin-bottom: 6px;
            color: #4a5568;
            font-weight: 500;
            font-size: 0.875rem;
        }

        .modal-content input,
        .modal-content select,
        .modal-content textarea {
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 1rem;
            font-family: 'Rubik', sans-serif;
            transition: border-color 0.3s;
        }

        .modal-content input[type="file"] {
            padding: 8px;
            cursor: pointer;
        }

        .modal-content input[type="file"]::file-selector-button {
            background: #3182ce;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
            font-family: 'Rubik', sans-serif;
        }

        .modal-content input[type="file"]::file-selector-button:hover {
            background: #2c5aa0;
        }

        .modal-content input:focus,
        .modal-content select:focus,
        .modal-content textarea:focus {
            outline: none;
            border-color: #3182ce;
            box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.1);
        }

        .modal-content textarea {
            min-height: 100px;
            resize: vertical;
        }

        .modal-content button[type="submit"] {
            background: #3182ce;
            color: white;
            padding: 11px 24px;
            border: none;
            border-radius: 8px;
            font-size: 0.9375rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .modal-content button[type="submit"]:hover {
            background: #2c5282;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .modal-content button[type="button"] {
            background: #ffffff;
            color: #4a5568;
            padding: 11px 24px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.9375rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-content button[type="button"]:hover {
            background: #f7fafc;
            border-color: #cbd5e0;
        }

        /* Charts and Reports */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.08);
        }

        .metric-icon {
            width: 48px;
            height: 48px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 12px;
        }

        .metric-icon.blue { background: #dbeafe; color: #3182ce; }
        .metric-icon.green { background: #d1fae5; color: #10b981; }
        .metric-icon.purple { background: #e9d5ff; color: #9333ea; }
        .metric-icon.orange { background: #fed7aa; color: #f97316; }

        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: #1a202c;
            margin: 8px 0;
        }

        .metric-label {
            color: #718096;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .metric-change {
            font-size: 0.875rem;
            margin-top: 8px;
            font-weight: 500;
        }

        .metric-change.positive { color: #10b981; }
        .metric-change.negative { color: #ef4444; }

        /* ========================================
           REPORTS DASHBOARD REDESIGN STYLES
           ======================================== */

        /* Period Selector Bar */
        .period-selector-bar {
            background: white;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .period-selector-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .period-preset-btn {
            padding: 0.5rem 1rem;
            border: 1px solid #e2e8f0;
            background: white;
            color: #64748b;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .period-preset-btn:hover {
            background: #f8fafc;
            border-color: #cbd5e1;
        }

        .period-preset-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .export-reports-btn {
            padding: 0.5rem 1.25rem;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .export-reports-btn:hover {
            background: #059669;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        /* Metrics Layout Grid */
        .metrics-layout {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 1.25rem;
            margin-bottom: 1.5rem;
        }

        /* Hero Metric Card */
        .metric-card-hero {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            padding: 2rem;
            border-radius: 16px;
            border: 2px solid #3b82f6;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .metric-card-hero::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #3b82f6 0%, #10b981 100%);
        }

        .metric-card-hero:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.15);
        }

        .metric-hero-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .metric-icon-hero {
            width: 56px;
            height: 56px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            color: #3b82f6;
        }

        .metric-hero-label {
            font-size: 1rem;
            color: #64748b;
            font-weight: 600;
        }

        .metric-hero-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #1a202c;
            margin: 0.75rem 0;
            line-height: 1.2;
        }

        .metric-hero-change {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .metric-hero-change.positive { color: #10b981; }
        .metric-hero-change.negative { color: #ef4444; }
        .metric-hero-change.neutral { color: #64748b; }

        .metric-hero-change i { font-size: 1rem; }

        .metric-change-context {
            font-size: 0.75rem;
            color: #94a3b8;
            font-weight: 500;
            margin-right: 0.25rem;
        }

        .metric-hero-footer {
            padding-top: 1rem;
            border-top: 1px solid #e2e8f0;
        }

        .metric-mini {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .metric-mini-label {
            font-size: 0.75rem;
            color: #94a3b8;
        }

        .metric-mini-value {
            font-size: 0.875rem;
            color: #64748b;
            font-weight: 500;
        }

        /* Financial Overview Card Group */
        .metric-card-group {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
            transition: all 0.2s;
            height: 100%;
        }

        .metric-card-group:hover {
            box-shadow: 0 4px 6px rgba(0,0,0,0.08);
        }

        .metric-group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.25rem;
        }

        .metric-group-title {
            font-size: 1rem;
            font-weight: 600;
            color: #1a202c;
            margin: 0;
        }

        .metric-group-action {
            background: transparent;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            padding: 0.25rem;
            transition: color 0.2s;
        }

        .metric-group-action:hover { color: #3b82f6; }

        .metric-group-grid {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 1.5rem;
            align-items: center;
        }

        .metric-group-divider {
            width: 1px;
            height: 80px;
            background: #e2e8f0;
        }

        .metric-group-item {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .metric-item-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .metric-icon-sm {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .metric-icon-sm.purple { background: #e9d5ff; color: #9333ea; }
        .metric-icon-sm.orange { background: #fed7aa; color: #f97316; }

        .metric-item-label {
            font-size: 0.875rem;
            color: #64748b;
            font-weight: 500;
        }

        .metric-item-value {
            font-size: 2rem;
            font-weight: 700;
            color: #1a202c;
            margin: 0.25rem 0;
        }

        .metric-item-change {
            font-size: 0.875rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .metric-item-change.positive { color: #10b981; }
        .metric-item-change.negative { color: #ef4444; }

        .metric-item-badge {
            font-size: 0.75rem;
            color: #94a3b8;
            background: #f8fafc;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            display: inline-block;
            width: fit-content;
        }

        /* Performance Metrics Row */
        .metric-card-row {
            background: white;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
            padding: 1.5rem;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 2rem;
            margin-bottom: 1.5rem;
        }

        .metric-card-compact {
            display: flex;
            gap: 1rem;
            align-items: flex-start;
        }

        .metric-compact-icon {
            width: 48px;
            height: 48px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            flex-shrink: 0;
        }

        .metric-compact-icon.green { background: #d1fae5; color: #10b981; }
        .metric-compact-icon.orange { background: #fed7aa; color: #f97316; }
        .metric-compact-icon.blue { background: #dbeafe; color: #3b82f6; }

        .metric-compact-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .metric-compact-label {
            font-size: 0.875rem;
            color: #64748b;
            font-weight: 500;
        }

        .metric-compact-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: #1a202c;
            line-height: 1.2;
        }

        .metric-compact-subtext {
            font-size: 0.75rem;
            color: #94a3b8;
        }

        .metric-compact-change {
            font-size: 0.875rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .metric-compact-change.positive { color: #10b981; }
        .metric-compact-change.negative { color: #ef4444; }

        .metric-progress-bar {
            width: 100%;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .metric-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6 0%, #10b981 100%);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        /* Enhanced Chart Container */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.25rem;
            margin-bottom: 2rem;
        }

        .chart-container-enhanced {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
            transition: all 0.2s;
            min-width: 0; /* Prevent grid overflow */
            overflow: hidden;
        }

        .chart-container-enhanced:hover {
            box-shadow: 0 4px 6px rgba(0,0,0,0.08);
        }

        .chart-header-enhanced {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .chart-title-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .chart-title-enhanced {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1a202c;
            margin: 0;
        }

        .chart-subtitle {
            font-size: 0.875rem;
            color: #94a3b8;
        }

        .chart-controls {
            display: flex;
            gap: 0.5rem;
            background: #f8fafc;
            padding: 0.25rem;
            border-radius: 8px;
        }

        .chart-control-btn {
            padding: 0.375rem 0.75rem;
            background: transparent;
            border: none;
            color: #64748b;
            font-size: 0.875rem;
            font-weight: 500;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .chart-control-btn:hover { background: white; }

        .chart-control-btn.active {
            background: white;
            color: #3b82f6;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        }

        .chart-canvas-wrapper {
            position: relative;
            height: 300px;
            margin-bottom: 1rem;
            width: 100%;
            overflow: hidden;
        }

        .chart-canvas-wrapper canvas {
            max-width: 100% !important;
            width: 100% !important;
        }

        .chart-footer {
            padding-top: 1rem;
            border-top: 1px solid #e2e8f0;
        }

        .chart-legend-custom {
            display: flex;
            gap: 1.5rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        .legend-label {
            font-size: 0.875rem;
            color: #64748b;
            font-weight: 500;
        }

        /* Section Title */
        .section-title-reports {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1a202c;
            margin: 2rem 0 1rem 0;
        }

        /* Reports Dashboard Responsive */
        @media (max-width: 1280px) {
            .metrics-layout {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 1024px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }

            .metric-card-row {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }

            .metric-card-compact {
                padding-bottom: 1.5rem;
                border-bottom: 1px solid #e2e8f0;
            }

            .metric-card-compact:last-child {
                border-bottom: none;
                padding-bottom: 0;
            }
        }

        @media (max-width: 768px) {
            .period-selector-bar {
                flex-direction: column;
                align-items: stretch;
            }

            .period-selector-group {
                justify-content: center;
            }

            .export-reports-btn {
                width: 100%;
                justify-content: center;
            }

            .metric-card-hero {
                padding: 1.5rem;
            }

            .metric-hero-value {
                font-size: 2rem;
            }

            .metric-group-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .metric-group-divider {
                display: none;
            }

            .metric-group-item {
                padding-bottom: 1rem;
                border-bottom: 1px solid #e2e8f0;
            }

            .metric-group-item:last-child {
                border-bottom: none;
                padding-bottom: 0;
            }

            .chart-header-enhanced {
                flex-direction: column;
                align-items: stretch;
            }

            .chart-controls {
                width: 100%;
                justify-content: space-between;
            }

            .chart-canvas-wrapper {
                height: 250px;
            }
        }

        @media (max-width: 480px) {
            .period-preset-btn {
                flex: 1;
                min-width: 0;
                font-size: 0.75rem;
                padding: 0.5rem 0.5rem;
            }

            .metric-hero-value {
                font-size: 1.75rem;
            }

            .metric-item-value {
                font-size: 1.5rem;
            }

            .metric-compact-value {
                font-size: 1.5rem;
            }
        }

        /* Page Load Animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in {
            animation: fadeInUp 0.4s ease-out forwards;
        }

        /* ========================================
           END REPORTS DASHBOARD REDESIGN STYLES
           ======================================== */

        .chart-container {
            background: white;
            padding: 24px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
            margin-bottom: 24px;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        /* Billing Plan Cards */
        .billing-plan-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.12);
        }

        .billing-plan-card.current-plan {
            background: #f0fdf4;
        }

        .billing-plan-card.featured-plan {
            transform: scale(1.02);
        }

        .billing-plan-card.featured-plan:hover {
            transform: scale(1.02) translateY(-3px);
        }

        .chart-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1a202c;
        }

        .chart-canvas {
            position: relative;
            height: 300px;
        }

        .reports-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 24px;
        }

        .report-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.2s;
        }

        .report-card:hover {
            border-color: #3182ce;
            box-shadow: 0 4px 6px rgba(0,0,0,0.08);
        }

        .report-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin-bottom: 12px;
            background: #dbeafe;
            color: #3182ce;
        }

        .report-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1a202c;
            margin-bottom: 8px;
        }

        .report-description {
            font-size: 0.875rem;
            color: #718096;
        }

        .filter-bar {
            background: white;
            padding: 16px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            margin-bottom: 20px;
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-bar label {
            margin: 0;
            font-size: 0.875rem;
        }

        .filter-bar select, .filter-bar input {
            padding: 8px 12px;
            font-size: 0.875rem;
            min-width: 150px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            background: #3182ce;
            transition: width 0.3s;
        }

        .progress-fill.warning { background: #f97316; }
        .progress-fill.danger { background: #ef4444; }

        .budget-table {
            width: 100%;
            margin-top: 20px;
        }

        .budget-table td {
            padding: 12px;
        }

        .alert-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .alert-badge.success { background: #d1fae5; color: #065f46; }
        .alert-badge.warning { background: #fed7aa; color: #9a3412; }
        .alert-badge.danger { background: #fee2e2; color: #991b1b; }

        /* Details Modal Styles */
        .details-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .details-modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            padding: 24px 30px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .modal-tabs {
            display: flex;
            border-bottom: 1px solid #e2e8f0;
            background: #f8f9fa;
        }

        .modal-tab {
            flex: 1;
            padding: 16px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            color: #64748b;
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
        }

        .modal-tab:hover {
            background: #e2e8f0;
        }

        .modal-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: white;
        }

        .modal-body {
            padding: 30px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-tab-content {
            display: none;
        }

        .modal-tab-content.active {
            display: block;
        }

        .detail-row {
            display: flex;
            padding: 16px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-weight: 600;
            color: #475569;
            min-width: 150px;
            flex-shrink: 0;
        }

        .detail-value {
            color: #1e293b;
            flex: 1;
        }

        .receipts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .receipt-card {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            transition: all 0.2s;
        }

        .receipt-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-color: #667eea;
        }

        .receipt-date {
            font-size: 0.875rem;
            color: #64748b;
            margin-bottom: 8px;
        }

        .receipt-description {
            font-weight: 600;
            margin-bottom: 8px;
            color: #1e293b;
        }

        .receipt-amount {
            font-size: 1.25rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 12px;
        }

        .receipt-image-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #667eea;
            text-decoration: none;
            font-size: 0.875rem;
            padding: 8px 16px;
            border: 1px solid #667eea;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .receipt-image-link:hover {
            background: #667eea;
            color: white;
        }

        .no-receipts {
            text-align: center;
            padding: 60px 20px;
            color: #94a3b8;
        }

        .no-receipts i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .clickable-card {
            cursor: pointer;
            transition: all 0.2s;
        }

        .clickable-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
        }

        .clickable-row {
            cursor: pointer;
            transition: background 0.2s;
        }

        .clickable-row:hover {
            background: #f1f5f9;
        }

        /* ============================================ */
        /* MOBILE RESPONSIVE STYLES */
        /* ============================================ */

        /* Tablet and below (768px) */
        @media (max-width: 768px) {
            /* Navigation */
            nav {
                padding: 0.75rem 1rem;
            }

            nav .logo {
                font-size: 1.2rem;
            }

            nav .nav-links {
                gap: 0.75rem;
            }

            nav .nav-links a {
                font-size: 0.85rem;
                padding: 0.5rem 0.75rem;
            }

            /* Dashboard Stats Cards */
            .stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.75rem;
                padding: 1rem;
            }

            .stat-card {
                padding: 1rem;
            }

            .stat-card h3 {
                font-size: 0.85rem;
            }

            .stat-card .stat-value {
                font-size: 1.5rem;
            }

            /* Content Area */
            .content {
                padding: 1rem;
            }

            /* Tabs */
            .tabs {
                padding: 0 1rem;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .tab {
                white-space: nowrap;
                padding: 0.75rem 1rem;
                font-size: 0.9rem;
            }

            /* Buttons */
            .btn-primary, .btn-secondary, .btn-danger {
                padding: 0.75rem 1.25rem;
                font-size: 0.95rem;
                min-height: 44px; /* Touch-friendly */
            }

            /* Modal */
            .modal-content {
                width: 95%;
                max-width: 95%;
                margin: 1rem auto;
                max-height: 90vh;
                overflow-y: auto;
            }

            .modal-content h2 {
                font-size: 1.3rem;
            }

            /* Onboarding Modal - Stack tier cards */
            #onboardingModal .modal-content {
                max-width: 100%;
                padding: 1.5rem 1rem;
            }

            #onboardingModal .tier-card {
                padding: 1rem;
            }

            #onboardingModal .tier-card h4 {
                font-size: 1.1rem;
            }

            #onboardingModal .tier-card ul li {
                font-size: 0.85rem;
                padding: 6px 0;
            }

            /* Forms */
            form label {
                font-size: 0.9rem;
            }

            form input, form select, form textarea {
                padding: 0.75rem;
                font-size: 1rem; /* Prevent zoom on iOS */
                min-height: 44px;
            }

            /* Tables */
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            table {
                min-width: 600px;
            }

            table th, table td {
                padding: 0.75rem 0.5rem;
                font-size: 0.85rem;
            }

            /* Charts */
            .chart-card {
                padding: 1rem;
            }

            .chart-card h3 {
                font-size: 1.1rem;
            }

            /* Close button */
            .close {
                font-size: 2rem;
                padding: 0.25rem;
                min-width: 44px;
                min-height: 44px;
            }
        }

        /* Mobile phones (480px) */
        @media (max-width: 480px) {
            /* Single column layout */
            .stats {
                grid-template-columns: 1fr;
            }

            /* Navigation - minimal */
            nav .logo {
                font-size: 1rem;
            }

            nav .nav-links {
                gap: 0.5rem;
            }

            nav .nav-links a {
                font-size: 0.75rem;
                padding: 0.4rem 0.6rem;
            }

            nav .nav-links a i {
                font-size: 1rem;
            }

            nav .nav-links a span {
                display: none; /* Hide text, show only icons */
            }

            /* Tabs - scrollable */
            .tabs {
                padding: 0 0.5rem;
            }

            .tab {
                padding: 0.75rem 0.75rem;
                font-size: 0.85rem;
            }

            /* Content */
            .content {
                padding: 0.75rem;
            }

            .content h1 {
                font-size: 1.3rem;
            }

            /* Modal */
            .modal-content {
                width: 100%;
                max-width: 100%;
                margin: 0;
                border-radius: 0;
                max-height: 100vh;
                padding: 1rem;
            }

            .modal-content h2 {
                font-size: 1.2rem;
            }

            /* Onboarding - Stack tier cards vertically */
            #onboardingModal [style*="grid-template-columns: 1fr 1fr 1fr"] {
                display: flex !important;
                flex-direction: column !important;
                gap: 1rem !important;
            }

            #onboardingModal .tier-card {
                width: 100% !important;
            }

            #onboardingModal .tier-card div[style*="font-size: 36px"] {
                font-size: 24px !important;
            }

            /* Upgrade Modal - Stack tier cards */
            #upgradeModal [style*="grid-template-columns: 1fr 1fr"] {
                display: flex !important;
                flex-direction: column !important;
                gap: 1rem !important;
            }

            /* Buttons */
            .btn-primary, .btn-secondary, .btn-danger {
                width: 100%;
                padding: 1rem;
                font-size: 1rem;
            }

            /* Form inputs */
            form input, form select, form textarea {
                font-size: 16px !important; /* Prevent iOS zoom */
            }

            /* Table actions */
            table .actions {
                display: flex;
                flex-direction: column;
                gap: 0.25rem;
            }

            table .actions button {
                width: 100%;
                padding: 0.5rem;
                font-size: 0.8rem;
            }

            /* Receipt grid */
            .receipt-grid {
                grid-template-columns: 1fr !important;
            }

            /* Chart container */
            .chart-card canvas {
                max-height: 250px !important;
            }
        }

        /* ============================================
           MOBILE UI IMPROVEMENTS (< 480px)
           ============================================ */

        /* Mobile Navigation Dropdown */
        .mobile-nav-dropdown {
            display: none;
            width: 100%;
            position: relative;
        }

        .mobile-nav-trigger {
            width: 100%;
            padding: 12px 16px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1rem;
            font-weight: 500;
            color: #2d3748;
            cursor: pointer;
        }

        .mobile-nav-trigger i.fa-chevron-down {
            transition: transform 0.3s;
        }

        .mobile-nav-trigger.open i.fa-chevron-down {
            transform: rotate(180deg);
        }

        .mobile-nav-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin-top: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 100;
            overflow: hidden;
        }

        .mobile-nav-menu.show {
            display: block;
        }

        .mobile-nav-item {
            padding: 14px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s;
        }

        .mobile-nav-item:last-child {
            border-bottom: none;
        }

        .mobile-nav-item:hover,
        .mobile-nav-item:active {
            background: #f7fafc;
        }

        .mobile-nav-item.active {
            background: #ebf8ff;
            color: #3182ce;
        }

        .mobile-nav-item i {
            width: 20px;
            text-align: center;
        }

        /* Mobile Expense Cards */
        .expense-cards-mobile {
            display: none;
        }

        .expense-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .expense-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .expense-card-date {
            font-size: 0.85rem;
            color: #718096;
        }

        .expense-card-amount {
            font-size: 1.25rem;
            font-weight: 700;
            color: #2d3748;
        }

        .expense-card-description {
            font-size: 1rem;
            font-weight: 500;
            color: #1a202c;
            margin-bottom: 8px;
        }

        .expense-card-details {
            font-size: 0.85rem;
            color: #718096;
            margin-bottom: 12px;
            text-align: right;
        }

        .expense-card-detail {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 8px;
            margin-bottom: 6px;
            direction: rtl;
        }

        .expense-card-detail i {
            color: #4299e1;
            font-size: 0.9rem;
            width: 16px;
            text-align: center;
        }

        .expense-card-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .expense-card-actions button,
        .expense-card-actions a {
            flex: 1;
            min-width: 80px;
            padding: 10px 12px;
            font-size: 0.85rem;
            text-align: center;
            border-radius: 6px;
        }

        /* Mobile Header User Menu */
        .mobile-user-menu-toggle {
            display: none;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            color: #4a5568;
            font-size: 1.2rem;
            cursor: pointer;
            align-items: center;
            justify-content: center;
        }

        .mobile-user-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin-top: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 200px;
            overflow: hidden;
        }

        .mobile-user-dropdown.show {
            display: block;
        }

        .mobile-user-dropdown button {
            width: 100%;
            padding: 14px 16px;
            background: none;
            border: none;
            border-bottom: 1px solid #f0f0f0;
            text-align: right;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .mobile-user-dropdown button:last-child {
            border-bottom: none;
        }

        .mobile-user-dropdown button:hover {
            background: #f7fafc;
        }

        @media (max-width: 480px) {
            /* Show mobile navigation, hide desktop tabs */
            .tabs {
                display: none !important;
            }

            .mobile-nav-dropdown {
                display: block;
                margin-bottom: 16px;
            }

            /* Show mobile expense cards, hide desktop table */
            #expensesTable {
                display: none !important;
            }

            .expense-cards-mobile {
                display: block;
            }

            /* Mobile header adjustments */
            .header {
                padding: 12px 16px !important;
            }

            .header h1 {
                font-size: 1rem !important;
            }

            .header h1 i {
                font-size: 1.2rem !important;
            }

            .user-menu {
                display: none !important;
            }

            .mobile-user-menu-toggle {
                display: flex !important;
            }

            .user-info {
                position: relative;
            }

            .user-details {
                display: none;
            }

            /* Smaller dashboard cards */
            .dashboard-cards {
                gap: 8px !important;
            }

            .card {
                padding: 12px !important;
            }

            .card-title {
                font-size: 0.75rem !important;
            }

            .card-value {
                font-size: 1.25rem !important;
            }

            /* Optimize receipt upload zone */
            .receipt-dropzone {
                min-height: 100px !important;
                padding: 16px !important;
            }

            .receipt-dropzone i {
                font-size: 28px !important;
            }

            .receipt-dropzone p {
                font-size: 0.85rem !important;
                margin: 4px 0 !important;
            }

            /* Single column forms */
            .form-grid,
            [style*="grid-template-columns: 1fr 1fr"],
            [style*="grid-template-columns: 1fr 1fr 1fr"] {
                display: block !important;
            }

            .form-grid > *,
            [style*="grid-template-columns"] > * {
                margin-bottom: 12px;
            }

            /* Filter row stacking */
            .filter-row,
            [style*="display: flex"][style*="gap: 12px"] {
                flex-direction: column !important;
            }

            /* Touch-friendly action buttons */
            .btn-edit, .btn-delete {
                padding: 10px 16px !important;
                font-size: 0.9rem !important;
            }

            /* Modal improvements */
            .modal-content {
                padding: 16px !important;
            }

            .modal-content h2 {
                font-size: 1.1rem !important;
            }

            /* Expense form layout on mobile */
            .expense-form-layout {
                flex-direction: column !important;
            }

            .expense-receipt-panel {
                flex: none !important;
                width: 100% !important;
                min-height: 150px !important;
            }

            .expense-form-panel {
                width: 100% !important;
            }

            /* Projects grid - single column on mobile */
            .projects-grid {
                grid-template-columns: 1fr !important;
            }

            /* Dashboard and Reports grids - single column on mobile */
            .dashboard-grid,
            .reports-grid {
                grid-template-columns: 1fr !important;
            }

            /* Charts grid - single column on mobile */
            .charts-row {
                grid-template-columns: 1fr !important;
            }

            /* Metric cards - smaller padding */
            .metric-card {
                padding: 16px !important;
            }

            /* Report cards - smaller */
            .report-card {
                padding: 16px !important;
            }

            /* Contractors table - hide on mobile */
            #contractorsTable {
                display: none !important;
            }

            .contractors-cards-mobile {
                display: block !important;
            }

            /* Works table - hide on mobile */
            #worksTable {
                display: none !important;
            }

            .works-cards-mobile {
                display: block !important;
            }

            /* Users table - hide on mobile */
            #usersTable,
            #invitationsTable {
                display: none !important;
            }

            .users-cards-mobile,
            .invitations-cards-mobile {
                display: block !important;
            }

            /* Users tab header - stack on mobile */
            .users-header {
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 12px !important;
            }

            /* Users tab switcher - full width on mobile */
            .users-tab-switcher {
                width: 100% !important;
                flex-direction: column !important;
            }

            .users-tab-switcher button {
                width: 100% !important;
            }

            /* Billing subscription card - stack on mobile */
            .subscription-status-row {
                flex-direction: column !important;
                align-items: flex-start !important;
                text-align: right !important;
            }

            .subscription-status-row > div:last-child {
                text-align: right !important;
                width: 100% !important;
                margin-top: 16px;
            }

            /* Missing receipts table - hide on mobile */
            .missing-receipts-table {
                display: none !important;
            }

            .missing-receipts-cards-mobile {
                display: block !important;
            }
        }

        /* Projects Grid - Desktop */
        .projects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        /* Mobile Card Views - Hidden by default */
        .contractors-cards-mobile,
        .works-cards-mobile,
        .users-cards-mobile,
        .invitations-cards-mobile,
        .missing-receipts-cards-mobile {
            display: none;
        }

        /* Generic Mobile Card Style */
        .mobile-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid #e2e8f0;
        }

        .mobile-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .mobile-card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1a202c;
        }

        .mobile-card-subtitle {
            font-size: 0.85rem;
            color: #718096;
            margin-top: 4px;
        }

        .mobile-card-details {
            font-size: 0.9rem;
            color: #4a5568;
            margin-bottom: 12px;
        }

        .mobile-card-detail {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 8px;
            margin-bottom: 6px;
            direction: rtl;
        }

        .mobile-card-detail i {
            color: #4299e1;
            font-size: 0.85rem;
            width: 18px;
            text-align: center;
        }

        .mobile-card-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            border-top: 1px solid #e2e8f0;
            padding-top: 12px;
            margin-top: 8px;
        }

        .mobile-card-actions button {
            flex: 1;
            min-width: 80px;
            padding: 10px 12px;
            font-size: 0.85rem;
            border-radius: 6px;
        }

        .mobile-card-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-active {
            background: #c6f6d5;
            color: #22543d;
        }

        .badge-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-admin {
            background: #e9d8fd;
            color: #553c9a;
        }

        /* Touch device optimizations */
        @media (hover: none) and (pointer: coarse) {
            /* Larger touch targets */
            button, a, input, select, textarea {
                min-height: 44px;
                min-width: 44px;
            }

            /* Remove hover effects on touch devices */
            .clickable-card:hover,
            .clickable-row:hover,
            .btn-primary:hover,
            .btn-secondary:hover,
            nav .nav-links a:hover,
            .tab:hover {
                transform: none;
            }

            /* Add active state for touch feedback */
            button:active, a:active {
                opacity: 0.7;
            }
        }

        /* Landscape mobile optimization */
        @media (max-width: 896px) and (orientation: landscape) {
            .modal-content {
                max-height: 85vh;
                overflow-y: auto;
            }

            .stats {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        /* Expense Type Selection Buttons */
        .btn-expense-type {
            padding: 20px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            background: #f7fafc;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .btn-expense-type:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .btn-expense-type:first-child {
            border-color: #3182ce;
            background: #ebf8ff;
        }

        .btn-expense-type:first-child:hover {
            background: #bee3f8;
            border-color: #2b6cb0;
        }

        .btn-expense-type:last-child:hover {
            background: #edf2f7;
            border-color: #cbd5e0;
        }

        /* Wide Expense Modal */
        .expense-modal-wide {
            max-width: 900px !important;
        }

        .expense-modal-wide.no-picture {
            max-width: 600px !important;
        }

        /* Side-by-side Layout - Picture on LEFT, Form on RIGHT for RTL readers */
        .expense-form-layout {
            display: flex;
            gap: 24px;
            direction: ltr; /* Keep picture on left side for Hebrew readers */
        }

        .expense-receipt-panel {
            flex: 0 0 350px;
            min-height: 400px;
            border: 2px dashed #e2e8f0;
            border-radius: 8px;
            background: #f7fafc;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .expense-form-panel {
            flex: 1;
            min-width: 0;
            direction: rtl; /* Keep form content RTL for Hebrew */
            text-align: right;
        }

        /* Receipt Upload Area */
        .receipt-upload-area {
            width: 100%;
            height: 100%;
        }

        .receipt-dropzone {
            width: 100%;
            height: 100%;
            min-height: 380px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            border-radius: 6px;
        }

        .receipt-dropzone:hover {
            background: #edf2f7;
        }

        .receipt-dropzone.drag-over {
            background: #ebf8ff;
            border-color: #3182ce;
        }

        /* Receipt Image Preview */
        .receipt-image-preview {
            width: 100%;
            height: 100%;
            position: relative;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .receipt-image-preview img {
            max-width: 100%;
            max-height: 350px;
            object-fit: contain;
            border-radius: 4px;
        }

        .btn-remove-receipt {
            margin-top: 15px;
            background: #e53e3e;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Rubik', sans-serif;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-remove-receipt:hover {
            background: #c53030;
        }

        /* Missing Receipt Badge */
        .missing-receipt-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: #fef3c7;
            color: #92400e;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
        }

        .missing-receipt-badge i {
            color: #d97706;
        }

        /* Mobile Responsive for Expense Modal */
        @media (max-width: 768px) {
            .expense-modal-wide {
                max-width: 95% !important;
            }

            .expense-form-layout {
                flex-direction: column;
            }

            .expense-receipt-panel {
                flex: none;
                width: 100%;
                min-height: 200px;
            }

            .receipt-dropzone {
                min-height: 180px;
            }
        }

        /* OCR Component Styles */
        .ocr-container-wrapper {
            margin-bottom: 20px;
            border-radius: 8px;
            overflow: hidden;
        }

        .receipt-upload-ocr {
            width: 100%;
        }

        /* Upload Zone */
        .ocr-upload-zone {
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            padding: 30px 20px;
            text-align: center;
            background: #f7fafc;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .ocr-upload-zone:hover {
            border-color: #3182ce;
            background: #edf2f7;
        }

        .ocr-upload-zone.drag-over {
            border-color: #3182ce;
            background: #e6f2ff;
            border-style: solid;
        }

        .upload-icon {
            font-size: 48px;
            color: #3182ce;
            margin-bottom: 15px;
        }

        .upload-text .primary-text {
            font-size: 16px;
            font-weight: 500;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .upload-text .secondary-text {
            font-size: 14px;
            color: #718096;
            margin-bottom: 10px;
        }

        .upload-text .ocr-info-text {
            font-size: 13px;
            color: #3182ce;
            background: #e6f2ff;
            padding: 8px 15px;
            border-radius: 5px;
            display: inline-block;
            margin-top: 10px;
        }

        .upload-text .ocr-info-text i {
            margin-left: 5px;
        }

        /* Progress Bar */
        .ocr-progress-container {
            padding: 20px;
            background: #f7fafc;
            border-radius: 8px;
        }

        .ocr-progress-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .progress-icon {
            font-size: 24px;
            color: #3182ce;
        }

        .progress-text {
            font-size: 16px;
            font-weight: 500;
            color: #2d3748;
        }

        .progress-bar-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .progress-bar {
            flex: 1;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3182ce, #4299e1);
            transition: width 0.3s ease;
        }

        .progress-percent {
            font-size: 14px;
            font-weight: 600;
            color: #3182ce;
            min-width: 40px;
        }

        .progress-subtext {
            text-align: center;
            font-size: 13px;
            color: #718096;
        }

        /* Preview */
        .ocr-preview-container {
            background: #f7fafc;
            border-radius: 8px;
            padding: 20px;
        }

        .preview-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .preview-header h3 {
            font-size: 16px;
            color: #2d3748;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .preview-success-icon {
            color: #10b981;
            font-size: 24px;
        }

        .clear-receipt-btn {
            background: none;
            border: none;
            color: #e53e3e;
            cursor: pointer;
            font-size: 20px;
            padding: 5px;
            transition: color 0.2s;
        }

        .clear-receipt-btn:hover {
            color: #c53030;
        }

        .preview-thumbnail {
            position: relative;
            margin-bottom: 15px;
            border-radius: 8px;
            overflow: hidden;
            max-width: 200px;
            margin-right: auto;
            margin-left: auto;
        }

        .preview-thumbnail img {
            width: 100%;
            height: auto;
            display: block;
        }

        .thumbnail-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            padding: 8px;
        }

        .thumbnail-overlay .file-name {
            color: white;
            font-size: 12px;
            text-align: center;
            display: block;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .extracted-fields-summary h4 {
            font-size: 14px;
            color: #2d3748;
            margin-bottom: 10px;
        }

        .fields-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .field-indicator {
            background: white;
            border-radius: 6px;
            padding: 10px;
            border: 1px solid #e2e8f0;
        }

        .field-indicator[data-confidence="high"] {
            border-color: #10b981;
        }

        .field-indicator[data-confidence="medium"] {
            border-color: #f59e0b;
        }

        .field-indicator[data-confidence="low"] {
            border-color: #ef4444;
        }

        .field-indicator .field-label {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 12px;
            color: #718096;
            margin-bottom: 5px;
        }

        .field-indicator .confidence-icon {
            font-size: 14px;
        }

        .field-indicator[data-confidence="high"] .confidence-icon {
            color: #10b981;
        }

        .field-indicator[data-confidence="medium"] .confidence-icon {
            color: #f59e0b;
        }

        .field-indicator[data-confidence="low"] .confidence-icon {
            color: #ef4444;
        }

        .field-indicator .field-value {
            font-size: 14px;
            font-weight: 500;
            color: #2d3748;
            margin-bottom: 3px;
        }

        .field-indicator .field-confidence {
            font-size: 11px;
            color: #718096;
        }

        .low-confidence-warning {
            background: #fff5f5;
            border: 1px solid #feb2b2;
            border-radius: 6px;
            padding: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #c53030;
        }

        .low-confidence-warning i {
            font-size: 16px;
        }

        .preview-actions {
            text-align: center;
            margin-top: 15px;
        }

        .btn-change-receipt {
            background: white;
            border: 1px solid #cbd5e0;
            color: #2d3748;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .btn-change-receipt:hover {
            background: #f7fafc;
            border-color: #3182ce;
            color: #3182ce;
        }

        .btn-change-receipt i {
            margin-left: 5px;
        }

        /* Error State */
        .ocr-error-container {
            background: #fff5f5;
            border: 1px solid #feb2b2;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }

        .error-icon {
            font-size: 48px;
            color: #e53e3e;
            margin-bottom: 15px;
        }

        .ocr-error-container h3 {
            font-size: 16px;
            color: #c53030;
            margin-bottom: 10px;
        }

        .error-message {
            font-size: 14px;
            color: #742a2a;
            margin-bottom: 15px;
        }

        .error-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .btn-retry,
        .btn-cancel {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-retry {
            background: #3182ce;
            border: none;
            color: white;
        }

        .btn-retry:hover {
            background: #2c5aa0;
        }

        .btn-cancel {
            background: white;
            border: 1px solid #cbd5e0;
            color: #2d3748;
        }

        .btn-cancel:hover {
            background: #f7fafc;
        }

        /* Form Field with Confidence */
        .form-field-with-confidence {
            position: relative;
            margin-bottom: 15px;
        }

        .field-confidence-indicator {
            position: absolute;
            top: 50%;
            left: 10px;
            transform: translateY(-50%);
            font-size: 18px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .field-confidence-indicator.visible {
            opacity: 1;
        }

        .field-confidence-indicator.high {
            color: #10b981;
        }

        .field-confidence-indicator.medium {
            color: #f59e0b;
        }

        .field-confidence-indicator.low {
            color: #ef4444;
        }

        .form-field-with-confidence input {
            padding-right: 35px;
        }

        .form-field-with-confidence input.ocr-filled {
            background: #f0fdf4;
            border-color: #10b981;
        }

        .form-field-with-confidence input.ocr-edited {
            background: #fff7ed;
            border-color: #f59e0b;
        }

        /* Pulse animation for low confidence warning */
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        /* Additional styles for confidence badge wrapper */
        .confidence-badge-wrapper {
            pointer-events: auto;
        }

        .confidence-percentage {
            user-select: none;
        }

        /* Contractor Match Indicator Styles */
        .contractor-match-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.875rem;
            margin-top: 4px;
        }

        .contractor-match-high {
            background: #c6f6d5;
            color: #22543d;
            border-left: 4px solid #48bb78;
        }

        .contractor-match-medium {
            background: #feebc8;
            color: #7c2d12;
            border-left: 4px solid #ed8936;
        }

        /* Payment Method Reasoning Styles */
        .payment-method-reasoning {
            display: flex;
            align-items: start;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.875rem;
            margin-top: 4px;
            background: #ebf8ff;
            color: #2c5282;
            border-left: 4px solid #3182ce;
        }

        /* Loading Overlay Styles */
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .loading-content {
            text-align: center;
            max-width: 400px;
            padding: 40px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e5e7eb;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-progress {
            width: 100%;
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
            margin-top: 20px;
            overflow: hidden;
        }

        #loadingProgressBar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <!-- Clerk Auth Container - DISABLED for custom auth pages -->
    <!-- ROLLBACK: Uncomment this section to restore Clerk modal auth -->
    <!--
    <div id="clerkAuthContainer">
        <div class="clerk-loading">
            <h2>מערכת מעקב הוצאות בניה</h2>
            <div class="spinner"></div>
            <p>מאתחל מערכת אבטחה...</p>
        </div>
    </div>
    -->

    <!-- Main Application -->
    <div id="mainContent">
        <div class="header">
            <h1>
                <i class="fas fa-hard-hat"></i>
                מערכת מעקב הוצאות בניה
            </h1>
            <div class="user-info" id="userInfo">
                <div class="user-details">
                    <div class="user-name" id="userName">טוען...</div>
                    <div class="company-name" id="headerCompanyName">טוען...</div>
                </div>
                <div class="user-menu">
                    <button class="btn-user btn-profile" onclick="ClerkAuth.showUserProfile()">
                        <i class="fas fa-user"></i> פרופיל
                    </button>
                    <button class="btn-user btn-signout" onclick="signOut()">
                        <i class="fas fa-sign-out-alt"></i> יציאה
                    </button>
                </div>
                <!-- Mobile User Menu Toggle -->
                <button class="mobile-user-menu-toggle" onclick="toggleMobileUserMenu()">
                    <i class="fas fa-user"></i>
                </button>
                <div class="mobile-user-dropdown" id="mobileUserDropdown">
                    <button onclick="ClerkAuth.showUserProfile(); closeMobileUserMenu();">
                        <i class="fas fa-user"></i> פרופיל
                    </button>
                    <button onclick="signOut()">
                        <i class="fas fa-sign-out-alt"></i> יציאה
                    </button>
                </div>
            </div>
        </div>

        <div class="container">
            <!-- Dashboard Cards -->
            <div class="dashboard-cards">
                <div class="card">
                    <div class="card-title">סה"כ הוצאות</div>
                    <div class="card-value" id="totalExpenses">₪0</div>
                </div>
                <div class="card">
                    <div class="card-title">פרויקטים פעילים</div>
                    <div class="card-value" id="activeProjects">0</div>
                </div>
                <div class="card">
                    <div class="card-title">קבלנים</div>
                    <div class="card-value" id="totalContractors">0</div>
                </div>
                <div class="card">
                    <div class="card-title">הוצאות החודש</div>
                    <div class="card-value" id="monthlyExpenses">₪0</div>
                </div>
            </div>

            <!-- Main Tabs -->
            <div class="tabs">
                <button class="tab-button active" onclick="showTab('expenses')">
                    <i class="fas fa-receipt"></i> הוצאות
                </button>
                <button class="tab-button" onclick="showTab('projects')">
                    <i class="fas fa-project-diagram"></i> פרויקטים
                </button>
                <button class="tab-button" onclick="showTab('contractors')">
                    <i class="fas fa-users"></i> קבלנים
                </button>
                <button class="tab-button" onclick="showTab('works')">
                    <i class="fas fa-hammer"></i> עבודות
                </button>
                <button class="tab-button" onclick="showTab('reports')">
                    <i class="fas fa-chart-bar"></i> דוחות
                </button>
                <button id="billingTabBtn" class="tab-button" onclick="showTab('billing')">
                    <i class="fas fa-credit-card"></i> חיוב ומנוי
                </button>
                <button id="usersTabBtn" class="tab-button" onclick="showTab('users')">
                    <i class="fas fa-user-friends"></i> משתמשים
                </button>
            </div>

            <!-- Mobile Navigation Dropdown -->
            <div class="mobile-nav-dropdown" id="mobileNavDropdown">
                <button class="mobile-nav-trigger" onclick="toggleMobileNav()" id="mobileNavTrigger">
                    <span id="mobileNavLabel"><i class="fas fa-receipt"></i> הוצאות</span>
                    <i class="fas fa-chevron-down"></i>
                </button>
                <div class="mobile-nav-menu" id="mobileNavMenu">
                    <div class="mobile-nav-item active" onclick="selectMobileTab('expenses')">
                        <i class="fas fa-receipt"></i> הוצאות
                    </div>
                    <div class="mobile-nav-item" onclick="selectMobileTab('projects')">
                        <i class="fas fa-project-diagram"></i> פרויקטים
                    </div>
                    <div class="mobile-nav-item" onclick="selectMobileTab('contractors')">
                        <i class="fas fa-users"></i> קבלנים
                    </div>
                    <div class="mobile-nav-item" onclick="selectMobileTab('works')">
                        <i class="fas fa-hammer"></i> עבודות
                    </div>
                    <div class="mobile-nav-item" onclick="selectMobileTab('reports')">
                        <i class="fas fa-chart-bar"></i> דוחות
                    </div>
                    <div class="mobile-nav-item" id="mobileNavBilling" onclick="selectMobileTab('billing')">
                        <i class="fas fa-credit-card"></i> חיוב ומנוי
                    </div>
                    <div class="mobile-nav-item" id="mobileNavUsers" onclick="selectMobileTab('users')">
                        <i class="fas fa-user-friends"></i> משתמשים
                    </div>
                </div>
            </div>

            <!-- Content Area -->
            <div class="content-area">
                <div id="messageArea" class="message"></div>
                <div id="tabContent">
                    <!-- Tab content will be loaded here -->
                    <div class="loading">
                        <i class="fas fa-spinner"></i>
                        <p>טוען נתונים...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Forms -->
    <div id="projectModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('projectModal')">&times;</span>
            <h2>הוסף פרויקט חדש</h2>
            <form id="projectForm" onsubmit="submitProject(event)">
                <input type="text" id="projectName" placeholder="שם פרויקט *" required>
                <textarea id="projectDescription" placeholder="תיאור" rows="3"></textarea>
                <div class="form-group">
                    <label for="projectStartDate">תאריך התחלה *</label>
                    <input type="date" id="projectStartDate" required>
                </div>
                <div class="form-group">
                    <label for="projectEndDate">תאריך סיום</label>
                    <input type="date" id="projectEndDate">
                </div>
                <input type="number" id="projectBudget" placeholder="תקציב" step="0.01">
                <input type="text" id="projectLocation" placeholder="מיקום">
                <input type="text" id="projectClient" placeholder="שם לקוח">
                <button type="submit" class="btn-primary">שמור</button>
                <button type="button" class="btn-secondary" onclick="closeModal('projectModal')">ביטול</button>
            </form>
        </div>
    </div>

    <div id="contractorModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('contractorModal')">&times;</span>
            <h2>הוסף קבלן חדש</h2>
            <form id="contractorForm" onsubmit="submitContractor(event)">
                <input type="text" id="contractorName" placeholder="שם קבלן *" required>
                <input type="tel" id="contractorPhone" placeholder="טלפון">
                <input type="text" id="contractorSpecialty" placeholder="התמחות">
                <button type="submit" class="btn-primary">שמור</button>
                <button type="button" class="btn-secondary" onclick="closeModal('contractorModal')">ביטול</button>
            </form>
        </div>
    </div>

    <div id="workModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('workModal')">&times;</span>
            <h2>הוסף עבודה חדשה</h2>
            <form id="workForm" onsubmit="submitWork(event)">
                <input type="text" id="workName" placeholder="שם עבודה *" required>
                <select id="workProjectId" required>
                    <option value="">בחר פרויקט *</option>
                </select>
                <select id="workContractorId" required>
                    <option value="">בחר קבלן *</option>
                </select>
                <input type="number" id="workCost" placeholder="עלות כוללת *" step="0.01" required>
                <input type="date" id="workStartDate" placeholder="תאריך התחלה">
                <textarea id="workDescription" placeholder="תיאור" rows="3"></textarea>
                <button type="submit" class="btn-primary">שמור</button>
                <button type="button" class="btn-secondary" onclick="closeModal('workModal')">ביטול</button>
            </form>
        </div>
    </div>

    <!-- Expense Modal -->
    <div id="expenseModal" class="modal">
        <div class="modal-content expense-modal-wide">
            <span class="close" onclick="closeModal('expenseModal')">&times;</span>
            <h2 id="expenseModalTitle">הוסף הוצאה חדשה</h2>

            <!-- OCR Upload Step (shown first) -->
            <div id="expense-ocr-container" style="display: block;">
                <!-- OCR component will be rendered here by ReceiptUploadWithOCR.js -->
            </div>

            <!-- Skip button - separate from OCR container so it doesn't get overwritten -->
            <div id="ocr-skip-container" style="text-align: center; margin-top: 24px; padding-top: 16px; border-top: 1px solid #e2e8f0;">
                <button type="button" class="btn-secondary" onclick="skipReceiptUpload()" style="padding: 12px 32px; font-size: 16px;">
                    <i class="fas fa-forward" style="margin-left: 8px;"></i>
                    דלג - המשך ללא קבלה
                </button>
            </div>

            <!-- Expense Form (shown after OCR completes) -->
            <div class="expense-form-layout" id="expense-form-layout" style="display: none;">
                <!-- Left side: Receipt Preview -->
                <div id="expense-receipt-preview" class="expense-receipt-panel">
                    <div class="receipt-upload-area" id="receipt-upload-area">
                        <input type="file" id="expenseReceiptFile" accept="image/*,application/pdf"
                               style="display: none;" onchange="handleReceiptUpload(event)">
                        <div class="receipt-dropzone" id="receipt-dropzone" onclick="document.getElementById('expenseReceiptFile').click()">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 48px; color: #3182ce; margin-bottom: 15px;"></i>
                            <p style="font-size: 16px; color: #2d3748; margin: 0;">לחץ או גרור תמונה לכאן</p>
                            <p style="font-size: 14px; color: #718096; margin-top: 8px;">JPG, PNG, PDF עד 10MB</p>
                        </div>
                    </div>
                    <div class="receipt-image-preview" id="receipt-image-preview" style="display: none;">
                        <img id="receipt-preview-img" src="" alt="תצוגה מקדימה">
                        <button type="button" class="btn-remove-receipt" onclick="removeReceiptPreview()">
                            <i class="fas fa-times"></i> הסר תמונה
                        </button>
                    </div>
                </div>

                <!-- Right side: Expense Form -->
                <div class="expense-form-panel">
                    <form id="expenseForm" onsubmit="submitExpense(event)">
                        <input type="text" id="expenseDescription" placeholder="תיאור *" required>
                        <input type="number" id="expenseAmount" placeholder="סכום *" step="0.01" required oninput="updateVATPreview()">
                        <div id="vatPreview" style="display: none; font-size: 0.85rem; color: #64748b; margin: -8px 0 8px 0; padding: 8px; background: #f8f9fa; border-radius: 4px;">
                            לפני מע״מ: <span id="vatPreviewBase">₪0</span> | מע״מ (18%): <span id="vatPreviewAmount">₪0</span>
                        </div>
                        <input type="date" id="expenseDate" placeholder="תאריך *" required>
                        <input type="text" id="expenseInvoice" placeholder="מספר חשבונית *" required>
                        <select id="expensePayment" required>
                            <option value="">אמצעי תשלום *</option>
                            <option value="מזומן">מזומן</option>
                            <option value="כרטיס אשראי">כרטיס אשראי</option>
                            <option value="העברה בנקאית">העברה בנקאית</option>
                            <option value="צ'ק">צ'ק</option>
                        </select>
                        <select id="expenseWorkId" onchange="onWorkSelected()">
                            <option value="">בחר עבודה (ממלא אוטומטית פרויקט וקבלן)</option>
                        </select>
                        <select id="expenseProjectId">
                            <option value="">הוצאות כלליות (ברירת מחדל)</option>
                        </select>
                        <select id="expenseContractorId">
                            <option value="">בחר קבלן (אופציונלי)</option>
                        </select>

                        <input type="hidden" id="expenseMissingReceipt" value="false">

                        <div class="form-buttons">
                            <button type="submit" class="btn-primary">שמור</button>
                            <button type="button" class="btn-secondary" onclick="closeModal('expenseModal')">ביטול</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Upgrade Modal -->
    <div id="upgradeModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <span class="close" onclick="closeModal('upgradeModal')">&times;</span>
            <div style="text-align: center; margin-bottom: 20px;">
                <div style="font-size: 48px; color: #e53e3e; margin-bottom: 10px;">⚠️</div>
                <h2 id="upgradeLimitMessage" style="color: #2d3748; margin: 0;">הגעת למגבלת התוכנית</h2>
            </div>

            <div id="upgradeUsageInfo" style="background: #f7fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center;">
                <p style="margin: 0; font-size: 16px; color: #4a5568;"></p>
            </div>

            <div style="margin-bottom: 20px;">
                <h3 style="text-align: center; color: #2d3748; margin-bottom: 15px;">שדרג את התוכנית שלך</h3>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <!-- Professional Tier -->
                    <div class="tier-card" data-tier="professional" style="border: 2px solid #3182ce; border-radius: 8px; padding: 20px; background: white; cursor: pointer; transition: all 0.3s;">
                        <h4 style="margin: 0 0 10px 0; color: #3182ce; font-size: 20px;">Professional</h4>
                        <div style="font-size: 32px; font-weight: bold; color: #2d3748; margin-bottom: 10px;">₪100<span style="font-size: 14px; font-weight: normal; color: #718096;">/חודש</span></div>
                        <ul style="list-style: none; padding: 0; margin: 0; text-align: right;">
                            <li style="padding: 5px 0; color: #4a5568;">✓ 3 משתמשים</li>
                            <li style="padding: 5px 0; color: #4a5568;">✓ 10 פרויקטים</li>
                            <li style="padding: 5px 0; color: #4a5568;">✓ הוצאות ללא הגבלה</li>
                            <li style="padding: 5px 0; color: #4a5568;">✓ העלאת קבלות</li>
                        </ul>
                    </div>

                    <!-- Enterprise Tier -->
                    <div class="tier-card" data-tier="enterprise" style="border: 2px solid #805ad5; border-radius: 8px; padding: 20px; background: white; cursor: pointer; transition: all 0.3s;">
                        <h4 style="margin: 0 0 10px 0; color: #805ad5; font-size: 20px;">Enterprise</h4>
                        <div style="font-size: 32px; font-weight: bold; color: #2d3748; margin-bottom: 10px;">₪150<span style="font-size: 14px; font-weight: normal; color: #718096;">/חודש</span></div>
                        <ul style="list-style: none; padding: 0; margin: 0; text-align: right;">
                            <li style="padding: 5px 0; color: #4a5568;">✓ 10 משתמשים</li>
                            <li style="padding: 5px 0; color: #4a5568;">✓ פרויקטים ללא הגבלה</li>
                            <li style="padding: 5px 0; color: #4a5568;">✓ הוצאות ללא הגבלה</li>
                            <li style="padding: 5px 0; color: #4a5568;">✓ תמיכה מועדפת</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div style="text-align: center;">
                <button onclick="viewPricing()" class="btn-primary" style="padding: 12px 30px; font-size: 16px;">צפה בכל התוכניות</button>
                <button onclick="closeModal('upgradeModal')" class="btn-secondary" style="padding: 12px 30px; font-size: 16px; margin-right: 10px;">סגור</button>
            </div>
        </div>
    </div>

    <!-- Invite User Modal -->
    <div id="inviteUserModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('inviteUserModal')">&times;</span>
            <h2>הזמן משתמש חדש</h2>
            <form onsubmit="sendInvitation(event)">
                <label>אימייל *</label>
                <input type="email" id="inviteEmail" required placeholder="user@example.com">
                <label>שם מלא *</label>
                <input type="text" id="inviteName" required placeholder="שם מלא">
                <label>טלפון *</label>
                <input type="tel" id="invitePhone" required placeholder="050-1234567" pattern="[0-9\-]{9,12}">
                <label>תפקיד *</label>
                <select id="inviteRole" required>
                    <option value="">בחר תפקיד</option>
                    <option value="admin">מנהל</option>
                    <option value="editor">עורך</option>
                    <option value="viewer">צופה</option>
                </select>
                <button type="submit" class="btn-primary">שלח הזמנה</button>
                <button type="button" class="btn-secondary" onclick="closeModal('inviteUserModal')">ביטול</button>
            </form>
        </div>
    </div>

    <!-- Onboarding Modal -->
    <div id="onboardingModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 800px;">
            <div style="text-align: center; margin-bottom: 30px;">
                <div style="font-size: 64px; margin-bottom: 15px;">🏗️</div>
                <h2 style="color: #2d3748; margin: 0 0 10px 0;">ברוכים הבאים ל-Builder Expenses!</h2>
                <p style="color: #718096; font-size: 16px;">בואו נגדיר את החברה שלכם ונבחר תוכנית מתאימה</p>
            </div>

            <form id="onboardingForm" onsubmit="submitOnboarding(event)">
                <div style="margin-bottom: 30px;">
                    <label for="companyName" style="display: block; margin-bottom: 8px; font-weight: 500; color: #2d3748;">שם החברה</label>
                    <input
                        type="text"
                        id="companyName"
                        name="companyName"
                        required
                        placeholder="הזן את שם החברה"
                        style="width: 100%; padding: 12px; border: 1px solid #cbd5e0; border-radius: 8px; font-size: 16px;"
                    >
                </div>

                <div style="margin-bottom: 30px;">
                    <label style="display: block; margin-bottom: 15px; font-weight: 500; color: #2d3748; font-size: 18px;">בחר תוכנית</label>

                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                        <!-- Starter Tier -->
                        <div class="tier-card" onclick="selectTier('starter')" data-tier="starter" style="border: 2px solid #cbd5e0; border-radius: 12px; padding: 20px; background: white; cursor: pointer; transition: all 0.3s; position: relative;">
                            <div style="position: absolute; top: 10px; left: 10px; background: #48bb78; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">חודש ניסיון חינם</div>
                            <h4 style="margin: 30px 0 10px 0; color: #48bb78; font-size: 22px; text-align: center;">Starter</h4>
                            <div style="text-align: center; font-size: 36px; font-weight: bold; color: #2d3748; margin-bottom: 15px;">₪50<span style="font-size: 14px; font-weight: normal; color: #718096;">/חודש</span></div>
                            <ul style="list-style: none; padding: 0; margin: 0; text-align: right;">
                                <li style="padding: 8px 0; color: #4a5568; border-bottom: 1px solid #e2e8f0;">✓ משתמש אחד</li>
                                <li style="padding: 8px 0; color: #4a5568; border-bottom: 1px solid #e2e8f0;">✓ 3 פרויקטים</li>
                                <li style="padding: 8px 0; color: #4a5568; border-bottom: 1px solid #e2e8f0;">✓ 50 הוצאות בחודש</li>
                                <li style="padding: 8px 0; color: #4a5568;">✓ קבלנים ועבודות ללא הגבלה</li>
                            </ul>
                            <p style="text-align: center; color: #718096; font-size: 13px; margin-top: 15px;">מושלם לעסקים קטנים</p>
                        </div>

                        <!-- Professional Tier -->
                        <div class="tier-card" onclick="selectTier('professional')" data-tier="professional" style="border: 2px solid #cbd5e0; border-radius: 12px; padding: 20px; background: white; cursor: pointer; transition: all 0.3s; position: relative;">
                            <div style="position: absolute; top: 10px; left: 10px; background: #3182ce; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">מומלץ + חודש ניסיון</div>
                            <h4 style="margin: 30px 0 10px 0; color: #3182ce; font-size: 22px; text-align: center;">Professional</h4>
                            <div style="text-align: center; font-size: 36px; font-weight: bold; color: #2d3748; margin-bottom: 15px;">₪100<span style="font-size: 14px; font-weight: normal; color: #718096;">/חודש</span></div>
                            <ul style="list-style: none; padding: 0; margin: 0; text-align: right;">
                                <li style="padding: 8px 0; color: #4a5568; border-bottom: 1px solid #e2e8f0;">✓ 3 משתמשים</li>
                                <li style="padding: 8px 0; color: #4a5568; border-bottom: 1px solid #e2e8f0;">✓ 10 פרויקטים</li>
                                <li style="padding: 8px 0; color: #4a5568; border-bottom: 1px solid #e2e8f0;">✓ הוצאות ללא הגבלה</li>
                                <li style="padding: 8px 0; color: #4a5568;">✓ העלאת קבלות</li>
                            </ul>
                            <p style="text-align: center; color: #718096; font-size: 13px; margin-top: 15px;">לעסקים קטנים ובינוניים</p>
                        </div>

                        <!-- Enterprise Tier -->
                        <div class="tier-card" onclick="selectTier('enterprise')" data-tier="enterprise" style="border: 2px solid #cbd5e0; border-radius: 12px; padding: 20px; background: white; cursor: pointer; transition: all 0.3s; position: relative;">
                            <div style="position: absolute; top: 10px; left: 10px; background: #805ad5; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">חודש ניסיון חינם</div>
                            <h4 style="margin: 30px 0 10px 0; color: #805ad5; font-size: 22px; text-align: center;">Enterprise</h4>
                            <div style="text-align: center; font-size: 36px; font-weight: bold; color: #2d3748; margin-bottom: 15px;">₪150<span style="font-size: 14px; font-weight: normal; color: #718096;">/חודש</span></div>
                            <ul style="list-style: none; padding: 0; margin: 0; text-align: right;">
                                <li style="padding: 8px 0; color: #4a5568; border-bottom: 1px solid #e2e8f0;">✓ 10 משתמשים</li>
                                <li style="padding: 8px 0; color: #4a5568; border-bottom: 1px solid #e2e8f0;">✓ פרויקטים ללא הגבלה</li>
                                <li style="padding: 8px 0; color: #4a5568; border-bottom: 1px solid #e2e8f0;">✓ הוצאות ללא הגבלה</li>
                                <li style="padding: 8px 0; color: #4a5568;">✓ תמיכה מועדפת</li>
                            </ul>
                            <p style="text-align: center; color: #718096; font-size: 13px; margin-top: 15px;">לעסקים גדולים</p>
                        </div>
                    </div>

                    <input type="hidden" id="selectedTier" name="subscriptionTier">
                    <p id="tierError" style="color: #e53e3e; margin-top: 10px; display: none; text-align: center;">אנא בחר תוכנית</p>
                </div>

                <div style="text-align: center; padding-top: 20px; border-top: 1px solid #e2e8f0;">
                    <button type="submit" class="btn-primary" style="padding: 14px 40px; font-size: 18px; font-weight: 600;">
                        התחל עכשיו
                    </button>
                    <p style="color: #718096; font-size: 13px; margin-top: 15px;">נדרש אימות כרטיס אשראי • ללא חיוב ל-30 יום</p>
                </div>
            </form>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" style="display: none;">
        <div class="loading-content">
            <div class="spinner"></div>
            <h2 id="loadingTitle">טוען את החברה שלך...</h2>
            <p id="loadingMessage">אנא המתן, זה לוקח רק כמה שניות</p>
            <div class="loading-progress">
                <div id="loadingProgressBar"></div>
            </div>
        </div>
    </div>

    <!-- Invitation Choice Modal - Professional Design -->
    <div id="invitationChoiceModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 520px; padding: 0; overflow: hidden; border-radius: 16px;">
            <!-- Header Section -->
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px 25px; text-align: center;">
                <div style="width: 56px; height: 56px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px;">
                    <i class="fas fa-user-plus" style="font-size: 24px; color: white;"></i>
                </div>
                <h2 style="color: white; margin: 0 0 8px 0; font-size: 22px; font-weight: 600;">הוזמנת להצטרף!</h2>
                <p style="color: rgba(255,255,255,0.85); font-size: 15px; margin: 0;">בחר לאיזו חברה תרצה להצטרף</p>
            </div>

            <!-- Invitations List -->
            <div style="padding: 24px;">
                <div id="invitationsList" style="max-height: 300px; overflow-y: auto;"></div>

                <!-- Divider -->
                <div style="display: flex; align-items: center; margin: 24px 0 20px; gap: 12px;">
                    <div style="flex: 1; height: 1px; background: #e2e8f0;"></div>
                    <span style="color: #a0aec0; font-size: 13px;">או</span>
                    <div style="flex: 1; height: 1px; background: #e2e8f0;"></div>
                </div>

                <!-- Create New Company Option -->
                <button onclick="skipInvitationsAndCreateCompany()" style="width: 100%; padding: 14px 20px; background: white; border: 2px dashed #cbd5e0; border-radius: 10px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 10px; color: #4a5568; font-size: 15px; font-weight: 500;">
                    <i class="fas fa-building" style="color: #718096;"></i>
                    הקם חברה חדשה
                </button>
            </div>
        </div>
    </div>

    <!-- Export Format Selection Popup -->
    <div id="exportModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px; text-align: center;">
            <span class="close" onclick="closeExportPopup()">&times;</span>
            <h2 style="margin-bottom: 30px; border-bottom: none;">
                <i class="fas fa-file-export" style="color: #667eea; margin-left: 10px;"></i>
                ייצוא דוח הוצאות
            </h2>

            <p style="color: #718096; margin-bottom: 30px; font-size: 15px;">
                בחר את הפורמט הרצוי לייצוא הדוח
            </p>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                <!-- PDF Option -->
                <div class="export-option" onclick="exportToPDF()" style="border: 2px solid #e2e8f0; border-radius: 12px; padding: 25px 15px; cursor: pointer; transition: all 0.3s; background: #fafafa;">
                    <div style="font-size: 48px; margin-bottom: 15px; color: #dc2626;">
                        <i class="fas fa-file-pdf"></i>
                    </div>
                    <h3 style="font-size: 18px; color: #2d3748; margin-bottom: 8px;">PDF</h3>
                    <p style="font-size: 13px; color: #718096; line-height: 1.5;">
                        דוח מעוצב עם פירוט<br>מלא וסיכומים
                    </p>
                </div>

                <!-- Excel Option -->
                <div class="export-option" onclick="exportToExcel()" style="border: 2px solid #e2e8f0; border-radius: 12px; padding: 25px 15px; cursor: pointer; transition: all 0.3s; background: #fafafa;">
                    <div style="font-size: 48px; margin-bottom: 15px; color: #217346;">
                        <i class="fas fa-file-excel"></i>
                    </div>
                    <h3 style="font-size: 18px; color: #2d3748; margin-bottom: 8px;">Excel</h3>
                    <p style="font-size: 13px; color: #718096; line-height: 1.5;">
                        גיליונות נפרדים לכל<br>פירוט ונתונים
                    </p>
                </div>
            </div>

            <p style="font-size: 12px; color: #a0aec0;">
                <i class="fas fa-info-circle" style="margin-left: 5px;"></i>
                הדוח יכלול את כל ההוצאות המסוננות כרגע
            </p>
        </div>
    </div>

    <style>
        /* Export Popup Styles */
        .export-option:hover {
            border-color: #667eea !important;
            background: #ffffff !important;
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }

        .export-option:active {
            transform: translateY(-1px);
        }
    </style>

    <!-- Session Timeout Warning Modal Styles -->
    <style>
        /* Session Timeout Warning Modal */
        .session-timeout-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 99999;
            animation: fadeIn 0.3s ease;
        }

        .session-timeout-overlay.show {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .session-timeout-modal {
            background: white;
            border-radius: 16px;
            padding: 40px;
            max-width: 420px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .session-timeout-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #f6ad55, #ed8936);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
        }

        .session-timeout-icon i {
            font-size: 36px;
            color: white;
        }

        .session-timeout-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 12px;
        }

        .session-timeout-message {
            color: #4a5568;
            margin-bottom: 24px;
            line-height: 1.6;
        }

        .session-timeout-countdown {
            font-size: 2.5rem;
            font-weight: 700;
            color: #e53e3e;
            margin-bottom: 24px;
        }

        .session-timeout-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .session-timeout-btn {
            padding: 12px 28px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .session-timeout-btn-continue {
            background: linear-gradient(135deg, #38a169, #2f855a);
            color: white;
        }

        .session-timeout-btn-continue:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(56, 161, 105, 0.4);
        }

        .session-timeout-btn-logout {
            background: #e2e8f0;
            color: #4a5568;
        }

        .session-timeout-btn-logout:hover {
            background: #cbd5e0;
        }

        /* Activity indicator (subtle) */
        .session-activity-indicator {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            display: none;
            z-index: 9998;
        }
    </style>

    <!-- Clerk Configuration -->
    <script>
        // Clerk Configuration
        window.CLERK_PUBLISHABLE_KEY = 'pk_live_Y2xlcmsuYnVpbGRlci1leHBlbnNlcy5jb20k';
        window.CLERK_FRONTEND_API = 'https://Builder-expenses.clerk.accounts.dev';

        // API Configuration
        const API_CONFIG = {
            endpoint: 'https://2woj5i92td.execute-api.us-east-1.amazonaws.com/prod'
        };

        // Set global API_BASE_URL for use throughout the app
        window.API_BASE_URL = API_CONFIG.endpoint;

        // Application State
        let currentUser = null;
        let currentOrganization = null;
        let currentCompany = null;
        let authToken = null;
        let currentTab = 'expenses'; // Track current active tab
        let appData = {
            expenses: [],
            projects: [],
            contractors: [],
            works: []
        };
    </script>

    <!-- Clerk Authentication Module -->
    <script src="clerk-auth.js"></script>

    <!-- OCR Component and Utilities - Smart Invoice OCR with Claude 3.5 -->
    <script src="utils/ocrApi.js"></script>
    <script src="components/OcrFieldIndicator.js"></script>
    <script src="components/ReceiptUploadWithOCR.js"></script>

    <!-- Main Application Script -->
    <script>
        // ============================================
        // PERFORMANCE UTILITIES
        // ============================================

        /**
         * Debounce utility - delays function execution until after wait milliseconds
         * have elapsed since the last time the debounced function was invoked.
         * @param {Function} fn - The function to debounce
         * @param {number} delay - The delay in milliseconds
         * @returns {Function} - The debounced function
         */
        function debounce(fn, delay) {
            let timeoutId;
            return function(...args) {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => fn.apply(this, args), delay);
            };
        }

        // Create debounced version of filterExpenses for search input (300ms delay)
        const debouncedFilterExpenses = debounce(() => {
            if (typeof window.filterExpenses === 'function') {
                window.filterExpenses();
            }
        }, 300);
        // Make it globally accessible for HTML oninput attribute
        window.debouncedFilterExpenses = debouncedFilterExpenses;

        /**
         * Load a script dynamically with integrity check
         * @param {string} src - Script URL
         * @param {string} integrity - SRI hash (optional)
         * @returns {Promise} - Resolves when script is loaded
         */
        function loadScript(src, integrity = null) {
            return new Promise((resolve, reject) => {
                // Check if already loaded
                if (document.querySelector(`script[src="${src}"]`)) {
                    resolve();
                    return;
                }

                const script = document.createElement('script');
                script.src = src;
                script.crossOrigin = 'anonymous';
                if (integrity) {
                    script.integrity = integrity;
                }
                script.onload = resolve;
                script.onerror = () => reject(new Error(`Failed to load script: ${src}`));
                document.head.appendChild(script);
            });
        }

        // Library loading state
        let exportLibrariesLoaded = false;
        let chartLibraryLoaded = false;

        /**
         * Lazy load Chart.js library (for reports tab)
         * @returns {Promise}
         */
        async function loadChartLibrary() {
            if (chartLibraryLoaded || typeof Chart !== 'undefined') {
                return;
            }
            console.log('[Performance] Loading Chart.js on demand...');
            await loadScript(
                'https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js',
                'sha384-e6nUZLBkQ86NJ6TVVKAeSaK8jWa3NhkYWZFomE39AvDbQWeie9PlQqM3pmYW5d1g'
            );
            chartLibraryLoaded = true;
            console.log('[Performance] Chart.js loaded successfully');
        }

        /**
         * Lazy load export libraries (PDF/Excel) - ~420KB saved on initial load
         * @returns {Promise}
         */
        async function loadExportLibraries() {
            if (exportLibrariesLoaded) {
                return;
            }
            console.log('[Performance] Loading export libraries on demand...');

            // Load all export libraries in parallel
            await Promise.all([
                loadScript(
                    'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js',
                    'sha384-ZZ1pncU3bQe8y31yfZdMFdSpttDoPmOZg2wguVK9almUodir1PghgT0eY7Mrty8H'
                ),
                loadScript(
                    'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js',
                    'sha384-JcnsjUPPylna1s1fvi1u12X5qjY5OL56iySh75FdtrwhO/SWXgMjoVqcKyIIWOLk'
                ),
                loadScript(
                    'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js',
                    'sha384-Yv5O+t3uE3hunW8uyrbpPW3iw6/5/Y7HitWJBLgqfMoA36NogMmy+8wWZMpn3HWc'
                ),
                loadScript(
                    'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js',
                    'sha384-vtjasyidUo0kW94K5MXDXntzOJpQgBKXmE7e2Ga4LG0skTTLeBi97eFAXsqewJjw'
                )
            ]);

            exportLibrariesLoaded = true;
            console.log('[Performance] Export libraries loaded successfully');
        }

        // Make lazy loading functions globally accessible
        window.loadExportLibraries = loadExportLibraries;
        window.loadChartLibrary = loadChartLibrary;

        // ============================================
        // EXPENSE LOOKUP MAPS (Performance Optimization)
        // ============================================

        // Pre-computed maps for O(1) expense lookups instead of O(n) filters
        let expensesByProject = new Map();
        let expensesByContractor = new Map();
        let expensesByWork = new Map();

        /**
         * Build expense lookup maps for fast access
         * Call this after expenses data is loaded or modified
         * Converts O(n) filter operations to O(1) map lookups
         */
        function buildExpenseMaps() {
            console.log('[Performance] Building expense lookup maps...');

            // Clear existing maps
            expensesByProject.clear();
            expensesByContractor.clear();
            expensesByWork.clear();

            // Build maps in single pass through expenses
            if (appData && appData.expenses) {
                appData.expenses.forEach(expense => {
                    // Map by projectId
                    if (expense.projectId) {
                        if (!expensesByProject.has(expense.projectId)) {
                            expensesByProject.set(expense.projectId, []);
                        }
                        expensesByProject.get(expense.projectId).push(expense);
                    }

                    // Map by contractorId
                    if (expense.contractorId) {
                        if (!expensesByContractor.has(expense.contractorId)) {
                            expensesByContractor.set(expense.contractorId, []);
                        }
                        expensesByContractor.get(expense.contractorId).push(expense);
                    }

                    // Map by workId
                    if (expense.workId) {
                        if (!expensesByWork.has(expense.workId)) {
                            expensesByWork.set(expense.workId, []);
                        }
                        expensesByWork.get(expense.workId).push(expense);
                    }
                });
            }

            console.log(`[Performance] Expense maps built: ${expensesByProject.size} projects, ${expensesByContractor.size} contractors, ${expensesByWork.size} works`);
        }

        /**
         * Get expenses for a specific project (O(1) lookup)
         * @param {string} projectId - The project ID
         * @returns {Array} - Array of expenses for this project
         */
        function getExpensesByProject(projectId) {
            return expensesByProject.get(projectId) || [];
        }

        /**
         * Get expenses for a specific contractor (O(1) lookup)
         * @param {string} contractorId - The contractor ID
         * @returns {Array} - Array of expenses for this contractor
         */
        function getExpensesByContractor(contractorId) {
            return expensesByContractor.get(contractorId) || [];
        }

        /**
         * Get expenses for a specific work (O(1) lookup)
         * @param {string} workId - The work ID
         * @returns {Array} - Array of expenses for this work
         */
        function getExpensesByWork(workId) {
            return expensesByWork.get(workId) || [];
        }

        // Make lookup functions globally accessible
        window.buildExpenseMaps = buildExpenseMaps;
        window.getExpensesByProject = getExpensesByProject;
        window.getExpensesByContractor = getExpensesByContractor;
        window.getExpensesByWork = getExpensesByWork;

        // ============================================
        // APPLICATION STATE
        // ============================================

        // Pending invitation token (from URL parameter)
        let pendingInvitationToken = null;
        let pendingInvitationData = null;

        // Initialize Clerk when page loads
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Check for invitation token in URL before anything else
                const urlParams = new URLSearchParams(window.location.search);
                pendingInvitationToken = urlParams.get('invitation');

                if (pendingInvitationToken) {
                    console.log('[INVITATION] Found invitation token in URL:', pendingInvitationToken);
                    // Validate the invitation token
                    await validatePendingInvitation(pendingInvitationToken);
                }

                // Initialize Clerk
                await ClerkAuth.initialize();

                // Initialize Paddle (MUST be called once at page load)
                console.log('Initializing Paddle at page load');
                // Set Paddle environment to production BEFORE Initialize
                Paddle.Environment.set("production");
                Paddle.Initialize({
                    token: 'live_78cd18afea0fe24f7d9440d3f14',
                    eventCallback: function(data) {
                        if (data.name === "checkout.completed") {
                            console.log('Paddle checkout completed!', data);
                            // Handle successful payment
                            handleCheckoutSuccess(data);
                        }
                    }
                });
                window.paddleInitialized = true;

                // Check if user is authenticated after Clerk initialization
                console.log('Clerk and Paddle initialized, checking auth status...');

                // If user is not authenticated, show sign-in UI immediately
                if (!ClerkAuth.isAuthenticated()) {
                    console.log('No authenticated user, showing sign-in UI');
                    showClerkAuth();
                }
                // Otherwise, onUserAuthenticated callback will be triggered automatically

                // Initialize drag-drop for receipt upload
                setupReceiptDragDrop();

            } catch (error) {
                console.error('Failed to initialize Clerk:', error);
                showError('Failed to initialize authentication system');
            }
        });

        // Validate invitation token before user signs in
        async function validatePendingInvitation(token) {
            try {
                const response = await fetch(`${window.API_BASE_URL}/acceptInvitation?token=${encodeURIComponent(token)}`);
                const data = await response.json();

                if (data.success && data.data?.invitation) {
                    pendingInvitationData = data.data.invitation;
                    console.log('[INVITATION] Valid invitation:', pendingInvitationData);
                } else {
                    console.error('[INVITATION] Invalid invitation:', data.message);
                    pendingInvitationToken = null;
                    showError(data.message || 'ההזמנה אינה תקפה או שפג תוקפה');
                }
            } catch (error) {
                console.error('[INVITATION] Error validating invitation:', error);
                pendingInvitationToken = null;
                showError('שגיאה באימות ההזמנה');
            }
        }

        // Process pending invitation after user is authenticated
        async function processPendingInvitation() {
            if (!pendingInvitationToken || !pendingInvitationData) {
                return false;
            }

            console.log('[INVITATION] Processing pending invitation...');

            try {
                const response = await fetch(`${window.API_BASE_URL}/acceptInvitation`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${await ClerkAuth.getAuthToken()}`
                    },
                    body: JSON.stringify({
                        token: pendingInvitationToken,
                        name: pendingInvitationData.name || '',
                        phone: ''
                    })
                });

                const data = await response.json();

                if (data.success) {
                    console.log('[INVITATION] Invitation accepted successfully!', data);
                    showSuccess(`הצטרפת בהצלחה לחברת ${data.data.company.name}!`);

                    // Clear URL parameters
                    window.history.replaceState({}, document.title, window.location.pathname);

                    // Clear pending invitation
                    pendingInvitationToken = null;
                    pendingInvitationData = null;

                    // Reload to get new company context
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);

                    return true;
                } else {
                    throw new Error(data.message || 'שגיאה בקבלת ההזמנה');
                }
            } catch (error) {
                console.error('[INVITATION] Error accepting invitation:', error);
                showError(error.message || 'שגיאה בקבלת ההזמנה');
                pendingInvitationToken = null;
                pendingInvitationData = null;
                return false;
            }
        }

        // Set up authentication callback
        window.onUserAuthenticated = async (user) => {
            console.log('User authenticated:', user);
            currentUser = user;

            // Check if there's a pending invitation to process
            if (pendingInvitationToken && pendingInvitationData) {
                console.log('[INVITATION] User authenticated, processing pending invitation...');
                const accepted = await processPendingInvitation();
                if (accepted) {
                    // processPendingInvitation will reload the page
                    return;
                }
            }

            await initializeApp();
        };

        window.onUserSignedOut = () => {
            console.log('User signed out');
            currentUser = null;
            currentOrganization = null;
            authToken = null;
            showClerkAuth();
        };

        // Show Clerk Authentication - REPLACED with redirect to custom login page
        async function showClerkAuth() {
            // ROLLBACK: Uncomment these lines to restore Clerk modal auth
            /*
            document.getElementById('clerkAuthContainer').style.display = 'flex';
            document.getElementById('mainContent').style.display = 'none';

            // Update loading message
            const loadingDiv = document.querySelector('.clerk-loading');
            */

            // NEW: Redirect to custom login page
            const currentPath = window.location.pathname + window.location.search;
            const redirectUrl = encodeURIComponent(currentPath);
            window.location.href = `login.html?redirect=${redirectUrl}`;
            return;

            // The code below is kept for rollback purposes (will not execute)
            const loadingDiv = document.querySelector('.clerk-loading');

            // Check if there's a pending invitation
            if (pendingInvitationData) {
                loadingDiv.innerHTML = `
                    <h2>הזמנה להצטרף לחברה</h2>
                    <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px; margin: 20px 0; max-width: 400px;">
                        <p style="color: white; font-size: 1.1em; margin-bottom: 15px;">
                            הוזמנת להצטרף לחברת <strong>${pendingInvitationData.companyName}</strong>
                        </p>
                        <p style="color: #ccc; margin-bottom: 10px;">
                            <i class="fas fa-envelope"></i> ${pendingInvitationData.email}
                        </p>
                        <p style="color: #ccc; margin-bottom: 15px;">
                            <i class="fas fa-user-tag"></i> תפקיד: ${pendingInvitationData.role === 'admin' ? 'מנהל' : pendingInvitationData.role === 'editor' ? 'עורך' : 'צופה'}
                        </p>
                        ${pendingInvitationData.personalMessage ? `
                            <p style="color: #eee; font-style: italic; margin-bottom: 15px;">
                                "${pendingInvitationData.personalMessage}"
                            </p>
                        ` : ''}
                    </div>
                    <p style="color: white; margin-bottom: 20px;">כדי לקבל את ההזמנה, אנא התחבר או צור חשבון:</p>
                    <div style="margin: 30px 0;">
                        <button class="btn-primary" onclick="ClerkAuth.showSignIn()" style="margin: 10px;">
                            <i class="fas fa-sign-in-alt"></i> התחברות
                        </button>
                        <button class="btn-primary" onclick="ClerkAuth.showSignUp()" style="margin: 10px;">
                            <i class="fas fa-user-plus"></i> הרשמה חדשה
                        </button>
                    </div>
                `;
            } else {
                loadingDiv.innerHTML = `
                    <h2>מערכת מעקב הוצאות בניה</h2>
                    <div style="margin: 30px 0;">
                        <button class="btn-primary" onclick="ClerkAuth.showSignIn()" style="margin: 10px;">
                            <i class="fas fa-sign-in-alt"></i> התחברות
                        </button>
                        <button class="btn-primary" onclick="ClerkAuth.showSignUp()" style="margin: 10px;">
                            <i class="fas fa-user-plus"></i> הרשמה
                        </button>
                    </div>
                    <p style="color: white; margin-top: 20px;">מערכת מאובטחת עם Clerk Authentication</p>
                `;
            }
        }

        // Handle successful Paddle checkout (called by eventCallback)
        async function handleCheckoutSuccess(data) {
            console.log('Paddle checkout.completed event received:', data);

            try {
                // Get company details from sessionStorage
                const companyName = sessionStorage.getItem('paddle_company_name');
                const subscriptionTier = sessionStorage.getItem('paddle_tier');

                if (!companyName || !subscriptionTier) {
                    // This checkout.completed event is for an UPGRADE (or downgrade), not new registration
                    console.log('[CHECKOUT] No sessionStorage - this is an upgrade/tier change for existing customer');

                    // Check if user is logged in
                    if (currentUser && appData.company) {
                        console.log('[CHECKOUT] User is logged in. Refreshing company data after upgrade...');

                        const oldTier = appData.company.subscriptionTier;
                        console.log('[CHECKOUT] Current tier before webhook:', oldTier);

                        showSuccess('התשלום הושלם בהצלחה! מחכה לאישור מהשרת...');

                        // Poll for tier update (webhook processing can take 5-15 seconds)
                        let tierUpdated = false;
                        const maxRetries = 15; // 15 attempts = up to 15 seconds

                        for (let i = 0; i < maxRetries; i++) {
                            console.log(`[CHECKOUT] Polling attempt ${i + 1}/${maxRetries}`);

                            // Wait 1 second before each check
                            await new Promise(resolve => setTimeout(resolve, 1000));

                            // Reload company data
                            await loadAppData();

                            // Check if tier changed
                            const newTier = appData.company?.subscriptionTier;
                            console.log(`[CHECKOUT] Tier check: ${oldTier} -> ${newTier}`);

                            if (newTier && newTier !== oldTier) {
                                tierUpdated = true;
                                console.log('[CHECKOUT] ✅ Tier updated successfully!');
                                break;
                            }
                        }

                        if (tierUpdated) {
                            console.log('[CHECKOUT] Final tier:', appData.company?.subscriptionTier);

                            // Refresh the billing tab if we're on it AND the container exists
                            const appContainer = document.getElementById('app');
                            if (currentTab === 'billing' && appContainer) {
                                console.log('[CHECKOUT] Refreshing billing tab...');
                                showBillingTab(appContainer);
                            } else {
                                console.log('[CHECKOUT] Not on billing tab. User will see updated tier when they navigate to billing.');
                            }

                            showSuccess('המנוי עודכן בהצלחה!');
                        } else {
                            console.warn('[CHECKOUT] Timeout waiting for tier update. Webhook may still be processing.');
                            showSuccess('התשלום התקבל! המנוי מתעדכן ברקע. רענן את הדף תוך מספר שניות.');
                        }
                    } else {
                        console.log('[CHECKOUT] User not logged in or no company - ignoring checkout event');
                    }

                    return;
                }

                console.log(`Creating company: ${companyName} with tier: ${subscriptionTier}`);

                // Show loading message
                showSuccess(`מעבד רישום חברה... אנא המתן`);

                // Call register-company-clerk API to create the company
                const response = await apiCall('/register-company-clerk', 'POST', {
                    companyName: companyName,
                    subscriptionTier: subscriptionTier.toLowerCase()
                });

                if (response.success) {
                    console.log('Company registered successfully!', response);

                    // Clear sessionStorage
                    sessionStorage.removeItem('paddle_checkout_in_progress');
                    sessionStorage.removeItem('paddle_company_name');
                    sessionStorage.removeItem('paddle_tier');
                    sessionStorage.removeItem('skip_invitation_check');

                    // Close the onboarding modal
                    document.getElementById('onboardingModal').style.display = 'none';

                    // Show success message
                    showSuccess(`ברוך הבא! החברה "${companyName}" נוצרה בהצלחה! תקופת ניסיון של 30 יום החלה.`);

                    // Reload the app to initialize with the new company
                    setTimeout(() => {
                        location.reload();
                    }, 1500);

                } else {
                    throw new Error(response.message || 'Failed to register company');
                }

            } catch (error) {
                console.error('Error in handleCheckoutSuccess:', error);
                showError('שגיאה ברישום החברה. אנא פנה לתמיכה.');
            }
        }

        /**
         * Load company with intelligent retry logic
         * - Post-checkout: 30 attempts × 2s = 60 seconds (webhook processing time)
         * - Regular sign-in: 5 attempts × 1s = 5 seconds (handle slow API responses)
         */
        async function loadCompanyWithRetry() {
            const isFromCheckout = sessionStorage.getItem('from_checkout_success') === 'true';
            const maxAttempts = isFromCheckout ? 30 : 5;
            const retryDelay = isFromCheckout ? 2000 : 1000;

            console.log(`[LOAD] Starting company load with retry (isFromCheckout: ${isFromCheckout}, max attempts: ${maxAttempts})`);

            // Show loading overlay
            const loadingOverlay = document.getElementById('loadingOverlay');
            const loadingTitle = document.getElementById('loadingTitle');
            const loadingMessage = document.getElementById('loadingMessage');
            const progressBar = document.getElementById('loadingProgressBar');

            loadingOverlay.style.display = 'flex';

            if (isFromCheckout) {
                loadingTitle.textContent = 'מעבד את המנוי שלך...';
                loadingMessage.textContent = 'יוצר את החברה שלך, רק עוד רגע...';
            }

            for (let attempt = 1; attempt <= maxAttempts; attempt++) {
                try {
                    console.log(`[LOAD] Attempt ${attempt}/${maxAttempts} to load company`);

                    // Update progress bar
                    const progress = (attempt / maxAttempts) * 100;
                    progressBar.style.width = `${progress}%`;

                    const companyResp = await apiCall('/get-company');

                    if (companyResp.companyExists) {
                        console.log('[LOAD] Company found!');

                        // Store company data
                        window.company = companyResp.company;
                        window.currentUser = companyResp.currentUser;

                        // Clear checkout flags
                        sessionStorage.removeItem('from_checkout_success');
                        sessionStorage.removeItem('paddle_checkout_in_progress');

                        // Hide loading overlay
                        loadingOverlay.style.display = 'none';

                        // Initialize app with company data
                        await finalizeAppInitialization();
                        return true;
                    }

                    // Company not found yet - retry if we have attempts left
                    if (attempt < maxAttempts) {
                        console.log(`[LOAD] Company not found, retrying in ${retryDelay}ms...`);
                        await new Promise(resolve => setTimeout(resolve, retryDelay));
                    }

                } catch (error) {
                    console.error(`[LOAD] Error on attempt ${attempt}:`, error);

                    // Don't retry on auth errors
                    if (error.message?.includes('unauthorized') || error.message?.includes('authentication')) {
                        loadingOverlay.style.display = 'none';
                        throw error;
                    }

                    // Retry on other errors
                    if (attempt < maxAttempts) {
                        await new Promise(resolve => setTimeout(resolve, retryDelay));
                    }
                }
            }

            // All retries exhausted - proceed to onboarding/invitation flow
            console.log('[LOAD] Company not found after all retries, checking for invitations...');
            loadingOverlay.style.display = 'none';

            // Clear checkout flags
            sessionStorage.removeItem('from_checkout_success');

            // Handle as new user (check invitations or show onboarding)
            await handleNewUserFlow();
            return false;
        }

        /**
         * Finalize app initialization after company is loaded
         */
        async function finalizeAppInitialization() {
            console.log('[INIT] Finalizing app initialization with company data');

            // Load additional data
            await loadExpenses();
            await loadProjects();
            await loadContractors();
            await loadWorks();
            await loadUsers();
            await loadInvitations();

            // Show dashboard
            showTab('expenses');

            // Start usage polling
            startUsagePolling();
        }

        /**
         * Handle new user flow - check invitations or show onboarding
         */
        async function handleNewUserFlow() {
            console.log('[ONBOARDING] No company found - checking for pending invitations');

            try {
                const invitationsResp = await apiCall('/check-pending-invitations');

                if (invitationsResp.hasPendingInvitations) {
                    console.log('[ONBOARDING] User has pending invitations');
                    showInvitationChoiceModal(invitationsResp.invitations);
                } else {
                    console.log('[ONBOARDING] No invitations - showing onboarding modal');
                    showOnboardingModal();
                }
            } catch (error) {
                console.error('[ONBOARDING] Error checking invitations:', error);
                showOnboardingModal();
            }
        }

        // Initialize Application
        async function initializeApp() {
            console.log('[INIT] Initializing app...');

            try {
                // Check if user is authenticated via window.currentUser (set by clerk-auth.js)
                // Note: window.currentUser is set by handleClerkUpdate() callback and is more reliable than window.Clerk.user
                const user = window.currentUser;
                if (!user) {
                    console.log('[INIT] No authenticated user - redirecting to login');
                    // ROLLBACK: Uncomment these lines to restore Clerk modal auth
                    /*
                    document.getElementById('clerkAuthContainer').style.display = 'block';
                    document.getElementById('mainContent').style.display = 'none';
                    */
                    // NEW: Redirect to custom login page
                    const currentPath = window.location.pathname + window.location.search;
                    const redirectUrl = encodeURIComponent(currentPath);
                    window.location.href = `login.html?redirect=${redirectUrl}`;
                    return;
                }

                console.log('[INIT] User authenticated:', user.id);

                // Get session token for API calls
                const token = await window.Clerk.session.getToken();
                window.authToken = token;

                // Show main app (auth container is now disabled)
                // ROLLBACK: Uncomment these lines to restore Clerk modal auth
                /*
                document.getElementById('clerkAuthContainer').style.display = 'none';
                */
                document.getElementById('mainContent').style.display = 'block';

                // Use intelligent retry logic to load company
                await loadCompanyWithRetry();

                // Initialize session timeout manager (15 min idle timeout)
                if (typeof SessionTimeout !== 'undefined') {
                    SessionTimeout.init();
                }

            } catch (error) {
                console.error('[INIT] Error initializing app:', error);
                showError('שגיאה באתחול האפליקציה: ' + error.message);
                // ROLLBACK: Uncomment these lines to restore Clerk modal auth
                /*
                document.getElementById('clerkAuthContainer').style.display = 'block';
                document.getElementById('mainContent').style.display = 'none';
                */
                // NEW: Redirect to login on error
                const currentPath = window.location.pathname + window.location.search;
                const redirectUrl = encodeURIComponent(currentPath);
                window.location.href = `login.html?redirect=${redirectUrl}`;
            }
        }

        // Load Application Data
        async function loadAppData(skipCompanyCheck = false) {
            try {
                // Check if company exists and load company data
                const companyResp = await apiCall('/get-company');

                // If company doesn't exist, check for pending invitations first
                if (!companyResp.companyExists) {
                    console.log('[ONBOARDING] No company found - checking for pending invitations');

                    // If user already has a company membership elsewhere, skip invitation modal
                    // (This can happen if they're a member of another company but not an admin)
                    if (companyResp.userHasCompanyMembership) {
                        console.log('[ONBOARDING] User already has company membership - skipping invitation check');
                        showOnboardingModal();
                        return;
                    }

                    // Check if user explicitly chose to skip invitations and create new company
                    const skipInvitationCheck = sessionStorage.getItem('skip_invitation_check') === 'true';

                    if (skipInvitationCheck) {
                        console.log('[ONBOARDING] User chose to create new company - skipping invitation check');
                        showOnboardingModal();
                        return;
                    }

                    // Get user email for invitation check
                    const userEmail = window.currentUser?.email || window.currentUser?.primaryEmailAddress?.emailAddress;
                    if (userEmail) {
                        const pendingInvitations = await checkPendingInvitationsByEmail(userEmail);
                        if (pendingInvitations && pendingInvitations.length > 0) {
                            console.log('[ONBOARDING] Found pending invitations:', pendingInvitations.length);
                            showInvitationChoiceModal(pendingInvitations);
                            return;
                        }
                    }

                    console.log('[ONBOARDING] No pending invitations - showing onboarding modal');
                    showOnboardingModal();
                    return;
                }

                // Store company data and update header
                currentCompany = companyResp.company;
                appData.company = companyResp.company; // Store in appData for billing functionality
                console.log('[LOAD] Company loaded:', currentCompany.name);
                document.getElementById('headerCompanyName').textContent = currentCompany.name;

                // Update user role with actual DynamoDB role
                if (window.currentUser && companyResp.userInfo) {
                    window.currentUser.role = companyResp.userInfo.role;
                    window.currentUser.isAdmin = companyResp.userInfo.isAdmin;
                    console.log('[LOAD] User role updated from DynamoDB:', {
                        userId: window.currentUser.id,
                        email: window.currentUser.email,
                        role: window.currentUser.role,
                        isAdmin: window.currentUser.isAdmin
                    });

                    // Apply role-based UI visibility
                    applyRoleBasedUI();
                }

                // Company exists - load all data in parallel
                const [expensesResp, projectsResp, contractorsResp, worksResp] = await Promise.all([
                    apiCall('/expenses'),
                    apiCall('/projects'),
                    apiCall('/contractors'),
                    apiCall('/works')
                ]);

                appData.expenses = expensesResp.expenses || [];
                appData.projects = projectsResp.projects || [];
                appData.contractors = contractorsResp.contractors || [];
                appData.works = worksResp.works || [];

                // Build expense lookup maps for O(1) access
                buildExpenseMaps();

                updateDashboard();

                // Initialize OCR component now that we have company context
                initializeExpenseOcrComponent();

            } catch (error) {
                console.error('Failed to load data:', error);
                showError('Failed to load application data');
            }
        }

        // API Call Helper with Clerk Authentication
        async function apiCall(endpoint, method = 'GET', data = null) {
            try {
                // Ensure we have a valid token
                const token = await ClerkAuth.ensureValidToken();

                const response = await fetch(`${API_CONFIG.endpoint}${endpoint}`, {
                    method,
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: data ? JSON.stringify(data) : null
                });

                if (!response.ok) {
                    // Try to parse error response
                    let errorMessage = response.statusText;
                    try {
                        const errorData = await response.json();

                        // Handle tier limit errors
                        if (response.status === 403 && errorData.data?.reason && errorData.data.reason.includes('LIMIT')) {
                            showUpgradeModal(errorData);
                            throw new Error('TIER_LIMIT'); // Special error to prevent generic error display
                        }

                        // Use the error message from the API response if available
                        if (errorData.message) {
                            errorMessage = errorData.message;
                        }

                        console.error('API Error Details:', errorData);
                    } catch (e) {
                        if (e.message === 'TIER_LIMIT') throw e;
                        // If JSON parsing fails, use statusText
                    }
                    throw new Error(`API call failed: ${errorMessage}`);
                }

                return await response.json();

            } catch (error) {
                console.error('API call error:', error);
                throw error;
            }
        }

        // Role-based permission helpers
        function canUserCreate() {
            const role = window.currentUser?.role;
            // Admin, Manager, Editor can create; Viewer cannot
            return role === 'admin' || role === 'manager' || role === 'editor';
        }

        function canUserManageUsers() {
            const role = window.currentUser?.role;
            // Only Admin can manage users (invite, edit roles, remove)
            return role === 'admin';
        }

        function canUserManageBilling() {
            const role = window.currentUser?.role;
            // Only Admin can manage billing
            return role === 'admin';
        }

        // Apply Role-Based UI Visibility
        function applyRoleBasedUI() {
            const role = window.currentUser?.role || 'viewer';
            console.log('[RBAC] Applying role-based UI for role:', role);

            // Hide billing tab for non-admins
            const billingTabBtn = document.getElementById('billingTabBtn');
            if (billingTabBtn) {
                billingTabBtn.style.display = canUserManageBilling() ? '' : 'none';
            }

            // Hide users tab for non-admins
            const usersTabBtn = document.getElementById('usersTabBtn');
            if (usersTabBtn) {
                usersTabBtn.style.display = canUserManageUsers() ? '' : 'none';
            }

            // Hide add expense button for viewers
            const addExpenseBtn = document.getElementById('addExpenseBtn');
            if (addExpenseBtn) {
                addExpenseBtn.style.display = canUserCreate() ? '' : 'none';
            }

            console.log('[RBAC] UI visibility applied:', {
                billingTab: canUserManageBilling(),
                usersTab: canUserManageUsers(),
                addButtons: canUserCreate()
            });
        }

        // Update Dashboard
        function updateDashboard() {
            // Calculate totals
            const totalExpenses = appData.expenses.reduce((sum, exp) => sum + (exp.amount || 0), 0);
            const activeProjects = appData.projects.length;
            const totalContractors = appData.contractors.length;

            // Calculate monthly expenses
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const monthlyExpenses = appData.expenses
                .filter(exp => {
                    const date = new Date(exp.date);
                    return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
                })
                .reduce((sum, exp) => sum + (exp.amount || 0), 0);

            // Update UI
            document.getElementById('totalExpenses').textContent = `₪${totalExpenses.toLocaleString('he-IL')}`;
            document.getElementById('activeProjects').textContent = activeProjects;
            document.getElementById('totalContractors').textContent = totalContractors;
            document.getElementById('monthlyExpenses').textContent = `₪${monthlyExpenses.toLocaleString('he-IL')}`;
        }

        // Mobile Navigation Functions
        function toggleMobileNav() {
            const menu = document.getElementById('mobileNavMenu');
            const trigger = document.getElementById('mobileNavTrigger');
            const isOpen = menu.style.display === 'block';

            menu.style.display = isOpen ? 'none' : 'block';
            trigger.classList.toggle('active', !isOpen);

            // Close when clicking outside
            if (!isOpen) {
                document.addEventListener('click', closeMobileNavOnOutsideClick);
            }
        }

        function closeMobileNavOnOutsideClick(e) {
            const dropdown = document.getElementById('mobileNavDropdown');
            if (!dropdown.contains(e.target)) {
                document.getElementById('mobileNavMenu').style.display = 'none';
                document.getElementById('mobileNavTrigger').classList.remove('active');
                document.removeEventListener('click', closeMobileNavOnOutsideClick);
            }
        }

        function selectMobileTab(tabName) {
            // Update mobile nav label
            const labelMap = {
                'expenses': '<i class="fas fa-receipt"></i> הוצאות',
                'projects': '<i class="fas fa-project-diagram"></i> פרויקטים',
                'contractors': '<i class="fas fa-hard-hat"></i> קבלנים',
                'works': '<i class="fas fa-tools"></i> עבודות',
                'reports': '<i class="fas fa-chart-bar"></i> דוחות',
                'billing': '<i class="fas fa-credit-card"></i> חיוב',
                'users': '<i class="fas fa-users"></i> משתמשים'
            };

            document.getElementById('mobileNavLabel').innerHTML = labelMap[tabName] || tabName;

            // Update active state
            document.querySelectorAll('.mobile-nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.mobile-nav-item').classList.add('active');

            // Close menu and switch tab
            document.getElementById('mobileNavMenu').style.display = 'none';
            document.getElementById('mobileNavTrigger').classList.remove('active');

            showTab(tabName);
        }

        // Mobile User Menu Functions
        function toggleMobileUserMenu() {
            const dropdown = document.getElementById('mobileUserDropdown');
            const isOpen = dropdown.style.display === 'block';

            dropdown.style.display = isOpen ? 'none' : 'block';

            if (!isOpen) {
                document.addEventListener('click', closeMobileUserOnOutsideClick);
            }
        }

        function closeMobileUserOnOutsideClick(e) {
            const toggle = document.querySelector('.mobile-user-menu-toggle');
            const dropdown = document.getElementById('mobileUserDropdown');

            if (!toggle.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.style.display = 'none';
                document.removeEventListener('click', closeMobileUserOnOutsideClick);
            }
        }

        function closeMobileUserMenu() {
            document.getElementById('mobileUserDropdown').style.display = 'none';
        }

        // Show Tab
        function showTab(tabName) {
            console.log('[TAB DEBUG] showTab called with:', tabName);
            console.log('[TAB DEBUG] Current tab before change:', currentTab);

            // Store current tab
            currentTab = tabName;

            // Update active tab
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            // Find and activate the button for this tab
            const activeButton = Array.from(document.querySelectorAll('.tab-button')).find(btn =>
                btn.textContent.includes(tabName) || btn.onclick?.toString().includes(`'${tabName}'`)
            );
            if (activeButton) {
                activeButton.classList.add('active');
                console.log('[TAB DEBUG] Activated button:', activeButton.textContent.trim());
            } else {
                console.warn('[TAB DEBUG] No button found for tab:', tabName);
            }

            // Load tab content
            const tabContent = document.getElementById('tabContent');

            try {
                switch(tabName) {
                    case 'expenses':
                        showExpensesTab(tabContent);
                        break;
                    case 'projects':
                        showProjectsTab(tabContent);
                        break;
                    case 'contractors':
                        showContractorsTab(tabContent);
                        break;
                    case 'works':
                        showWorksTab(tabContent);
                        break;
                    case 'reports':
                        showReportsTab(tabContent);
                        break;
                    case 'billing':
                        showBillingTab(tabContent);
                        break;
                    case 'users':
                        showUsersTab(tabContent);
                        break;
                    default:
                        console.error('[TAB DEBUG] Unknown tab:', tabName);
                }
                console.log('[TAB DEBUG] Tab content loaded successfully for:', tabName);
            } catch (error) {
                console.error('[TAB DEBUG] Error loading tab content:', error);
            }
        }

        // Refresh current tab (used after data updates)
        function refreshCurrentTab() {
            showTab(currentTab);
        }

        // Show Expenses Tab
        function showExpensesTab(container) {
            const showAddBtn = canUserCreate();
            container.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">הוצאות</h2>
                    <div style="display: flex; gap: 10px;">
                        <button id="exportBtn" class="btn-secondary" onclick="showExportPopup()">
                            <i class="fas fa-file-export"></i> ייצא דוח
                        </button>
                        ${showAddBtn ? `<button id="addExpenseBtn" class="btn-primary" onclick="showAddExpenseForm()">
                            <i class="fas fa-plus"></i> הוסף הוצאה
                        </button>` : ''}
                    </div>
                </div>

                <!-- Search and Filters -->
                <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #475569;">חיפוש</label>
                            <input type="text" id="expenseSearch" placeholder="חפש לפי תיאור..."
                                   style="width: 100%; padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 6px;"
                                   oninput="debouncedFilterExpenses()">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #475569;">פרויקט</label>
                            <select id="projectFilter" style="width: 100%; padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 6px;" onchange="filterExpenses()">
                                <option value="">כל הפרויקטים</option>
                                ${appData.projects.map(p => `<option value="${p.projectId}">${p.name}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #475569;">קבלן</label>
                            <select id="contractorFilter" style="width: 100%; padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 6px;" onchange="filterExpenses()">
                                <option value="">כל הקבלנים</option>
                                ${appData.contractors.map(c => `<option value="${c.contractorId}">${c.name}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #475569;">תקופה</label>
                            <select id="dateRangeFilter" style="width: 100%; padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 6px;" onchange="handleDateRangeChange()">
                                <option value="all">כל התקופות</option>
                                <option value="today">היום</option>
                                <option value="week">השבוע</option>
                                <option value="month">החודש</option>
                                <option value="year">השנה</option>
                                <option value="custom">תקופה מותאמת אישית</option>
                            </select>
                        </div>
                        <div id="customDateRange" style="display: none;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #475569;">מתאריך</label>
                            <input type="date" id="startDate" style="width: 100%; padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 6px;" onchange="filterExpenses()">
                        </div>
                        <div id="customDateRangeEnd" style="display: none;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #475569;">עד תאריך</label>
                            <input type="date" id="endDate" style="width: 100%; padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 6px;" onchange="filterExpenses()">
                        </div>
                    </div>
                </div>

                <table id="expensesTable">
                    <thead>
                        <tr>
                            <th>תאריך</th>
                            <th>תיאור</th>
                            <th>סכום</th>
                            <th>עבודה</th>
                            <th>פרויקט</th>
                            <th>קבלן</th>
                            <th>קבלה</th>
                            <th>פעולות</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${appData.expenses.map(expense => `
                            <tr>
                                <td>${new Date(expense.date).toLocaleDateString('he-IL')}</td>
                                <td>${expense.description}</td>
                                <td>
                                    <div>₪${expense.amount.toLocaleString('he-IL')}</div>
                                    ${expense.baseAmount ? `<div style="font-size: 0.75rem; color: #64748b;">לפני מע״מ: ₪${expense.baseAmount.toLocaleString('he-IL')} | מע״מ: ₪${expense.vatAmount.toLocaleString('he-IL')}</div>` : ''}
                                </td>
                                <td>${expense.workName || '-'}</td>
                                <td>${expense.projectName || '-'}</td>
                                <td>${expense.contractorName || '-'}</td>
                                <td>
                                    ${expense.receiptUrl
                                        ? `<a href="${expense.receiptUrl}" target="_blank" class="btn-secondary" style="display: inline-block; padding: 6px 12px; text-decoration: none;"><i class="fas fa-file-image"></i> צפה</a>`
                                        : expense.missingReceipt
                                            ? `<span class="missing-receipt-badge"><i class="fas fa-exclamation-triangle"></i> חסרה קבלה</span>`
                                            : '-'
                                    }
                                </td>
                                <td>
                                    <button class="btn-edit" onclick="editExpense('${expense.expenseId}')">ערוך</button>
                                    <button class="btn-delete" onclick="deleteExpense('${expense.expenseId}')">מחק</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>

                <!-- Mobile Cards View -->
                <div class="expense-cards-mobile" id="expenseCardsMobile"></div>
            `;

            // Initial render
            filterExpenses();
        }

        // Handle Date Range Change
        window.handleDateRangeChange = function() {
            const dateRangeFilter = document.getElementById('dateRangeFilter')?.value;
            const customDateRange = document.getElementById('customDateRange');
            const customDateRangeEnd = document.getElementById('customDateRangeEnd');

            if (dateRangeFilter === 'custom') {
                customDateRange.style.display = 'block';
                customDateRangeEnd.style.display = 'block';
            } else {
                customDateRange.style.display = 'none';
                customDateRangeEnd.style.display = 'none';
            }
            filterExpenses();
        }

        // Filter Expenses
        window.filterExpenses = function() {
            const searchTerm = document.getElementById('expenseSearch')?.value.toLowerCase() || '';
            const projectFilter = document.getElementById('projectFilter')?.value || '';
            const contractorFilter = document.getElementById('contractorFilter')?.value || '';
            const dateRangeFilter = document.getElementById('dateRangeFilter')?.value || 'all';
            const startDate = document.getElementById('startDate')?.value;
            const endDate = document.getElementById('endDate')?.value;

            let filtered = appData.expenses.filter(expense => {
                // Search filter
                const matchesSearch = !searchTerm ||
                    expense.description.toLowerCase().includes(searchTerm) ||
                    (expense.projectName && expense.projectName.toLowerCase().includes(searchTerm)) ||
                    (expense.contractorName && expense.contractorName.toLowerCase().includes(searchTerm));

                // Project filter
                const matchesProject = !projectFilter || expense.projectId === projectFilter;

                // Contractor filter
                const matchesContractor = !contractorFilter || expense.contractorId === contractorFilter;

                // Date range filter
                let matchesDate = true;
                if (dateRangeFilter !== 'all') {
                    const expenseDate = new Date(expense.date);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);

                    if (dateRangeFilter === 'custom') {
                        // Custom date range
                        if (startDate) {
                            const start = new Date(startDate);
                            start.setHours(0, 0, 0, 0);
                            matchesDate = matchesDate && expenseDate >= start;
                        }
                        if (endDate) {
                            const end = new Date(endDate);
                            end.setHours(23, 59, 59, 999);
                            matchesDate = matchesDate && expenseDate <= end;
                        }
                    } else {
                        switch(dateRangeFilter) {
                            case 'today':
                                matchesDate = expenseDate >= today;
                                break;
                            case 'week':
                                const weekAgo = new Date(today);
                                weekAgo.setDate(weekAgo.getDate() - 7);
                                matchesDate = expenseDate >= weekAgo;
                                break;
                            case 'month':
                                const monthAgo = new Date(today);
                                monthAgo.setMonth(monthAgo.getMonth() - 1);
                                matchesDate = expenseDate >= monthAgo;
                                break;
                            case 'year':
                                const yearAgo = new Date(today);
                                yearAgo.setFullYear(yearAgo.getFullYear() - 1);
                                matchesDate = expenseDate >= yearAgo;
                                break;
                        }
                    }
                }

                return matchesSearch && matchesProject && matchesContractor && matchesDate;
            });

            // Render filtered expenses
            const tbody = document.querySelector('#expensesTable tbody');
            if (tbody) {
                tbody.innerHTML = filtered.map(expense => `
                    <tr>
                        <td>${new Date(expense.date).toLocaleDateString('he-IL')}</td>
                        <td>${expense.description}</td>
                        <td>
                            <div>₪${expense.amount.toLocaleString('he-IL')}</div>
                            ${expense.baseAmount ? `<div style="font-size: 0.75rem; color: #64748b;">לפני מע״מ: ₪${expense.baseAmount.toLocaleString('he-IL')} | מע״מ: ₪${expense.vatAmount.toLocaleString('he-IL')}</div>` : ''}
                        </td>
                        <td>${expense.workName || '-'}</td>
                        <td>${expense.projectName || '-'}</td>
                        <td>${expense.contractorName || '-'}</td>
                        <td>
                            ${expense.receiptUrl
                                ? `<a href="${expense.receiptUrl}" target="_blank" class="btn-secondary" style="display: inline-block; padding: 6px 12px; text-decoration: none;"><i class="fas fa-file-image"></i> צפה</a>`
                                : expense.missingReceipt
                                    ? `<span class="missing-receipt-badge"><i class="fas fa-exclamation-triangle"></i> חסרה קבלה</span>`
                                    : '-'
                            }
                        </td>
                        <td>
                            <button class="btn-edit" onclick="editExpense('${expense.expenseId}')">ערוך</button>
                            <button class="btn-delete" onclick="deleteExpense('${expense.expenseId}')">מחק</button>
                        </td>
                    </tr>
                `).join('');
            }

            // Also render mobile cards
            const mobileCards = document.getElementById('expenseCardsMobile');
            if (mobileCards) {
                mobileCards.innerHTML = filtered.map(expense => `
                    <div class="expense-card">
                        <div class="expense-card-header">
                            <span class="expense-card-date">${new Date(expense.date).toLocaleDateString('he-IL')}</span>
                            <span class="expense-card-amount">₪${expense.amount.toLocaleString('he-IL')}</span>
                        </div>
                        ${expense.baseAmount ? `<div style="font-size: 0.75rem; color: #64748b; text-align: left; margin-bottom: 8px;">לפני מע״מ: ₪${expense.baseAmount.toLocaleString('he-IL')} | מע״מ: ₪${expense.vatAmount.toLocaleString('he-IL')}</div>` : ''}
                        <div class="expense-card-description">${expense.description}</div>
                        <div class="expense-card-details">
                            ${expense.projectName ? `<div class="expense-card-detail"><i class="fas fa-project-diagram"></i> ${expense.projectName}</div>` : ''}
                            ${expense.contractorName ? `<div class="expense-card-detail"><i class="fas fa-hard-hat"></i> ${expense.contractorName}</div>` : ''}
                            ${expense.workName ? `<div class="expense-card-detail"><i class="fas fa-tools"></i> ${expense.workName}</div>` : ''}
                        </div>
                        <div class="expense-card-actions">
                            ${expense.receiptUrl
                                ? `<a href="${expense.receiptUrl}" target="_blank" class="expense-card-btn expense-card-btn-receipt"><i class="fas fa-file-image"></i> קבלה</a>`
                                : expense.missingReceipt
                                    ? `<span class="missing-receipt-badge"><i class="fas fa-exclamation-triangle"></i> חסרה</span>`
                                    : ''
                            }
                            <button class="expense-card-btn expense-card-btn-edit" onclick="editExpense('${expense.expenseId}')"><i class="fas fa-edit"></i> ערוך</button>
                            <button class="expense-card-btn expense-card-btn-delete" onclick="deleteExpense('${expense.expenseId}')"><i class="fas fa-trash"></i> מחק</button>
                        </div>
                    </div>
                `).join('');
            }
        }

        // Export Expenses to CSV
        window.exportExpensesToCSV = function() {
            const searchTerm = document.getElementById('expenseSearch')?.value.toLowerCase() || '';
            const projectFilter = document.getElementById('projectFilter')?.value || '';
            const contractorFilter = document.getElementById('contractorFilter')?.value || '';
            const dateRangeFilter = document.getElementById('dateRangeFilter')?.value || 'all';
            const startDate = document.getElementById('startDate')?.value;
            const endDate = document.getElementById('endDate')?.value;

            // Use same filter logic as filterExpenses
            let filtered = appData.expenses.filter(expense => {
                const matchesSearch = !searchTerm ||
                    expense.description.toLowerCase().includes(searchTerm) ||
                    (expense.projectName && expense.projectName.toLowerCase().includes(searchTerm)) ||
                    (expense.contractorName && expense.contractorName.toLowerCase().includes(searchTerm));

                const matchesProject = !projectFilter || expense.projectId === projectFilter;
                const matchesContractor = !contractorFilter || expense.contractorId === contractorFilter;

                let matchesDate = true;
                if (dateRangeFilter !== 'all') {
                    const expenseDate = new Date(expense.date);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);

                    if (dateRangeFilter === 'custom') {
                        if (startDate) {
                            const start = new Date(startDate);
                            start.setHours(0, 0, 0, 0);
                            matchesDate = matchesDate && expenseDate >= start;
                        }
                        if (endDate) {
                            const end = new Date(endDate);
                            end.setHours(23, 59, 59, 999);
                            matchesDate = matchesDate && expenseDate <= end;
                        }
                    } else {
                        switch(dateRangeFilter) {
                            case 'today': matchesDate = expenseDate >= today; break;
                            case 'week':
                                const weekAgo = new Date(today);
                                weekAgo.setDate(weekAgo.getDate() - 7);
                                matchesDate = expenseDate >= weekAgo;
                                break;
                            case 'month':
                                const monthAgo = new Date(today);
                                monthAgo.setMonth(monthAgo.getMonth() - 1);
                                matchesDate = expenseDate >= monthAgo;
                                break;
                            case 'year':
                                const yearAgo = new Date(today);
                                yearAgo.setFullYear(yearAgo.getFullYear() - 1);
                                matchesDate = expenseDate >= yearAgo;
                                break;
                        }
                    }
                }
                return matchesSearch && matchesProject && matchesContractor && matchesDate;
            });

            // Group by project, then by contractor
            const groupedData = {};
            filtered.forEach(expense => {
                const projectKey = expense.projectName || 'ללא פרויקט';
                const contractorKey = expense.contractorName || 'ללא קבלן';

                if (!groupedData[projectKey]) {
                    groupedData[projectKey] = {};
                }
                if (!groupedData[projectKey][contractorKey]) {
                    groupedData[projectKey][contractorKey] = [];
                }
                groupedData[projectKey][contractorKey].push(expense);
            });

            // Build comprehensive CSV content
            let csvRows = [];

            // Report Header
            const reportDate = new Date().toLocaleString('he-IL');
            const dateRangeText = dateRangeFilter === 'custom' && startDate && endDate
                ? `${startDate} עד ${endDate}`
                : dateRangeFilter === 'all' ? 'כל התקופות' : dateRangeFilter;

            csvRows.push('\ufeff"דוח הוצאות - מערכת מעקב הוצאות בניה"');
            csvRows.push(`"תאריך דוח: ${reportDate}"`);
            csvRows.push(`"תקופת הדוח: ${dateRangeText}"`);
            csvRows.push(`"סה\\"כ הוצאות: ${filtered.length}"`);
            csvRows.push(`"סכום כולל: ₪${filtered.reduce((sum, e) => sum + e.amount, 0).toLocaleString('he-IL')}"`);
            csvRows.push('');

            // Detailed headers for all fields (reversed for RTL display in Excel)
            const rlm = '\u200F'; // Right-to-Left Mark
            const headers = [
                `${rlm}קישור לקבלה`,
                `${rlm}מזהה עבודה`,
                `${rlm}מזהה קבלן`,
                `${rlm}מזהה פרויקט`,
                `${rlm}מזהה הוצאה`,
                `${rlm}עבודה`,
                `${rlm}קבלן`,
                `${rlm}פרויקט`,
                `${rlm}סכום`,
                `${rlm}תיאור`,
                `${rlm}תאריך`
            ];

            // Process each project
            Object.keys(groupedData).sort().forEach(projectName => {
                const projectExpenses = Object.values(groupedData[projectName]).flat();
                const projectTotal = projectExpenses.reduce((sum, e) => sum + e.amount, 0);

                csvRows.push('');
                csvRows.push(`"=== פרויקט: ${projectName} ==="`);
                csvRows.push(`"סה\\"כ הוצאות בפרויקט: ${projectExpenses.length}"`);
                csvRows.push(`"סכום כולל: ₪${projectTotal.toLocaleString('he-IL')}"`);
                csvRows.push('');

                // Process each contractor in this project
                Object.keys(groupedData[projectName]).sort().forEach(contractorName => {
                    const contractorExpenses = groupedData[projectName][contractorName];
                    const contractorTotal = contractorExpenses.reduce((sum, e) => sum + e.amount, 0);

                    csvRows.push(`"--- קבלן: ${contractorName} ---"`);
                    csvRows.push(`"סה\\"כ הוצאות לקבלן: ${contractorExpenses.length} | סכום: ₪${contractorTotal.toLocaleString('he-IL')}"`);
                    csvRows.push(headers.join(','));

                    // Add expense rows with RTL markers
                    contractorExpenses.forEach(expense => {
                        const rlm = '\u200F'; // Right-to-Left Mark for proper RTL display
                        const row = [
                            expense.receiptUrl || '',
                            expense.workId || '',
                            expense.contractorId || '',
                            expense.projectId || '',
                            expense.expenseId || '',
                            `"${rlm}${(expense.workName || '').replace(/"/g, '""')}"`,
                            `"${rlm}${(expense.contractorName || '').replace(/"/g, '""')}"`,
                            `"${rlm}${(expense.projectName || '').replace(/"/g, '""')}"`,
                            expense.amount,
                            `"${rlm}${(expense.description || '').replace(/"/g, '""')}"`,
                            `"${rlm}${new Date(expense.date).toLocaleDateString('he-IL')}"`
                        ];
                        csvRows.push(row.join(','));
                    });

                    csvRows.push('');
                });
            });

            // Create final CSV content
            const csvContent = csvRows.join('\n');

            // Download CSV
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            const filename = `expenses_report_${new Date().toISOString().split('T')[0]}.csv`;
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showSuccess(`דוח מפורט עם ${filtered.length} הוצאות יוצא בהצלחה`);
        }

        // ========================================
        // EXPORT POPUP AND FUNCTIONS
        // ========================================

        // Show Export Format Selection Popup
        window.showExportPopup = function() {
            document.getElementById('exportModal').style.display = 'block';
        }

        // Close Export Popup
        window.closeExportPopup = function() {
            document.getElementById('exportModal').style.display = 'none';
        }

        // Close popup when clicking outside
        window.onclick = function(event) {
            const exportModal = document.getElementById('exportModal');
            if (event.target === exportModal) {
                closeExportPopup();
            }
        }

        // Helper function to get filtered expenses (shared by PDF and Excel export)
        function getFilteredExpensesForExport() {
            const searchTerm = document.getElementById('expenseSearch')?.value.toLowerCase() || '';
            const projectFilter = document.getElementById('projectFilter')?.value || '';
            const contractorFilter = document.getElementById('contractorFilter')?.value || '';
            const dateRangeFilter = document.getElementById('dateRangeFilter')?.value || 'all';
            const startDate = document.getElementById('startDate')?.value;
            const endDate = document.getElementById('endDate')?.value;

            let filtered = appData.expenses.filter(expense => {
                const matchesSearch = !searchTerm ||
                    expense.description.toLowerCase().includes(searchTerm) ||
                    (expense.projectName && expense.projectName.toLowerCase().includes(searchTerm)) ||
                    (expense.contractorName && expense.contractorName.toLowerCase().includes(searchTerm));

                const matchesProject = !projectFilter || expense.projectId === projectFilter;
                const matchesContractor = !contractorFilter || expense.contractorId === contractorFilter;

                let matchesDate = true;
                if (dateRangeFilter !== 'all') {
                    const expenseDate = new Date(expense.date);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);

                    if (dateRangeFilter === 'custom') {
                        if (startDate) {
                            const start = new Date(startDate);
                            start.setHours(0, 0, 0, 0);
                            matchesDate = matchesDate && expenseDate >= start;
                        }
                        if (endDate) {
                            const end = new Date(endDate);
                            end.setHours(23, 59, 59, 999);
                            matchesDate = matchesDate && expenseDate <= end;
                        }
                    } else {
                        switch(dateRangeFilter) {
                            case 'today': matchesDate = expenseDate >= today; break;
                            case 'week':
                                const weekAgo = new Date(today);
                                weekAgo.setDate(weekAgo.getDate() - 7);
                                matchesDate = expenseDate >= weekAgo;
                                break;
                            case 'month':
                                const monthAgo = new Date(today);
                                monthAgo.setMonth(monthAgo.getMonth() - 1);
                                matchesDate = expenseDate >= monthAgo;
                                break;
                            case 'year':
                                const yearAgo = new Date(today);
                                yearAgo.setFullYear(yearAgo.getFullYear() - 1);
                                matchesDate = expenseDate >= yearAgo;
                                break;
                        }
                    }
                }
                return matchesSearch && matchesProject && matchesContractor && matchesDate;
            });

            return {
                filtered,
                dateRangeFilter,
                startDate,
                endDate
            };
        }

        // Export to PDF (called from popup)
        window.exportToPDF = async function() {
            closeExportPopup();
            // Lazy load export libraries before generating PDF
            try {
                await loadExportLibraries();
            } catch (error) {
                console.error('[Performance] Failed to load export libraries:', error);
                alert('שגיאה בטעינת ספריות הייצוא. אנא נסה שוב.');
                return;
            }
            exportExpensesToPDF();
        }

        // Export Expenses to PDF (original function)
        window.exportExpensesToPDF = function() {
            // Disable button to prevent multiple clicks
            const btn = document.getElementById('exportBtn');
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> מייצא PDF...';
            }

            const searchTerm = document.getElementById('expenseSearch')?.value.toLowerCase() || '';
            const projectFilter = document.getElementById('projectFilter')?.value || '';
            const contractorFilter = document.getElementById('contractorFilter')?.value || '';
            const dateRangeFilter = document.getElementById('dateRangeFilter')?.value || 'all';
            const startDate = document.getElementById('startDate')?.value;
            const endDate = document.getElementById('endDate')?.value;

            // Use same filter logic as filterExpenses
            let filtered = appData.expenses.filter(expense => {
                const matchesSearch = !searchTerm ||
                    expense.description.toLowerCase().includes(searchTerm) ||
                    (expense.projectName && expense.projectName.toLowerCase().includes(searchTerm)) ||
                    (expense.contractorName && expense.contractorName.toLowerCase().includes(searchTerm));

                const matchesProject = !projectFilter || expense.projectId === projectFilter;
                const matchesContractor = !contractorFilter || expense.contractorId === contractorFilter;

                let matchesDate = true;
                if (dateRangeFilter !== 'all') {
                    const expenseDate = new Date(expense.date);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);

                    if (dateRangeFilter === 'custom') {
                        if (startDate) {
                            const start = new Date(startDate);
                            start.setHours(0, 0, 0, 0);
                            matchesDate = matchesDate && expenseDate >= start;
                        }
                        if (endDate) {
                            const end = new Date(endDate);
                            end.setHours(23, 59, 59, 999);
                            matchesDate = matchesDate && expenseDate <= end;
                        }
                    } else {
                        switch(dateRangeFilter) {
                            case 'today': matchesDate = expenseDate >= today; break;
                            case 'week':
                                const weekAgo = new Date(today);
                                weekAgo.setDate(weekAgo.getDate() - 7);
                                matchesDate = expenseDate >= weekAgo;
                                break;
                            case 'month':
                                const monthAgo = new Date(today);
                                monthAgo.setMonth(monthAgo.getMonth() - 1);
                                matchesDate = expenseDate >= monthAgo;
                                break;
                            case 'year':
                                const yearAgo = new Date(today);
                                yearAgo.setFullYear(yearAgo.getFullYear() - 1);
                                matchesDate = expenseDate >= yearAgo;
                                break;
                        }
                    }
                }
                return matchesSearch && matchesProject && matchesContractor && matchesDate;
            });

            // Validate that we have expenses to export
            if (filtered.length === 0) {
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-file-export"></i> ייצא דוח';
                }
                showError('אין הוצאות להצגה בדוח');
                return;
            }

            // Calculate statistics
            const reportDate = new Date().toLocaleString('he-IL');
            const dateRangeText = dateRangeFilter === 'custom' && startDate && endDate
                ? `${startDate}&nbsp;עד&nbsp;${endDate}`
                : dateRangeFilter === 'all' ? 'כל&nbsp;התקופות' : dateRangeFilter;
            const totalAmount = filtered.reduce((sum, e) => sum + e.amount, 0);
            const uniqueProjects = new Set(filtered.map(e => e.projectId)).size;
            const uniqueContractors = new Set(filtered.map(e => e.contractorId)).size;
            const avgAmount = filtered.length > 0 ? totalAmount / filtered.length : 0;
            const withReceipt = filtered.filter(e => e.receiptUrl).length;
            const withoutReceipt = filtered.filter(e => !e.receiptUrl).length;

            // Group by project -> contractor -> work for hierarchical view
            const groupedData = {};
            filtered.forEach(expense => {
                const projectKey = expense.projectName || 'ללא&nbsp;פרויקט';
                const contractorKey = expense.contractorName || 'ללא&nbsp;קבלן';
                const workKey = expense.workName || 'ללא&nbsp;עבודה';

                if (!groupedData[projectKey]) {
                    groupedData[projectKey] = {};
                }
                if (!groupedData[projectKey][contractorKey]) {
                    groupedData[projectKey][contractorKey] = {};
                }
                if (!groupedData[projectKey][contractorKey][workKey]) {
                    groupedData[projectKey][contractorKey][workKey] = [];
                }
                groupedData[projectKey][contractorKey][workKey].push(expense);
            });

            // ========================================
            // html2pdf Implementation with Hebrew Support
            // Using simpler structure for better page breaks
            // ========================================

            // Build HTML content - simplified structure for better page breaks
            let htmlContent = `
                <div style="font-family: 'Rubik', Arial, sans-serif; padding: 20px; color: #1a202c; direction: rtl; width: 100%;">

                    <!-- PAGE 1: Title and Summary -->
                    <h1 style="text-align: center; color: #2c3e50; margin-bottom: 30px; font-size: 22px; word-spacing: 0.1em;">דוח&nbsp;הוצאות&nbsp;-&nbsp;מערכת&nbsp;מעקב&nbsp;הוצאות&nbsp;בניה</h1>

                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h2 style="margin: 0 0 15px 0; font-size: 18px; text-align: center; border-bottom: 2px solid rgba(255,255,255,0.5); padding-bottom: 10px; word-spacing: 0.1em;">סיכום&nbsp;מנהלים</h2>
                        <table style="width: 100%; border-collapse: collapse; color: white; word-spacing: 0.05em;">
                            <tr>
                                <td style="padding: 8px; text-align: right; width: 50%;">סה"כ&nbsp;הוצאות:&nbsp;<strong>${filtered.length}</strong></td>
                                <td style="padding: 8px; text-align: right; width: 50%;">סכום&nbsp;כולל:&nbsp;<strong>₪${totalAmount.toLocaleString('he-IL')}</strong></td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; text-align: right;">מספר&nbsp;פרויקטים:&nbsp;<strong>${uniqueProjects}</strong></td>
                                <td style="padding: 8px; text-align: right;">מספר&nbsp;קבלנים:&nbsp;<strong>${uniqueContractors}</strong></td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; text-align: right;">ממוצע&nbsp;להוצאה:&nbsp;<strong>₪${avgAmount.toLocaleString('he-IL', {maximumFractionDigits: 2})}</strong></td>
                                <td style="padding: 8px; text-align: right;">עם&nbsp;קבלה:&nbsp;<strong>${withReceipt}</strong></td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; text-align: right;">ללא&nbsp;קבלה:&nbsp;<strong>${withoutReceipt}</strong></td>
                                <td style="padding: 8px; text-align: right;">תאריך&nbsp;דוח:&nbsp;<strong>${reportDate}</strong></td>
                            </tr>
                        </table>
                        <div style="text-align: center; margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.3); word-spacing: 0.05em;">
                            תקופת&nbsp;הדוח&nbsp;-&nbsp;<strong>${dateRangeText}</strong>
                        </div>
                    </div>
            `;

            // SECTION 2: All Expenses Table (simplified - one big table)
            htmlContent += `
                <div style="page-break-before: always;"></div>
                <h2 style="color: #2c3e50; margin: 20px 0 15px 0; font-size: 18px; border-bottom: 3px solid #2c3e50; padding-bottom: 8px; word-spacing: 0.1em;">כל&nbsp;ההוצאות&nbsp;לפי&nbsp;תאריך</h2>
                <table style="width: 100%; border-collapse: collapse; font-size: 9px;">
                    <thead>
                        <tr style="background: #2c3e50; color: white;">
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: center; width: 12%;">תאריך</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: right; width: 25%;">תיאור</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: center; width: 13%;">סכום</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: center; width: 18%;">פרויקט</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: center; width: 18%;">קבלן</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: center; width: 8%;">קבלה</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            // Sort by date (newest first)
            const sortedExpenses = [...filtered].sort((a, b) => new Date(b.date) - new Date(a.date));

            sortedExpenses.forEach((expense, idx) => {
                const bgColor = idx % 2 === 0 ? '#ffffff' : '#f8f9fa';
                htmlContent += `
                    <tr style="background: ${bgColor}; page-break-inside: avoid;">
                        <td style="border: 1px solid #ddd; padding: 6px; text-align: center;">${new Date(expense.date).toLocaleDateString('he-IL')}</td>
                        <td style="border: 1px solid #ddd; padding: 6px; text-align: right;">${expense.description || '-'}</td>
                        <td style="border: 1px solid #ddd; padding: 6px; text-align: center;">₪${expense.amount.toLocaleString('he-IL')}</td>
                        <td style="border: 1px solid #ddd; padding: 6px; text-align: center;">${expense.projectName || 'ללא&nbsp;פרויקט'}</td>
                        <td style="border: 1px solid #ddd; padding: 6px; text-align: center;">${expense.contractorName || 'ללא&nbsp;קבלן'}</td>
                        <td style="border: 1px solid #ddd; padding: 6px; text-align: center;">${expense.receiptUrl ? '✓' : '-'}</td>
                    </tr>
                `;
            });

            htmlContent += `
                    </tbody>
                    <tfoot>
                        <tr style="background: #2c3e50; color: white; font-weight: bold;">
                            <td colspan="2" style="border: 1px solid #ddd; padding: 8px; text-align: right;">סה"כ&nbsp;כללי</td>
                            <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">₪${totalAmount.toLocaleString('he-IL')}</td>
                            <td colspan="3" style="border: 1px solid #ddd; padding: 8px; text-align: center;">${filtered.length} הוצאות</td>
                        </tr>
                    </tfoot>
                </table>
            `;

            // SECTION 3: Summary by Project
            htmlContent += `
                <div style="page-break-before: always;"></div>
                <h2 style="color: #2c3e50; margin: 20px 0 15px 0; font-size: 18px; border-bottom: 3px solid #2c3e50; padding-bottom: 8px; word-spacing: 0.1em;">סיכום&nbsp;לפי&nbsp;פרויקט</h2>
                <table style="width: 100%; border-collapse: collapse; font-size: 10px; word-spacing: 0.05em;">
                    <thead>
                        <tr style="background: #2c3e50; color: white;">
                            <th style="border: 1px solid #ddd; padding: 10px; text-align: right;">פרויקט</th>
                            <th style="border: 1px solid #ddd; padding: 10px; text-align: center;">מספר&nbsp;הוצאות</th>
                            <th style="border: 1px solid #ddd; padding: 10px; text-align: center;">סכום&nbsp;כולל</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            const projectGroups = {};
            filtered.forEach(expense => {
                const key = expense.projectName || 'ללא&nbsp;פרויקט';
                if (!projectGroups[key]) projectGroups[key] = [];
                projectGroups[key].push(expense);
            });

            Object.keys(projectGroups).sort().forEach((projectName, idx) => {
                const expenses = projectGroups[projectName];
                const total = expenses.reduce((sum, e) => sum + e.amount, 0);
                const bgColor = idx % 2 === 0 ? '#ffffff' : '#f8f9fa';
                htmlContent += `
                    <tr style="background: ${bgColor}; page-break-inside: avoid;">
                        <td style="border: 1px solid #ddd; padding: 10px; text-align: right; font-weight: bold;">${projectName}</td>
                        <td style="border: 1px solid #ddd; padding: 10px; text-align: center;">${expenses.length}</td>
                        <td style="border: 1px solid #ddd; padding: 10px; text-align: center;">₪${total.toLocaleString('he-IL')}</td>
                    </tr>
                `;
            });

            htmlContent += `
                    </tbody>
                </table>
            `;

            // SECTION 4: Summary by Contractor
            htmlContent += `
                <h2 style="color: #2c3e50; margin: 20px 0 15px 0; font-size: 18px; border-bottom: 3px solid #2c3e50; padding-bottom: 8px; page-break-before: auto; word-spacing: 0.1em;">סיכום&nbsp;לפי&nbsp;קבלן</h2>
                <table style="width: 100%; border-collapse: collapse; font-size: 10px; word-spacing: 0.05em;">
                    <thead>
                        <tr style="background: #7f8c8d; color: white;">
                            <th style="border: 1px solid #ddd; padding: 10px; text-align: right;">קבלן</th>
                            <th style="border: 1px solid #ddd; padding: 10px; text-align: center;">מספר&nbsp;הוצאות</th>
                            <th style="border: 1px solid #ddd; padding: 10px; text-align: center;">סכום&nbsp;כולל</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            const contractorGroups = {};
            filtered.forEach(expense => {
                const key = expense.contractorName || 'ללא&nbsp;קבלן';
                if (!contractorGroups[key]) contractorGroups[key] = [];
                contractorGroups[key].push(expense);
            });

            Object.keys(contractorGroups).sort().forEach((contractorName, idx) => {
                const expenses = contractorGroups[contractorName];
                const total = expenses.reduce((sum, e) => sum + e.amount, 0);
                const bgColor = idx % 2 === 0 ? '#ffffff' : '#f8f9fa';
                htmlContent += `
                    <tr style="background: ${bgColor}; page-break-inside: avoid;">
                        <td style="border: 1px solid #ddd; padding: 10px; text-align: right; font-weight: bold;">${contractorName}</td>
                        <td style="border: 1px solid #ddd; padding: 10px; text-align: center;">${expenses.length}</td>
                        <td style="border: 1px solid #ddd; padding: 10px; text-align: center;">₪${total.toLocaleString('he-IL')}</td>
                    </tr>
                `;
            });

            htmlContent += `
                    </tbody>
                </table>
            `;

            // ========================================
            // SECTION 5: Detailed Breakdown by Project
            // ========================================
            htmlContent += `
                <div style="page-break-before: always;"></div>
                <h2 style="color: #2c3e50; margin: 20px 0 15px 0; font-size: 18px; border-bottom: 3px solid #667eea; padding-bottom: 8px; word-spacing: 0.1em;">
                    <span style="background: #667eea; color: white; padding: 3px 10px; border-radius: 4px; margin-left: 10px;">פירוט</span>
                    הוצאות&nbsp;לפי&nbsp;פרויקט
                </h2>
            `;

            // For each project, show all its expenses
            Object.keys(projectGroups).sort().forEach((projectName, projectIdx) => {
                const projectExpenses = projectGroups[projectName];
                const projectTotal = projectExpenses.reduce((sum, e) => sum + e.amount, 0);

                // Project header with total
                htmlContent += `
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 15px; border-radius: 8px 8px 0 0; margin-top: ${projectIdx > 0 ? '25px' : '15px'}; display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0; font-size: 14px; word-spacing: 0.05em;">${projectName}</h3>
                        <div style="font-size: 13px;">
                            <span style="opacity: 0.9;">${projectExpenses.length}&nbsp;הוצאות</span>
                            <span style="margin: 0 8px;">|</span>
                            <strong>₪${projectTotal.toLocaleString('he-IL')}</strong>
                        </div>
                    </div>
                    <table style="width: 100%; border-collapse: collapse; font-size: 9px; margin-bottom: 0;">
                        <thead>
                            <tr style="background: #f8f9fa;">
                                <th style="border: 1px solid #ddd; padding: 6px; text-align: center; width: 15%;">תאריך</th>
                                <th style="border: 1px solid #ddd; padding: 6px; text-align: right; width: 35%;">תיאור</th>
                                <th style="border: 1px solid #ddd; padding: 6px; text-align: center; width: 20%;">קבלן</th>
                                <th style="border: 1px solid #ddd; padding: 6px; text-align: center; width: 15%;">סכום</th>
                                <th style="border: 1px solid #ddd; padding: 6px; text-align: center; width: 15%;">קבלה</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                // Sort project expenses by date (newest first)
                const sortedProjectExpenses = [...projectExpenses].sort((a, b) => new Date(b.date) - new Date(a.date));

                sortedProjectExpenses.forEach((expense, idx) => {
                    const bgColor = idx % 2 === 0 ? '#ffffff' : '#f8f9fa';
                    htmlContent += `
                        <tr style="background: ${bgColor}; page-break-inside: avoid;">
                            <td style="border: 1px solid #ddd; padding: 5px; text-align: center;">${new Date(expense.date).toLocaleDateString('he-IL')}</td>
                            <td style="border: 1px solid #ddd; padding: 5px; text-align: right;">${expense.description || '-'}</td>
                            <td style="border: 1px solid #ddd; padding: 5px; text-align: center;">${expense.contractorName || 'ללא&nbsp;קבלן'}</td>
                            <td style="border: 1px solid #ddd; padding: 5px; text-align: center;">₪${expense.amount.toLocaleString('he-IL')}</td>
                            <td style="border: 1px solid #ddd; padding: 5px; text-align: center;">${expense.receiptUrl ? '✓' : '-'}</td>
                        </tr>
                    `;
                });

                htmlContent += `
                        </tbody>
                        <tfoot>
                            <tr style="background: #e2e8f0; font-weight: bold;">
                                <td colspan="3" style="border: 1px solid #ddd; padding: 6px; text-align: right;">סה"כ&nbsp;${projectName}</td>
                                <td style="border: 1px solid #ddd; padding: 6px; text-align: center;">₪${projectTotal.toLocaleString('he-IL')}</td>
                                <td style="border: 1px solid #ddd; padding: 6px; text-align: center;"></td>
                            </tr>
                        </tfoot>
                    </table>
                `;
            });

            // ========================================
            // SECTION 6: Detailed Breakdown by Contractor
            // ========================================
            htmlContent += `
                <div style="page-break-before: always;"></div>
                <h2 style="color: #2c3e50; margin: 20px 0 15px 0; font-size: 18px; border-bottom: 3px solid #48bb78; padding-bottom: 8px; word-spacing: 0.1em;">
                    <span style="background: #48bb78; color: white; padding: 3px 10px; border-radius: 4px; margin-left: 10px;">פירוט</span>
                    הוצאות&nbsp;לפי&nbsp;קבלן
                </h2>
            `;

            // For each contractor, show all their expenses
            Object.keys(contractorGroups).sort().forEach((contractorName, contractorIdx) => {
                const contractorExpenses = contractorGroups[contractorName];
                const contractorTotal = contractorExpenses.reduce((sum, e) => sum + e.amount, 0);

                // Contractor header with total
                htmlContent += `
                    <div style="background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); color: white; padding: 12px 15px; border-radius: 8px 8px 0 0; margin-top: ${contractorIdx > 0 ? '25px' : '15px'}; display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0; font-size: 14px; word-spacing: 0.05em;">${contractorName}</h3>
                        <div style="font-size: 13px;">
                            <span style="opacity: 0.9;">${contractorExpenses.length}&nbsp;הוצאות</span>
                            <span style="margin: 0 8px;">|</span>
                            <strong>₪${contractorTotal.toLocaleString('he-IL')}</strong>
                        </div>
                    </div>
                    <table style="width: 100%; border-collapse: collapse; font-size: 9px; margin-bottom: 0;">
                        <thead>
                            <tr style="background: #f8f9fa;">
                                <th style="border: 1px solid #ddd; padding: 6px; text-align: center; width: 15%;">תאריך</th>
                                <th style="border: 1px solid #ddd; padding: 6px; text-align: right; width: 35%;">תיאור</th>
                                <th style="border: 1px solid #ddd; padding: 6px; text-align: center; width: 20%;">פרויקט</th>
                                <th style="border: 1px solid #ddd; padding: 6px; text-align: center; width: 15%;">סכום</th>
                                <th style="border: 1px solid #ddd; padding: 6px; text-align: center; width: 15%;">קבלה</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                // Sort contractor expenses by date (newest first)
                const sortedContractorExpenses = [...contractorExpenses].sort((a, b) => new Date(b.date) - new Date(a.date));

                sortedContractorExpenses.forEach((expense, idx) => {
                    const bgColor = idx % 2 === 0 ? '#ffffff' : '#f8f9fa';
                    htmlContent += `
                        <tr style="background: ${bgColor}; page-break-inside: avoid;">
                            <td style="border: 1px solid #ddd; padding: 5px; text-align: center;">${new Date(expense.date).toLocaleDateString('he-IL')}</td>
                            <td style="border: 1px solid #ddd; padding: 5px; text-align: right;">${expense.description || '-'}</td>
                            <td style="border: 1px solid #ddd; padding: 5px; text-align: center;">${expense.projectName || 'ללא&nbsp;פרויקט'}</td>
                            <td style="border: 1px solid #ddd; padding: 5px; text-align: center;">₪${expense.amount.toLocaleString('he-IL')}</td>
                            <td style="border: 1px solid #ddd; padding: 5px; text-align: center;">${expense.receiptUrl ? '✓' : '-'}</td>
                        </tr>
                    `;
                });

                htmlContent += `
                        </tbody>
                        <tfoot>
                            <tr style="background: #c6f6d5; font-weight: bold;">
                                <td colspan="3" style="border: 1px solid #ddd; padding: 6px; text-align: right;">סה"כ&nbsp;${contractorName}</td>
                                <td style="border: 1px solid #ddd; padding: 6px; text-align: center;">₪${contractorTotal.toLocaleString('he-IL')}</td>
                                <td style="border: 1px solid #ddd; padding: 6px; text-align: center;"></td>
                            </tr>
                        </tfoot>
                    </table>
                `;
            });

            // Close the main container div
            htmlContent += `</div>`;

            // Debug: Log content
            console.log('PDF HTML Content length:', htmlContent.length);

            // Create wrapper in normal document flow
            // A4 = 210mm, with 10mm margins on each side = 190mm content area
            // At 96 DPI: 190mm * 96 / 25.4 ≈ 718px, use 700px for safety
            const wrapper = document.createElement('div');
            wrapper.id = 'pdf-wrapper-debug';
            wrapper.innerHTML = htmlContent;
            wrapper.style.cssText = 'width: 700px; background: white; padding: 0; margin: 0;';
            document.body.appendChild(wrapper);

            console.log('Wrapper added, dimensions:', wrapper.offsetWidth, 'x', wrapper.offsetHeight);

            const filename = `expenses_report_${new Date().toISOString().split('T')[0]}.pdf`;

            // Wait for render
            setTimeout(async () => {
                console.log('Generating PDF with html2pdf.js and page break support...');
                const captureHeight = wrapper.offsetHeight;
                const captureWidth = wrapper.offsetWidth;
                console.log('Capture dimensions:', captureWidth, 'x', captureHeight);

                try {
                    // Use html2pdf.js with proper page break configuration
                    const opt = {
                        margin: 10,
                        filename: filename,
                        image: { type: 'jpeg', quality: 0.98 },
                        html2canvas: {
                            scale: 2,
                            useCORS: true,
                            allowTaint: true,
                            logging: true,
                            backgroundColor: '#ffffff'
                        },
                        jsPDF: {
                            unit: 'mm',
                            format: 'a4',
                            orientation: 'portrait'
                        },
                        pagebreak: {
                            mode: ['avoid-all', 'css', 'legacy'],
                            before: '.page-break-before',
                            after: '.page-break-after',
                            avoid: ['tr', 'thead', 'tfoot', '.avoid-break']
                        }
                    };

                    console.log('Starting html2pdf generation with pagebreak mode...');

                    await html2pdf().set(opt).from(wrapper).save();

                    console.log('PDF saved successfully!');
                    if (btn) {
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-file-export"></i> ייצא דוח';
                    }
                    showSuccess(`דוח PDF יוצא בהצלחה`);

                } catch (error) {
                    console.error('PDF error:', error);
                    console.error('Error message:', error.message);
                    console.error('Error stack:', error.stack);
                    if (btn) {
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-file-export"></i> ייצא דוח';
                    }
                    showError('שגיאה בייצוא PDF: ' + (error.message || 'Unknown error'));
                }

                // Remove wrapper
                if (wrapper.parentNode) wrapper.parentNode.removeChild(wrapper);
            }, 500);
        }

        // ========================================
        // EXCEL EXPORT FUNCTION
        // ========================================
        window.exportToExcel = async function() {
            closeExportPopup();

            // Lazy load export libraries before generating Excel
            try {
                await loadExportLibraries();
            } catch (error) {
                console.error('[Performance] Failed to load export libraries:', error);
                alert('שגיאה בטעינת ספריות הייצוא. אנא נסה שוב.');
                return;
            }

            const btn = document.getElementById('exportBtn');
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> מייצא Excel...';
            }

            try {
                // Get filtered expenses using same logic as PDF
                const searchTerm = document.getElementById('expenseSearch')?.value.toLowerCase() || '';
                const projectFilter = document.getElementById('projectFilter')?.value || '';
                const contractorFilter = document.getElementById('contractorFilter')?.value || '';
                const dateRangeFilter = document.getElementById('dateRangeFilter')?.value || 'all';
                const startDate = document.getElementById('startDate')?.value;
                const endDate = document.getElementById('endDate')?.value;

                let filtered = appData.expenses.filter(expense => {
                    const matchesSearch = !searchTerm ||
                        expense.description.toLowerCase().includes(searchTerm) ||
                        (expense.projectName && expense.projectName.toLowerCase().includes(searchTerm)) ||
                        (expense.contractorName && expense.contractorName.toLowerCase().includes(searchTerm));

                    const matchesProject = !projectFilter || expense.projectId === projectFilter;
                    const matchesContractor = !contractorFilter || expense.contractorId === contractorFilter;

                    let matchesDate = true;
                    if (dateRangeFilter !== 'all') {
                        const expenseDate = new Date(expense.date);
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);

                        if (dateRangeFilter === 'custom') {
                            if (startDate) {
                                const start = new Date(startDate);
                                start.setHours(0, 0, 0, 0);
                                matchesDate = matchesDate && expenseDate >= start;
                            }
                            if (endDate) {
                                const end = new Date(endDate);
                                end.setHours(23, 59, 59, 999);
                                matchesDate = matchesDate && expenseDate <= end;
                            }
                        } else {
                            switch(dateRangeFilter) {
                                case 'today': matchesDate = expenseDate >= today; break;
                                case 'week':
                                    const weekAgo = new Date(today);
                                    weekAgo.setDate(weekAgo.getDate() - 7);
                                    matchesDate = expenseDate >= weekAgo;
                                    break;
                                case 'month':
                                    const monthAgo = new Date(today);
                                    monthAgo.setMonth(monthAgo.getMonth() - 1);
                                    matchesDate = expenseDate >= monthAgo;
                                    break;
                                case 'year':
                                    const yearAgo = new Date(today);
                                    yearAgo.setFullYear(yearAgo.getFullYear() - 1);
                                    matchesDate = expenseDate >= yearAgo;
                                    break;
                            }
                        }
                    }
                    return matchesSearch && matchesProject && matchesContractor && matchesDate;
                });

                if (filtered.length === 0) {
                    if (btn) {
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-file-export"></i> ייצא דוח';
                    }
                    showError('אין הוצאות להצגה בדוח');
                    return;
                }

                // Create workbook
                const wb = XLSX.utils.book_new();

                // ========================================
                // Sheet 1: All Expenses (כל ההוצאות)
                // ========================================
                // RTL: Columns reversed for Hebrew (right-to-left reading)
                const allExpensesData = filtered.map(expense => ({
                    'קבלה': expense.receiptUrl ? 'כן' : 'לא',
                    'עבודה': expense.workName || 'ללא עבודה',
                    'קבלן': expense.contractorName || 'ללא קבלן',
                    'פרויקט': expense.projectName || 'ללא פרויקט',
                    'סכום': expense.amount,
                    'תיאור': expense.description || '',
                    'תאריך': new Date(expense.date).toLocaleDateString('he-IL')
                }));

                // Add total row
                const totalAmount = filtered.reduce((sum, e) => sum + e.amount, 0);
                allExpensesData.push({
                    'קבלה': '',
                    'עבודה': '',
                    'קבלן': '',
                    'פרויקט': '',
                    'סכום': totalAmount,
                    'תיאור': 'סה"כ',
                    'תאריך': ''
                });

                const ws1 = XLSX.utils.json_to_sheet(allExpensesData);
                // Set RTL column widths (reversed order)
                ws1['!cols'] = [
                    { wch: 8 },   // קבלה
                    { wch: 15 }, // עבודה
                    { wch: 20 }, // קבלן
                    { wch: 20 }, // פרויקט
                    { wch: 12 }, // סכום
                    { wch: 35 }, // תיאור
                    { wch: 12 }  // תאריך
                ];
                XLSX.utils.book_append_sheet(wb, ws1, 'כל ההוצאות');

                // ========================================
                // Sheet 2: Summary by Project (סיכום לפי פרויקט)
                // ========================================
                const projectGroups = {};
                filtered.forEach(expense => {
                    const key = expense.projectName || 'ללא פרויקט';
                    if (!projectGroups[key]) projectGroups[key] = [];
                    projectGroups[key].push(expense);
                });

                // RTL: Columns reversed for Hebrew
                const projectSummaryData = Object.keys(projectGroups).sort().map(projectName => {
                    const expenses = projectGroups[projectName];
                    const total = expenses.reduce((sum, e) => sum + e.amount, 0);
                    return {
                        'סכום כולל': total,
                        'מספר הוצאות': expenses.length,
                        'פרויקט': projectName
                    };
                });

                // Add total row
                projectSummaryData.push({
                    'סכום כולל': totalAmount,
                    'מספר הוצאות': filtered.length,
                    'פרויקט': 'סה"כ'
                });

                const ws2 = XLSX.utils.json_to_sheet(projectSummaryData);
                ws2['!cols'] = [
                    { wch: 15 }, // סכום כולל
                    { wch: 15 }, // מספר הוצאות
                    { wch: 25 }  // פרויקט
                ];
                XLSX.utils.book_append_sheet(wb, ws2, 'סיכום לפי פרויקט');

                // ========================================
                // Sheet 3: Summary by Contractor (סיכום לפי קבלן)
                // ========================================
                const contractorGroups = {};
                filtered.forEach(expense => {
                    const key = expense.contractorName || 'ללא קבלן';
                    if (!contractorGroups[key]) contractorGroups[key] = [];
                    contractorGroups[key].push(expense);
                });

                // RTL: Columns reversed for Hebrew
                const contractorSummaryData = Object.keys(contractorGroups).sort().map(contractorName => {
                    const expenses = contractorGroups[contractorName];
                    const total = expenses.reduce((sum, e) => sum + e.amount, 0);
                    return {
                        'סכום כולל': total,
                        'מספר הוצאות': expenses.length,
                        'קבלן': contractorName
                    };
                });

                // Add total row
                contractorSummaryData.push({
                    'סכום כולל': totalAmount,
                    'מספר הוצאות': filtered.length,
                    'קבלן': 'סה"כ'
                });

                const ws3 = XLSX.utils.json_to_sheet(contractorSummaryData);
                ws3['!cols'] = [
                    { wch: 15 }, // סכום כולל
                    { wch: 15 }, // מספר הוצאות
                    { wch: 25 }  // קבלן
                ];
                XLSX.utils.book_append_sheet(wb, ws3, 'סיכום לפי קבלן');

                // ========================================
                // Sheet 4: Detailed by Project (פירוט לפי פרויקט)
                // ========================================
                // RTL: Columns reversed for Hebrew
                const detailedByProjectData = [];

                Object.keys(projectGroups).sort().forEach(projectName => {
                    const expenses = projectGroups[projectName];
                    const projectTotal = expenses.reduce((sum, e) => sum + e.amount, 0);

                    // Add project header
                    detailedByProjectData.push({
                        'קבלה': '',
                        'סכום': '',
                        'קבלן': '',
                        'תיאור': '',
                        'תאריך': '',
                        'פרויקט': `=== ${projectName} ===`
                    });

                    // Add expenses sorted by date
                    const sortedExpenses = [...expenses].sort((a, b) => new Date(b.date) - new Date(a.date));
                    sortedExpenses.forEach(expense => {
                        detailedByProjectData.push({
                            'קבלה': expense.receiptUrl ? 'כן' : 'לא',
                            'סכום': expense.amount,
                            'קבלן': expense.contractorName || 'ללא קבלן',
                            'תיאור': expense.description || '',
                            'תאריך': new Date(expense.date).toLocaleDateString('he-IL'),
                            'פרויקט': ''
                        });
                    });

                    // Add subtotal
                    detailedByProjectData.push({
                        'קבלה': '',
                        'סכום': projectTotal,
                        'קבלן': '',
                        'תיאור': `סה"כ ${projectName}`,
                        'תאריך': '',
                        'פרויקט': ''
                    });

                    // Empty row between projects
                    detailedByProjectData.push({});
                });

                const ws4 = XLSX.utils.json_to_sheet(detailedByProjectData);
                ws4['!cols'] = [
                    { wch: 8 },   // קבלה
                    { wch: 12 }, // סכום
                    { wch: 20 }, // קבלן
                    { wch: 30 }, // תיאור
                    { wch: 12 }, // תאריך
                    { wch: 25 }  // פרויקט
                ];
                XLSX.utils.book_append_sheet(wb, ws4, 'פירוט לפי פרויקט');

                // ========================================
                // Sheet 5: Detailed by Contractor (פירוט לפי קבלן)
                // ========================================
                // RTL: Columns reversed for Hebrew
                const detailedByContractorData = [];

                Object.keys(contractorGroups).sort().forEach(contractorName => {
                    const expenses = contractorGroups[contractorName];
                    const contractorTotal = expenses.reduce((sum, e) => sum + e.amount, 0);

                    // Add contractor header
                    detailedByContractorData.push({
                        'קבלה': '',
                        'סכום': '',
                        'פרויקט': '',
                        'תיאור': '',
                        'תאריך': '',
                        'קבלן': `=== ${contractorName} ===`
                    });

                    // Add expenses sorted by date
                    const sortedExpenses = [...expenses].sort((a, b) => new Date(b.date) - new Date(a.date));
                    sortedExpenses.forEach(expense => {
                        detailedByContractorData.push({
                            'קבלה': expense.receiptUrl ? 'כן' : 'לא',
                            'סכום': expense.amount,
                            'פרויקט': expense.projectName || 'ללא פרויקט',
                            'תיאור': expense.description || '',
                            'תאריך': new Date(expense.date).toLocaleDateString('he-IL'),
                            'קבלן': ''
                        });
                    });

                    // Add subtotal
                    detailedByContractorData.push({
                        'קבלה': '',
                        'סכום': contractorTotal,
                        'פרויקט': '',
                        'תיאור': `סה"כ ${contractorName}`,
                        'תאריך': '',
                        'קבלן': ''
                    });

                    // Empty row between contractors
                    detailedByContractorData.push({});
                });

                const ws5 = XLSX.utils.json_to_sheet(detailedByContractorData);
                ws5['!cols'] = [
                    { wch: 8 },   // קבלה
                    { wch: 12 }, // סכום
                    { wch: 20 }, // פרויקט
                    { wch: 30 }, // תיאור
                    { wch: 12 }, // תאריך
                    { wch: 25 }  // קבלן
                ];
                XLSX.utils.book_append_sheet(wb, ws5, 'פירוט לפי קבלן');

                // Generate filename with date
                const filename = `expenses_report_${new Date().toISOString().split('T')[0]}.xlsx`;

                // Save the file
                XLSX.writeFile(wb, filename);

                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-file-export"></i> ייצא דוח';
                }
                showSuccess(`דוח Excel עם ${filtered.length} הוצאות יוצא בהצלחה`);

            } catch (error) {
                console.error('Excel export error:', error);
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-file-export"></i> ייצא דוח';
                }
                showError('שגיאה בייצוא Excel: ' + (error.message || 'Unknown error'));
            }
        }

        // Show Projects Tab
        function showProjectsTab(container) {
            const showAddBtn = canUserCreate();
            container.innerHTML = `
                <h2>פרויקטים</h2>
                ${showAddBtn ? `<button class="btn-primary" onclick="showAddProjectForm()">
                    <i class="fas fa-plus"></i> הוסף פרויקט
                </button>` : ''}
                <div class="projects-grid">
                    ${appData.projects.map(project => {
                        // Calculate total expenses for this project (O(1) lookup)
                        const projectExpenses = getExpensesByProject(project.projectId);
                        const totalSpent = projectExpenses.reduce((sum, e) => sum + e.amount, 0);
                        const budget = project.budget || 0;
                        const percentUsed = budget > 0 ? (totalSpent / budget) * 100 : 0;

                        // Determine alert level
                        let alertClass = 'success';
                        let alertIcon = 'fa-check-circle';
                        if (percentUsed >= 90) {
                            alertClass = 'danger';
                            alertIcon = 'fa-exclamation-triangle';
                        } else if (percentUsed >= 75) {
                            alertClass = 'warning';
                            alertIcon = 'fa-exclamation-circle';
                        }

                        return `
                        <div class="card clickable-card" onclick="showProjectDetails('${project.projectId}')">
                            <h3>${project.name}</h3>
                            <p>${project.description || 'אין תיאור'}</p>

                            <!-- Budget Tracking -->
                            <div style="margin-top: 15px; padding: 12px; background: #f8f9fa; border-radius: 6px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="font-size: 0.875rem; color: #64748b;">תקציב:</span>
                                    <span style="font-weight: 600;">₪${budget.toLocaleString('he-IL')}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="font-size: 0.875rem; color: #64748b;">הוצאו:</span>
                                    <span style="font-weight: 600; color: ${alertClass === 'danger' ? '#dc2626' : alertClass === 'warning' ? '#f59e0b' : '#10b981'};">
                                        ₪${totalSpent.toLocaleString('he-IL')}
                                    </span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                    <span style="font-size: 0.875rem; color: #64748b;">נותר:</span>
                                    <span style="font-weight: 600;">₪${(budget - totalSpent).toLocaleString('he-IL')}</span>
                                </div>

                                <!-- Progress Bar -->
                                <div style="background: #e2e8f0; height: 8px; border-radius: 4px; overflow: hidden; margin-bottom: 8px;">
                                    <div style="background: ${alertClass === 'danger' ? '#dc2626' : alertClass === 'warning' ? '#f59e0b' : '#10b981'};
                                               width: ${Math.min(percentUsed, 100)}%; height: 100%; transition: width 0.3s;"></div>
                                </div>

                                <!-- Alert Badge -->
                                <div class="alert-badge ${alertClass}" style="display: inline-flex; align-items: center; gap: 6px;">
                                    <i class="fas ${alertIcon}"></i>
                                    ${percentUsed.toFixed(1)}% בשימוש
                                </div>
                            </div>

                            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e2e8f0;">
                                <button class="btn-edit" onclick="event.stopPropagation(); editProject('${project.projectId}')">ערוך</button>
                                <button class="btn-delete" onclick="event.stopPropagation(); deleteProject('${project.projectId}')">מחק</button>
                            </div>
                        </div>
                    `}).join('')}
                </div>
            `;
        }

        // Delete Functions using Clerk Auth
        async function deleteProject(projectId) {
            if (!confirm('האם אתה בטוח שברצונך למחוק פרויקט זה?')) {
                return;
            }

            try {
                await apiCall(`/projects?projectId=${projectId}`, 'DELETE');
                showSuccess('הפרויקט נמחק בהצלחה');
                await loadAppData();
                refreshCurrentTab();
            } catch (error) {
                showError('שגיאה במחיקת הפרויקט');
            }
        }

        async function deleteExpense(expenseId) {
            if (!confirm('האם אתה בטוח שברצונך למחוק הוצאה זו?')) {
                return;
            }

            try {
                await apiCall(`/expenses?expenseId=${expenseId}`, 'DELETE');
                showSuccess('ההוצאה נמחקה בהצלחה');
                await loadAppData();
                refreshCurrentTab();
            } catch (error) {
                showError('שגיאה במחיקת ההוצאה');
            }
        }

        // Show Contractors Tab
        function showContractorsTab(container) {
            const showAddBtn = canUserCreate();
            // Show all contractors including system contractors
            const allContractors = appData.contractors;
            container.innerHTML = `
                <h2>קבלנים</h2>
                ${showAddBtn ? `<button class="btn-primary" onclick="showAddContractorForm()">
                    <i class="fas fa-plus"></i> הוסף קבלן
                </button>` : ''}
                <table id="contractorsTable">
                    <thead>
                        <tr>
                            <th>שם</th>
                            <th>טלפון</th>
                            <th>התמחות</th>
                            <th>פעולות</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${allContractors.map(contractor => `
                            <tr class="clickable-row" onclick="showContractorDetails('${contractor.contractorId}')">
                                <td>${contractor.name}${contractor.isSystemContractor ? ' <span style="color: #888; font-size: 0.8em;">(ברירת מחדל)</span>' : ''}</td>
                                <td>${contractor.phone || '-'}</td>
                                <td>${contractor.specialty || contractor.speciality || '-'}</td>
                                <td>
                                    ${contractor.isSystemContractor ? '' : `<button class="btn-edit" onclick="event.stopPropagation(); editContractor('${contractor.contractorId}')">ערוך</button>`}
                                    ${contractor.isSystemContractor ? '' : `<button class="btn-delete" onclick="event.stopPropagation(); deleteContractor('${contractor.contractorId}')">מחק</button>`}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                <!-- Mobile Cards View -->
                <div class="contractors-cards-mobile">
                    ${allContractors.map(contractor => `
                        <div class="mobile-card" onclick="showContractorDetails('${contractor.contractorId}')">
                            <div class="mobile-card-header">
                                <div>
                                    <div class="mobile-card-title">${contractor.name}${contractor.isSystemContractor ? ' <span style="color: #888; font-size: 0.8em;">(ברירת מחדל)</span>' : ''}</div>
                                    <div class="mobile-card-subtitle">${contractor.specialty || contractor.speciality || 'לא צוין התמחות'}</div>
                                </div>
                            </div>
                            <div class="mobile-card-details">
                                <div class="mobile-card-detail">
                                    <span>${contractor.phone || 'לא צוין טלפון'}</span>
                                    <i class="fas fa-phone"></i>
                                </div>
                            </div>
                            ${contractor.isSystemContractor ? '' : `
                            <div class="mobile-card-actions">
                                <button class="btn-edit" onclick="event.stopPropagation(); editContractor('${contractor.contractorId}')">
                                    <i class="fas fa-edit"></i> ערוך
                                </button>
                                <button class="btn-delete" onclick="event.stopPropagation(); deleteContractor('${contractor.contractorId}')">
                                    <i class="fas fa-trash"></i> מחק
                                </button>
                            </div>
                            `}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        async function deleteContractor(contractorId) {
            if (!confirm('האם אתה בטוח שברצונך למחוק קבלן זה?')) {
                return;
            }

            try {
                await apiCall(`/contractors?contractorId=${contractorId}`, 'DELETE');
                showSuccess('הקבלן נמחק בהצלחה');
                await loadAppData();
                refreshCurrentTab();
            } catch (error) {
                showError('שגיאה במחיקת הקבלן');
            }
        }

        // Show Works Tab
        function showWorksTab(container) {
            const showAddBtn = canUserCreate();
            const getStatusBadge = (status) => {
                const statusMap = {
                    'planned': { text: 'מתוכנן', class: 'badge-pending' },
                    'in_progress': { text: 'בביצוע', class: 'badge-active' },
                    'completed': { text: 'הושלם', class: 'badge-active' },
                    'cancelled': { text: 'בוטל', class: '' }
                };
                const s = statusMap[status] || statusMap['planned'];
                return `<span class="mobile-card-badge ${s.class}">${s.text}</span>`;
            };

            // Helper to calculate work budget info
            const getWorkBudgetInfo = (work) => {
                const workExpenses = getExpensesByWork(work.workId);
                const totalSpent = workExpenses.reduce((sum, e) => sum + e.amount, 0);
                const budget = work.totalWorkCost || 0;
                const percentUsed = budget > 0 ? (totalSpent / budget) * 100 : 0;
                let alertClass = 'success';
                let alertIcon = 'fa-check-circle';
                if (percentUsed >= 90) {
                    alertClass = 'danger';
                    alertIcon = 'fa-exclamation-triangle';
                } else if (percentUsed >= 75) {
                    alertClass = 'warning';
                    alertIcon = 'fa-exclamation-circle';
                }
                return { totalSpent, budget, percentUsed, alertClass, alertIcon };
            };

            container.innerHTML = `
                <h2>עבודות</h2>
                ${showAddBtn ? `<button class="btn-primary" onclick="showAddWorkForm()">
                    <i class="fas fa-plus"></i> הוסף עבודה
                </button>` : ''}
                <table id="worksTable">
                    <thead>
                        <tr>
                            <th>שם העבודה</th>
                            <th>פרויקט</th>
                            <th>קבלן</th>
                            <th>תקציב</th>
                            <th>סטטוס תקציב</th>
                            <th>פעולות</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${appData.works.map(work => {
                            const { totalSpent, budget, percentUsed, alertClass } = getWorkBudgetInfo(work);
                            const colorStyle = alertClass === 'danger' ? '#dc2626' : alertClass === 'warning' ? '#f59e0b' : '#10b981';
                            return `
                            <tr class="clickable-row" onclick="showWorkDetails('${work.workId}')">
                                <td>${work.workName || '-'}</td>
                                <td>${work.projectName || '-'}</td>
                                <td>${work.contractorName || '-'}</td>
                                <td>₪${budget.toLocaleString('he-IL')}</td>
                                <td>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <div style="flex: 1; background: #e2e8f0; height: 6px; border-radius: 3px; overflow: hidden; min-width: 60px;">
                                            <div style="background: ${colorStyle}; width: ${Math.min(percentUsed, 100)}%; height: 100%;"></div>
                                        </div>
                                        <span style="font-size: 0.75rem; color: ${colorStyle}; white-space: nowrap;">${percentUsed.toFixed(0)}%</span>
                                    </div>
                                </td>
                                <td>
                                    <button class="btn-edit" onclick="event.stopPropagation(); editWork('${work.workId}')">ערוך</button>
                                    <button class="btn-delete" onclick="event.stopPropagation(); deleteWork('${work.workId}')">מחק</button>
                                </td>
                            </tr>
                        `}).join('')}
                    </tbody>
                </table>
                <!-- Mobile Cards View -->
                <div class="works-cards-mobile">
                    ${appData.works.map(work => {
                        const { totalSpent, budget, percentUsed, alertClass, alertIcon } = getWorkBudgetInfo(work);
                        const colorStyle = alertClass === 'danger' ? '#dc2626' : alertClass === 'warning' ? '#f59e0b' : '#10b981';
                        return `
                        <div class="mobile-card" onclick="showWorkDetails('${work.workId}')">
                            <div class="mobile-card-header">
                                <div>
                                    <div class="mobile-card-title">${work.workName || 'עבודה ללא שם'}</div>
                                    <div class="mobile-card-subtitle">${work.projectName || 'ללא פרויקט'}</div>
                                </div>
                                ${getStatusBadge(work.status)}
                            </div>
                            <div class="mobile-card-details">
                                <div class="mobile-card-detail">
                                    <span>${work.contractorName || 'לא צוין קבלן'}</span>
                                    <i class="fas fa-user-hard-hat"></i>
                                </div>
                                <div class="mobile-card-detail">
                                    <span>${work.startDate ? new Date(work.startDate).toLocaleDateString('he-IL') : 'לא צוין תאריך'}</span>
                                    <i class="fas fa-calendar"></i>
                                </div>
                            </div>
                            <!-- Budget Progress Bar -->
                            ${budget > 0 ? `
                            <div style="margin-top: 12px; padding: 10px; background: #f8f9fa; border-radius: 6px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 0.85rem;">
                                    <span style="color: #64748b;">תקציב: ₪${budget.toLocaleString('he-IL')}</span>
                                    <span style="color: ${colorStyle}; font-weight: 600;">₪${totalSpent.toLocaleString('he-IL')} הוצאו</span>
                                </div>
                                <div style="background: #e2e8f0; height: 8px; border-radius: 4px; overflow: hidden; margin-bottom: 6px;">
                                    <div style="background: ${colorStyle}; width: ${Math.min(percentUsed, 100)}%; height: 100%; transition: width 0.3s;"></div>
                                </div>
                                <div style="display: flex; justify-content: space-between; font-size: 0.75rem;">
                                    <span style="color: #64748b;">נותר: ₪${(budget - totalSpent).toLocaleString('he-IL')}</span>
                                    <span class="alert-badge ${alertClass}" style="padding: 2px 6px; border-radius: 4px; display: inline-flex; align-items: center; gap: 4px;">
                                        <i class="fas ${alertIcon}" style="font-size: 0.7rem;"></i>
                                        ${percentUsed.toFixed(1)}%
                                    </span>
                                </div>
                            </div>
                            ` : ''}
                            <div class="mobile-card-actions">
                                <button class="btn-edit" onclick="event.stopPropagation(); editWork('${work.workId}')">
                                    <i class="fas fa-edit"></i> ערוך
                                </button>
                                <button class="btn-delete" onclick="event.stopPropagation(); deleteWork('${work.workId}')">
                                    <i class="fas fa-trash"></i> מחק
                                </button>
                            </div>
                        </div>
                    `}).join('')}
                </div>
            `;
        }

        async function deleteWork(workId) {
            if (!confirm('האם אתה בטוח שברצונך למחוק עבודה זו?')) {
                return;
            }

            try {
                await apiCall(`/works?workId=${workId}`, 'DELETE');
                showSuccess('העבודה נמחקה בהצלחה');
                await loadAppData();
                refreshCurrentTab();
            } catch (error) {
                showError('שגיאה במחיקת העבודה');
            }
        }

        // Details Modal Functions (exposed globally for onclick handlers)
        window.openDetailsModal = function() {
            document.getElementById('detailsModal').classList.add('active');
        }

        window.closeDetailsModal = function(event) {
            if (event && event.target !== event.currentTarget) {
                return;
            }
            document.getElementById('detailsModal').classList.remove('active');
        }

        window.switchModalTab = function(tabName, event) {
            // Update tab buttons
            const tabs = document.querySelectorAll('.modal-tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            if (event && event.target) {
                event.target.closest('.modal-tab').classList.add('active');
            } else {
                // Fallback for programmatic calls
                tabs[0].classList.add('active');
            }

            // Update tab content
            const contents = document.querySelectorAll('.modal-tab-content');
            contents.forEach(content => content.classList.remove('active'));
            document.getElementById(`modalTab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`).classList.add('active');
        }

        window.showProjectDetails = function(projectId) {
            const project = appData.projects.find(p => p.projectId === projectId);
            if (!project) return;

            // Set modal title
            document.getElementById('modalTitle').textContent = project.name;

            // Populate info tab
            document.getElementById('modalTabInfo').innerHTML = `
                <div class="detail-row">
                    <div class="detail-label">שם הפרויקט</div>
                    <div class="detail-value">${project.name}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">תיאור</div>
                    <div class="detail-value">${project.description || 'אין תיאור'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">תקציב</div>
                    <div class="detail-value">₪${(project.budget || 0).toLocaleString('he-IL')}</div>
                </div>
            `;

            // Populate receipts tab (O(1) lookup)
            const projectExpenses = getExpensesByProject(projectId);
            window.renderReceipts(projectExpenses);

            // Reset to info tab
            window.switchModalTab('info');
            const tabs = document.querySelectorAll('.modal-tab');
            tabs[0].classList.add('active');
            tabs[1].classList.remove('active');

            window.openDetailsModal();
        }

        window.showContractorDetails = function(contractorId) {
            const contractor = appData.contractors.find(c => c.contractorId === contractorId);
            if (!contractor) return;

            // Set modal title
            document.getElementById('modalTitle').textContent = contractor.name;

            // Populate info tab
            document.getElementById('modalTabInfo').innerHTML = `
                <div class="detail-row">
                    <div class="detail-label">שם הקבלן</div>
                    <div class="detail-value">${contractor.name}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">טלפון</div>
                    <div class="detail-value">${contractor.phone || '-'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">התמחות</div>
                    <div class="detail-value">${contractor.specialty || contractor.speciality || '-'}</div>
                </div>
            `;

            // Populate receipts tab (O(1) lookup)
            const contractorExpenses = getExpensesByContractor(contractorId);
            window.renderReceipts(contractorExpenses);

            // Reset to info tab
            window.switchModalTab('info');
            const tabs = document.querySelectorAll('.modal-tab');
            tabs[0].classList.add('active');
            tabs[1].classList.remove('active');

            window.openDetailsModal();
        }

        window.showWorkDetails = function(workId) {
            const work = appData.works.find(w => w.workId === workId);
            if (!work) return;

            // Set modal title
            document.getElementById('modalTitle').textContent = work.workName || 'עבודה';

            // Populate info tab
            document.getElementById('modalTabInfo').innerHTML = `
                <div class="detail-row">
                    <div class="detail-label">שם העבודה</div>
                    <div class="detail-value">${work.workName || '-'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">פרויקט</div>
                    <div class="detail-value">${work.projectName || '-'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">קבלן</div>
                    <div class="detail-value">${work.contractorName || '-'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">תאריך התחלה</div>
                    <div class="detail-value">${work.startDate ? new Date(work.startDate).toLocaleDateString('he-IL') : '-'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">סטטוס</div>
                    <div class="detail-value">${work.status || 'planned'}</div>
                </div>
            `;

            // Populate receipts tab
            const workExpenses = appData.expenses.filter(e => e.workId === workId);
            window.renderReceipts(workExpenses);

            // Reset to info tab
            window.switchModalTab('info');
            const tabs = document.querySelectorAll('.modal-tab');
            tabs[0].classList.add('active');
            tabs[1].classList.remove('active');

            window.openDetailsModal();
        }

        window.renderReceipts = function(expenses) {
            const receiptsContainer = document.getElementById('modalTabReceipts');

            if (expenses.length === 0) {
                receiptsContainer.innerHTML = `
                    <div class="no-receipts">
                        <i class="fas fa-receipt"></i>
                        <p>אין קבלות קשורות</p>
                    </div>
                `;
                return;
            }

            receiptsContainer.innerHTML = `
                <div class="receipts-grid">
                    ${expenses.map(expense => `
                        <div class="receipt-card">
                            <div class="receipt-date">${new Date(expense.date).toLocaleDateString('he-IL')}</div>
                            <div class="receipt-description">${expense.description}</div>
                            <div class="receipt-amount">₪${expense.amount.toLocaleString('he-IL')}</div>
                            ${expense.receiptUrl
                                ? `<a href="${expense.receiptUrl}" target="_blank" class="receipt-image-link">
                                    <i class="fas fa-file-image"></i> צפה בקבלה
                                   </a>`
                                : '<span style="color: #94a3b8; font-size: 0.875rem;">אין קבלה</span>'}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Show Reports Tab
        function showReportsTab(container) {
            container.innerHTML = `
                <h2>דוחות וניתוחים</h2>

                <!-- Period Selector -->
                <div class="period-selector-bar">
                    <div class="period-selector-group">
                        <button class="period-preset-btn" data-period="thisMonth">החודש</button>
                        <button class="period-preset-btn" data-period="last3Months">3 חודשים</button>
                        <button class="period-preset-btn active" data-period="last6Months">6 חודשים</button>
                        <button class="period-preset-btn" data-period="thisYear">שנה נוכחית</button>
                        <button class="period-preset-btn" data-period="all">הכל</button>
                    </div>
                    <button class="export-reports-btn" onclick="exportReportsPDF()">
                        <i class="fas fa-download"></i> ייצוא PDF
                    </button>
                </div>

                <!-- Metrics Section -->
                <div class="metrics-layout">
                    <!-- Left: Hero Card -->
                    <div class="metric-card-hero animate-fade-in">
                        <div class="metric-hero-header">
                            <div class="metric-icon-hero">
                                <i class="fas fa-coins"></i>
                            </div>
                            <div class="metric-hero-label">סה"כ הוצאות</div>
                        </div>
                        <div class="metric-hero-value" id="report-total-expenses">₪0</div>
                        <div class="metric-hero-change neutral" id="report-expense-change-hero">
                            <span>טוען...</span>
                        </div>
                        <div class="metric-hero-footer">
                            <div class="metric-mini">
                                <span class="metric-mini-label">מעודכן</span>
                                <span class="metric-mini-value" id="last-updated-time">--:--</span>
                            </div>
                        </div>
                    </div>

                    <!-- Right: Financial Overview -->
                    <div class="metric-card-group animate-fade-in" style="animation-delay: 0.1s;">
                        <div class="metric-group-header">
                            <h3 class="metric-group-title">סיכום כספי</h3>
                            <button class="metric-group-action" title="מידע נוסף">
                                <i class="fas fa-info-circle"></i>
                            </button>
                        </div>
                        <div class="metric-group-grid">
                            <div class="metric-group-item">
                                <div class="metric-item-header">
                                    <div class="metric-icon-sm purple">
                                        <i class="fas fa-calendar"></i>
                                    </div>
                                    <span class="metric-item-label">הוצאות החודש</span>
                                </div>
                                <div class="metric-item-value" id="report-monthly-expenses">₪0</div>
                                <div class="metric-item-change positive" id="monthly-expense-change">
                                    <i class="fas fa-arrow-up"></i> --
                                </div>
                            </div>
                            <div class="metric-group-divider"></div>
                            <div class="metric-group-item">
                                <div class="metric-item-header">
                                    <div class="metric-icon-sm orange">
                                        <i class="fas fa-percent"></i>
                                    </div>
                                    <span class="metric-item-label">סה"כ מע"מ (18%)</span>
                                </div>
                                <div class="metric-item-value" id="report-total-vat">₪0</div>
                                <div class="metric-item-badge" id="monthly-vat-badge">
                                    מתוך החודש: ₪0
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Performance Metrics Row -->
                <div class="metric-card-row animate-fade-in" style="animation-delay: 0.2s;">
                    <div class="metric-card-compact">
                        <div class="metric-compact-icon green">
                            <i class="fas fa-project-diagram"></i>
                        </div>
                        <div class="metric-compact-content">
                            <div class="metric-compact-label">פרויקטים פעילים</div>
                            <div class="metric-compact-value" id="report-active-projects">0</div>
                            <div class="metric-compact-subtext" id="total-projects-text">מתוך 0 סה"כ</div>
                        </div>
                    </div>
                    <div class="metric-card-compact">
                        <div class="metric-compact-icon orange">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="metric-compact-content">
                            <div class="metric-compact-label">ממוצע הוצאה</div>
                            <div class="metric-compact-value" id="report-avg-expense">₪0</div>
                            <div class="metric-compact-change positive" id="avg-expense-change">
                                <i class="fas fa-arrow-up"></i> --
                            </div>
                        </div>
                    </div>
                    <div class="metric-card-compact">
                        <div class="metric-compact-icon blue">
                            <i class="fas fa-wallet"></i>
                        </div>
                        <div class="metric-compact-content">
                            <div class="metric-compact-label">סה"כ הוצאות/פרויקט</div>
                            <div class="metric-compact-value" id="expense-per-project">₪0</div>
                            <div class="metric-progress-bar">
                                <div class="metric-progress-fill" id="budget-progress" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts Row -->
                <div class="charts-grid animate-fade-in" style="animation-delay: 0.3s;">
                    <div class="chart-container-enhanced">
                        <div class="chart-header-enhanced">
                            <div class="chart-title-group">
                                <h3 class="chart-title-enhanced">מגמת הוצאות</h3>
                                <span class="chart-subtitle" id="trend-chart-subtitle">6 חודשים אחרונים</span>
                            </div>
                            <div class="chart-controls">
                                <button class="chart-control-btn" data-months="3" onclick="updateTrendChart(3)">3 חודשים</button>
                                <button class="chart-control-btn active" data-months="6" onclick="updateTrendChart(6)">6 חודשים</button>
                                <button class="chart-control-btn" data-months="12" onclick="updateTrendChart(12)">שנה</button>
                            </div>
                        </div>
                        <div class="chart-canvas-wrapper">
                            <canvas id="expenseTrendChart"></canvas>
                        </div>
                        <div class="chart-footer">
                            <div class="chart-legend-custom">
                                <div class="legend-item">
                                    <span class="legend-color" style="background: #3b82f6;"></span>
                                    <span class="legend-label">הוצאות</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="chart-container-enhanced">
                        <div class="chart-header-enhanced">
                            <div class="chart-title-group">
                                <h3 class="chart-title-enhanced">התפלגות הוצאות לפי פרויקט</h3>
                                <span class="chart-subtitle">התקופה הנוכחית</span>
                            </div>
                        </div>
                        <div class="chart-canvas-wrapper">
                            <canvas id="projectDistributionChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Report Categories -->
                <h3 class="section-title-reports">דוחות מפורטים</h3>
                <div class="reports-grid animate-fade-in" style="animation-delay: 0.4s;">
                    <div class="report-card" onclick="showProjectBudgetReport()">
                        <div class="report-icon">
                            <i class="fas fa-chart-bar"></i>
                        </div>
                        <div class="report-title">תקציב פרויקטים</div>
                        <div class="report-description">השוואת תקציב מול הוצאות בפועל לכל פרויקט</div>
                    </div>
                    <div class="report-card" onclick="showContractorReport()">
                        <div class="report-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="report-title">ניתוח קבלנים</div>
                        <div class="report-description">סיכום הוצאות לפי קבלן ופרטי ביצועים</div>
                    </div>
                    <div class="report-card" onclick="showMonthlyReport()">
                        <div class="report-icon">
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                        <div class="report-title">סיכום חודשי</div>
                        <div class="report-description">דוח הוצאות חודשי עם השוואה לחודש הקודם</div>
                    </div>
                    <div class="report-card" onclick="showMissingReceiptsReport()">
                        <div class="report-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="report-title">קבלות חסרות</div>
                        <div class="report-description">רשימת הוצאות ללא תמונת קבלה</div>
                    </div>
                </div>
            `;

            // Initialize dashboard data
            initializeReportsDashboard();

            // Initialize period selector
            initializePeriodSelector();
        }

        // Show Billing Tab (Paddle Billing)
        async function showBillingTab(container) {
            container.innerHTML = `
                <h2>חיוב ומנוי</h2>

                <!-- Current Subscription Status -->
                <div class="card" style="margin-bottom: 24px;">
                    <h3 style="margin-bottom: 20px; color: #2c3e50;">
                        <i class="fas fa-credit-card"></i> המנוי שלך
                    </h3>
                    <div id="currentSubscriptionStatus">
                        <div style="text-align: center; padding: 20px; color: #666;">
                            <i class="fas fa-spinner fa-spin"></i> טוען מצב מנוי...
                        </div>
                    </div>
                </div>

                <!-- Usage Metrics -->
                <div class="card" style="margin-bottom: 24px;">
                    <h3 style="margin-bottom: 20px; color: #2c3e50;">
                        <i class="fas fa-chart-bar"></i> שימוש נוכחי
                    </h3>
                    <div id="currentUsageMetrics">
                        <div style="text-align: center; padding: 20px; color: #666;">
                            <i class="fas fa-spinner fa-spin"></i> טוען נתוני שימוש...
                        </div>
                    </div>
                </div>

                <!-- Available Plans -->
                <div class="card">
                    <h3 style="margin-bottom: 20px; color: #2c3e50;">
                        <i class="fas fa-layer-group"></i> תוכניות זמינות
                    </h3>
                    <div id="availablePlansGrid">
                        <div style="text-align: center; padding: 20px; color: #666;">
                            <i class="fas fa-spinner fa-spin"></i> טוען תוכניות...
                        </div>
                    </div>
                </div>
            `;

            // Load subscription data
            await loadCurrentSubscription();
            await loadCurrentUsage();
            await loadAvailablePlans();
        }

        // Load current subscription status
        async function loadCurrentSubscription() {
            const statusContainer = document.getElementById('currentSubscriptionStatus');
            if (!statusContainer) return;

            try {
                // Get current company data
                const currentTier = appData.company?.subscriptionTier || 'starter';
                const subscriptionStatus = appData.company?.subscriptionStatus || 'active';

                // Tier information from tier-config.js
                const tiers = {
                    starter: { name: 'בסיסי', price: 100, color: '#3498db' },
                    professional: { name: 'מקצועי', price: 200, color: '#34495e' },
                    enterprise: { name: 'ארגוני', price: 300, color: '#27ae60' }
                };

                const currentTierInfo = tiers[currentTier] || tiers.starter;

                statusContainer.innerHTML = `
                    <div class="subscription-status-row" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px;">
                        <div>
                            <div style="font-size: 1.8rem; font-weight: bold; color: ${currentTierInfo.color}; margin-bottom: 8px;">
                                ${currentTierInfo.name}
                            </div>
                            <div style="font-size: 2.5rem; font-weight: bold; color: #2c3e50;">
                                ₪${currentTierInfo.price}<span style="font-size: 1rem; color: #666; font-weight: normal;"> / חודש</span>
                            </div>
                        </div>
                        <div style="text-align: left;">
                            <div style="background: ${['active', 'trialing'].includes(subscriptionStatus) ? '#27ae60' : '#e74c3c'}; color: white; padding: 8px 20px; border-radius: 20px; font-weight: 600; margin-bottom: 10px;">
                                ${['active', 'trialing'].includes(subscriptionStatus) ? '✓ פעיל' : '✗ לא פעיל'}
                            </div>
                            <button class="btn-secondary" onclick="managePaddleBilling()" style="white-space: nowrap;">
                                <i class="fas fa-cog"></i> נהל פרטי תשלום
                            </button>
                        </div>
                    </div>
                `;

            } catch (error) {
                console.error('Error loading subscription:', error);
                statusContainer.innerHTML = `
                    <div style="color: #e74c3c; text-align: center; padding: 20px;">
                        שגיאה בטעינת מצב המנוי
                    </div>
                `;
            }
        }

        // Load current usage metrics
        async function loadCurrentUsage() {
            const usageContainer = document.getElementById('currentUsageMetrics');
            if (!usageContainer) return;

            try {
                const currentTier = appData.company?.subscriptionTier || 'starter';

                // Get limits from tier-config
                const tierLimits = {
                    starter: { maxUsers: 1, maxProjects: 3, maxExpensesPerMonth: 50 },
                    professional: { maxUsers: 3, maxProjects: 10, maxExpensesPerMonth: -1 },
                    enterprise: { maxUsers: 10, maxProjects: -1, maxExpensesPerMonth: -1 }
                };

                const limits = tierLimits[currentTier];

                // Calculate current usage
                const currentUsers = appData.users?.length || 1;
                const currentProjects = appData.projects?.length || 0;
                const currentExpenses = appData.expenses?.filter(e => {
                    const expenseDate = new Date(e.date);
                    const now = new Date();
                    return expenseDate.getMonth() === now.getMonth() &&
                           expenseDate.getFullYear() === now.getFullYear();
                }).length || 0;

                usageContainer.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                        ${createUsageCard('משתמשים', currentUsers, limits.maxUsers, 'fa-users', '#3498db')}
                        ${createUsageCard('פרויקטים', currentProjects, limits.maxProjects, 'fa-project-diagram', '#34495e')}
                        ${createUsageCard('הוצאות החודש', currentExpenses, limits.maxExpensesPerMonth, 'fa-receipt', '#27ae60')}
                    </div>
                `;

            } catch (error) {
                console.error('Error loading usage:', error);
                usageContainer.innerHTML = `
                    <div style="color: #e74c3c; text-align: center; padding: 20px;">
                        שגיאה בטעינת נתוני שימוש
                    </div>
                `;
            }
        }

        // Create usage card HTML
        function createUsageCard(label, current, max, icon, color) {
            const isUnlimited = max === -1;
            const percentage = isUnlimited ? 0 : Math.min((current / max) * 100, 100);
            const isNearLimit = percentage >= 80;

            return `
                <div style="background: #f8f9fa; border-radius: 8px; padding: 20px;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
                        <i class="fas ${icon}" style="font-size: 1.5rem; color: ${color};"></i>
                        <div style="font-weight: 600; color: #2c3e50;">${label}</div>
                    </div>
                    <div style="font-size: 2rem; font-weight: bold; color: #2c3e50; margin-bottom: 8px;">
                        ${current}${isUnlimited ? '' : ' / ' + max}
                    </div>
                    ${isUnlimited ? `
                        <div style="color: #27ae60; font-weight: 600;">
                            <i class="fas fa-infinity"></i> ללא הגבלה
                        </div>
                    ` : `
                        <div style="background: #e2e8f0; border-radius: 10px; height: 8px; overflow: hidden; margin-bottom: 8px;">
                            <div style="background: ${isNearLimit ? '#e74c3c' : color}; height: 100%; width: ${percentage}%; transition: width 0.3s;"></div>
                        </div>
                        <div style="color: ${isNearLimit ? '#e74c3c' : '#666'}; font-size: 0.9rem; font-weight: ${isNearLimit ? '600' : 'normal'};">
                            ${isNearLimit ? '⚠️ מתקרב למגבלה' : Math.round(percentage) + '%'}
                        </div>
                    `}
                </div>
            `;
        }

        // Load available plans for upgrade/downgrade
        async function loadAvailablePlans() {
            const plansContainer = document.getElementById('availablePlansGrid');
            if (!plansContainer) return;

            try {
                const currentTier = appData.company?.subscriptionTier || 'starter';

                const plans = [
                    {
                        id: 'starter',
                        name: 'בסיסי',
                        price: 100,
                        features: [
                            'משתמש אחד',
                            'עד 3 פרויקטים',
                            'עד 50 הוצאות בחודש',
                            'ספקים ללא הגבלה',
                            'עבודות ללא הגבלה',
                            'ייצוא דוחות PDF',
                            'דשבורד ניתוח'
                        ]
                    },
                    {
                        id: 'professional',
                        name: 'מקצועי',
                        price: 200,
                        featured: true,
                        features: [
                            'עד 3 משתמשים',
                            'עד 10 פרויקטים',
                            'הוצאות ללא הגבלה',
                            'ספקים ללא הגבלה',
                            'עבודות ללא הגבלה',
                            'ייצוא PDF מתקדם',
                            'תמיכה מועדפת'
                        ]
                    },
                    {
                        id: 'enterprise',
                        name: 'ארגוני',
                        price: 300,
                        features: [
                            'עד 10 משתמשים',
                            'פרויקטים ללא הגבלה',
                            'הוצאות ללא הגבלה',
                            'ספקים ללא הגבלה',
                            'עבודות ללא הגבלה',
                            'ייצוא PDF מתקדם',
                            'גיבויים אוטומטיים',
                            'תמיכה מועדפת'
                        ]
                    }
                ];

                plansContainer.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 24px; margin-top: 20px;">
                        ${plans.map(plan => `
                            <div class="billing-plan-card ${plan.id === currentTier ? 'current-plan' : ''} ${plan.featured ? 'featured-plan' : ''}" style="
                                background: white;
                                border: ${plan.id === currentTier ? '3px solid #27ae60' : plan.featured ? '3px solid #34495e' : '2px solid #e2e8f0'};
                                border-radius: 12px;
                                padding: 24px;
                                position: relative;
                                display: flex;
                                flex-direction: column;
                                transition: transform 0.3s, box-shadow 0.3s;
                            ">
                                ${plan.id === currentTier ? `
                                    <div style="position: absolute; top: -12px; right: 50%; transform: translateX(50%); background: #27ae60; color: white; padding: 6px 16px; border-radius: 16px; font-size: 0.85rem; font-weight: 600;">
                                        התוכנית הנוכחית שלך
                                    </div>
                                ` : plan.featured ? `
                                    <div style="position: absolute; top: -12px; right: 50%; transform: translateX(50%); background: #34495e; color: white; padding: 6px 16px; border-radius: 16px; font-size: 0.85rem; font-weight: 600;">
                                        המומלץ ביותר
                                    </div>
                                ` : ''}

                                <div style="font-size: 1.5rem; font-weight: bold; color: #2c3e50; margin-bottom: 12px; ${plan.id === currentTier || plan.featured ? 'margin-top: 12px;' : ''}">
                                    ${plan.name}
                                </div>
                                <div style="font-size: 2.5rem; font-weight: bold; color: #34495e; margin-bottom: 20px;">
                                    ₪${plan.price}<span style="font-size: 1rem; color: #666; font-weight: normal;"> / חודש</span>
                                </div>

                                <ul style="list-style: none; padding: 0; margin: 0 0 24px 0; flex-grow: 1;">
                                    ${plan.features.map(feature => `
                                        <li style="padding: 8px 0; color: #555; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #f0f0f0;">
                                            <i class="fas fa-check" style="color: #27ae60; font-size: 1rem;"></i>
                                            <span>${feature}</span>
                                        </li>
                                    `).join('')}
                                </ul>

                                ${plan.id === currentTier ? `
                                    <button class="btn-secondary" disabled style="width: 100%; opacity: 0.6; cursor: not-allowed;">
                                        התוכנית הנוכחית
                                    </button>
                                ` : `
                                    <button class="btn-primary" onclick="changePlanTo('${plan.id}')" style="width: 100%;">
                                        ${getPlanChangeAction(currentTier, plan.id)} ל${plan.name}
                                    </button>
                                `}
                            </div>
                        `).join('')}
                    </div>

                    <div style="margin-top: 24px; padding: 20px; background: #f8f9fa; border-radius: 8px; border-right: 4px solid #34495e;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px;">
                            <i class="fas fa-info-circle" style="color: #34495e; font-size: 1.2rem;"></i>
                            <strong style="color: #2c3e50;">מידע חשוב</strong>
                        </div>
                        <ul style="margin-right: 28px; color: #555; line-height: 1.8;">
                            <li>שדרוג נכנס לתוקף מיידית עם חיוב יחסי</li>
                            <li>הורדה בדרגה תיכנס לתוקף בתום תקופת החיוב הנוכחית</li>
                            <li>כל התשלומים מעובדים באמצעות Paddle.com</li>
                            <li>ניתן לבטל בכל עת - ראה <a href="refund.html" target="_blank" style="color: #34495e; font-weight: 600;">מדיניות ביטולים</a></li>
                        </ul>
                    </div>
                `;

            } catch (error) {
                console.error('Error loading plans:', error);
                plansContainer.innerHTML = `
                    <div style="color: #e74c3c; text-align: center; padding: 20px;">
                        שגיאה בטעינת תוכניות זמינות
                    </div>
                `;
            }
        }

        // Get action text for plan change (upgrade/downgrade)
        function getPlanChangeAction(currentPlan, targetPlan) {
            const tierOrder = { starter: 1, professional: 2, enterprise: 3 };
            const current = tierOrder[currentPlan] || 1;
            const target = tierOrder[targetPlan] || 1;

            if (target > current) {
                return 'שדרג';
            } else if (target < current) {
                return 'שנמך';
            }
            return 'עבור';
        }

        // Change plan (upgrade or downgrade)
        async function changePlanTo(newPlan) {
            const currentTier = appData.company?.subscriptionTier || 'starter';
            const tierOrder = { starter: 1, professional: 2, enterprise: 3 };
            const isUpgrade = tierOrder[newPlan] > tierOrder[currentTier];

            const planNames = {
                starter: 'בסיסי',
                professional: 'מקצועי',
                enterprise: 'ארגוני'
            };

            const actionText = isUpgrade ? 'לשדרג' : 'להוריד בדרגה';
            const confirmMessage = isUpgrade
                ? `האם אתה בטוח שברצונך לשדרג לתוכנית ${planNames[newPlan]}?\n\nהשדרוג ייכנס לתוקף מיידית ותחויב באופן יחסי.`
                : `האם אתה בטוח שברצונך להוריד לתוכנית ${planNames[newPlan]}?\n\nההורדה בדרגה תיכנס לתוקף בתום תקופת החיוב הנוכחית.`;

            if (!confirm(confirmMessage)) {
                return;
            }

            try {
                // If company exists, ALWAYS use API update path for tier changes
                // Never create new subscriptions for existing companies (prevents duplicate subscriptions)
                const hasExistingCompany = appData.company?.companyId;

                console.log('[TIER CHANGE] Decision factors:', {
                    hasCompany: hasExistingCompany,
                    currentTier: currentTier,
                    targetTier: newPlan,
                    companyId: appData.company?.companyId
                });

                if (hasExistingCompany) {
                    // EXISTING COMPANY: Always use API update path (upgrade/downgrade existing subscription)
                    console.log('[TIER CHANGE] Company exists - using API update path for:', newPlan);

                    const updateData = {
                        newTier: newPlan
                    };

                    const response = await apiCall('/update-paddle-subscription', 'POST', updateData);

                    if (response.success) {
                        // Update the appData immediately for instant UI feedback
                        if (appData.company && response.subscription) {
                            appData.company.subscriptionTier = response.subscription.currentTier;
                            console.log('[UPGRADE] Updated tier immediately to:', response.subscription.currentTier);
                        }

                        showSuccess(`המנוי עודכן בהצלחה ל-${planNames[newPlan]}!`);

                        // Refresh company data and billing tab to show new tier
                        setTimeout(async () => {
                            await loadAppData(); // Wait for data to load
                            showTab('billing'); // This will trigger a full billing tab re-render
                            console.log('[TIER CHANGE] Page refreshed with new tier');
                        }, 1500);
                    } else {
                        throw new Error(response.message || 'Failed to update subscription');
                    }

                } else {
                    // NO COMPANY EXISTS: Open Paddle checkout for NEW customer onboarding
                    // This should ONLY happen during initial registration/onboarding
                    console.log('[TIER CHANGE] No company exists - opening checkout for new customer onboarding:', newPlan);

                    const companyName = appData.company?.companyName || 'החברה שלי';
                    const checkoutData = {
                        companyName: companyName,
                        subscriptionTier: newPlan
                    };

                    const response = await apiCall('/create-paddle-checkout', 'POST', checkoutData);

                    if (!response.success || !response.paddleConfig) {
                        throw new Error('לא התקבל תצורת Paddle תקינה');
                    }

                    const { paddleConfig } = response;

                    if (typeof Paddle === 'undefined') {
                        throw new Error('Paddle.js לא נטען. אנא רענן את הדף ונסה שנית.');
                    }

                    Paddle.Environment.set(paddleConfig.environment || 'production');
                    Paddle.Initialize({
                        token: paddleConfig.token,
                        eventCallback: function(data) {
                            console.log('Paddle event:', data);
                        }
                    });

                    console.log('[UPGRADE FLOW] Opening Paddle checkout with successCallback registered');

                    Paddle.Checkout.open({
                        items: [{
                            priceId: paddleConfig.priceId,
                            quantity: 1
                        }],
                        customer: paddleConfig.customerEmail ? {
                            email: paddleConfig.customerEmail
                        } : undefined,
                        customData: paddleConfig.customData,
                        settings: {
                            displayMode: "overlay",
                            theme: "light",
                            locale: "he"
                        }
                    });

                    // ALTERNATIVE APPROACH: Listen to global checkout.completed event
                    // and handle it THERE since successCallback isn't firing
                    console.log('[UPGRADE FLOW] Checkout opened. Will handle completion via global eventCallback.');
                }

            } catch (error) {
                console.error('Error changing plan:', error);
                showError(`שגיאה ב${actionText} המנוי: ${error.message}`);
            }
        }

        // Manage billing info via Paddle
        async function managePaddleBilling() {
            try {
                // Get company subscription data from the correct location
                const subscriptionId = appData.paddleSubscription?.info?.subscriptionId;
                const paddleCustomerId = appData.paddleSubscription?.info?.paddleCustomerId;

                if (!subscriptionId) {
                    showError('לא נמצא מנוי פעיל. אנא פנה לתמיכה לקבלת עזרה.');
                    return;
                }

                // Paddle Billing doesn't provide a direct customer portal URL
                // Redirect to email support with subscription details
                const subject = encodeURIComponent('בקשה לניהול מנוי והתשלומים');
                const body = encodeURIComponent(
                    `שלום,\n\n` +
                    `אני מעוניין לנהל את המנוי שלי:\n` +
                    `מספר מנוי: ${subscriptionId}\n` +
                    `מספר לקוח Paddle: ${paddleCustomerId}\n\n` +
                    `אשמח לקבל עזרה בנושאים הבאים:\n` +
                    `☐ עדכון פרטי כרטיס אשראי\n` +
                    `☐ הורדת קבלות\n` +
                    `☐ שינוי תוכנית מנוי\n` +
                    `☐ ביטול מנוי\n` +
                    `☐ אחר: _______\n\n` +
                    `תודה רבה!`
                );

                // Open default email client with pre-filled message
                window.location.href = `mailto:maordaniel40@gmail.com?subject=${subject}&body=${body}`;

            } catch (error) {
                console.error('Error opening billing portal:', error);
                showError('שגיאה בפתיחת דף ניהול התשלום');
            }
        }

        // Show Users Tab
        async function showUsersTab(container) {
            container.innerHTML = `
                <div class="users-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">ניהול משתמשים</h2>
                    <button class="btn-primary" onclick="showInviteUserModal()">
                        <i class="fas fa-user-plus"></i> שלח הזמנה
                    </button>
                </div>

                <!-- Tab Switcher -->
                <div class="users-tab-switcher" style="background: white; padding: 8px; border-radius: 8px; margin-bottom: 20px; display: inline-flex; gap: 4px; border: 1px solid #e2e8f0;">
                    <button id="activeUsersBtn" class="btn-secondary" onclick="switchUsersView('active')" style="padding: 8px 16px;">
                        <i class="fas fa-user-check"></i> משתמשים פעילים
                    </button>
                    <button id="pendingInvitationsBtn" class="btn-secondary" onclick="switchUsersView('pending')" style="padding: 8px 16px;">
                        <i class="fas fa-envelope"></i> הזמנות ממתינות
                    </button>
                </div>

                <!-- Active Users Table -->
                <div id="activeUsersView" style="display: block;">
                    <table id="usersTable">
                        <thead>
                            <tr>
                                <th>שם</th>
                                <th>אימייל</th>
                                <th>טלפון</th>
                                <th>תפקיד</th>
                                <th>תאריך הצטרפות</th>
                                <th>פעולות</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 20px; color: #666;">
                                    <i class="fas fa-spinner fa-spin"></i> טוען משתמשים...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <!-- Mobile Cards View -->
                    <div class="users-cards-mobile" id="usersCardsMobile">
                        <div style="text-align: center; padding: 20px; color: #666;">
                            <i class="fas fa-spinner fa-spin"></i> טוען משתמשים...
                        </div>
                    </div>
                </div>

                <!-- Pending Invitations Table -->
                <div id="pendingInvitationsView" style="display: none;">
                    <table id="invitationsTable">
                        <thead>
                            <tr>
                                <th>אימייל</th>
                                <th>שם</th>
                                <th>טלפון</th>
                                <th>תפקיד</th>
                                <th>תאריך שליחה</th>
                                <th>פעולות</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 20px; color: #666;">
                                    <i class="fas fa-spinner fa-spin"></i> טוען הזמנות...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <!-- Mobile Cards View -->
                    <div class="invitations-cards-mobile" id="invitationsCardsMobile">
                        <div style="text-align: center; padding: 20px; color: #666;">
                            <i class="fas fa-spinner fa-spin"></i> טוען הזמנות...
                        </div>
                    </div>
                </div>
            `;

            // Load initial data
            await loadActiveUsers();
            await loadPendingInvitations();
            switchUsersView('active');
        }

        // Switch between active users and pending invitations
        function switchUsersView(view) {
            const activeBtn = document.getElementById('activeUsersBtn');
            const pendingBtn = document.getElementById('pendingInvitationsBtn');
            const activeView = document.getElementById('activeUsersView');
            const pendingView = document.getElementById('pendingInvitationsView');

            if (view === 'active') {
                activeBtn.style.background = '#3182ce';
                activeBtn.style.color = 'white';
                pendingBtn.style.background = 'white';
                pendingBtn.style.color = '#3182ce';
                activeView.style.display = 'block';
                pendingView.style.display = 'none';
            } else {
                activeBtn.style.background = 'white';
                activeBtn.style.color = '#3182ce';
                pendingBtn.style.background = '#3182ce';
                pendingBtn.style.color = 'white';
                activeView.style.display = 'none';
                pendingView.style.display = 'block';
            }
        }

        // Show invite user modal with tier limit check
        async function showInviteUserModal() {
            // Check tier limits
            const currentTier = appData.company?.subscriptionTier || 'starter';
            const tierLimits = {
                starter: { maxUsers: 1 },
                professional: { maxUsers: 3 },
                enterprise: { maxUsers: 10 }
            };

            const currentUsers = appData.users?.length || 1;
            const maxUsers = tierLimits[currentTier].maxUsers;

            if (currentUsers >= maxUsers) {
                showUpgradeModal({
                    resource: 'users',
                    current: currentUsers,
                    max: maxUsers,
                    tier: currentTier
                });
                return;
            }

            // Show modal
            document.getElementById('inviteUserModal').style.display = 'block';
        }

        // Send invitation
        async function sendInvitation(event) {
            event.preventDefault();

            const email = document.getElementById('inviteEmail').value.trim();
            const name = document.getElementById('inviteName').value.trim();
            const phone = document.getElementById('invitePhone').value.trim();
            const role = document.getElementById('inviteRole').value;

            if (!email || !name || !phone || !role) {
                showError('נא למלא את כל השדות');
                return;
            }

            // Validate phone format (Israeli format)
            const phoneRegex = /^0\d{1,2}-?\d{7}$/;
            if (!phoneRegex.test(phone)) {
                showError('מספר טלפון לא תקין. נא להזין מספר ישראלי תקני (למשל: 050-1234567)');
                return;
            }

            try {
                const response = await fetch(`${window.API_BASE_URL}/sendInvitation`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${await ClerkAuth.getAuthToken()}`
                    },
                    body: JSON.stringify({ email, name, phone, role })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || 'שגיאה בשליחת ההזמנה');
                }

                showSuccess('ההזמנה נשלחה בהצלחה!');
                closeModal('inviteUserModal');
                await loadPendingInvitations();
                switchUsersView('pending');

            } catch (error) {
                console.error('Error sending invitation:', error);
                showError(error.message || 'שגיאה בשליחת ההזמנה');
            }
        }

        // Load active users
        async function loadActiveUsers() {
            try {
                const response = await fetch(`${window.API_BASE_URL}/listUsers`, {
                    headers: {
                        'Authorization': `Bearer ${await ClerkAuth.getAuthToken()}`
                    }
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || 'שגיאה בטעינת משתמשים');
                }

                const tbody = document.querySelector('#usersTable tbody');
                if (!tbody) return;

                if (!data.users || data.users.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px; color: #666;">
                                <i class="fas fa-users" style="font-size: 48px; opacity: 0.3; margin-bottom: 15px; display: block;"></i>
                                <p style="margin: 0;">אין משתמשים פעילים</p>
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = data.users.map(user => {
                    const roleClass = `role-${user.role || 'viewer'}`;
                    const roleText = {
                        admin: 'מנהל',
                        editor: 'עורך',
                        viewer: 'צופה'
                    }[user.role] || 'צופה';

                    return `
                        <tr>
                            <td>${user.name || '-'}</td>
                            <td>${user.email}</td>
                            <td>${user.phone || '-'}</td>
                            <td><span class="role-badge ${roleClass}">${roleText}</span></td>
                            <td>${user.joinedAt ? new Date(user.joinedAt).toLocaleDateString('he-IL') : '-'}</td>
                            <td>
                                ${user.userId !== appData.company?.ownerId ?
                                    `<button class="btn-delete" onclick="removeUser('${user.userId}', '${user.email}')">הסר</button>` :
                                    '<span style="color: #718096; font-size: 0.875rem;">בעלים</span>'}
                            </td>
                        </tr>
                    `;
                }).join('');

                // Update mobile cards view
                const mobileCardsContainer = document.getElementById('usersCardsMobile');
                if (mobileCardsContainer) {
                    mobileCardsContainer.innerHTML = data.users.map(user => {
                        const roleClass = `role-${user.role || 'viewer'}`;
                        const roleText = {
                            admin: 'מנהל',
                            editor: 'עורך',
                            viewer: 'צופה'
                        }[user.role] || 'צופה';
                        const isOwner = user.userId === appData.company?.ownerId;

                        return `
                            <div class="mobile-card">
                                <div class="mobile-card-header">
                                    <div class="mobile-card-title">${user.name || '-'}</div>
                                    <span class="role-badge ${roleClass}">${roleText}</span>
                                </div>
                                <div class="mobile-card-details">
                                    <div class="mobile-card-detail">
                                        <span class="mobile-card-label">אימייל:</span>
                                        <span class="mobile-card-value">${user.email}</span>
                                    </div>
                                    ${user.phone ? `
                                    <div class="mobile-card-detail">
                                        <span class="mobile-card-label">טלפון:</span>
                                        <span class="mobile-card-value">${user.phone}</span>
                                    </div>
                                    ` : ''}
                                    <div class="mobile-card-detail">
                                        <span class="mobile-card-label">הצטרף:</span>
                                        <span class="mobile-card-value">${user.joinedAt ? new Date(user.joinedAt).toLocaleDateString('he-IL') : '-'}</span>
                                    </div>
                                </div>
                                <div class="mobile-card-actions">
                                    ${!isOwner ?
                                        `<button class="btn-delete" onclick="removeUser('${user.userId}', '${user.email}')">
                                            <i class="fas fa-user-minus"></i> הסר משתמש
                                        </button>` :
                                        '<span style="color: #718096; font-size: 0.875rem;"><i class="fas fa-crown"></i> בעלים</span>'}
                                </div>
                            </div>
                        `;
                    }).join('');
                }

                // Update appData
                appData.users = data.users;

            } catch (error) {
                console.error('Error loading users:', error);
                const tbody = document.querySelector('#usersTable tbody');
                if (tbody) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 20px; color: #e74c3c;">
                                שגיאה בטעינת משתמשים: ${error.message}
                            </td>
                        </tr>
                    `;
                }
            }
        }

        // Load pending invitations
        async function loadPendingInvitations() {
            try {
                const response = await fetch(`${window.API_BASE_URL}/listInvitations`, {
                    headers: {
                        'Authorization': `Bearer ${await ClerkAuth.getAuthToken()}`
                    }
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || 'שגיאה בטעינת הזמנות');
                }

                const tbody = document.querySelector('#invitationsTable tbody');
                if (!tbody) return;

                // API returns { data: { invitations: [...] } } structure
                const invitations = data.data?.invitations || data.invitations || [];
                if (invitations.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px; color: #666;">
                                <i class="fas fa-envelope-open" style="font-size: 48px; opacity: 0.3; margin-bottom: 15px; display: block;"></i>
                                <p style="margin: 0;">אין הזמנות ממתינות</p>
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = invitations.map(invitation => {
                    const roleClass = `role-${invitation.role || 'viewer'}`;
                    const roleText = {
                        admin: 'מנהל',
                        editor: 'עורך',
                        viewer: 'צופה'
                    }[invitation.role] || 'צופה';

                    // Backend returns 'id' not 'invitationId', and 'invitedAt' not 'sentAt'
                    const invitationId = invitation.id || invitation.invitationId;
                    const sentDate = invitation.invitedAt || invitation.sentAt;
                    const isExpired = invitation.isExpired;

                    return `
                        <tr${isExpired ? ' style="opacity: 0.6;"' : ''}>
                            <td>${invitation.email}${isExpired ? ' <span style="color: #e74c3c; font-size: 0.8em;">(פג תוקף)</span>' : ''}</td>
                            <td>${invitation.name || '-'}</td>
                            <td>${invitation.phone || '-'}</td>
                            <td><span class="role-badge ${roleClass}">${roleText}</span></td>
                            <td>${sentDate ? new Date(sentDate).toLocaleDateString('he-IL') : '-'}</td>
                            <td>
                                ${!isExpired ? `
                                <button class="btn-secondary" onclick="resendInvitation('${invitationId}', '${invitation.email}')" style="padding: 6px 12px; margin-left: 5px;">
                                    <i class="fas fa-redo"></i> שלח שוב
                                </button>
                                ` : ''}
                                <button class="btn-delete" onclick="cancelInvitation('${invitationId}', '${invitation.email}')">
                                    <i class="fas fa-times"></i> ${isExpired ? 'הסר' : 'בטל'}
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');

                // Update mobile cards view
                const mobileCardsContainer = document.getElementById('invitationsCardsMobile');
                if (mobileCardsContainer) {
                    mobileCardsContainer.innerHTML = invitations.map(invitation => {
                        const roleClass = `role-${invitation.role || 'viewer'}`;
                        const roleText = {
                            admin: 'מנהל',
                            editor: 'עורך',
                            viewer: 'צופה'
                        }[invitation.role] || 'צופה';

                        const invitationId = invitation.id || invitation.invitationId;
                        const sentDate = invitation.invitedAt || invitation.sentAt;
                        const isExpired = invitation.isExpired;

                        return `
                            <div class="mobile-card${isExpired ? ' expired' : ''}" style="${isExpired ? 'opacity: 0.6;' : ''}">
                                <div class="mobile-card-header">
                                    <div class="mobile-card-title">${invitation.name || invitation.email}</div>
                                    <span class="role-badge ${roleClass}">${roleText}</span>
                                </div>
                                ${isExpired ? '<div style="color: #e74c3c; font-size: 0.8em; margin-bottom: 8px;"><i class="fas fa-exclamation-circle"></i> פג תוקף</div>' : ''}
                                <div class="mobile-card-details">
                                    <div class="mobile-card-detail">
                                        <span class="mobile-card-label">אימייל:</span>
                                        <span class="mobile-card-value">${invitation.email}</span>
                                    </div>
                                    ${invitation.phone ? `
                                    <div class="mobile-card-detail">
                                        <span class="mobile-card-label">טלפון:</span>
                                        <span class="mobile-card-value">${invitation.phone}</span>
                                    </div>
                                    ` : ''}
                                    <div class="mobile-card-detail">
                                        <span class="mobile-card-label">נשלח:</span>
                                        <span class="mobile-card-value">${sentDate ? new Date(sentDate).toLocaleDateString('he-IL') : '-'}</span>
                                    </div>
                                </div>
                                <div class="mobile-card-actions">
                                    ${!isExpired ? `
                                    <button class="btn-secondary" onclick="resendInvitation('${invitationId}', '${invitation.email}')" style="flex: 1;">
                                        <i class="fas fa-redo"></i> שלח שוב
                                    </button>
                                    ` : ''}
                                    <button class="btn-delete" onclick="cancelInvitation('${invitationId}', '${invitation.email}')" style="flex: 1;">
                                        <i class="fas fa-times"></i> ${isExpired ? 'הסר' : 'בטל'}
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('');
                }

            } catch (error) {
                console.error('Error loading invitations:', error);
                const tbody = document.querySelector('#invitationsTable tbody');
                if (tbody) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 20px; color: #e74c3c;">
                                שגיאה בטעינת הזמנות: ${error.message}
                            </td>
                        </tr>
                    `;
                }
            }
        }

        // Remove user
        async function removeUser(userId, email) {
            if (!confirm(`האם אתה בטוח שברצונך להסיר את המשתמש ${email}?`)) {
                return;
            }

            try {
                const response = await fetch(`${window.API_BASE_URL}/removeUser`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${await ClerkAuth.getAuthToken()}`
                    },
                    body: JSON.stringify({ userId })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || 'שגיאה בהסרת משתמש');
                }

                showSuccess('המשתמש הוסר בהצלחה');
                await loadActiveUsers();

            } catch (error) {
                console.error('Error removing user:', error);
                showError(error.message || 'שגיאה בהסרת משתמש');
            }
        }

        // Resend invitation
        async function resendInvitation(invitationId, email) {
            try {
                // Note: API expects invitationId in path parameter
                const response = await fetch(`${window.API_BASE_URL}/resendInvitation/${encodeURIComponent(invitationId)}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${await ClerkAuth.getAuthToken()}`
                    }
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || 'שגיאה בשליחת ההזמנה מחדש');
                }

                showSuccess(`ההזמנה נשלחה מחדש ל-${email}`);
                await loadPendingInvitations();

            } catch (error) {
                console.error('Error resending invitation:', error);
                showError(error.message || 'שגיאה בשליחת ההזמנה מחדש');
            }
        }

        // Cancel invitation
        async function cancelInvitation(invitationId, email) {
            if (!confirm(`האם אתה בטוח שברצונך לבטל את ההזמנה ל-${email}?`)) {
                return;
            }

            try {
                // Note: API expects invitationId in path parameter
                const response = await fetch(`${window.API_BASE_URL}/cancelInvitation/${encodeURIComponent(invitationId)}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${await ClerkAuth.getAuthToken()}`
                    }
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || 'שגיאה בביטול ההזמנה');
                }

                showSuccess('ההזמנה בוטלה בהצלחה');
                await loadPendingInvitations();

            } catch (error) {
                console.error('Error canceling invitation:', error);
                showError(error.message || 'שגיאה בביטול ההזמנה');
            }
        }

        // Sign Out
        async function signOut() {
            if (confirm('האם אתה בטוח שברצונך לצאת מהמערכת?')) {
                // Destroy session timeout manager before signing out
                if (typeof SessionTimeout !== 'undefined') {
                    SessionTimeout.destroy();
                }
                await ClerkAuth.signOut();
            }
        }

        // Message Functions
        function showSuccess(message) {
            showMessage(message, 'success');
        }

        // ===== OCR COMPONENT INTEGRATION =====

        // Store OCR component instance globally
        let expenseOcrComponent = null;

        /**
         * Initialize OCR component in expense modal
         */
        function initializeExpenseOcrComponent() {
            // Check if already initialized
            if (expenseOcrComponent) {
                // DON'T reset if component is actively processing - this preserves the base64 data
                // during async OCR API calls when re-authentication triggers re-initialization
                if (expenseOcrComponent.state === 'processing' || expenseOcrComponent.state === 'success') {
                    console.log('[OCR] Component already processing/success, skipping reset');
                    return;
                }
                expenseOcrComponent.reset();
                return;
            }

            // Get company ID from current context
            const companyId = window.companyContext?.companyId || currentCompany?.companyId;

            if (!companyId) {
                console.warn('[OCR] No company ID available, OCR component will not be initialized');
                return;
            }

            try {
                expenseOcrComponent = new ReceiptUploadWithOCR('expense-ocr-container', {
                    companyId: companyId,
                    onOcrComplete: handleExpenseOcrComplete,
                    onError: handleExpenseOcrError,
                    apiEndpoint: 'https://2woj5i92td.execute-api.us-east-1.amazonaws.com/prod/expenses/ocr-process'
                });

                console.log('[OCR] Component initialized successfully');
            } catch (error) {
                console.error('[OCR] Failed to initialize component:', error);
            }
        }

        /**
         * Handle successful OCR processing
         * Pre-fill form fields with extracted data
         */
        function handleExpenseOcrComplete(ocrResult) {
            console.log('[OCR] Processing complete:', ocrResult);

            const { extractedFields, ocrMetadata, receiptFile, receiptBase64 } = ocrResult;

            // Store OCR data globally for later use (including File object and base64!)
            window.currentExpenseOcrData = {
                receiptFile: receiptFile, // The actual File object from OCR result
                receiptBase64: receiptBase64, // Pre-converted base64 from OCR
                extractedFields: extractedFields,
                ocrMetadata: ocrMetadata,
                userEdits: {} // Track which fields user has edited
            };

            // CRITICAL: Set pendingReceiptFile so submitExpense uploads to S3
            // This bridges the OCR flow with the standard upload flow
            pendingReceiptFile = receiptFile;
            expenseWithPicture = true;  // Mark that we have a picture
            console.log('[OCR] Set pendingReceiptFile for S3 upload:', receiptFile?.name);

            // Hide OCR container and skip button, show expense form
            document.getElementById('expense-ocr-container').style.display = 'none';
            document.getElementById('ocr-skip-container').style.display = 'none';
            document.getElementById('expense-form-layout').style.display = 'flex';

            // Show receipt preview panel and ensure modal is wide
            document.getElementById('expense-receipt-preview').style.display = 'flex';
            const modalWide = document.querySelector('.expense-modal-wide');
            if (modalWide) modalWide.classList.remove('no-picture');

            // Mark as having receipt
            document.getElementById('expenseMissingReceipt').value = 'false';

            // Show receipt preview with uploaded image - use receiptBase64 directly
            console.log('[OCR] Setting image preview, receiptBase64:', receiptBase64 ? 'present (' + receiptBase64.substring(0, 50) + '...)' : 'missing');
            if (receiptBase64) {
                const previewImg = document.getElementById('receipt-preview-img');
                if (previewImg) {
                    previewImg.src = receiptBase64;
                }
                // Hide upload dropzone and show image preview (consistent with handleReceiptUpload)
                const uploadArea = document.getElementById('receipt-upload-area');
                const dropzone = document.getElementById('receipt-dropzone');
                const imagePreview = document.getElementById('receipt-image-preview');

                if (uploadArea) uploadArea.style.display = 'none';
                if (dropzone) dropzone.style.display = 'none';
                if (imagePreview) imagePreview.style.display = 'flex';

                console.log('[OCR] Image preview set successfully using receiptBase64');
            } else {
                console.warn('[OCR] No receiptBase64 to preview!');
            }

            // Pre-fill form fields with extracted data
            if (extractedFields.date) {
                const dateInput = document.getElementById('expenseDate');
                dateInput.value = extractedFields.date;
                dateInput.classList.add('ocr-filled');
                updateConfidenceIndicator('expenseDate', extractedFields.confidence?.date || 0);
            }

            if (extractedFields.amount) {
                const amountInput = document.getElementById('expenseAmount');
                amountInput.value = extractedFields.amount;
                amountInput.classList.add('ocr-filled');
                updateConfidenceIndicator('expenseAmount', extractedFields.confidence?.amount || 0);
            }

            // Fill description field - prefer handwritten description, fall back to vendor name
            if (extractedFields.description || extractedFields.vendor) {
                const descInput = document.getElementById('expenseDescription');
                descInput.value = extractedFields.description || extractedFields.vendor;
                descInput.classList.add('ocr-filled');
                updateConfidenceIndicator('expenseDescription',
                    extractedFields.description
                        ? (extractedFields.confidence?.description || 0)
                        : (extractedFields.confidence?.vendor || 0)
                );
            }

            if (extractedFields.invoiceNum) {
                const invoiceInput = document.getElementById('expenseInvoice');
                invoiceInput.value = extractedFields.invoiceNum;
                invoiceInput.classList.add('ocr-filled');
                updateConfidenceIndicator('expenseInvoice', extractedFields.confidence?.invoiceNum || 0);
            }

            // NEW: Auto-fill payment method if confident
            if (extractedFields.paymentMethod && extractedFields.confidence?.paymentMethod >= 70) {
                const paymentSelect = document.getElementById('expensePayment');
                if (paymentSelect) {
                    paymentSelect.value = extractedFields.paymentMethod;
                    paymentSelect.classList.add('ocr-filled');
                    updateConfidenceIndicator('expensePayment', extractedFields.confidence.paymentMethod);

                    // Show reasoning if available
                    if (ocrMetadata.paymentMethodReasoning) {
                        showPaymentMethodReasoning(extractedFields.paymentMethod, ocrMetadata.paymentMethodReasoning);
                    }
                }
            }

            // NEW: Auto-select contractor if match found
            if (extractedFields.contractorMatch && extractedFields.contractorMatch.confidence >= 70) {
                const contractorSelect = document.getElementById('expenseContractorId');
                if (contractorSelect) {
                    contractorSelect.value = extractedFields.contractorMatch.contractorId;
                    contractorSelect.classList.add('ocr-filled');

                    // Show contractor match indicator
                    showContractorMatchIndicator(
                        extractedFields.contractorMatch.name,
                        extractedFields.contractorMatch.confidence
                    );
                }
            }

            // Show success message
            showSuccess('הקבלה עובדה בהצלחה! השדות מולאו אוטומטית. אנא בדוק את הנתונים לפני שמירה.');

            console.log('[OCR] Form fields pre-filled successfully');
        }

        /**
         * Handle OCR processing error
         */
        function handleExpenseOcrError(error) {
            console.error('[OCR] Error:', error);
            showError('שגיאה בעיבוד הקבלה: ' + error.message);
        }

        /**
         * Show contractor match indicator
         */
        function showContractorMatchIndicator(contractorName, confidence) {
            // Remove existing indicator if present
            const existing = document.querySelector('.contractor-match-indicator');
            if (existing) existing.remove();

            const contractorSelect = document.getElementById('expenseContractorId');
            if (!contractorSelect || !contractorSelect.parentElement) return;

            const indicatorClass = confidence >= 90 ? 'contractor-match-high' : 'contractor-match-medium';
            const icon = confidence >= 90
                ? '<i class="fas fa-check-circle"></i>'
                : '<i class="fas fa-exclamation-triangle"></i>';
            const message = confidence >= 90
                ? `התאמה אוטומטית: ${contractorName}`
                : `התאמה משוערת: ${contractorName} (${Math.round(confidence)}% ביטחון) - אנא ודא`;

            const indicator = document.createElement('div');
            indicator.className = `contractor-match-indicator ${indicatorClass}`;
            indicator.innerHTML = `${icon}<span>${message}</span>`;

            contractorSelect.parentElement.appendChild(indicator);
        }

        /**
         * Show payment method inference reasoning
         */
        function showPaymentMethodReasoning(paymentMethod, reasoning) {
            // Remove existing reasoning if present
            const existing = document.querySelector('.payment-method-reasoning');
            if (existing) existing.remove();

            const paymentSelect = document.getElementById('expensePayment');
            if (!paymentSelect || !paymentSelect.parentElement) return;

            const reasoningDiv = document.createElement('div');
            reasoningDiv.className = 'payment-method-reasoning';
            reasoningDiv.innerHTML = `<i class="fas fa-info-circle"></i><span>זוהה: ${paymentMethod} - ${reasoning}</span>`;

            paymentSelect.parentElement.appendChild(reasoningDiv);
        }

        /**
         * Update confidence indicator next to form field
         * Uses OcrFieldIndicator component for consistent UI
         */
        function updateConfidenceIndicator(fieldId, confidence) {
            const indicator = document.getElementById(fieldId + '-confidence');
            if (!indicator) return;

            // Get confidence icon and color from OcrFieldIndicator component
            const confidenceIcon = OcrFieldIndicator.getConfidenceIcon(confidence);
            const confidenceColor = OcrFieldIndicator.getConfidenceColor(confidence);
            const confidenceDesc = OcrFieldIndicator.getConfidenceDescription(confidence);
            const confidenceClass = OcrFieldIndicator.getConfidenceClass(confidence);

            // Update indicator with enhanced UI
            indicator.innerHTML = `
                <div class="confidence-badge-wrapper" style="display: flex; align-items: center; gap: 6px;">
                    <i class="fas ${confidenceIcon}" style="color: ${confidenceColor}; font-size: 16px;"></i>
                    <span class="confidence-percentage" style="font-size: 12px; font-weight: 600; color: ${confidenceColor};">
                        ${Math.round(confidence)}%
                    </span>
                    ${confidence < 80 ? `
                        <i class="fas fa-exclamation-triangle"
                           style="color: #ef4444; font-size: 14px; animation: pulse 2s infinite;"
                           title="יש לבדוק שדה זה ידנית"></i>
                    ` : ''}
                </div>
            `;
            indicator.className = `field-confidence-indicator visible ${confidenceClass}`;
            indicator.title = confidenceDesc;
            indicator.setAttribute('aria-label', `${confidenceDesc} - ${Math.round(confidence)}%`);
        }

        /**
         * Clear confidence indicators
         */
        function clearConfidenceIndicators() {
            ['expenseDate', 'expenseAmount', 'expenseDescription', 'expenseInvoice'].forEach(fieldId => {
                const indicator = document.getElementById(fieldId + '-confidence');
                if (indicator) {
                    indicator.className = 'field-confidence-indicator';
                    indicator.innerHTML = '';
                }

                const input = document.getElementById(fieldId);
                if (input) {
                    input.classList.remove('ocr-filled', 'ocr-edited');
                }
            });
        }

        /**
         * Track field edits
         * Called when user modifies an OCR-filled field
         */
        function trackFieldEdit(fieldId) {
            if (window.currentExpenseOcrData) {
                window.currentExpenseOcrData.userEdits[fieldId] = true;

                // Change visual indicator to show it was edited
                const input = document.getElementById(fieldId);
                if (input && input.classList.contains('ocr-filled')) {
                    input.classList.remove('ocr-filled');
                    input.classList.add('ocr-edited');
                }
            }
        }

        /**
         * Set up field edit listeners
         */
        function setupFieldEditListeners() {
            ['expenseDate', 'expenseAmount', 'expenseDescription', 'expenseInvoice'].forEach(fieldId => {
                const input = document.getElementById(fieldId);
                if (input) {
                    input.addEventListener('change', () => trackFieldEdit(fieldId));
                    input.addEventListener('input', () => trackFieldEdit(fieldId));
                }
            });
        }

        // Modal Control Functions
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
                // Clear form inputs
                const form = modal.querySelector('form');
                if (form) form.reset();

                // Reset editing states and modal titles
                if (modalId === 'projectModal') {
                    editingProjectId = null;
                    document.querySelector('#projectModal h2').textContent = 'הוסף פרויקט חדש';
                } else if (modalId === 'contractorModal') {
                    editingContractorId = null;
                    document.querySelector('#contractorModal h2').textContent = 'הוסף קבלן חדש';
                } else if (modalId === 'workModal') {
                    editingWorkId = null;
                    document.querySelector('#workModal h2').textContent = 'הוסף עבודה חדשה';
                } else if (modalId === 'expenseModal') {
                    editingExpenseId = null;
                    document.querySelector('#expenseModalTitle').textContent = 'הוסף הוצאה חדשה';
                    // Clear receipt preview and pending file
                    pendingReceiptFile = null;
                    expenseWithPicture = false;
                    resetReceiptPreview();

                    // Reset form layout states to initial values
                    const ocrContainer = document.getElementById('expense-ocr-container');
                    const formLayout = document.getElementById('expense-form-layout');
                    const receiptPreview = document.getElementById('expense-receipt-preview');
                    const modalWide = document.querySelector('.expense-modal-wide');

                    if (ocrContainer) ocrContainer.style.display = 'block';
                    const skipContainer = document.getElementById('ocr-skip-container');
                    if (skipContainer) skipContainer.style.display = 'block';
                    if (formLayout) formLayout.style.display = 'none';
                    if (receiptPreview) receiptPreview.style.display = 'flex';
                    if (modalWide) modalWide.classList.remove('no-picture');

                    // Reset OCR component state if it exists
                    if (expenseOcrComponent && typeof expenseOcrComponent.reset === 'function') {
                        expenseOcrComponent.reset();
                    }
                }
            }
        }

        // Upgrade Modal Functions
        function showUpgradeModal(errorData) {
            const modal = document.getElementById('upgradeModal');
            const messageEl = document.getElementById('upgradeLimitMessage');
            const usageInfoEl = document.getElementById('upgradeUsageInfo').querySelector('p');

            // Set the main message
            if (errorData.message) {
                messageEl.textContent = errorData.message;
            }

            // Set usage information
            if (errorData.data) {
                const { reason, currentUsage, limit } = errorData.data;
                let usageText = '';

                if (reason === 'PROJECT_LIMIT_REACHED') {
                    usageText = `יש לך ${currentUsage} פרויקטים פעילים מתוך ${limit} המותרים`;
                } else if (reason === 'EXPENSE_LIMIT_REACHED') {
                    usageText = `יש לך ${currentUsage} הוצאות החודש מתוך ${limit} המותרים`;
                } else if (reason === 'USER_LIMIT_REACHED') {
                    usageText = `יש לך ${currentUsage} משתמשים מתוך ${limit} המותרים`;
                }

                usageInfoEl.textContent = usageText;
            }

            // Show the modal
            modal.style.display = 'block';
        }

        function viewPricing() {
            // Redirect to pricing page or external pricing URL
            window.location.href = '/pricing.html';
        }

        // Onboarding Modal Functions
        function selectTier(tier) {
            // Clear previous selection
            document.querySelectorAll('#onboardingModal .tier-card').forEach(card => {
                card.style.border = '2px solid #cbd5e0';
                card.style.transform = 'scale(1)';
            });

            // Highlight selected tier
            const selectedCard = document.querySelector(`#onboardingModal .tier-card[data-tier="${tier}"]`);
            if (selectedCard) {
                selectedCard.style.border = `2px solid ${tier === 'trial' ? '#48bb78' : tier === 'professional' ? '#3182ce' : '#805ad5'}`;
                selectedCard.style.transform = 'scale(1.05)';
            }

            // Set hidden input value
            document.getElementById('selectedTier').value = tier;
            document.getElementById('tierError').style.display = 'none';
        }

        async function submitOnboarding(event) {
            event.preventDefault();

            const companyName = document.getElementById('companyName').value;
            const subscriptionTier = document.getElementById('selectedTier').value;

            // Validate tier selection
            if (!subscriptionTier) {
                document.getElementById('tierError').style.display = 'block';
                return;
            }

            try {
                // Show loading state
                const submitBtn = event.target.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;
                submitBtn.disabled = true;
                submitBtn.textContent = 'פותח תשלום מאובטח...';

                // Get Paddle checkout configuration from backend
                const response = await apiCall('/create-paddle-checkout', 'POST', {
                    companyName,
                    subscriptionTier
                });

                if (response.success && response.paddleConfig) {
                    console.log('Paddle checkout config received:', response.paddleConfig.priceId);

                    // Store company creation state for webhook processing
                    sessionStorage.setItem('paddle_checkout_in_progress', 'true');
                    sessionStorage.setItem('paddle_company_name', companyName);
                    sessionStorage.setItem('paddle_tier', subscriptionTier);

                    // Open Paddle checkout overlay
                    const paddleConfig = response.paddleConfig;
                    const checkoutData = {
                        items: [{
                            priceId: paddleConfig.priceId,
                            quantity: 1
                        }],
                        customData: paddleConfig.customData
                    };

                    // Add customer email if available
                    if (paddleConfig.customerEmail) {
                        checkoutData.customer = {
                            email: paddleConfig.customerEmail
                        };
                    }

                    // Open Paddle checkout (Paddle is already initialized at page load)
                    console.log('Opening Paddle checkout with priceId:', paddleConfig.priceId);
                    Paddle.Checkout.open(checkoutData);

                    // Reset button state (checkout overlay is open)
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;

                } else {
                    throw new Error(response.message || 'Failed to get checkout configuration');
                }

            } catch (error) {
                console.error('Onboarding error:', error);

                // Show specific error message
                let errorMsg = 'שגיאה ביצירת מעבר לתשלום. נסה שוב.';
                if (error.message && error.message.includes('Payment provider')) {
                    errorMsg = 'שגיאה בחיבור לספק התשלום. נסה שוב מאוחר יותר.';
                }
                showError(errorMsg);

                // Reset button
                const submitBtn = event.target.querySelector('button[type="submit"]');
                submitBtn.disabled = false;
                submitBtn.textContent = 'התחל עכשיו';
            }
        }

        function showOnboardingModal() {
            document.getElementById('onboardingModal').style.display = 'block';
        }

        // Helper function to escape HTML to prevent XSS
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Invitation Choice Modal Functions
        function showInvitationChoiceModal(invitations) {
            const listContainer = document.getElementById('invitationsList');
            listContainer.innerHTML = invitations.map((inv, index) => `
                <div style="background: white; border: 2px solid ${index === 0 ? '#667eea' : '#e2e8f0'}; border-radius: 12px; padding: 18px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s; position: relative; ${index === 0 ? 'box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);' : ''}"
                     onmouseover="this.style.borderColor='#667eea'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.15)';"
                     onmouseout="this.style.borderColor='${index === 0 ? '#667eea' : '#e2e8f0'}'; ${index === 0 ? '' : "this.style.boxShadow='none';"}">
                    ${index === 0 ? '<div style="position: absolute; top: -10px; right: 15px; background: #667eea; color: white; font-size: 11px; padding: 3px 10px; border-radius: 10px; font-weight: 500;">מומלץ</div>' : ''}
                    <div style="display: flex; align-items: flex-start; gap: 14px; text-align: right;">
                        <div style="width: 44px; height: 44px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            <i class="fas fa-building" style="color: white; font-size: 18px;"></i>
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-weight: 600; font-size: 17px; color: #1a202c; margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                ${escapeHtml(inv.companyName)}
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px; color: #718096; font-size: 13px;">
                                <span style="background: #edf2f7; padding: 2px 8px; border-radius: 4px; font-weight: 500;">
                                    ${getRoleDisplayName(inv.role)}
                                </span>
                                ${inv.invitedBy && inv.invitedBy.includes('@') ? `<span>הוזמנת ע"י ${escapeHtml(inv.invitedBy.split('@')[0])}</span>` : ''}
                            </div>
                        </div>
                        <button onclick="acceptInvitationFromChoice('${inv.invitationId}'); event.stopPropagation();"
                                style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 10px 18px; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; white-space: nowrap; transition: transform 0.2s, box-shadow 0.2s;"
                                onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.3)';"
                                onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';">
                            הצטרף
                        </button>
                    </div>
                </div>
            `).join('');
            document.getElementById('invitationChoiceModal').style.display = 'flex';
            // Store invitations for later reference
            window.pendingEmailInvitations = invitations;
        }

        function getRoleDisplayName(role) {
            const roleNames = {
                'owner': 'בעלים',
                'admin': 'מנהל',
                'manager': 'מנהל פרויקטים',
                'member': 'חבר צוות',
                'viewer': 'צופה',
                'editor': 'עורך'
            };
            return roleNames[role] || role;
        }

        async function acceptInvitationFromChoice(invitationId) {
            try {
                showNotification('מצטרף לחברה...', 'info');
                // Call the acceptInvitation endpoint with token in body
                const response = await apiCall('/acceptInvitation', 'POST', { token: invitationId });

                if (response.success) {
                    document.getElementById('invitationChoiceModal').style.display = 'none';
                    // Clear the skip flag since user successfully joined
                    sessionStorage.removeItem('skip_invitation_check');
                    showNotification('הצטרפת לחברה בהצלחה!', 'success');
                    // Reload the app to load company data
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    showNotification(response.message || 'שגיאה בהצטרפות לחברה', 'error');
                }
            } catch (error) {
                console.error('Error accepting invitation:', error);
                showNotification('שגיאה בהצטרפות לחברה', 'error');
            }
        }

        function skipInvitationsAndCreateCompany() {
            // Set flag to skip invitation check on subsequent loads
            sessionStorage.setItem('skip_invitation_check', 'true');
            document.getElementById('invitationChoiceModal').style.display = 'none';
            showOnboardingModal();
        }

        async function checkPendingInvitationsByEmail(email) {
            try {
                const response = await apiCall(`/check-pending-invitations?email=${encodeURIComponent(email)}`, 'GET');
                if (response.success && response.hasInvitations && response.invitations.length > 0) {
                    return response.invitations;
                }
                return null;
            } catch (error) {
                console.error('Error checking pending invitations:', error);
                return null;
            }
        }

        // Form Display Functions - Open Modals
        function showAddProjectForm() {
            document.getElementById('projectModal').style.display = 'block';
        }

        function showAddContractorForm() {
            document.getElementById('contractorModal').style.display = 'block';
        }

        async function showAddWorkForm() {
            // Load projects and contractors for dropdowns
            try {
                const projects = await apiCall('/projects', 'GET');
                const contractors = await apiCall('/contractors', 'GET');

                if (!projects.projects || projects.projects.length === 0) {
                    showError('אין פרויקטים. צור פרויקט תחילה.');
                    return;
                }
                if (!contractors.contractors || contractors.contractors.length === 0) {
                    showError('אין קבלנים. צור קבלן תחילה.');
                    return;
                }

                // Populate project dropdown
                const projectSelect = document.getElementById('workProjectId');
                projectSelect.innerHTML = '<option value="">בחר פרויקט *</option>';
                projects.projects.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.projectId;
                    option.textContent = p.name;
                    projectSelect.appendChild(option);
                });

                // Populate contractor dropdown
                const contractorSelect = document.getElementById('workContractorId');
                contractorSelect.innerHTML = '<option value="">בחר קבלן *</option>';
                contractors.contractors.forEach(c => {
                    const option = document.createElement('option');
                    option.value = c.contractorId;
                    option.textContent = c.name;
                    contractorSelect.appendChild(option);
                });

                document.getElementById('workModal').style.display = 'block';
            } catch (error) {
                showError('שגיאה בטעינת נתונים: ' + error.message);
            }
        }

        // Global variable to store works data for expense form
        let expenseFormWorks = [];

        async function showAddExpenseForm() {
            // Reset state for new expense
            editingExpenseId = null;
            pendingReceiptFile = null;
            expenseWithPicture = false;

            // Prepare modal data (fetch projects, contractors, works)
            await prepareExpenseModal();

            // Show OCR upload screen first
            document.getElementById('expense-ocr-container').style.display = 'block';
            document.getElementById('expense-form-layout').style.display = 'none';

            // Initialize OCR component
            initializeExpenseOcrComponent();

            // Show modal
            document.getElementById('expenseModal').style.display = 'block';
        }

        function skipReceiptUpload() {
            // Mark as skipped (no picture)
            expenseWithPicture = false;
            pendingReceiptFile = null;

            // Hide OCR container and skip button, show form
            document.getElementById('expense-ocr-container').style.display = 'none';
            document.getElementById('ocr-skip-container').style.display = 'none';
            document.getElementById('expense-form-layout').style.display = 'flex';

            // Hide receipt preview panel (no image to show)
            document.getElementById('expense-receipt-preview').style.display = 'none';

            // Shrink modal to single-column layout
            const modalWide = document.querySelector('.expense-modal-wide');
            if (modalWide) modalWide.classList.add('no-picture');

            // Mark as missing receipt
            document.getElementById('expenseMissingReceipt').value = 'true';

            // Clear any form fields (fresh start)
            document.getElementById('expenseForm').reset();
        }

        async function prepareExpenseModal() {
            try {
                const projects = await apiCall('/projects', 'GET');
                const contractors = await apiCall('/contractors', 'GET');
                const works = await apiCall('/works', 'GET');

                expenseFormWorks = works.works || [];

                // Populate dropdowns
                const workSelect = document.getElementById('expenseWorkId');
                workSelect.innerHTML = '<option value="">בחר עבודה (ממלא אוטומטית פרויקט וקבלן)</option>';
                if (works.works) {
                    works.works.forEach(w => {
                        const option = document.createElement('option');
                        option.value = w.workId;
                        option.textContent = w.workName;
                        workSelect.appendChild(option);
                    });
                }

                const projectSelect = document.getElementById('expenseProjectId');
                projectSelect.innerHTML = '<option value="">הוצאות כלליות (ברירת מחדל)</option>';
                if (projects.projects) {
                    projects.projects.forEach(p => {
                        // Skip system projects (like General Expenses) - represented by default option
                        if (p.isSystemProject) return;

                        const option = document.createElement('option');
                        option.value = p.projectId;
                        option.textContent = p.name;
                        projectSelect.appendChild(option);
                    });
                }

                const contractorSelect = document.getElementById('expenseContractorId');
                contractorSelect.innerHTML = '<option value="">ספק כללי (ברירת מחדל)</option>';
                if (contractors.contractors) {
                    contractors.contractors.forEach(c => {
                        // Skip system contractors (like General Contractor) - represented by default option
                        if (c.isSystemContractor) return;

                        const option = document.createElement('option');
                        option.value = c.contractorId;
                        option.textContent = c.name;
                        contractorSelect.appendChild(option);
                    });
                }

                // Reset form
                document.getElementById('expenseForm').reset();
                document.getElementById('expenseModalTitle').textContent = 'הוסף הוצאה חדשה';

            } catch (error) {
                showError('שגיאה בטעינת נתונים: ' + error.message);
            }
        }

        function handleReceiptUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate file type
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'application/pdf'];
            if (!allowedTypes.includes(file.type)) {
                showError('סוג קובץ לא נתמך. אנא בחר קובץ מסוג JPG, PNG או PDF');
                return;
            }

            // Validate file size (10MB max)
            if (file.size > 10 * 1024 * 1024) {
                showError('הקובץ גדול מדי. גודל מקסימלי: 10MB');
                return;
            }

            pendingReceiptFile = file;

            // Show preview
            if (file.type === 'application/pdf') {
                // For PDF, show placeholder
                document.getElementById('receipt-preview-img').src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiB2aWV3Qm94PSIwIDAgMjQgMjQiIGZpbGw9Im5vbmUiIHN0cm9rZT0iI2U1M2UzZSIgc3Ryb2tlLXdpZHRoPSIyIj48cGF0aCBkPSJNMTQgMkg2YTIgMiAwIDAgMC0yIDJ2MTZhMiAyIDAgMCAwIDIgMmgxMmEyIDIgMCAwIDAgMi0yVjhsLTYtNnoiLz48cG9seWxpbmUgcG9pbnRzPSIxNCAyIDE0IDggMjAgOCIvPjxwYXRoIGQ9Ik05IDEzaDZ2NUg5eiIvPjxwYXRoIGQ9Ik05IDEzVjloNnY0Ii8+PC9zdmc+';
                document.getElementById('receipt-preview-img').alt = file.name;
                document.getElementById('receipt-dropzone').style.display = 'none';
                document.getElementById('receipt-image-preview').style.display = 'flex';
            } else {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('receipt-preview-img').src = e.target.result;
                    document.getElementById('receipt-dropzone').style.display = 'none';
                    document.getElementById('receipt-image-preview').style.display = 'flex';
                };
                reader.readAsDataURL(file);
            }

            // Update missing receipt flag
            document.getElementById('expenseMissingReceipt').value = 'false';
        }

        function removeReceiptPreview() {
            pendingReceiptFile = null;
            document.getElementById('expenseReceiptFile').value = '';
            document.getElementById('receipt-dropzone').style.display = 'flex';
            document.getElementById('receipt-image-preview').style.display = 'none';
            document.getElementById('receipt-preview-img').src = '';

            // If in picture mode but removed picture, still mark as missing
            if (expenseWithPicture) {
                document.getElementById('expenseMissingReceipt').value = 'true';
            }
        }

        function resetReceiptPreview() {
            pendingReceiptFile = null;
            const fileInput = document.getElementById('expenseReceiptFile');
            if (fileInput) fileInput.value = '';
            const dropzone = document.getElementById('receipt-dropzone');
            if (dropzone) dropzone.style.display = 'flex';
            const imagePreview = document.getElementById('receipt-image-preview');
            if (imagePreview) imagePreview.style.display = 'none';
            const previewImg = document.getElementById('receipt-preview-img');
            if (previewImg) previewImg.src = '';
        }

        // Drag and drop handlers for receipt panel
        function setupReceiptDragDrop() {
            const dropzone = document.getElementById('receipt-dropzone');
            if (!dropzone) return;

            dropzone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropzone.classList.add('drag-over');
            });

            dropzone.addEventListener('dragleave', () => {
                dropzone.classList.remove('drag-over');
            });

            dropzone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropzone.classList.remove('drag-over');

                const file = e.dataTransfer?.files[0];
                if (file) {
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    document.getElementById('expenseReceiptFile').files = dataTransfer.files;
                    handleReceiptUpload({ target: { files: [file] } });
                }
            });
        }

        // Auto-fill project and contractor when work is selected
        function onWorkSelected() {
            const workId = document.getElementById('expenseWorkId').value;

            if (!workId) {
                // Clear selections if no work selected
                document.getElementById('expenseProjectId').value = '';
                document.getElementById('expenseContractorId').value = '';
                return;
            }

            // Find the selected work
            const selectedWork = expenseFormWorks.find(w => w.workId === workId);

            if (selectedWork) {
                // Auto-fill project and contractor
                document.getElementById('expenseProjectId').value = selectedWork.projectId || '';
                document.getElementById('expenseContractorId').value = selectedWork.contractorId || '';
            }
        }

        // Form Submission Functions
        async function submitProject(event) {
            event.preventDefault();

            try {
                const project = {
                    name: document.getElementById('projectName').value,
                    description: document.getElementById('projectDescription').value || '',
                    startDate: document.getElementById('projectStartDate').value,
                    endDate: document.getElementById('projectEndDate').value || undefined,
                    budget: parseFloat(document.getElementById('projectBudget').value) || 0,
                    location: document.getElementById('projectLocation').value || '',
                    clientName: document.getElementById('projectClient').value || ''
                };

                if (editingProjectId) {
                    // Update existing project
                    project.projectId = editingProjectId;
                    await apiCall('/projects', 'PUT', project);
                    showSuccess('פרויקט עודכן בהצלחה');
                    editingProjectId = null;
                } else {
                    // Create new project
                    await apiCall('/projects', 'POST', project);
                    showSuccess('פרויקט נוסף בהצלחה');
                }

                closeModal('projectModal');
                await loadAppData();
                // Always stay on current tab after creating/updating
                refreshCurrentTab();
            } catch (error) {
                // Don't show error if upgrade modal is already displayed
                if (error.message !== 'TIER_LIMIT') {
                    showError('שגיאה בעדכון פרויקט: ' + error.message);
                }
            }
        }

        async function submitContractor(event) {
            event.preventDefault();

            try {
                const contractor = {
                    name: document.getElementById('contractorName').value,
                    phone: document.getElementById('contractorPhone').value || '',
                    specialty: document.getElementById('contractorSpecialty').value || ''
                };

                if (editingContractorId) {
                    // Update existing contractor
                    contractor.contractorId = editingContractorId;
                    await apiCall('/contractors', 'PUT', contractor);
                    showSuccess('קבלן עודכן בהצלחה');
                    editingContractorId = null;
                } else {
                    // Create new contractor
                    await apiCall('/contractors', 'POST', contractor);
                    showSuccess('קבלן נוסף בהצלחה');
                }

                closeModal('contractorModal');
                await loadAppData();
                // Always stay on current tab after creating/updating
                refreshCurrentTab();
            } catch (error) {
                // Don't show error if upgrade modal is already displayed
                if (error.message !== 'TIER_LIMIT') {
                    showError('שגיאה בעדכון קבלן: ' + error.message);
                }
            }
        }

        async function submitWork(event) {
            event.preventDefault();

            try {
                const work = {
                    workName: document.getElementById('workName').value,
                    projectId: document.getElementById('workProjectId').value,
                    contractorId: document.getElementById('workContractorId').value,
                    startDate: document.getElementById('workStartDate').value || null,
                    totalWorkCost: parseFloat(document.getElementById('workCost').value) || 0,
                    status: 'planned'
                };

                if (editingWorkId) {
                    // Update existing work
                    work.workId = editingWorkId;
                    await apiCall('/works', 'PUT', work);
                    showSuccess('עבודה עודכנה בהצלחה');
                    editingWorkId = null;
                } else {
                    // Create new work
                    await apiCall('/works', 'POST', work);
                    showSuccess('עבודה נוספה בהצלחה');
                }

                closeModal('workModal');
                await loadAppData();
                // Always stay on current tab after creating/updating
                refreshCurrentTab();
            } catch (error) {
                // Don't show error if upgrade modal is already displayed
                if (error.message !== 'TIER_LIMIT') {
                    showError('שגיאה בעדכון עבודה: ' + error.message);
                }
            }
        }

        // VAT calculation for expense form preview
        const VAT_RATE = 0.18;

        function updateVATPreview() {
            const amountInput = document.getElementById('expenseAmount');
            const vatPreview = document.getElementById('vatPreview');
            const vatPreviewBase = document.getElementById('vatPreviewBase');
            const vatPreviewAmount = document.getElementById('vatPreviewAmount');

            const amount = parseFloat(amountInput.value) || 0;

            if (amount > 0) {
                const baseAmount = Math.round((amount / (1 + VAT_RATE)) * 100) / 100;
                const vatAmount = Math.round((amount - baseAmount) * 100) / 100;

                vatPreviewBase.textContent = '₪' + baseAmount.toLocaleString('he-IL');
                vatPreviewAmount.textContent = '₪' + vatAmount.toLocaleString('he-IL');
                vatPreview.style.display = 'block';
            } else {
                vatPreview.style.display = 'none';
            }
        }
        window.updateVATPreview = updateVATPreview;

        async function submitExpense(event) {
            event.preventDefault();

            try {
                let receiptUrl = '';
                const missingReceipt = document.getElementById('expenseMissingReceipt').value === 'true';

                // If editing, get existing receipt URL
                if (editingExpenseId) {
                    const existingExpense = appData.expenses.find(e => e.expenseId === editingExpenseId);
                    receiptUrl = existingExpense?.receiptUrl || '';
                }

                // Upload receipt if file is pending
                if (pendingReceiptFile) {
                    const file = pendingReceiptFile;

                    console.log('[SUBMIT] Uploading receipt to S3:', file.name);

                    // Get presigned URL from Lambda
                    const uploadData = await apiCall('/upload-receipt', 'POST', {
                        fileName: file.name,
                        fileType: file.type,
                        fileSize: file.size
                    });

                    // Upload file to S3 using presigned URL
                    const uploadResponse = await fetch(uploadData.data.uploadUrl, {
                        method: 'PUT',
                        body: file,
                        headers: {
                            'Content-Type': file.type
                        }
                    });

                    if (!uploadResponse.ok) {
                        throw new Error('Failed to upload receipt to S3');
                    }

                    // Store S3 key (not pre-signed URL) so backend can generate fresh URLs on-demand
                    receiptUrl = uploadData.data.receiptKey;
                }

                // Create expense object
                const expense = {
                    description: document.getElementById('expenseDescription').value,
                    amount: parseFloat(document.getElementById('expenseAmount').value) || 0,
                    date: document.getElementById('expenseDate').value,
                    invoiceNum: document.getElementById('expenseInvoice').value || 'N/A',
                    paymentMethod: document.getElementById('expensePayment').value || 'מזומן',
                    workId: document.getElementById('expenseWorkId').value || '',
                    projectId: document.getElementById('expenseProjectId').value || '',
                    contractorId: document.getElementById('expenseContractorId').value || '',
                    receiptUrl: receiptUrl,
                    missingReceipt: !receiptUrl && missingReceipt,
                    category: 'General'
                };

                console.log('[SUBMIT] Creating expense:', expense);

                if (editingExpenseId) {
                    expense.expenseId = editingExpenseId;
                    await apiCall('/expenses', 'PUT', expense);
                    showSuccess('הוצאה עודכנה בהצלחה');
                    editingExpenseId = null;
                } else {
                    await apiCall('/expenses', 'POST', expense);
                    showSuccess('הוצאה נוספה בהצלחה');
                }

                // Clear pending file
                pendingReceiptFile = null;

                closeModal('expenseModal');
                await loadAppData();
                refreshCurrentTab();
            } catch (error) {
                if (error.message !== 'TIER_LIMIT') {
                    showError('שגיאה בעדכון הוצאה: ' + error.message);
                }
            }
        }

        // ===== EDIT FUNCTIONS =====

        // Track if we're editing (stores entity ID being edited)
        let editingProjectId = null;
        let editingContractorId = null;
        let editingWorkId = null;
        let editingExpenseId = null;

        // Global variables for expense flow
        let expenseWithPicture = false;
        let pendingReceiptFile = null;

        function editProject(projectId) {
            const project = appData.projects.find(p => p.projectId === projectId);
            if (!project) {
                showError('פרויקט לא נמצא');
                return;
            }

            // Store that we're editing
            editingProjectId = projectId;

            // Populate form
            document.getElementById('projectName').value = project.name || '';
            document.getElementById('projectDescription').value = project.description || '';
            document.getElementById('projectStartDate').value = project.startDate || '';
            document.getElementById('projectEndDate').value = project.endDate || '';
            document.getElementById('projectBudget').value = project.budget || '';
            document.getElementById('projectLocation').value = project.location || '';
            document.getElementById('projectClient').value = project.clientName || '';

            // Change modal title
            document.querySelector('#projectModal h2').textContent = 'ערוך פרויקט';

            // Show modal
            document.getElementById('projectModal').style.display = 'block';
        }

        function editContractor(contractorId) {
            const contractor = appData.contractors.find(c => c.contractorId === contractorId);
            if (!contractor) {
                showError('קבלן לא נמצא');
                return;
            }

            console.log('[EDIT CONTRACTOR] Full contractor object:', contractor);
            console.log('[EDIT CONTRACTOR] contractor.specialty:', contractor.specialty);
            console.log('[EDIT CONTRACTOR] contractor.speciality:', contractor.speciality);

            // Store that we're editing
            editingContractorId = contractorId;

            // Populate form
            document.getElementById('contractorName').value = contractor.name || '';
            document.getElementById('contractorPhone').value = contractor.phone || '';
            // Support both spellings for backwards compatibility
            const specialtyValue = contractor.specialty || contractor.speciality || '';
            console.log('[EDIT CONTRACTOR] Using specialty value:', specialtyValue);
            document.getElementById('contractorSpecialty').value = specialtyValue;

            // Change modal title
            document.querySelector('#contractorModal h2').textContent = 'ערוך קבלן';

            // Show modal
            document.getElementById('contractorModal').style.display = 'block';
        }

        async function editWork(workId) {
            console.log('[EDIT WORK] Starting edit for workId:', workId);
            const work = appData.works.find(w => w.workId === workId);
            if (!work) {
                showError('עבודה לא נמצאה');
                return;
            }
            console.log('[EDIT WORK] Found work:', work);

            // Store that we're editing
            editingWorkId = workId;

            // Load projects and contractors for dropdowns
            try {
                console.log('[EDIT WORK] Loading projects and contractors...');
                const projects = await apiCall('/projects', 'GET');
                const contractors = await apiCall('/contractors', 'GET');
                console.log('[EDIT WORK] Loaded projects:', projects.projects?.length, 'contractors:', contractors.contractors?.length);

                // Populate project dropdown
                const projectSelect = document.getElementById('workProjectId');
                if (!projectSelect) {
                    console.error('[EDIT WORK] ERROR: workProjectId element not found!');
                    showError('שגיאה: שדה פרויקט לא נמצא');
                    return;
                }
                projectSelect.innerHTML = '<option value="">בחר פרויקט *</option>';
                if (projects.projects) {
                    projects.projects.forEach(p => {
                        const option = document.createElement('option');
                        option.value = p.projectId;
                        option.textContent = p.name;
                        if (p.projectId === work.projectId) option.selected = true;
                        projectSelect.appendChild(option);
                    });
                }
                console.log('[EDIT WORK] Populated project dropdown, selected:', work.projectId);

                // Populate contractor dropdown
                const contractorSelect = document.getElementById('workContractorId');
                if (!contractorSelect) {
                    console.error('[EDIT WORK] ERROR: workContractorId element not found!');
                    showError('שגיאה: שדה קבלן לא נמצא');
                    return;
                }
                contractorSelect.innerHTML = '<option value="">בחר קבלן *</option>';
                if (contractors.contractors) {
                    contractors.contractors.forEach(c => {
                        const option = document.createElement('option');
                        option.value = c.contractorId;
                        option.textContent = c.name;
                        if (c.contractorId === work.contractorId) option.selected = true;
                        contractorSelect.appendChild(option);
                    });
                }
                console.log('[EDIT WORK] Populated contractor dropdown, selected:', work.contractorId);

                // Populate form fields
                const workNameField = document.getElementById('workName');
                const workStartDateField = document.getElementById('workStartDate');
                const workCostField = document.getElementById('workCost');

                if (!workNameField || !workStartDateField || !workCostField) {
                    console.error('[EDIT WORK] ERROR: Missing form fields!', {
                        workName: !!workNameField,
                        workStartDate: !!workStartDateField,
                        workCost: !!workCostField
                    });
                    showError('שגיאה: שדות טופס חסרים');
                    return;
                }

                workNameField.value = work.workName || '';
                workStartDateField.value = work.startDate || '';
                workCostField.value = work.totalWorkCost || '';
                console.log('[EDIT WORK] Populated form fields');

                // Change modal title
                document.querySelector('#workModal h2').textContent = 'ערוך עבודה';

                // Show modal
                document.getElementById('workModal').style.display = 'block';
                console.log('[EDIT WORK] Modal displayed');

            } catch (error) {
                console.error('[EDIT WORK] ERROR:', error);
                showError('שגיאה בטעינת נתונים: ' + error.message);
            }
        }

        async function editExpense(expenseId) {
            const expense = appData.expenses.find(e => e.expenseId === expenseId);
            if (!expense) {
                showError('הוצאה לא נמצאה');
                return;
            }

            // Store that we're editing
            editingExpenseId = expenseId;

            // Load projects, contractors, and works for dropdowns
            try {
                const projects = await apiCall('/projects', 'GET');
                const contractors = await apiCall('/contractors', 'GET');
                const works = await apiCall('/works', 'GET');

                // Store works data globally for onWorkSelected function
                expenseFormWorks = works.works || [];

                // Populate works dropdown
                const workSelect = document.getElementById('expenseWorkId');
                workSelect.innerHTML = '<option value="">בחר עבודה (ממלא אוטומטית פרויקט וקבלן)</option>';
                if (works.works) {
                    works.works.forEach(w => {
                        const option = document.createElement('option');
                        option.value = w.workId;
                        option.textContent = w.workName;
                        if (w.workId === expense.workId) option.selected = true;
                        workSelect.appendChild(option);
                    });
                }

                // Populate project dropdown
                const projectSelect = document.getElementById('expenseProjectId');
                // Check if expense is assigned to General Expenses (system project)
                const isGeneralExpenses = expense.projectId === 'proj_GENERAL_EXPENSES';
                projectSelect.innerHTML = '<option value=""' + (isGeneralExpenses ? ' selected' : '') + '>הוצאות כלליות (ברירת מחדל)</option>';
                if (projects.projects) {
                    projects.projects.forEach(p => {
                        // Skip system projects (like General Expenses) - represented by default option
                        if (p.isSystemProject) return;

                        const option = document.createElement('option');
                        option.value = p.projectId;
                        option.textContent = p.name;
                        if (p.projectId === expense.projectId && !isGeneralExpenses) option.selected = true;
                        projectSelect.appendChild(option);
                    });
                }

                // Populate contractor dropdown
                const contractorSelect = document.getElementById('expenseContractorId');
                // Check if expense is assigned to General Contractor (system contractor)
                const isGeneralContractor = expense.contractorId === 'cont_GENERAL';
                contractorSelect.innerHTML = '<option value=""' + (isGeneralContractor ? ' selected' : '') + '>ספק כללי (ברירת מחדל)</option>';
                if (contractors.contractors) {
                    contractors.contractors.forEach(c => {
                        // Skip system contractors (like General Contractor) - represented by default option
                        if (c.isSystemContractor) return;

                        const option = document.createElement('option');
                        option.value = c.contractorId;
                        option.textContent = c.name;
                        if (c.contractorId === expense.contractorId && !isGeneralContractor) option.selected = true;
                        contractorSelect.appendChild(option);
                    });
                }

                // Populate form fields
                document.getElementById('expenseDescription').value = expense.description || '';
                document.getElementById('expenseAmount').value = expense.amount || '';
                document.getElementById('expenseDate').value = expense.date || '';
                document.getElementById('expenseInvoice').value = expense.invoiceNum || '';
                document.getElementById('expensePayment').value = expense.paymentMethod || 'מזומן';

                // Update VAT preview for existing amount
                updateVATPreview();

                // Note: File input cannot be pre-populated for security reasons

                // ===== EDIT MODE: Hide OCR components, show form directly =====

                // Hide OCR upload container (only for creating new expenses)
                document.getElementById('expense-ocr-container').style.display = 'none';

                // Hide skip button (only for creating new expenses)
                const skipContainer = document.getElementById('ocr-skip-container');
                if (skipContainer) skipContainer.style.display = 'none';

                // Show form layout
                document.getElementById('expense-form-layout').style.display = 'flex';

                // Handle receipt preview and modal width
                const receiptPreview = document.getElementById('expense-receipt-preview');
                const modalWide = document.querySelector('.expense-modal-wide');
                const uploadArea = document.getElementById('receipt-upload-area');
                const dropzone = document.getElementById('receipt-dropzone');
                const imagePreview = document.getElementById('receipt-image-preview');
                const previewImg = document.getElementById('receipt-preview-img');

                // Always show the receipt panel (for upload or viewing)
                receiptPreview.style.display = 'flex';
                if (modalWide) modalWide.classList.remove('no-picture');

                if (expense.receiptUrl) {
                    // Show existing receipt image, hide upload dropzone
                    expenseWithPicture = true;
                    if (uploadArea) uploadArea.style.display = 'none';
                    if (dropzone) dropzone.style.display = 'none';
                    if (imagePreview) {
                        imagePreview.style.display = 'block';
                        if (previewImg) previewImg.src = expense.receiptUrl;
                    }
                } else {
                    // No receipt - show upload dropzone so user can add one
                    expenseWithPicture = false;
                    pendingReceiptFile = null;
                    if (uploadArea) uploadArea.style.display = 'block';
                    if (dropzone) dropzone.style.display = 'flex';
                    if (imagePreview) imagePreview.style.display = 'none';
                }

                // Set missing receipt checkbox based on expense data
                const missingReceiptInput = document.getElementById('expenseMissingReceipt');
                if (missingReceiptInput) {
                    missingReceiptInput.value = expense.missingReceipt ? 'true' : 'false';
                }

                // Change modal title
                document.querySelector('#expenseModal h2').textContent = 'ערוך הוצאה';

                // Show modal
                document.getElementById('expenseModal').style.display = 'block';

            } catch (error) {
                showError('שגיאה בטעינת נתונים: ' + error.message);
            }
        }

        function showError(message) {
            showMessage(message, 'error');
        }

        function showMessage(message, type) {
            const messageArea = document.getElementById('messageArea');
            messageArea.className = `message ${type}`;
            messageArea.textContent = message;
            messageArea.style.display = 'block';

            setTimeout(() => {
                messageArea.style.display = 'none';
            }, 5000);
        }

        // ===== REPORTS AND ANALYTICS FUNCTIONS =====

        let expenseTrendChartInstance = null;
        let projectDistributionChartInstance = null;

        function initializeReportsDashboard() {
            // Calculate key metrics
            const totalExpenses = appData.expenses.reduce((sum, exp) => sum + (exp.amount || 0), 0);
            const totalVAT = appData.expenses.reduce((sum, exp) => sum + (exp.vatAmount || 0), 0);
            const activeProjects = appData.projects.length;
            const totalProjects = appData.projects.length;

            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const monthlyExpenses = appData.expenses
                .filter(exp => {
                    const date = new Date(exp.date);
                    return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
                })
                .reduce((sum, exp) => sum + (exp.amount || 0), 0);

            const monthlyVAT = appData.expenses
                .filter(exp => {
                    const date = new Date(exp.date);
                    return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
                })
                .reduce((sum, exp) => sum + (exp.vatAmount || 0), 0);

            const avgExpense = appData.expenses.length > 0 ? totalExpenses / appData.expenses.length : 0;
            const expensePerProject = activeProjects > 0 ? totalExpenses / activeProjects : 0;

            // Calculate previous month for comparison
            const lastMonth = currentMonth === 0 ? 11 : currentMonth - 1;
            const lastMonthYear = currentMonth === 0 ? currentYear - 1 : currentYear;
            const lastMonthExpenses = appData.expenses
                .filter(exp => {
                    const date = new Date(exp.date);
                    return date.getMonth() === lastMonth && date.getFullYear() === lastMonthYear;
                })
                .reduce((sum, exp) => sum + (exp.amount || 0), 0);

            const change = lastMonthExpenses > 0
                ? ((monthlyExpenses - lastMonthExpenses) / lastMonthExpenses * 100).toFixed(1)
                : 0;

            // Calculate average expense change (vs 6-month average)
            const sixMonthsAgo = new Date();
            sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
            const historicalExpenses = appData.expenses.filter(exp => new Date(exp.date) >= sixMonthsAgo);
            const historicalAvg = historicalExpenses.length > 0
                ? historicalExpenses.reduce((sum, exp) => sum + (exp.amount || 0), 0) / historicalExpenses.length
                : avgExpense;
            const avgChange = historicalAvg > 0
                ? ((avgExpense - historicalAvg) / historicalAvg * 100).toFixed(1)
                : 0;

            // Update UI - Hero Card
            document.getElementById('report-total-expenses').textContent = `₪${totalExpenses.toLocaleString('he-IL')}`;

            const changeHeroEl = document.getElementById('report-expense-change-hero');
            if (changeHeroEl) {
                if (change > 0) {
                    changeHeroEl.innerHTML = `<i class="fas fa-arrow-up"></i><span>${change}% עליה</span><span class="metric-change-context">לעומת החודש הקודם</span>`;
                    changeHeroEl.className = 'metric-hero-change negative';
                } else if (change < 0) {
                    changeHeroEl.innerHTML = `<i class="fas fa-arrow-down"></i><span>${Math.abs(change)}% ירידה</span><span class="metric-change-context">לעומת החודש הקודם</span>`;
                    changeHeroEl.className = 'metric-hero-change positive';
                } else {
                    changeHeroEl.innerHTML = `<span>ללא שינוי</span><span class="metric-change-context">לעומת החודש הקודם</span>`;
                    changeHeroEl.className = 'metric-hero-change neutral';
                }
            }

            // Update timestamp
            const lastUpdatedEl = document.getElementById('last-updated-time');
            if (lastUpdatedEl) {
                lastUpdatedEl.textContent = new Date().toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' });
            }

            // Update UI - Financial Overview
            document.getElementById('report-monthly-expenses').textContent = `₪${monthlyExpenses.toLocaleString('he-IL')}`;
            document.getElementById('report-total-vat').textContent = `₪${totalVAT.toLocaleString('he-IL')}`;

            const monthlyChangeEl = document.getElementById('monthly-expense-change');
            if (monthlyChangeEl) {
                if (change > 0) {
                    monthlyChangeEl.innerHTML = `<i class="fas fa-arrow-up"></i> ${change}%`;
                    monthlyChangeEl.className = 'metric-item-change negative';
                } else if (change < 0) {
                    monthlyChangeEl.innerHTML = `<i class="fas fa-arrow-down"></i> ${Math.abs(change)}%`;
                    monthlyChangeEl.className = 'metric-item-change positive';
                } else {
                    monthlyChangeEl.innerHTML = `ללא שינוי`;
                    monthlyChangeEl.className = 'metric-item-change';
                }
            }

            const monthlyVatBadgeEl = document.getElementById('monthly-vat-badge');
            if (monthlyVatBadgeEl) {
                monthlyVatBadgeEl.textContent = `מתוך החודש: ₪${monthlyVAT.toLocaleString('he-IL')}`;
            }

            // Update UI - Performance Row
            document.getElementById('report-active-projects').textContent = activeProjects;

            const totalProjectsEl = document.getElementById('total-projects-text');
            if (totalProjectsEl) {
                totalProjectsEl.textContent = `מתוך ${totalProjects} סה"כ`;
            }

            document.getElementById('report-avg-expense').textContent = `₪${Math.round(avgExpense).toLocaleString('he-IL')}`;

            const avgChangeEl = document.getElementById('avg-expense-change');
            if (avgChangeEl) {
                if (avgChange > 0) {
                    avgChangeEl.innerHTML = `<i class="fas fa-arrow-up"></i> ${avgChange}%`;
                    avgChangeEl.className = 'metric-compact-change negative';
                } else if (avgChange < 0) {
                    avgChangeEl.innerHTML = `<i class="fas fa-arrow-down"></i> ${Math.abs(avgChange)}%`;
                    avgChangeEl.className = 'metric-compact-change positive';
                } else {
                    avgChangeEl.innerHTML = `ללא שינוי`;
                    avgChangeEl.className = 'metric-compact-change';
                }
            }

            const expensePerProjectEl = document.getElementById('expense-per-project');
            if (expensePerProjectEl) {
                expensePerProjectEl.textContent = `₪${Math.round(expensePerProject).toLocaleString('he-IL')}`;
            }

            // Calculate progress bar (expense distribution across projects)
            const budgetProgressEl = document.getElementById('budget-progress');
            if (budgetProgressEl && activeProjects > 0) {
                // Show as percentage of max single project expense vs average
                const projectExpenses = {};
                appData.expenses.forEach(exp => {
                    const pid = exp.projectId || 'general';
                    projectExpenses[pid] = (projectExpenses[pid] || 0) + (exp.amount || 0);
                });
                const maxProjectExpense = Math.max(...Object.values(projectExpenses), 1);
                const progressPercent = Math.min(100, Math.round((expensePerProject / maxProjectExpense) * 100));
                budgetProgressEl.style.width = `${progressPercent}%`;
            }

            // Initialize charts
            createExpenseTrendChart();
            createProjectDistributionChart();
        }

        // Initialize period selector buttons
        function initializePeriodSelector() {
            const buttons = document.querySelectorAll('.period-preset-btn');
            buttons.forEach(btn => {
                btn.addEventListener('click', function() {
                    buttons.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    // Period filtering can be implemented here
                    // For now, just update the UI
                });
            });
        }
        window.initializePeriodSelector = initializePeriodSelector;

        // Update trend chart with different month ranges
        function updateTrendChart(months) {
            // Update button states
            document.querySelectorAll('.chart-control-btn').forEach(btn => {
                btn.classList.remove('active');
                if (parseInt(btn.dataset.months) === months) {
                    btn.classList.add('active');
                }
            });

            // Update subtitle
            const subtitle = document.getElementById('trend-chart-subtitle');
            if (subtitle) {
                if (months === 12) {
                    subtitle.textContent = 'שנה אחרונה';
                } else {
                    subtitle.textContent = `${months} חודשים אחרונים`;
                }
            }

            // Recreate chart with new month range
            createExpenseTrendChart(months);
        }
        window.updateTrendChart = updateTrendChart;

        // Export reports as PDF (placeholder - shows alert for now)
        function exportReportsPDF() {
            showNotification('ייצוא PDF יהיה זמין בקרוב', 'info');
        }
        window.exportReportsPDF = exportReportsPDF;

        function createExpenseTrendChart(monthCount = 6) {
            const canvas = document.getElementById('expenseTrendChart');
            if (!canvas) return;

            // Destroy existing chart
            if (expenseTrendChartInstance) {
                expenseTrendChartInstance.destroy();
            }

            // Get data for specified number of months
            const monthsData = [];
            const today = new Date();

            for (let i = monthCount - 1; i >= 0; i--) {
                const month = new Date(today.getFullYear(), today.getMonth() - i, 1);
                const monthExpenses = appData.expenses
                    .filter(exp => {
                        const expDate = new Date(exp.date);
                        return expDate.getMonth() === month.getMonth() &&
                               expDate.getFullYear() === month.getFullYear();
                    })
                    .reduce((sum, exp) => sum + (exp.amount || 0), 0);

                monthsData.push({
                    label: month.toLocaleDateString('he-IL', { month: 'short', year: 'numeric' }),
                    value: monthExpenses
                });
            }

            const ctx = canvas.getContext('2d');
            expenseTrendChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: monthsData.map(d => d.label),
                    datasets: [{
                        label: 'הוצאות',
                        data: monthsData.map(d => d.value),
                        borderColor: '#3182ce',
                        backgroundColor: 'rgba(49, 130, 206, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '₪' + value.toLocaleString('he-IL');
                                }
                            }
                        }
                    }
                }
            });
        }

        function createProjectDistributionChart() {
            const canvas = document.getElementById('projectDistributionChart');
            if (!canvas) return;

            // Destroy existing chart
            if (projectDistributionChartInstance) {
                projectDistributionChartInstance.destroy();
            }

            // Calculate expenses per project
            const projectExpenses = {};
            appData.expenses.forEach(exp => {
                const projectName = exp.projectName || 'ללא פרויקט';
                projectExpenses[projectName] = (projectExpenses[projectName] || 0) + exp.amount;
            });

            // Sort and get top 5
            const sorted = Object.entries(projectExpenses)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            const colors = ['#3182ce', '#10b981', '#f97316', '#9333ea', '#ef4444'];

            const ctx = canvas.getContext('2d');
            projectDistributionChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: sorted.map(d => d[0]),
                    datasets: [{
                        data: sorted.map(d => d[1]),
                        backgroundColor: colors
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function showProjectBudgetReport() {
            const container = document.getElementById('tabContent');

            // Calculate budget vs actual for each project (O(1) lookup)
            const projectData = appData.projects.map(project => {
                const spent = getExpensesByProject(project.projectId)
                    .reduce((sum, exp) => sum + exp.amount, 0);

                const budget = project.budget || 0;
                const remaining = budget - spent;
                const percentage = budget > 0 ? (spent / budget * 100).toFixed(1) : 0;

                let status = 'success';
                if (percentage > 100) status = 'danger';
                else if (percentage > 80) status = 'warning';

                return {
                    name: project.name,
                    budget,
                    spent,
                    remaining,
                    percentage,
                    status
                };
            });

            container.innerHTML = `
                <h2>דוח תקציב פרויקטים</h2>
                <button class="btn-primary" onclick="showTab('reports')" style="margin-bottom: 20px;">
                    <i class="fas fa-arrow-right"></i> חזרה לדוחות
                </button>

                <table class="budget-table">
                    <thead>
                        <tr>
                            <th>פרויקט</th>
                            <th>תקציב</th>
                            <th>בוצע</th>
                            <th>נותר</th>
                            <th>% ביצוע</th>
                            <th>סטטוס</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${projectData.map(p => `
                            <tr>
                                <td><strong>${p.name}</strong></td>
                                <td>₪${p.budget.toLocaleString('he-IL')}</td>
                                <td>₪${p.spent.toLocaleString('he-IL')}</td>
                                <td>₪${p.remaining.toLocaleString('he-IL')}</td>
                                <td>
                                    <div>${p.percentage}%</div>
                                    <div class="progress-bar">
                                        <div class="progress-fill ${p.status}" style="width: ${Math.min(p.percentage, 100)}%"></div>
                                    </div>
                                </td>
                                <td>
                                    <span class="alert-badge ${p.status}">
                                        ${p.status === 'success' ? 'תקין' : p.status === 'warning' ? 'התראה' : 'חריגה'}
                                    </span>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function showContractorReport() {
            const container = document.getElementById('tabContent');

            // Calculate data per contractor (O(1) lookup)
            const contractorData = appData.contractors.map(contractor => {
                const expenses = getExpensesByContractor(contractor.contractorId);
                const totalPaid = expenses.reduce((sum, exp) => sum + exp.amount, 0);
                const transactionCount = expenses.length;
                const avgTransaction = transactionCount > 0 ? totalPaid / transactionCount : 0;

                return {
                    name: contractor.name,
                    specialty: contractor.speciality || '-',
                    totalPaid,
                    transactionCount,
                    avgTransaction
                };
            }).sort((a, b) => b.totalPaid - a.totalPaid);

            container.innerHTML = `
                <h2>דוח ניתוח קבלנים</h2>
                <button class="btn-primary" onclick="showTab('reports')" style="margin-bottom: 20px;">
                    <i class="fas fa-arrow-right"></i> חזרה לדוחות
                </button>

                <table>
                    <thead>
                        <tr>
                            <th>קבלן</th>
                            <th>התמחות</th>
                            <th>סה"כ שולם</th>
                            <th>מס' עסקאות</th>
                            <th>ממוצע לעסקה</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${contractorData.map(c => `
                            <tr>
                                <td><strong>${c.name}</strong></td>
                                <td>${c.specialty}</td>
                                <td>₪${c.totalPaid.toLocaleString('he-IL')}</td>
                                <td>${c.transactionCount}</td>
                                <td>₪${Math.round(c.avgTransaction).toLocaleString('he-IL')}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function showMonthlyReport() {
            const container = document.getElementById('tabContent');

            const currentDate = new Date();
            const currentMonth = currentDate.getMonth();
            const currentYear = currentDate.getFullYear();

            const currentMonthExpenses = appData.expenses.filter(exp => {
                const date = new Date(exp.date);
                return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
            });

            const lastMonth = currentMonth === 0 ? 11 : currentMonth - 1;
            const lastMonthYear = currentMonth === 0 ? currentYear - 1 : currentYear;

            const lastMonthExpenses = appData.expenses.filter(exp => {
                const date = new Date(exp.date);
                return date.getMonth() === lastMonth && date.getFullYear() === lastMonthYear;
            });

            const currentTotal = currentMonthExpenses.reduce((sum, exp) => sum + exp.amount, 0);
            const lastTotal = lastMonthExpenses.reduce((sum, exp) => sum + exp.amount, 0);
            const change = lastTotal > 0 ? ((currentTotal - lastTotal) / lastTotal * 100).toFixed(1) : 0;

            container.innerHTML = `
                <h2>סיכום חודשי - ${currentDate.toLocaleDateString('he-IL', { month: 'long', year: 'numeric' })}</h2>
                <button class="btn-primary" onclick="showTab('reports')" style="margin-bottom: 20px;">
                    <i class="fas fa-arrow-right"></i> חזרה לדוחות
                </button>

                <div class="dashboard-grid">
                    <div class="metric-card">
                        <div class="metric-icon blue">
                            <i class="fas fa-calendar-check"></i>
                        </div>
                        <div class="metric-value">₪${currentTotal.toLocaleString('he-IL')}</div>
                        <div class="metric-label">החודש הנוכחי</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon purple">
                            <i class="fas fa-calendar"></i>
                        </div>
                        <div class="metric-value">₪${lastTotal.toLocaleString('he-IL')}</div>
                        <div class="metric-label">החודש הקודם</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon ${change > 0 ? 'orange' : 'green'}">
                            <i class="fas fa-${change > 0 ? 'arrow-up' : 'arrow-down'}"></i>
                        </div>
                        <div class="metric-value">${Math.abs(change)}%</div>
                        <div class="metric-label">${change > 0 ? 'עלייה' : 'ירידה'}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon green">
                            <i class="fas fa-receipt"></i>
                        </div>
                        <div class="metric-value">${currentMonthExpenses.length}</div>
                        <div class="metric-label">הוצאות החודש</div>
                    </div>
                </div>

                <h3 style="margin-top: 32px;">הוצאות החודש</h3>
                <table>
                    <thead>
                        <tr>
                            <th>תאריך</th>
                            <th>תיאור</th>
                            <th>סכום</th>
                            <th>פרויקט</th>
                            <th>קבלן</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${currentMonthExpenses.map(exp => `
                            <tr>
                                <td>${new Date(exp.date).toLocaleDateString('he-IL')}</td>
                                <td>${exp.description}</td>
                                <td>₪${exp.amount.toLocaleString('he-IL')}</td>
                                <td>${exp.projectName || '-'}</td>
                                <td>${exp.contractorName || '-'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function showMissingReceiptsReport() {
            const container = document.getElementById('tabContent');

            const missingReceipts = appData.expenses.filter(exp => !exp.receiptUrl || exp.receiptUrl === '');
            const total = missingReceipts.reduce((sum, exp) => sum + exp.amount, 0);

            container.innerHTML = `
                <h2>דוח קבלות חסרות</h2>
                <button class="btn-primary" onclick="showTab('reports')" style="margin-bottom: 20px;">
                    <i class="fas fa-arrow-right"></i> חזרה לדוחות
                </button>

                <div class="chart-container" style="margin-bottom: 24px;">
                    <h3>סיכום</h3>
                    <p><strong>${missingReceipts.length}</strong> הוצאות ללא קבלה</p>
                    <p>סך הכל: <strong>₪${total.toLocaleString('he-IL')}</strong></p>
                </div>

                ${missingReceipts.length > 0 ? `
                    <!-- Desktop Table -->
                    <table class="missing-receipts-table">
                        <thead>
                            <tr>
                                <th>תאריך</th>
                                <th>תיאור</th>
                                <th>סכום</th>
                                <th>פרויקט</th>
                                <th>קבלן</th>
                                <th>פעולות</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${missingReceipts.map(exp => `
                                <tr>
                                    <td>${new Date(exp.date).toLocaleDateString('he-IL')}</td>
                                    <td>${exp.description}</td>
                                    <td>₪${exp.amount.toLocaleString('he-IL')}</td>
                                    <td>${exp.projectName || '-'}</td>
                                    <td>${exp.contractorName || '-'}</td>
                                    <td>
                                        <button class="btn-edit" onclick="editExpense('${exp.expenseId}')">העלה קבלה</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>

                    <!-- Mobile Cards View -->
                    <div class="missing-receipts-cards-mobile">
                        ${missingReceipts.map(exp => `
                            <div class="mobile-card">
                                <div class="mobile-card-header">
                                    <div class="mobile-card-title">${exp.description}</div>
                                    <span style="font-weight: 600; color: #e53e3e;">₪${exp.amount.toLocaleString('he-IL')}</span>
                                </div>
                                <div class="mobile-card-details">
                                    <div class="mobile-card-detail">
                                        <span class="mobile-card-label">תאריך:</span>
                                        <span class="mobile-card-value">${new Date(exp.date).toLocaleDateString('he-IL')}</span>
                                    </div>
                                    ${exp.projectName ? `
                                    <div class="mobile-card-detail">
                                        <span class="mobile-card-label">פרויקט:</span>
                                        <span class="mobile-card-value">${exp.projectName}</span>
                                    </div>
                                    ` : ''}
                                    ${exp.contractorName ? `
                                    <div class="mobile-card-detail">
                                        <span class="mobile-card-label">קבלן:</span>
                                        <span class="mobile-card-value">${exp.contractorName}</span>
                                    </div>
                                    ` : ''}
                                </div>
                                <div class="mobile-card-actions">
                                    <button class="btn-edit" onclick="editExpense('${exp.expenseId}')" style="width: 100%;">
                                        <i class="fas fa-upload"></i> העלה קבלה
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                ` : '<p style="text-align: center; padding: 40px; color: #10b981;"><i class="fas fa-check-circle"></i> כל ההוצאות כוללות קבלות!</p>'}
            `;
        }
    </script>

    <!-- Session Timeout Warning Modal -->
    <div id="sessionTimeoutOverlay" class="session-timeout-overlay">
        <div class="session-timeout-modal">
            <div class="session-timeout-icon">
                <i class="fas fa-clock"></i>
            </div>
            <h2 class="session-timeout-title">החיבור שלך עומד לפוג</h2>
            <p class="session-timeout-message">
                בשל חוסר פעילות, תנותק מהמערכת בעוד:
            </p>
            <div id="sessionTimeoutCountdown" class="session-timeout-countdown">2:00</div>
            <div class="session-timeout-buttons">
                <button class="session-timeout-btn session-timeout-btn-continue" onclick="SessionTimeout.continueSession()">
                    <i class="fas fa-check"></i> להישאר מחובר
                </button>
                <button class="session-timeout-btn session-timeout-btn-logout" onclick="SessionTimeout.logoutNow()">
                    <i class="fas fa-sign-out-alt"></i> יציאה
                </button>
            </div>
        </div>
    </div>

    <!-- Session Timeout Module -->
    <script>
        /**
         * Session Timeout Manager
         * Automatically logs out users after 15 minutes of inactivity
         * Shows a 2-minute warning before logout
         */
        const SessionTimeout = (function() {
            // Configuration
            const IDLE_TIMEOUT_MS = 15 * 60 * 1000; // 15 minutes of inactivity
            const WARNING_TIME_MS = 2 * 60 * 1000;  // 2 minutes warning before logout
            const CHECK_INTERVAL_MS = 1000;         // Check every second

            // State
            let idleTimer = null;
            let warningTimer = null;
            let countdownTimer = null;
            let lastActivity = Date.now();
            let isWarningShown = false;
            let isInitialized = false;

            // Activity events to track
            const ACTIVITY_EVENTS = [
                'mousedown', 'mousemove', 'keydown', 'keypress',
                'scroll', 'touchstart', 'touchmove', 'click', 'focus'
            ];

            /**
             * Initialize the session timeout manager
             */
            function init() {
                if (isInitialized) {
                    console.log('[SessionTimeout] Already initialized');
                    return;
                }

                console.log('[SessionTimeout] Initializing with', IDLE_TIMEOUT_MS / 60000, 'min timeout');

                // Bind activity events
                ACTIVITY_EVENTS.forEach(event => {
                    document.addEventListener(event, handleActivity, { passive: true });
                });

                // Also track visibility changes (tab switching)
                document.addEventListener('visibilitychange', handleVisibilityChange);

                // Start the idle checker
                startIdleChecker();

                isInitialized = true;
                console.log('[SessionTimeout] Initialized successfully');
            }

            /**
             * Handle user activity
             */
            function handleActivity() {
                lastActivity = Date.now();

                // If warning is shown, hide it on activity
                if (isWarningShown) {
                    hideWarning();
                }
            }

            /**
             * Handle tab visibility changes
             */
            function handleVisibilityChange() {
                if (document.visibilityState === 'visible') {
                    // User returned to tab, check if session should have expired
                    const idleTime = Date.now() - lastActivity;
                    if (idleTime >= IDLE_TIMEOUT_MS) {
                        console.log('[SessionTimeout] Session expired while away');
                        performLogout();
                    }
                }
            }

            /**
             * Start the idle checker interval
             */
            function startIdleChecker() {
                if (idleTimer) {
                    clearInterval(idleTimer);
                }

                idleTimer = setInterval(() => {
                    const idleTime = Date.now() - lastActivity;

                    // Check if we should show warning
                    if (!isWarningShown && idleTime >= (IDLE_TIMEOUT_MS - WARNING_TIME_MS)) {
                        showWarning();
                    }

                    // Check if we should logout
                    if (idleTime >= IDLE_TIMEOUT_MS) {
                        performLogout();
                    }
                }, CHECK_INTERVAL_MS);
            }

            /**
             * Show the warning modal
             */
            function showWarning() {
                if (isWarningShown) return;

                isWarningShown = true;
                const overlay = document.getElementById('sessionTimeoutOverlay');
                if (overlay) {
                    overlay.classList.add('show');
                }

                // Start countdown
                startCountdown();

                console.log('[SessionTimeout] Warning shown');
            }

            /**
             * Hide the warning modal
             */
            function hideWarning() {
                isWarningShown = false;
                const overlay = document.getElementById('sessionTimeoutOverlay');
                if (overlay) {
                    overlay.classList.remove('show');
                }

                // Clear countdown timer
                if (countdownTimer) {
                    clearInterval(countdownTimer);
                    countdownTimer = null;
                }

                console.log('[SessionTimeout] Warning hidden - session continued');
            }

            /**
             * Start the countdown timer in the warning modal
             */
            function startCountdown() {
                let remainingTime = WARNING_TIME_MS;
                const countdownEl = document.getElementById('sessionTimeoutCountdown');

                function updateCountdown() {
                    const minutes = Math.floor(remainingTime / 60000);
                    const seconds = Math.floor((remainingTime % 60000) / 1000);
                    if (countdownEl) {
                        countdownEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                    }
                }

                updateCountdown();

                countdownTimer = setInterval(() => {
                    remainingTime -= 1000;
                    updateCountdown();

                    if (remainingTime <= 0) {
                        clearInterval(countdownTimer);
                    }
                }, 1000);
            }

            /**
             * Continue the session (user clicked "stay logged in")
             */
            function continueSession() {
                lastActivity = Date.now();
                hideWarning();
                console.log('[SessionTimeout] User chose to continue session');
            }

            /**
             * Logout now (user clicked "logout" or timeout expired)
             */
            function logoutNow() {
                hideWarning();
                performLogout();
            }

            /**
             * Perform the actual logout
             */
            async function performLogout() {
                console.log('[SessionTimeout] Performing automatic logout due to inactivity');

                // Stop all timers
                if (idleTimer) {
                    clearInterval(idleTimer);
                    idleTimer = null;
                }
                if (countdownTimer) {
                    clearInterval(countdownTimer);
                    countdownTimer = null;
                }

                // Remove event listeners
                ACTIVITY_EVENTS.forEach(event => {
                    document.removeEventListener(event, handleActivity);
                });
                document.removeEventListener('visibilitychange', handleVisibilityChange);

                isInitialized = false;
                isWarningShown = false;

                // Perform Clerk signout
                try {
                    if (typeof ClerkAuth !== 'undefined' && ClerkAuth.signOut) {
                        await ClerkAuth.signOut();
                    }
                } catch (error) {
                    console.error('[SessionTimeout] Error during logout:', error);
                    // Fallback: reload the page
                    window.location.reload();
                }
            }

            /**
             * Destroy the session timeout manager
             */
            function destroy() {
                if (idleTimer) {
                    clearInterval(idleTimer);
                    idleTimer = null;
                }
                if (countdownTimer) {
                    clearInterval(countdownTimer);
                    countdownTimer = null;
                }

                ACTIVITY_EVENTS.forEach(event => {
                    document.removeEventListener(event, handleActivity);
                });
                document.removeEventListener('visibilitychange', handleVisibilityChange);

                isInitialized = false;
                isWarningShown = false;

                console.log('[SessionTimeout] Destroyed');
            }

            /**
             * Get current idle time (for debugging)
             */
            function getIdleTime() {
                return Date.now() - lastActivity;
            }

            // Public API
            return {
                init,
                destroy,
                continueSession,
                logoutNow,
                getIdleTime
            };
        })();
    </script>

    <!-- Details Modal -->
    <div id="detailsModal" class="details-modal" onclick="closeDetailsModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2 id="modalTitle">פרטים</h2>
                <button class="modal-close" onclick="closeDetailsModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-tabs">
                <button class="modal-tab active" onclick="switchModalTab('info', event)">
                    <i class="fas fa-info-circle"></i> מידע
                </button>
                <button class="modal-tab" onclick="switchModalTab('receipts', event)">
                    <i class="fas fa-receipt"></i> קבלות
                </button>
            </div>
            <div class="modal-body">
                <div id="modalTabInfo" class="modal-tab-content active">
                    <!-- Details will be populated here -->
                </div>
                <div id="modalTabReceipts" class="modal-tab-content">
                    <!-- Receipts will be populated here -->
                </div>
            </div>
        </div>
    </div>
</body>
</html>