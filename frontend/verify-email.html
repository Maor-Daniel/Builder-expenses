<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>אימות אימייל - Builder Expenses</title>

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">

    <!-- Prevent Flash of Wrong Theme -->
    <script>
        (function() {
            const theme = localStorage.getItem('theme') ||
                (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            document.documentElement.setAttribute('data-theme', theme);
        })();
    </script>

    <!-- Auth Styles -->
    <link rel="stylesheet" href="auth-styles.css">

    <!-- Rubik Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="auth-page">
    <!-- Theme Toggle Button -->
    <button class="theme-toggle" id="themeToggle" aria-label="החלף למצב כהה" type="button">
        <svg class="theme-icon sun-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="5"></circle>
            <line x1="12" y1="1" x2="12" y2="3"></line>
            <line x1="12" y1="21" x2="12" y2="23"></line>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
            <line x1="1" y1="12" x2="3" y2="12"></line>
            <line x1="21" y1="12" x2="23" y2="12"></line>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
        </svg>
        <svg class="theme-icon moon-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
        </svg>
    </button>

    <div class="auth-container">
        <div class="auth-card">
            <!-- Header -->
            <div class="auth-header">
                <h1 class="auth-title">אימות כתובת אימייל</h1>
                <p class="auth-subtitle" id="subtitle">הזנו את קוד האימות בן 6 הספרות ששלחנו לכתובת <strong id="userEmail"></strong></p>
            </div>

            <!-- Error Message (hidden by default) -->
            <div id="errorMessage" class="message message-error hidden"></div>

            <!-- Success Message (hidden by default) -->
            <div id="successMessage" class="message message-success hidden"></div>

            <!-- Verification Form -->
            <form id="verifyForm" class="auth-form" novalidate>
                <!-- 6-Digit Code Input -->
                <div class="form-group">
                    <label class="form-label text-center">קוד אימות</label>
                    <div class="code-input-group">
                        <input type="text" class="code-digit" maxlength="1" pattern="[0-9]" inputmode="numeric" autocomplete="one-time-code" id="digit1">
                        <input type="text" class="code-digit" maxlength="1" pattern="[0-9]" inputmode="numeric" id="digit2">
                        <input type="text" class="code-digit" maxlength="1" pattern="[0-9]" inputmode="numeric" id="digit3">
                        <input type="text" class="code-digit" maxlength="1" pattern="[0-9]" inputmode="numeric" id="digit4">
                        <input type="text" class="code-digit" maxlength="1" pattern="[0-9]" inputmode="numeric" id="digit5">
                        <input type="text" class="code-digit" maxlength="1" pattern="[0-9]" inputmode="numeric" id="digit6">
                    </div>
                    <span id="codeError" class="field-error"></span>
                </div>

                <!-- Submit Button -->
                <button type="submit" class="btn btn-primary" id="submitButton">
                    <span class="btn-text">אמת קוד</span>
                    <span class="btn-spinner"></span>
                </button>
            </form>

            <!-- Resend Code -->
            <div class="resend-code">
                <span id="resendText">לא קיבלת את הקוד? </span>
                <a href="#" class="resend-link" id="resendLink">שלח שוב</a>
                <span id="cooldownText" style="display: none;"></span>
            </div>

            <!-- Footer Links -->
            <div class="auth-footer">
                <a href="signup.html" class="auth-link" id="backLink">חזור להרשמה</a>
            </div>
        </div>
    </div>

    <!-- Auth Utils -->
    <script src="auth-utils.js"></script>

    <!-- Theme Manager -->
    <script src="theme-manager.js"></script>

    <script>
        // Get mode from URL parameters (signup or reset)
        const urlParams = new URLSearchParams(window.location.search);
        const mode = urlParams.get('mode') || 'signup';

        // DOM Elements
        const form = document.getElementById('verifyForm');
        const submitButton = document.getElementById('submitButton');
        const errorMessageDiv = document.getElementById('errorMessage');
        const successMessageDiv = document.getElementById('successMessage');
        const userEmailSpan = document.getElementById('userEmail');
        const resendLink = document.getElementById('resendLink');
        const resendText = document.getElementById('resendText');
        const cooldownText = document.getElementById('cooldownText');
        const backLink = document.getElementById('backLink');

        // Code input elements
        const codeInputs = [
            document.getElementById('digit1'),
            document.getElementById('digit2'),
            document.getElementById('digit3'),
            document.getElementById('digit4'),
            document.getElementById('digit5'),
            document.getElementById('digit6')
        ];

        // Get email from session storage or URL params (fallback for Safari private mode)
        const urlEmail = new URLSearchParams(window.location.search).get('email') || '';
        const email = mode === 'reset'
            ? sessionStorage.getItem('reset_email') || urlEmail
            : sessionStorage.getItem('signup_email') || urlEmail;

        console.log('[VERIFY-EMAIL] Email source:', {
            mode,
            fromSessionStorage: mode === 'reset' ? sessionStorage.getItem('reset_email') : sessionStorage.getItem('signup_email'),
            fromUrlParams: urlEmail,
            final: email
        });

        userEmailSpan.textContent = email || 'האימייל שלך';

        // Update back link based on mode
        if (mode === 'reset') {
            backLink.href = 'forgot-password.html';
            backLink.textContent = 'חזור לאיפוס סיסמה';
        }

        // Cooldown state
        let cooldownSeconds = 0;
        let cooldownInterval = null;

        // Auto-focus first input
        window.addEventListener('DOMContentLoaded', () => {
            codeInputs[0].focus();
        });

        // Check if sign-up state exists on page load (only for signup mode)
        window.addEventListener('DOMContentLoaded', async () => {
            // Only check for signup mode, not password reset
            if (mode !== 'signup') {
                console.log('[VERIFY-EMAIL] Skipping sign-up state check (mode:', mode, ')');
                return;
            }

            try {
                console.log('[VERIFY-EMAIL] Checking sign-up state on page load...');
                const clerk = await AuthUtils.getClerkInstance();
                const hasSignUpState = !!clerk.client?.signUp;

                console.log('[VERIFY-EMAIL] Sign-up state check:', {
                    hasClerkInstance: !!window.ClerkInstance,
                    hasClient: !!clerk.client,
                    hasSignUpState: hasSignUpState,
                    signUpEmail: clerk.client?.signUp?.emailAddress,
                    signUpStatus: clerk.client?.signUp?.status
                });

                if (!hasSignUpState) {
                    console.warn('[VERIFY-EMAIL] No sign-up state found on page load');
                    console.warn('[VERIFY-EMAIL] User may have refreshed the page or navigated directly');

                    // Show warning message
                    showError('תהליך ההרשמה לא נמצא. ייתכן שרענת את הדף. אנא התחל מחדש.');

                    // Create and add "Start Over" button
                    const startOverBtn = document.createElement('a');
                    startOverBtn.href = 'signup.html';
                    startOverBtn.className = 'btn btn-secondary';
                    startOverBtn.textContent = 'חזור להרשמה';
                    startOverBtn.style.marginTop = '15px';
                    startOverBtn.style.display = 'block';

                    // Insert after the form
                    form.parentNode.insertBefore(startOverBtn, form.nextSibling);

                    // Disable verification form
                    submitButton.disabled = true;
                    codeInputs.forEach(input => input.disabled = true);
                } else {
                    console.log('[VERIFY-EMAIL] Sign-up state verified successfully');
                }
            } catch (error) {
                console.error('[VERIFY-EMAIL] Error checking sign-up state:', error);
                // Don't block the user if there's an error checking state
                // They can still try to verify, and the actual error will be shown if it fails
            }
        });

        // Handle input for each digit
        codeInputs.forEach((input, index) => {
            // Auto-advance on input
            input.addEventListener('input', (e) => {
                const value = e.target.value;

                // Only allow digits
                if (!/^[0-9]$/.test(value)) {
                    e.target.value = '';
                    return;
                }

                // Mark as filled
                if (value) {
                    e.target.classList.add('filled');
                } else {
                    e.target.classList.remove('filled');
                }

                // Auto-advance to next input
                if (value && index < 5) {
                    codeInputs[index + 1].focus();
                }

                // Auto-submit when all 6 digits are filled
                if (index === 5 && value) {
                    const allFilled = codeInputs.every(input => input.value);
                    if (allFilled) {
                        setTimeout(() => form.requestSubmit(), 100);
                    }
                }

                hideFieldError('codeError');
            });

            // Handle backspace navigation
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Backspace' && !e.target.value && index > 0) {
                    codeInputs[index - 1].focus();
                    codeInputs[index - 1].value = '';
                    codeInputs[index - 1].classList.remove('filled');
                }
            });

            // Handle paste (6-digit code)
            input.addEventListener('paste', (e) => {
                e.preventDefault();
                const pastedData = e.clipboardData.getData('text');
                const digits = pastedData.replace(/\D/g, '').slice(0, 6);

                if (digits.length === 6) {
                    digits.split('').forEach((digit, i) => {
                        codeInputs[i].value = digit;
                        codeInputs[i].classList.add('filled');
                    });
                    codeInputs[5].focus();

                    // Auto-submit after paste
                    setTimeout(() => form.requestSubmit(), 100);
                }
            });
        });

        // Show Error Message
        function showError(message) {
            errorMessageDiv.textContent = message;
            errorMessageDiv.classList.remove('hidden');
            successMessageDiv.classList.add('hidden');
            errorMessageDiv.classList.add('shake');
            setTimeout(() => errorMessageDiv.classList.remove('shake'), 500);
        }

        // Show Success Message
        function showSuccess(message) {
            successMessageDiv.textContent = message;
            successMessageDiv.classList.remove('hidden');
            errorMessageDiv.classList.add('hidden');
        }

        // Hide Messages
        function hideMessages() {
            errorMessageDiv.classList.add('hidden');
            successMessageDiv.classList.add('hidden');
        }

        // Show Field Error
        function showFieldError(fieldId, message) {
            const errorSpan = document.getElementById(fieldId);
            errorSpan.textContent = message;
            errorSpan.classList.add('show');
        }

        // Hide Field Error
        function hideFieldError(fieldId) {
            const errorSpan = document.getElementById(fieldId);
            errorSpan.classList.remove('show');
        }

        // Set Button Loading State
        function setLoading(isLoading) {
            if (isLoading) {
                submitButton.classList.add('loading');
                submitButton.disabled = true;
            } else {
                submitButton.classList.remove('loading');
                submitButton.disabled = false;
            }
        }

        // Clear all code inputs
        function clearCodeInputs() {
            codeInputs.forEach(input => {
                input.value = '';
                input.classList.remove('filled');
            });
            codeInputs[0].focus();
        }

        // Start cooldown timer
        function startCooldown(seconds) {
            cooldownSeconds = seconds;
            resendLink.classList.add('disabled');
            resendText.style.display = 'none';
            resendLink.style.display = 'none';
            cooldownText.style.display = 'inline';

            cooldownInterval = setInterval(() => {
                cooldownSeconds--;
                cooldownText.textContent = `אפשר לשלוח שוב בעוד ${cooldownSeconds} שניות`;

                if (cooldownSeconds <= 0) {
                    clearInterval(cooldownInterval);
                    resendLink.classList.remove('disabled');
                    resendText.style.display = 'inline';
                    resendLink.style.display = 'inline';
                    cooldownText.style.display = 'none';
                }
            }, 1000);
        }

        // Handle resend code
        resendLink.addEventListener('click', async (e) => {
            e.preventDefault();

            if (cooldownSeconds > 0) {
                return; // Still in cooldown
            }

            console.log('[VERIFY] Resending verification code');

            try {
                hideMessages();

                if (mode === 'reset') {
                    // For password reset mode, request a new reset code
                    const result = await AuthUtils.requestPasswordReset(email);

                    if (result.success) {
                        showSuccess('קוד איפוס חדש נשלח לאימייל שלך');
                        startCooldown(60);
                    } else {
                        showError(result.error);
                    }
                } else {
                    // For signup mode, we need to trigger a new verification
                    // Clerk automatically handles this when we call prepareEmailAddressVerification again
                    const clerk = await AuthUtils.getClerkInstance();
                    const signUp = clerk.client.signUp;

                    if (signUp) {
                        await signUp.prepareEmailAddressVerification({ strategy: 'email_code' });
                        showSuccess('קוד אימות חדש נשלח לאימייל שלך');
                        startCooldown(60);
                    } else {
                        showError('לא נמצא תהליך הרשמה פעיל');
                    }
                }
            } catch (error) {
                console.error('[VERIFY] Resend error:', error);
                showError('שגיאה בשליחת קוד אימות. אנא נסה שוב.');
            }
        });

        // Form Validation
        function validateForm() {
            hideFieldError('codeError');
            hideMessages();

            const code = codeInputs.map(input => input.value).join('');

            if (code.length !== 6) {
                showFieldError('codeError', 'נא להזין קוד בן 6 ספרות');
                return false;
            }

            if (!/^\d{6}$/.test(code)) {
                showFieldError('codeError', 'קוד האימות חייב להכיל ספרות בלבד');
                return false;
            }

            return true;
        }

        // Handle Form Submission
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            // Client-side validation
            if (!validateForm()) {
                return;
            }

            // Get verification code
            const code = codeInputs.map(input => input.value).join('');

            console.log('[VERIFY] Attempting verification with code:', code);

            // Set loading state
            setLoading(true);
            hideMessages();

            try {
                if (mode === 'reset') {
                    // Password reset flow - Clerk requires code + password together
                    // So we just store the code and redirect without API verification
                    console.log('[VERIFY] Password reset mode - storing code for later verification');

                    // Store verification code for reset-password page
                    sessionStorage.setItem('reset_code', code);

                    // Show success message
                    showSuccess('✓ קוד התקבל! מעביר אותך להגדרת סיסמה חדשה...');

                    // Redirect to reset password page
                    setTimeout(() => {
                        window.location.href = 'reset-password.html';
                    }, 1500);
                } else {
                    // Signup flow - verify code with Clerk API
                    const result = await AuthUtils.verifyEmailCode(code);

                    if (result.success) {
                        console.log('[VERIFY] Verification successful');

                        // Show success message
                        showSuccess('✓ אימות הצליח! מעביר אותך למערכת...');

                        // Check if this is a mobile app signup
                        const isMobileSignup = sessionStorage.getItem('mobile_app_signup') === 'true';

                        // Clear stored data
                        sessionStorage.removeItem('signup_email');
                        sessionStorage.removeItem('mobile_app_signup');

                        // Redirect after brief delay
                        setTimeout(() => {
                            if (isMobileSignup) {
                                // Mobile app signup: redirect to Universal Link
                                const userEmail = email; // Already available from line 133
                                const encodedEmail = encodeURIComponent(userEmail);
                                const deepLinkUrl = `https://www.builder-expenses.com/app/signup-complete?email=${encodedEmail}`;

                                console.log('[VERIFY] Redirecting to mobile app via Universal Link:', deepLinkUrl);
                                window.location.href = deepLinkUrl;
                            } else {
                                // Regular web signup: redirect to web app
                                window.location.href = 'app.html';
                            }
                        }, 1500);
                    } else {
                        // Show error message in Hebrew
                        console.error('[VERIFY] Verification failed:', result.error);

                        // Check if this is the SIGNUP_STATE_LOST error
                        if (result.errorCode === 'SIGNUP_STATE_LOST') {
                            showError(result.error);

                            // Check if "Start Over" button already exists
                            const existingBtn = document.querySelector('.btn-secondary[href="signup.html"]');
                            if (!existingBtn) {
                                // Create and add "Start Over" button
                                const startOverBtn = document.createElement('a');
                                startOverBtn.href = 'signup.html';
                                startOverBtn.className = 'btn btn-secondary';
                                startOverBtn.textContent = 'חזור להרשמה';
                                startOverBtn.style.marginTop = '15px';
                                startOverBtn.style.display = 'block';

                                // Insert after the form
                                form.parentNode.insertBefore(startOverBtn, form.nextSibling);
                            }

                            // Disable verification form
                            submitButton.disabled = true;
                            codeInputs.forEach(input => input.disabled = true);
                        } else {
                            // Regular error - just show the message
                            showError(result.error);
                            clearCodeInputs();
                        }

                        setLoading(false);
                    }
                }
            } catch (error) {
                console.error('[VERIFY] Unexpected error:', error);
                showError('אירעה שגיאה בלתי צפויה. אנא נסה שוב.');
                clearCodeInputs();
                setLoading(false);
            }
        });
    </script>
</body>
</html>
